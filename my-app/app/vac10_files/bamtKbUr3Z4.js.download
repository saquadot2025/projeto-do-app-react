;/*FB_PKG_DELIM*/

__d("ArmadilloReceiveWriteDbSuccessFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(a,b,c,d,e,f,g){"use strict";a=c("getFalcoLogPolicy_DO_NOT_USE")("5721");b=d("FalcoLoggerInternal").create("armadillo_receive_write_db_success",a);e=b;g["default"]=e}),98);
__d("MAWEBCombinedSwitch",["MAWEBEnabledStateManager","MAWEBLSInWorkerSwitch","MAWEBSwitch"],(function(a,b,c,d,e,f,g){"use strict";var h=new(d("MAWEBEnabledStateManager").MAWEBEnabledStateManager)();function i(){h.set(c("MAWEBSwitch").isEnabled()&&c("MAWEBLSInWorkerSwitch").isEnabled())}c("MAWEBSwitch").onSet(function(){i()});c("MAWEBLSInWorkerSwitch").onSet(function(){i()});i();g.MAWEBCombinedSwitch=h}),98);
__d("EBAPI",["MAWEBCombinedSwitch","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h=(a=c("requireDeferred"))("EBAPIMinosVerifySingleEpoch").__setRef("EBAPI"),i=a("EBAPIWriteMinosPublicKeysForRecipient").__setRef("EBAPI"),j=a("EBGetContactEpochHead").__setRef("EBAPI"),k=a("EBGetMessageKeys").__setRef("EBAPI"),l=a("EBIsEbEnabled").__setRef("EBAPI"),m=a("EBMessageBulkPointQuery").__setRef("EBAPI"),n=a("EBMessagePointQueryWithPersistence").__setRef("EBAPI"),o=a("EBMessageRangeQueryForIndexing").__setRef("EBAPI"),p=a("EBMessageRangeQueryWithPersistence").__setRef("EBAPI"),q=a("EBUploadDeletedMessage").__setRef("EBAPI"),r=a("EBUploadReceivedMessages").__setRef("EBAPI"),s=a("EBUploadReceivedMessagesProtobufOnly").__setRef("EBAPI"),t=a("EBUploadSentMessage").__setRef("EBAPI");b={getContactEpochHead:function(){for(var a=arguments.length,b=new Array(a),c=0;c<a;c++)b[c]=arguments[c];return j.load().then(function(a){return a.getContactEpochHead.apply(a,b)})},getMessageKeys:function(){for(var a=arguments.length,b=new Array(a),c=0;c<a;c++)b[c]=arguments[c];return k.load().then(function(a){return a.getMessageKeys.apply(a,b)})},isEBEnabled:function(){return d("MAWEBCombinedSwitch").MAWEBCombinedSwitch.isEnabled()},isEbEnabledEbSwitch:function(){return l.load().then(function(a){return a.isEbEnabledEbSwitch()})},messageBulkPointQuery:function(){for(var a=arguments.length,b=new Array(a),c=0;c<a;c++)b[c]=arguments[c];return m.load().then(function(a){return a.messageBulkPointQuery.apply(a,b)})},messagePointQueryWithPersistence:function(){for(var a=arguments.length,b=new Array(a),c=0;c<a;c++)b[c]=arguments[c];return n.load().then(function(a){return a.messagePointQueryWithPersistence.apply(a,b)})},messageRangeQueryForIndexing:function(){for(var a=arguments.length,b=new Array(a),c=0;c<a;c++)b[c]=arguments[c];return o.load().then(function(a){return a.messageRangeQueryForIndexing.apply(a,b)})},messageRangeQueryWithPersistence:function(){for(var a=arguments.length,b=new Array(a),c=0;c<a;c++)b[c]=arguments[c];return p.load().then(function(a){return a.messageRangeQueryWithPersistence.apply(a,b)})},minosVerifySingleEpoch:function(){for(var a=arguments.length,b=new Array(a),c=0;c<a;c++)b[c]=arguments[c];return h.load().then(function(a){return a.minosVerifySingleEpoch.apply(a,b)})},uploadDeletedMessage:function(){for(var a=arguments.length,b=new Array(a),c=0;c<a;c++)b[c]=arguments[c];return q.load().then(function(a){return a.uploadDeletedMessage.apply(a,b)})},uploadReceivedMessages:function(){for(var a=arguments.length,b=new Array(a),c=0;c<a;c++)b[c]=arguments[c];return r.load().then(function(a){return a.uploadReceivedMessages.apply(a,b)})},uploadReceivedMessagesProtobufOnly:function(){for(var a=arguments.length,b=new Array(a),c=0;c<a;c++)b[c]=arguments[c];return s.load().then(function(a){return a.uploadReceivedMessagesProtobufOnly.apply(a,b)})},uploadSentMessage:function(){for(var a=arguments.length,b=new Array(a),c=0;c<a;c++)b[c]=arguments[c];return t.load().then(function(a){return a.uploadSentMessage.apply(a,b)})},writeMinosMailboxKeysForRecipient:function(){for(var a=arguments.length,b=new Array(a),c=0;c<a;c++)b[c]=arguments[c];return i.load().then(function(a){return a.writeMinosMailboxKeysForRecipient.apply(a,b)})}};e=b;g["default"]=e}),98);
__d("EBDBMetricsConsistencyOperationEnum",["$InternalEnum"],(function(a,b,c,d,e,f){"use strict";a=b("$InternalEnum")({Upload:0});f.EBConsistencyOperation=a}),66);
__d("EBGenerateMessageTags",["EncryptedBackupsUploadEntity","MSGDataclassTypes.flow"],(function(a,b,c,d,e,f,g){"use strict";function a(a){switch(a){case d("EncryptedBackupsUploadEntity").AttachmentContextMediaType.IMAGE:return d("MSGDataclassTypes.flow").MpsMessageTag.Photo;case d("EncryptedBackupsUploadEntity").AttachmentContextMediaType.VIDEO:return d("MSGDataclassTypes.flow").MpsMessageTag.Video;case d("EncryptedBackupsUploadEntity").AttachmentContextMediaType.GIF:return d("MSGDataclassTypes.flow").MpsMessageTag.Gif;case d("EncryptedBackupsUploadEntity").AttachmentContextMediaType.PTT:return d("MSGDataclassTypes.flow").MpsMessageTag.Audio;case d("EncryptedBackupsUploadEntity").AttachmentContextMediaType.DOCUMENT:return d("MSGDataclassTypes.flow").MpsMessageTag.File;default:return null}}g.generateEBMessageTags=a}),98);
__d("EBGetMinosWasm",["WAWasmModuleCache","bx"],(function(a,b,c,d,e,f,g){"use strict";var h=c("bx").getURL(c("bx")("31853"));a=function(){return d("WAWasmModuleCache").loadWasmModule(h)};g.getMinosWasm=a}),98);
__d("EBGraphQLTypeUtils",["err"],(function(a,b,c,d,e,f,g){"use strict";function a(a){if(/^\d+$/.test(a)===!1)throw c("err")("threadId is not a number");return Number(a)}function b(a){return a.toString()}g.threadIdToThreadIdInt=a;g.timestampMsToTimestampMsString=b}),98);
__d("EBLogger",["FBLogger"],(function(a,b,c,d,e,f,g){"use strict";a=c("FBLogger")("labyrinth_web").tags(["labyrinth_web"]);g.EBLogger=a}),98);
__d("EBMinosDBDev",["FBLogger","MAWWormOdsLogger","Promise","QPLFlow","WALogger","Worm","WormEAR","WormIDbDriver","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Error performing makeEBMinosDevDB: ",""]);i=function(){return a};return a}var j={secure_minos_mailbox_keys:{indexes:{},primaryKey:"contact_id",secure:!0},secure_minos_thread_message_encryption_keys:{indexes:{"[roster_hash+act_thread_id]":{fields:["roster_hash","act_thread_id"],unique:!1}},primaryKey:"mek_id_blob",secure:!0}},k,l=1e4;function a(a,b,c){return m.apply(this,arguments)}function m(){m=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c){var e=d("QPLFlow").startQPLFlow(b,{annotations:{string:{operationType:"initEBMinosDevDbSchema"}},timeoutInMs:l});try{c=new(d("WormEAR").WormEAR)(j,c);a=new(d("Worm").WormDatabase)(new(d("WormIDbDriver").WormIDbDriver)(a,"ebMinosDev",j,c,d("MAWWormOdsLogger").wormOdsWorkerLogger,{}),b);k=a;yield a.init({eventFlow:e});e.endSuccess();return a}catch(a){e.endFail("error");d("WALogger").ERROR(i(),a);throw a}});return m.apply(this,arguments)}function n(){if(k==null)throw c("FBLogger")("messenger_web").mustfixThrow("EBMinosDevDb is not initialized");return k}function e(){var a=Object.keys(j);return n().runInTransaction(a,"readonly",function(){var c=b("asyncToGeneratorRuntime").asyncToGenerator(function*(c){var d={};yield (h||(h=b("Promise"))).all(a.map(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=(yield c.stores[a].readAll());d[a]=b});return function(b){return a.apply(this,arguments)}}()));return d});return function(a){return c.apply(this,arguments)}}(),"EBMinosDevDb - Dump")["catch"](function(){return{}})}g.ebdbDescriptor=j;g.makeEBMinosDevDB=a;g.getEBMinosDevDb=n;g.getDbDump=e}),98);
__d("EBMinosLoadMailboxKeys",["EBMinosDBDev","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";a=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=(yield d("EBMinosDBDev").getEBMinosDevDb());b=(yield b.runInTransaction(["secure_minos_mailbox_keys"],"readonly",function(b){return b.stores.secure_minos_mailbox_keys.get(a)},"LoadMailboxKeys"));return b});return function(b){return a.apply(this,arguments)}}();g.loadMailboxKeys=a}),98);
__d("EBMinosLogger",["WATagsLogger"],(function(a,b,c,d,e,f,g){"use strict";a=d("WATagsLogger").TAGS(["minos"]);g.minosLogger=a}),98);
__d("EBMinosTypes",["$InternalEnum","WAJids"],(function(a,b,c,d,e,f,g){"use strict";function a(a){return a}function c(a){return a.endsWith(d("WAJids").MSGR_USER_DOMAIN)?a.slice(0,-d("WAJids").MSGR_USER_DOMAIN.length):null}var h=d("WAJids").createJidUtils({platform:"msgr"});function e(a){return h.toUserJid(a)}function f(a){return a}function i(a){return a}function j(a){return a}function k(a){return a}function l(a){return a}function m(a){return a}function n(a){return a}function o(a){return a}function p(a){return a}function q(a){return a}function r(a){return a}function s(a){return a}function t(a){return a}function u(a){return a}function v(a){return a}function w(a){return a}function x(a){return a}function y(a){return a}function z(a){return a}function A(a){return a}function B(a){return a}function C(a){return a}function D(a){return a}function E(a){return a}function F(a){return a}function G(a){return a}b=b("$InternalEnum")({INVALID:"-1",IMAGE:"0",PTT:"1",DOCUMENT:"3",VIDEO:"4",GIF:"5",STICKER:"6",XMA:"22",MESSENGER_PREVIEW:"25"});g.unsafeCastToUserFbId=a;g.userJidToUserFbId=c;g.userFbidToUserJid=e;g.unsafeCastToEpochHead=f;g.unsafeCastToEpochSignature=i;g.unsafeCastToEpochNumber=j;g.unsafeCastToEpochCreationTime=k;g.unsafeCastToExportRootKey=l;g.unsafeCastToMekId=m;g.unsafeCastMekKey=n;g.unsafeCastMekRosterHash=o;g.unsafeCastToEncryptedMek=p;g.unsafeCastToMekFbId=q;g.unsafeCastToMekMiThreadId=r;g.unsafeCastToMailboxFbId=s;g.unsafeCastToMailboxSigningPK=t;g.unsafeCastToMailboxSigningSK=u;g.unsafeCastToMailboxEncryptionPK=v;g.unsafeCastToMailboxEncryptionSK=w;g.unsafeCastToMailboxAuthPK=x;g.unsafeCastToMailboxAuthSK=y;g.unsafeCastToTransportSenderEphemeralPK=z;g.unsafeCastToTransportSenderEphemeralKeySig=A;g.unsafeCastToTransportSigningPK=B;g.unsafeCastToTransportSigningSK=C;g.unsafeCastToEpochFbId=D;g.castToSupplementalOpToken=E;g.unsafeCastToAttachmentAccessTokenSecret=F;g.unsafeCastToAttachmentPrimaryKeySecret=G;g.MinosAttachmentMediaType=b}),98);
__d("EBMinosWasm.pb",["WAProtoConst"],(function(a,b,c,d,e,f,g){a={};b={};c={};e={};f={};var h={},i={},j={},k={},l={},m={},n={},o={},p={},q={},r={},s={},t={},u={},v={},w={},x={},y={},z={},A={},B={},C={},D={},E={},F={},G={},H={},I={},J={},K={},L={},M={},N={},O={},P={},Q={},R={},S={},T={},U={},V={};a.name="MinosMessageMetadata";a.internalSpec={mekId:[1,(d=d("WAProtoConst")).FLAGS.REQUIRED|d.TYPES.BYTES],timestamp:[2,d.FLAGS.REQUIRED|d.TYPES.UINT64],messageId:[3,d.FLAGS.REQUIRED|d.TYPES.STRING],threadId:[4,d.FLAGS.REQUIRED|d.TYPES.STRING]};b.name="MinosEncryptAndSignMessageInput";b.internalSpec={transportSigningSk:[1,d.FLAGS.REQUIRED|d.TYPES.BYTES],mek:[2,d.FLAGS.REQUIRED|d.TYPES.BYTES],plaintext:[3,d.FLAGS.REQUIRED|d.TYPES.BYTES],metadata:[4,d.FLAGS.REQUIRED|d.TYPES.MESSAGE,a]};c.name="MinosEncryptAndSignMessageResult";c.internalSpec={ciphertext:[1,d.FLAGS.REQUIRED|d.TYPES.BYTES],signature:[2,d.FLAGS.REQUIRED|d.TYPES.BYTES]};e.name="MinosDecryptAndVerifyMessageInput";e.internalSpec={transportSigningPk:[1,d.FLAGS.REQUIRED|d.TYPES.BYTES],mek:[2,d.FLAGS.REQUIRED|d.TYPES.BYTES],encryptedMessageCiphertext:[3,d.FLAGS.REQUIRED|d.TYPES.BYTES],encryptedMessageSignature:[4,d.FLAGS.REQUIRED|d.TYPES.BYTES],metadata:[5,d.FLAGS.REQUIRED|d.TYPES.MESSAGE,a]};f.name="MinosDecryptAndVerifyMessageResult";f.internalSpec={plaintext:[1,d.FLAGS.REQUIRED|d.TYPES.BYTES]};h.name="MekBundle";h.internalSpec={key:[1,d.FLAGS.REQUIRED|d.TYPES.BYTES],mekId:[2,d.FLAGS.REQUIRED|d.TYPES.BYTES],rosterHash:[3,d.FLAGS.REQUIRED|d.TYPES.BYTES]};i.name="GenerateMekInput";i.internalSpec={epochHeads:[1,d.FLAGS.REPEATED|d.TYPES.BYTES]};j.name="GenerateMekResult";j.internalSpec={mek:[1,d.FLAGS.REQUIRED|d.TYPES.MESSAGE,h]};k.name="GenerateMekRosterHashInput";k.internalSpec={epochHeads:[1,d.FLAGS.REPEATED|d.TYPES.BYTES]};l.name="GenerateMekRosterHashResult";l.internalSpec={rosterHash:[1,d.FLAGS.REQUIRED|d.TYPES.BYTES]};m.name="EncryptMekForDistributionInput";m.internalSpec={senderEpochHead:[1,d.FLAGS.REQUIRED|d.TYPES.BYTES],toMailboxPk:[2,d.FLAGS.REQUIRED|d.TYPES.BYTES],fromKeypair:[3,d.FLAGS.REQUIRED|d.TYPES.MESSAGE,n],mek:[4,d.FLAGS.REQUIRED|d.TYPES.MESSAGE,h]};n.name="EncryptMekForDistributionInput$MailboxAuthKP";n.internalSpec={sk:[1,d.FLAGS.REQUIRED|d.TYPES.BYTES],pk:[2,d.FLAGS.REQUIRED|d.TYPES.BYTES]};o.name="EncryptMekForDistributionResult";o.internalSpec={ciphertext:[1,d.FLAGS.REQUIRED|d.TYPES.BYTES]};p.name="DecryptMekForDistributionInput";p.internalSpec={toMailboxSk:[1,d.FLAGS.REQUIRED|d.TYPES.BYTES],fromPk:[2,d.FLAGS.REQUIRED|d.TYPES.BYTES],mekId:[3,d.FLAGS.REQUIRED|d.TYPES.BYTES],senderEpochHead:[4,d.FLAGS.REQUIRED|d.TYPES.BYTES],rosterHash:[5,d.FLAGS.REQUIRED|d.TYPES.BYTES],ciphertext:[6,d.FLAGS.REQUIRED|d.TYPES.BYTES]};q.name="DecryptMekForDistributionResult";q.internalSpec={mek:[1,d.FLAGS.REQUIRED|d.TYPES.BYTES]};r.name="EncryptMeksForDistributionFromTransportSenderInput";r.internalSpec={mek:[1,d.FLAGS.REQUIRED|d.TYPES.MESSAGE,h],transportSigningKp:[2,d.FLAGS.REQUIRED|d.TYPES.MESSAGE,s],recipientMailboxEncryptionPks:[3,d.FLAGS.REPEATED|d.TYPES.BYTES],recipientEpochHeads:[4,d.FLAGS.REPEATED|d.TYPES.BYTES]};s.name="EncryptMeksForDistributionFromTransportSenderInput$TransportSigningKP";s.internalSpec={sk:[1,d.FLAGS.REQUIRED|d.TYPES.BYTES],pk:[2,d.FLAGS.REQUIRED|d.TYPES.BYTES]};t.name="EncryptMeksForDistributionFromTransportSenderResult";t.internalSpec={encryptedMeks:[1,d.FLAGS.REPEATED|d.TYPES.BYTES],ephemeralEncryptionPk:[2,d.FLAGS.REQUIRED|d.TYPES.BYTES],signingPk:[3,d.FLAGS.REQUIRED|d.TYPES.BYTES],signature:[4,d.FLAGS.REQUIRED|d.TYPES.BYTES]};u.name="DecryptMekForDistributionFromTransportSenderInput";u.internalSpec={mekDistribution:[1,d.FLAGS.REQUIRED|d.TYPES.MESSAGE,v],mekId:[2,d.FLAGS.REQUIRED|d.TYPES.BYTES],rosterHash:[3,d.FLAGS.REQUIRED|d.TYPES.BYTES],recipientEncSk:[4,d.FLAGS.REQUIRED|d.TYPES.BYTES]};v.name="DecryptMekForDistributionFromTransportSenderInput$TransportSenderMEKDistributionSingleRecipient";v.internalSpec={encryptedMek:[1,d.FLAGS.REQUIRED|d.TYPES.BYTES],ephemeralEncryptionPk:[2,d.FLAGS.REQUIRED|d.TYPES.BYTES],signingPk:[3,d.FLAGS.REQUIRED|d.TYPES.BYTES],signature:[4,d.FLAGS.REQUIRED|d.TYPES.BYTES]};w.name="DecryptMekForDistributionFromTransportSenderResult";w.internalSpec={mek:[1,d.FLAGS.REQUIRED|d.TYPES.BYTES]};x.name="WrapTransportSigningPublicKeyInput";x.internalSpec={keyBytes:[1,d.FLAGS.REQUIRED|d.TYPES.BYTES]};y.name="WrapTransportSigningPublicKeyResult";y.internalSpec={prefixedKey:[1,d.FLAGS.REQUIRED|d.TYPES.BYTES]};z.name="WrapTransportSigningSecretKeyInput";z.internalSpec={keyBytes:[1,d.FLAGS.REQUIRED|d.TYPES.BYTES]};A.name="WrapTransportSigningSecretKeyResult";A.internalSpec={prefixedKey:[1,d.FLAGS.REQUIRED|d.TYPES.BYTES]};B.name="DeriveMailboxSigningKeypairInput";B.internalSpec={exportRootKey:[1,d.FLAGS.REQUIRED|d.TYPES.BYTES],epochNumber:[2,d.FLAGS.REQUIRED|d.TYPES.UINT64]};C.name="DeriveMailboxSigningKeypairResult";C.internalSpec={mailboxSigningPublicKey:[1,d.FLAGS.REQUIRED|d.TYPES.BYTES],mailboxSigningPrivateKey:[2,d.FLAGS.REQUIRED|d.TYPES.BYTES]};D.name="DeriveMailboxEncryptionKeypairInput";D.internalSpec={exportRootKey:[1,d.FLAGS.REQUIRED|d.TYPES.BYTES],epochNumber:[2,d.FLAGS.REQUIRED|d.TYPES.UINT64]};E.name="DeriveMailboxEncryptionKeypairResult";E.internalSpec={mailboxEncryptionPublicKey:[1,d.FLAGS.REQUIRED|d.TYPES.BYTES],mailboxEncryptionPrivateKey:[2,d.FLAGS.REQUIRED|d.TYPES.BYTES]};F.name="DeriveMailboxAuthKeypairInput";F.internalSpec={exportRootKey:[1,d.FLAGS.REQUIRED|d.TYPES.BYTES],epochNumber:[2,d.FLAGS.REQUIRED|d.TYPES.UINT64]};G.name="DeriveMailboxAuthKeypairResult";G.internalSpec={mailboxAuthPublicKey:[1,d.FLAGS.REQUIRED|d.TYPES.BYTES],mailboxAuthPrivateKey:[2,d.FLAGS.REQUIRED|d.TYPES.BYTES]};H.name="DeriveAttachmentAccessTokenSecretInput";H.internalSpec={mediaKey:[1,d.FLAGS.REQUIRED|d.TYPES.BYTES]};I.name="DeriveAttachmentAccessTokenSecretResult";I.internalSpec={attachmentAccessTokenSecret:[1,d.FLAGS.REQUIRED|d.TYPES.BYTES]};J.name="DeriveAttachmentPrimaryKeySecretInput";J.internalSpec={mediaKey:[1,d.FLAGS.REQUIRED|d.TYPES.BYTES]};K.name="DeriveAttachmentPrimaryKeySecretResult";K.internalSpec={attachmentPrimaryKeySecret:[1,d.FLAGS.REQUIRED|d.TYPES.BYTES]};L.name="EpochPublicData";L.internalSpec={epochNumber:[1,d.FLAGS.REQUIRED|d.TYPES.UINT64],userFbid:[2,d.FLAGS.REQUIRED|d.TYPES.STRING],mailboxSigningPk:[3,d.FLAGS.REQUIRED|d.TYPES.BYTES],mailboxEncryptionPk:[4,d.FLAGS.REQUIRED|d.TYPES.BYTES],mailboxAuthPk:[5,d.FLAGS.REQUIRED|d.TYPES.BYTES],previousEpochHead:[6,d.TYPES.BYTES]};M.name="EpochSignatures";M.internalSpec={selfSignature:[1,d.FLAGS.REQUIRED|d.TYPES.BYTES],prevSignature:[2,d.TYPES.BYTES]};N.name="MinosSignedEpoch";N.internalSpec={epochPublicData:[1,d.FLAGS.REQUIRED|d.TYPES.MESSAGE,L],signatures:[2,d.FLAGS.REQUIRED|d.TYPES.MESSAGE,M],epochHead:[3,d.FLAGS.REQUIRED|d.TYPES.BYTES]};O.name="MinosOpenInitialEpochInput";O.internalSpec={userFbid:[1,d.FLAGS.REQUIRED|d.TYPES.STRING],epochNumber:[2,d.FLAGS.REQUIRED|d.TYPES.UINT64],exportRootKey:[3,d.FLAGS.REQUIRED|d.TYPES.BYTES]};P.name="MinosOpenInitialEpochResult";P.internalSpec={minosSignedEpoch:[1,d.FLAGS.REQUIRED|d.TYPES.MESSAGE,N]};Q.name="MinosOpenEpochInput";Q.internalSpec={userFbid:[1,d.FLAGS.REQUIRED|d.TYPES.STRING],epochNumber:[2,d.FLAGS.REQUIRED|d.TYPES.UINT64],exportRootKey:[3,d.FLAGS.REQUIRED|d.TYPES.BYTES],previousExportRootKey:[4,d.FLAGS.REQUIRED|d.TYPES.BYTES],previousEpochNumber:[5,d.FLAGS.REQUIRED|d.TYPES.UINT64],previousEpochHead:[6,d.FLAGS.REQUIRED|d.TYPES.BYTES]};R.name="MinosOpenEpochResult";R.internalSpec={minosSignedEpoch:[1,d.FLAGS.REQUIRED|d.TYPES.MESSAGE,N]};S.name="MinosValidateEpochInput";S.internalSpec={epochPublicData:[1,d.FLAGS.REQUIRED|d.TYPES.MESSAGE,L],previousEpochPublicData:[2,d.FLAGS.REQUIRED|d.TYPES.MESSAGE,L],signatures:[3,d.FLAGS.REQUIRED|d.TYPES.MESSAGE,M]};T.name="MinosValidateEpochResult";T.internalSpec={valid:[1,d.TYPES.BOOL],errorMessage:[2,d.TYPES.STRING],__oneofs__:{result:["valid","errorMessage"]}};U.name="MinosVerifySingleEpochInput";U.internalSpec={epochPublicData:[1,d.FLAGS.REQUIRED|d.TYPES.MESSAGE,L],signature:[2,d.FLAGS.REQUIRED|d.TYPES.BYTES]};V.name="MinosVerifySingleEpochResult";V.internalSpec={valid:[1,d.FLAGS.REQUIRED|d.TYPES.BOOL]};g.MinosMessageMetadataSpec=a;g.MinosEncryptAndSignMessageInputSpec=b;g.MinosEncryptAndSignMessageResultSpec=c;g.MinosDecryptAndVerifyMessageInputSpec=e;g.MinosDecryptAndVerifyMessageResultSpec=f;g.MekBundleSpec=h;g.GenerateMekInputSpec=i;g.GenerateMekResultSpec=j;g.GenerateMekRosterHashInputSpec=k;g.GenerateMekRosterHashResultSpec=l;g.EncryptMekForDistributionInputSpec=m;g.EncryptMekForDistributionInput$MailboxAuthKPSpec=n;g.EncryptMekForDistributionResultSpec=o;g.DecryptMekForDistributionInputSpec=p;g.DecryptMekForDistributionResultSpec=q;g.EncryptMeksForDistributionFromTransportSenderInputSpec=r;g.EncryptMeksForDistributionFromTransportSenderInput$TransportSigningKPSpec=s;g.EncryptMeksForDistributionFromTransportSenderResultSpec=t;g.DecryptMekForDistributionFromTransportSenderInputSpec=u;g.DecryptMekForDistributionFromTransportSenderInput$TransportSenderMEKDistributionSingleRecipientSpec=v;g.DecryptMekForDistributionFromTransportSenderResultSpec=w;g.WrapTransportSigningPublicKeyInputSpec=x;g.WrapTransportSigningPublicKeyResultSpec=y;g.WrapTransportSigningSecretKeyInputSpec=z;g.WrapTransportSigningSecretKeyResultSpec=A;g.DeriveMailboxSigningKeypairInputSpec=B;g.DeriveMailboxSigningKeypairResultSpec=C;g.DeriveMailboxEncryptionKeypairInputSpec=D;g.DeriveMailboxEncryptionKeypairResultSpec=E;g.DeriveMailboxAuthKeypairInputSpec=F;g.DeriveMailboxAuthKeypairResultSpec=G;g.DeriveAttachmentAccessTokenSecretInputSpec=H;g.DeriveAttachmentAccessTokenSecretResultSpec=I;g.DeriveAttachmentPrimaryKeySecretInputSpec=J;g.DeriveAttachmentPrimaryKeySecretResultSpec=K;g.EpochPublicDataSpec=L;g.EpochSignaturesSpec=M;g.MinosSignedEpochSpec=N;g.MinosOpenInitialEpochInputSpec=O;g.MinosOpenInitialEpochResultSpec=P;g.MinosOpenEpochInputSpec=Q;g.MinosOpenEpochResultSpec=R;g.MinosValidateEpochInputSpec=S;g.MinosValidateEpochResultSpec=T;g.MinosVerifySingleEpochInputSpec=U;g.MinosVerifySingleEpochResultSpec=V}),98);
__d("EchoCommonUtils",[],(function(a,b,c,d,e,f){"use strict";c="Echo-Doc-Version";function a(a,b){var c=a.localKey;a=a.transportKey;return c+"@"+a+"-"+b}function b(a,b,c){return a==null?{localKey:b,transportKey:c}:{displayName:a,localKey:b,transportKey:c}}f.ECHO_COMMON_FIELD_DOCUMENT_VERSION=c;f.getEchoAddressFieldNameWithSuffix=a;f.craftEchoAddress=b}),66);
__d("EchoConstants",[],(function(a,b,c,d,e,f){"use strict";a=new Set(["\0","\x01","\x02","\x03","\x04","\x05","\x06","\x07","\b","\t","\n","\v","\f","\r","\x0e","\x0f","\x10","\x11","\x12","\x13","\x14","\x15","\x16","\x17","\x18","\x19","\x1a","\x1b","\x1c","\x1d","\x1e","\x1f",'"'," ","(",")",",",":",";","<",">","@","[","]","\\"]);f.ADDRESS_LOCAL_KEY_CHARS_NEED_QUOTE=a}),66);
__d("EchoDecodingUtils",["invariant","EchoConstants","WALogger"],(function(a,b,c,d,e,f,g,h){"use strict";function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] "," not a valid number in echo message"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Fail to decode if the input string does not have CRLF"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Address  decode failed with value: ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] invalid input to echoDecodeAddressList detected"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] invalid transportKey in address detected"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] invalid localKey in address detected"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] parse localKey in address failed"]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] echoDecodeAddress failed"]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] conditional quote mode decode failed"]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] invalid input to echoDecodeAddress"]);r=function(){return a};return a}function s(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Fail decoding because we didn't have a closing quote. Error Field: ",""]);s=function(){return a};return a}function t(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Field name is blank"]);t=function(){return a};return a}function u(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] This is a raw line and we cannot decode its field name and value."]);u=function(){return a};return a}var v=new Set([]);function w(a,b){if(a.length===0)return;var c=a.indexOf(":");if(c===-1){d("WALogger").ERROR(u());return}var e=a.substring(0,c).trim();a=a.substring(c+1).trim();if(e.length===0){d("WALogger").ERROR(t());return}if(a.length===0){b.has(e)&&b["delete"](e);return}b.set(e,a)}function x(a,b,c,e){c===void 0&&(c=new Set());var f=!1,g=b==="conditional"&&a[0]==='"',h="",i=g?1:0;while(i<a.length){var j=a[i];if(b==="conditional"&&!g&&j==='"')break;if(!g&&c.has(j))break;if(g&&!f&&j==='"'){g=!1;i++;break}if(g&&!f&&j==="\\"){if(i===a.length-1)break;f=!0}else f&&j==="r"?h+="\r":f&&j==="n"?h+="\n":h+=j,f=!1;i++}if(g||h.length===0){c=(j=e)!=null?j:"unknown";d("WALogger").ERROR(s(),c);return{remainder:a,result:null,success:!1}}return{remainder:a.substring(i),result:h,success:!0}}function y(a,b){if(a.length===0){d("WALogger").ERROR(r());return{remainder:a,result:null,success:!1}}var c=a.trimLeft();c=x(c,"conditional",d("EchoConstants").ADDRESS_LOCAL_KEY_CHARS_NEED_QUOTE,b);if(!c.success){d("WALogger").ERROR(q());return{remainder:a,result:null,success:!1}}c.result!=null||h(0,47923);if(c.remainder[0]==="@"){var e=z(c.remainder,c.result,b);return{remainder:e.remainder,result:e.result,success:e.success}}e=c.result;c=c.remainder.trimLeft();if(c.startsWith("<")){c=z(c.substring(1),void 0,b);b=c.result;var f=c.remainder;if(c.success&&b!=null&&f.startsWith(">"))if(e.length===0)return{remainder:f.substring(1),result:b,success:!0};else return{remainder:f.substring(1),result:babelHelpers["extends"]({},b,{displayName:e}),success:!0}}d("WALogger").ERROR(p());return{remainder:a,result:null,success:!1}}function z(a,b,c){var e=b==null?a.trimLeft():a;b=b;if(b==null){var f=x(e,"conditional",d("EchoConstants").ADDRESS_LOCAL_KEY_CHARS_NEED_QUOTE,c);if(!f.success){d("WALogger").ERROR(o());return{remainder:a,result:null,success:!1}}b=f.result;e=f.remainder}if(b==null||b.length===0||e[0]!=="@"){d("WALogger").ERROR(n());return{remainder:a,result:null,success:!1}}f=x(e.substring(1),"never",d("EchoConstants").ADDRESS_LOCAL_KEY_CHARS_NEED_QUOTE,c);e=f.result;if(f.success&&e!=null&&e.length>0)return{remainder:f.remainder,result:{localKey:b,transportKey:e},success:!0};else{d("WALogger").ERROR(m());return{remainder:a,result:null,success:!1}}}function A(a,b){if(a.length===0){d("WALogger").ERROR(l());return{result:null,success:!1}}var c=y(a,b);if(!c.success){d("WALogger").ERROR(k(),a);return{result:null,success:!1}}c.result!=null||h(0,47927);a=[c.result];c=c.remainder;while(c.startsWith(",")){var e=y(c.substring(1).trimLeft(),b);if(e.success)e.result!=null&&a.push(e.result),c=e.remainder;else break}return{result:a,success:!0}}function a(a){var b=new Map(),c=a.split("\r\n");if(c.length===1&&c[0]===a){d("WALogger").ERROR(j());return b}c.forEach(function(a){return w(a,b)});return b}function b(a,b){a=a.get(b);if(a==null||a.length===0||a==='""')return{result:null,success:!1};a=x(a,"conditional",v,b);b=a.result;a=a.success;return{result:b,success:a}}function c(a,b){a=B(a,b);return{result:(b=a.result)!=null?b:0,success:a.success}}function B(a,b){a=a.get(b);if(a==null||a.length===0)return{result:null,success:!1};a=parseInt(a,10);if(isNaN(a)){d("WALogger").ERROR(i(),b);return{result:null,success:!1}}else return Number.isSafeInteger(a)?{result:a,success:!0}:{result:a>Number.MAX_SAFE_INTEGER?Number.MAX_SAFE_INTEGER:Number.MIN_SAFE_INTEGER,success:!0}}function e(a,b){a=C(a,b);return{result:(b=a.result)!=null?b:!1,success:a.success}}function C(a,b){a=B(a,b);return!a.success||a.result!==0&&a.result!==1?{result:null,success:!1}:{result:a.result===1,success:!0}}function f(a,b){a=a.get(b);if(a==null||a.length===0)return{result:null,success:!1};a=y(a,b);b=a.result;a=a.success;return{result:b,success:a}}function D(a,b){a=a.get(b);return a==null||a.length===0?{result:null,success:!1}:A(a,b)}function E(a,b){a=a.get(b);if(a==null||a.length===0)return{result:null,success:!1};b=a.split(",").map(function(a){return a.trim()}).filter(Boolean);return b.length===0?{result:null,success:!1}:{result:b,success:!0}}g.echoDecodeFields=a;g.echoDecodeStringField=b;g.echoDecodeIntField=c;g.echoDecodeNullableIntField=B;g.echoDecodeBooleanField=e;g.echoDecodeNullableBooleanField=C;g.echoDecodeAddressField=f;g.echoDecodeAddressListField=D;g.echoDecodeObjectIdListField=E}),98);
__d("EchoEncodingUtils",["EchoConstants","EchoMessage","FBLogger","MAWMsgType","WABase64"],(function(a,b,c,d,e,f,g){"use strict";var h=new Set(['"',"\\","\n","\r","\0"]),i=new Set(["\0","\x01","\x02","\x03","\x04","\x05","\x06","\x07","\b","\t","\n","\v","\f","\r","\x0e","\x0f","\x10","\x11","\x12","\x13","\x14","\x15","\x16","\x17","\x18","\x19","\x1a","\x1b","\x1c","\x1d","\x1e","\x1f",'"',"\\"]);function j(a,b){for(b of b)if(a.indexOf(b)>=0)return!0;return!1}function k(a,b,d){d===void 0&&(d=new Set());if(a.length<=0)throw c("FBLogger")("wmi_eb").mustfixThrow("The input string must be non-empty");var e=b;b==="conditional"&&(j(a,d)?e="always":e="never");if(e==="never")return a;b='"';for(d=0;d<a.length;d++){e=a[d];h.has(e)?(b+="\\",e==="\r"?b+="r":e==="\n"?b+="n":b+=e):b+=e}return b+'"'}function l(a){if(!Number.isSafeInteger(a))throw c("FBLogger")("wmi_eb").mustfixThrow("The input value must be a safe integer");return a.toString()}function m(a){var b="",c=a.displayName,e=a.localKey;a=a.transportKey;c!=null&&c.length>0&&(b+=k(c,"always")+" <");b+=k(e,"conditional",d("EchoConstants").ADDRESS_LOCAL_KEY_CHARS_NEED_QUOTE)+"@"+a;c!=null&&c.length>0&&(b+=">");return b}function n(a,b,c){c!=null&&c.length!==0&&a.set(b,k(c,"conditional",i))}function a(a,b,c){if(c!=null){c=l(c);n(a,b,c)}}function b(a,b,c){if(c!=null){c=l(c?1:0);n(a,b,c)}}function e(a,b,c){c!=null&&a.set(b,m(c))}function f(a,b,c){if(c!=null){var d="";c.forEach(function(a,b){d+=m(a),b<c.length-1&&(d+=", ")});a.set(b,d)}}function o(a){var b="";a.forEach(function(a,c){b=b+c+": "+a+"\r\n"});return b}function p(a){return d("WABase64").encodeB64UrlSafe(a)}function q(a){switch(a){case d("MAWMsgType").MSG_TYPE.TEXT:return d("EchoMessage").EchoXMessageContentType.TEXT;case d("MAWMsgType").MSG_TYPE.IMAGE:return d("EchoMessage").EchoXMessageContentType.IMAGE;case d("MAWMsgType").MSG_TYPE.VIDEO:return d("EchoMessage").EchoXMessageContentType.VIDEO;case d("MAWMsgType").MSG_TYPE.PTT:return d("EchoMessage").EchoXMessageContentType.AUDIO;case d("MAWMsgType").MSG_TYPE.STICKER:return d("EchoMessage").EchoXMessageContentType.STICKER;case d("MAWMsgType").MSG_TYPE.GIF:return d("EchoMessage").EchoXMessageContentType.GIF;case d("MAWMsgType").MSG_TYPE.XMA:return d("EchoMessage").EchoXMessageContentType.XMA;case d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return d("EchoMessage").EchoXMessageContentType.DOCUMENT;case d("MAWMsgType").MSG_TYPE.REACTION:return d("EchoMessage").EchoXMessageContentType.REACTION;case d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN:return d("EchoMessage").EchoXMessageContentType.EPHEMERAL_SETTINGS;case d("MAWMsgType").MSG_TYPE.EPHEMERAL_SYNC_RESPONSE:return d("EchoMessage").EchoXMessageContentType.EPHEMERAL_SYNC_RESPONSE;case d("MAWMsgType").MSG_TYPE.DELETE_FOR_ME:return d("EchoMessage").EchoXMessageContentType.MESSAGE_DELETE_FOR_ME;case d("MAWMsgType").MSG_TYPE.REVOKED:return d("EchoMessage").EchoXMessageContentType.UNSEND;case d("MAWMsgType").MSG_TYPE.GROUP_INVITE:return d("EchoMessage").EchoXMessageContentType.GROUP_INVITES;case d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:return d("EchoMessage").EchoXMessageContentType.BUMP;default:return d("EchoMessage").EchoXMessageContentType.UNKNOWN}}g.echoSetStringField=n;g.echoSetIntField=a;g.echoSetBooleanField=b;g.echoSetAddressField=e;g.echoSetAddressListField=f;g.echoEncodeFields=o;g.convertMediaKeyToString=p;g.convertDbMsgTypeToXMessageContentType=q}),98);
__d("EchoMessage",["$InternalEnum","EchoCommonUtils","EchoDecodingUtils","EchoEncodingUtils","EchoMessageMediaFieldUtils","EchoMessageMediaGroupFieldUtil","EchoMessageQuoteFieldUtils","EchoMessageReceiptStatusFieldUtils","EchoMessageXMAFieldUtils","FBLogger","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] mandatory xma data is missing from xma message, msgId: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose([""," Message origin: ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose([""," Message origin: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose([""," Message origin: ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose([""," Message origin: ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to decode media data for Receiver Fetch, Message origin: ",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] fieldsMap is empty for the echo message"]);n=function(){return a};return a}var o="Message-ID",p="Thread-ID",q="Sort-Order",r="Display-Timestamp",s="Authoritative-Timestamp",t="From",u="Text",v="Text-Size",w="Send-Error",x="Is-Tombstoned",y="Expire-Timestamp",z="Delete-Timestamp",A="Ephemeral-Duration",B="Message-Content-Type",C="X-Message-Content-Type",D="Message-Content-Subtype",E="Is-Forwarded",F="X-Offline-Threading-ID",G="X-Thread-ID",H="X-Message-Placeholder-Type",I="Reactions",J="Reaction-Authoritative-Timestamps",K="X-Reaction-Offline-Threading-IDs",L="Echo-Serialization-Origin",M="Revoke-Sent-Timestamp",N="Revoke-Unsent-Timestamp",O="Edit-Count",P="Edit-Contents-",Q="Edit-Timestamps-";f="Group-ID";var R="Group-Index",S="Group-Size",T="Receiver-Fetch-Id",U="Message-Ephemerality-Type",V=1,W=(b=b("$InternalEnum"))({NONE:"none",SMALL:"small",MEDIUM:"medium",LARGE:"large"}),X=b({NONE:"none",UNSEND:"unsend"}),Y=b({DECRYPTION_FAILURE:"decryption_failure",UNSUPPORTED_NEEDS_UPDATE:"unsupported_needs_update",TEXT:"text",ADMIN_MESSAGE:"admin_message",MEDIA:"media",XMA:"xma",NULL_STATE:"null_state",PLACEHOLDER:"placeholder"}),aa=b({UNKNOWN:"unknown",TEXT:"text",IMAGE:"image",VIDEO:"video",AUDIO:"audio",STICKER:"sticker",GIF:"gif",URL:"url",EPHEMERAL_SETTINGS:"ephemeral_settings",LOCATION:"location",DOCUMENT:"document",UNSEND:"unsend",SCREENSHOT_ACTION:"screenshot_action",REACTION:"reaction",XMA:"xma",VISUAL_MESSAGE_VIDEO:"visual_message_video",VISUAL_MESSAGE_IMAGE:"visual_message_image",VISUAL_MESSAGE_ACTION:"visual_message_action",SCREEN_RECORDING_ACTION:"screen_recording_action",MESSAGE_DELETE_FOR_ME:"message_delete_for_me",ENCRYPTED_BACKUP_NEW_DEVICE_ENROLLMENT:"encrypted_backup_new_device_enrollment",SENDER_KEY:"sender_key",DELETE_THREAD:"delete_thread",READ_THREAD:"read_thread",UNREAD_THREAD:"unread_thread",REACTION_UNSEND:"reaction_unsend",GROUP_INVITES:"group_invites",EPHEMERAL_SYNC_RESPONSE:"ephemeral_sync_response",BUMP:"bump"}),Z=b({NO_PLACEHOLDER:"0",DECRYPTION_FAILURE:"-1",CLIENT_NOT_SUPPORTED_NEED_UPDATE:"-2",UNAVIALABLE_DEVICE:"-3"}),$=b({UNKNOWN:"Unknown",WEB:"Web",MOBILE:"Mobile"});function a(a){var b=new Map();ia(b,a);"mediaData"in a&&a.mediaData&&d("EchoMessageMediaFieldUtils").echoMessageSetMediaMetadataFields(b,a.mediaData);return d("EchoEncodingUtils").echoEncodeFields(b)}function ba(a,b){var c,e=[],f=new Set();b.forEach(function(c,g,h){c=g.startsWith(P);h=g.startsWith(Q);if(c||h){h=g.slice(c?P.length:Q.length);if(!f.has(h)){f.add(h);c=(g=d("EchoDecodingUtils").echoDecodeStringField(b,""+P+h).result)!=null?g:"";g=((g=d("EchoDecodingUtils").echoDecodeIntField(b,""+Q+h).result)!=null?g:0)/1e3;e.push({messageId:h,originalMessageId:a,text:c,timestamp:g})}}});c=(c=d("EchoDecodingUtils").echoDecodeIntField(b,O).result)!=null?c:0;return{editCount:c,editHistory:e}}function e(a){a=d("EchoDecodingUtils").echoDecodeFields(a);if(a.size===0){d("WALogger").ERROR(n());return null}var b=d("EchoDecodingUtils").echoDecodeStringField(a,o),e=d("EchoDecodingUtils").echoDecodeStringField(a,p),f=d("EchoDecodingUtils").echoDecodeIntField(a,q),g=d("EchoDecodingUtils").echoDecodeIntField(a,r),O=d("EchoDecodingUtils").echoDecodeStringField(a,B),P=d("EchoDecodingUtils").echoDecodeStringField(a,C),Q=d("EchoDecodingUtils").echoDecodeStringField(a,D);if(b.success&&e.success&&f.success){b=b.result;if(b==null)throw c("FBLogger")("messenger_web").mustfixThrow("The decoded messageId cannot be null");e=e.result;if(e==null)throw c("FBLogger")("messenger_web").mustfixThrow("The decoded threadId cannot be null");O=O==null?void 0:O.result;if(O==null)throw c("FBLogger")("messenger_web").mustfixThrow("The decoded contentTypeString cannot be null");var R=ba(b,a),S=R.editCount;R=R.editHistory;Q={contentSubtype:fa(Q.result),contentType:da(O),displayTimestampMs:g.success?g.result:f.result,editCount:S,editHistory:R,messageId:b,sortOrderMs:f.result,threadId:e};O=ea(P.result);O!=null&&(Q.xContentType=O);g=d("EchoDecodingUtils").echoDecodeAddressField(a,t);g.success&&g.result!=null&&(Q.from=g.result);S=d("EchoDecodingUtils").echoDecodeNullableBooleanField(a,x);S.success&&S.result!=null&&(Q.isTombstoned=S.result);R=d("EchoDecodingUtils").echoDecodeStringField(a,u);R.success&&R.result!=null&&(Q.text=R.result);b=d("EchoDecodingUtils").echoDecodeStringField(a,v);if(b.success&&b.result!=null){f=ca(b.result);Q.textSize=f}e=d("EchoDecodingUtils").echoDecodeStringField(a,H);if(e.success&&e.result!=null){P=ga(e.result);Q.xMessagePlaceholderType=P}O=d("EchoDecodingUtils").echoDecodeStringField(a,w);O.success&&O.result!=null&&(Q.sendError=O.result);g=d("EchoDecodingUtils").echoDecodeNullableIntField(a,y);g.success&&g.result!=null&&(Q.expireTimestampMs=g.result);S=d("EchoDecodingUtils").echoDecodeNullableIntField(a,z);S.success&&S.result!=null&&(Q.deleteTimestampMs=S.result);R=d("EchoDecodingUtils").echoDecodeNullableIntField(a,A);R.success&&R.result!=null&&(Q.ephemeralDurationInSec=R.result);b=d("EchoDecodingUtils").echoDecodeStringField(a,U);b.success&&b.result!=null&&(b.result==="view_once"&&(Q.viewOnce=!0));f=d("EchoDecodingUtils").echoDecodeNullableIntField(a,s);f.success&&f.result!=null&&(Q.authoritativeTimestampMs=f.result);e=d("EchoMessageReceiptStatusFieldUtils").echoMessageDecodeReceiptStatusDataFields(a);e.length>0&&(Q.receiptStatusList=e);P=d("EchoDecodingUtils").echoDecodeNullableBooleanField(a,E);P.success&&P.result!=null&&(Q.isForwarded=P.result);d("EchoMessageMediaGroupFieldUtil").decodeMessageMediaGroupFields(a,Q);O=d("EchoDecodingUtils").echoDecodeStringField(a,F);O.success&&O.result!=null&&(Q.xOfflineThreadingId=O.result);g=d("EchoDecodingUtils").echoDecodeStringField(a,G);g.success&&g.result!=null&&(Q.xThreadId=g.result);S=d("EchoDecodingUtils").echoDecodeStringField(a,L);S.success&&S.result!=null&&(Q.serializationOrigin=ha(S.result));R=d("EchoDecodingUtils").echoDecodeNullableIntField(a,d("EchoCommonUtils").ECHO_COMMON_FIELD_DOCUMENT_VERSION);Q.version=R.success&&R.result!=null?R.result:V;b=d("EchoDecodingUtils").echoDecodeAddressListField(a,I);b.success&&b.result!=null&&(Q.reactions=b.result);f=d("EchoDecodingUtils").echoDecodeAddressListField(a,J);f.success&&f.result!=null&&(Q.reactionAuthoritativeTimestampMs=f.result);e=d("EchoDecodingUtils").echoDecodeAddressListField(a,K);e.success&&e.result!=null&&(Q.reactionXOfflineThreadingIds=e.result);P=d("EchoMessageQuoteFieldUtils").echoMessageDecodeQuoteFields(a);P!=null&&(Q.quoteData=P);O=(Q==null?void 0:Q.contentType)===Y.XMA&&a.has(d("EchoMessageMediaFieldUtils").ECHO_MESSAGE_FIELD_NAME_ATTACHMENT_TYPE)&&(a.has(d("EchoMessageMediaFieldUtils").ECHO_MESSAGE_FIELD_NAME_ATTACHMENT_OBJECT_ID)||a.has(d("EchoMessageMediaFieldUtils").ECHO_MESSAGE_FIELD_NAME_ATTACHMENT_OBJECT_IDS));g=a.has(T);if(a.has(T)){S=d("EchoMessageMediaFieldUtils").decodeReceiverFetchData(a);R=d("EchoDecodingUtils").echoDecodeStringField(a,T);b=R.result;f=R.success;S==null||!f||b==null?d("WALogger").ERROR(m(),Q.serializationOrigin):(Q.receiverFetchData=S,Q.receiverFetchId=b)}if(((Q==null?void 0:Q.contentType)===Y.MEDIA||O)&&!g){e=d("EchoMessageMediaFieldUtils").echoMessageDecodeMediaDataFields(a,Q==null?void 0:Q.contentType,Q==null?void 0:Q.xContentType);P="[labyrinth_web] mandatory media data is missing from media message, msgId: "+Q.messageId+".";e!=null?(e.length!==1&&e.length!==2&&((Q==null?void 0:Q.contentType)===Y.MEDIA&&d("WALogger").ERROR(l(),P,Q.serializationOrigin),(Q==null?void 0:Q.contentType)===Y.XMA&&d("WALogger").WARN(k(),P,Q.serializationOrigin)),Q.mediaData=e[0],e.length===2&&(Q.previewMediaData=e[1])):((Q==null?void 0:Q.contentType)===Y.MEDIA&&d("WALogger").ERROR(j(),P,Q.serializationOrigin),(Q==null?void 0:Q.contentType)===Y.XMA&&d("WALogger").WARN(i(),P,Q.serializationOrigin))}if(Q.contentType===Y.PLACEHOLDER&&Q.contentSubtype===X.UNSEND){R=d("EchoDecodingUtils").echoDecodeNullableIntField(a,M);R.success&&R.result!=null&&(Q.revokeSentTimestampMs=R.result);f=d("EchoDecodingUtils").echoDecodeNullableIntField(a,N);f.success&&f.result!=null&&(Q.revokeUnsentTimestampMS=f.result)}if(Q.contentType===Y.XMA){S=d("EchoMessageXMAFieldUtils").decodeXMAFields(a);if(S!=null)Q.xmaData=S;else{d("WALogger").ERROR(h(),Q.messageId);return null}}return Q}else return null}function ca(a){return(a=W.cast(a))!=null?a:W.NONE}function da(a){return(a=Y.cast(a))!=null?a:Y.TEXT}function ea(a){return aa.cast(a)}function fa(a){return(a=X.cast(a))!=null?a:X.NONE}function ga(a){return(a=Z.cast(a))!=null?a:Z.NO_PLACEHOLDER}function ha(a){return(a=$.cast(a))!=null?a:$.UNKNOWN}function ia(a,b){var c;(c=d("EchoEncodingUtils")).echoSetStringField(a,o,b.messageId);c.echoSetStringField(a,p,b.threadId);c.echoSetIntField(a,q,b.sortOrderMs);c.echoSetIntField(a,r,b.displayTimestampMs);c.echoSetIntField(a,s,b.authoritativeTimestampMs);c.echoSetAddressField(a,t,b.from);c.echoSetStringField(a,u,b.text);b.textSize!=null&&d("EchoEncodingUtils").echoSetStringField(a,v,b.textSize);b.xMessagePlaceholderType!=null&&d("EchoEncodingUtils").echoSetStringField(a,H,b.xMessagePlaceholderType);d("EchoEncodingUtils").echoSetStringField(a,w,b.sendError);d("EchoEncodingUtils").echoSetBooleanField(a,x,b.isTombstoned);d("EchoEncodingUtils").echoSetIntField(a,y,b.expireTimestampMs);d("EchoEncodingUtils").echoSetIntField(a,z,b.deleteTimestampMs);d("EchoEncodingUtils").echoSetIntField(a,A,b.ephemeralDurationInSec);b.contentType!=null&&d("EchoEncodingUtils").echoSetStringField(a,B,b.contentType);b.xContentType!=null&&d("EchoEncodingUtils").echoSetStringField(a,C,b.xContentType);d("EchoMessageReceiptStatusFieldUtils").echoMessageSetReceiptStatusDataFields(a,b.receiptStatusList);d("EchoEncodingUtils").echoSetBooleanField(a,E,b.isForwarded);d("EchoEncodingUtils").echoSetStringField(a,F,b.xOfflineThreadingId);d("EchoEncodingUtils").echoSetStringField(a,G,b.xThreadId);d("EchoEncodingUtils").echoSetIntField(a,d("EchoCommonUtils").ECHO_COMMON_FIELD_DOCUMENT_VERSION,b.version);b.contentSubtype!=null&&d("EchoEncodingUtils").echoSetStringField(a,D,b.contentSubtype);d("EchoEncodingUtils").echoSetAddressListField(a,I,b.reactions);d("EchoEncodingUtils").echoSetAddressListField(a,J,b.reactionAuthoritativeTimestampMs);d("EchoEncodingUtils").echoSetAddressListField(a,K,b.reactionXOfflineThreadingIds);d("EchoMessageQuoteFieldUtils").echoMessageSetQuoteFields(a,b);b.serializationOrigin!=null&&d("EchoEncodingUtils").echoSetStringField(a,L,b.serializationOrigin);b.revokeSentTimestampMs!=null&&d("EchoEncodingUtils").echoSetIntField(a,M,b.revokeSentTimestampMs);b.revokeUnsentTimestampMS!=null&&d("EchoEncodingUtils").echoSetIntField(a,N,b.revokeUnsentTimestampMS);d("EchoMessageMediaGroupFieldUtil").echoMessageSetMediaGroupFields(a,b);c=b.xmaData;c!=null&&d("EchoMessageXMAFieldUtils").echoMessageSetXMAFields(a,c);((c=b.editHistory)==null?void 0:c.length)>0&&(d("EchoEncodingUtils").echoSetIntField(a,O,b.editCount),b.editHistory.forEach(function(b){var c=b.messageId;c!=null&&(d("EchoEncodingUtils").echoSetStringField(a,P+c,b.text),d("EchoEncodingUtils").echoSetIntField(a,Q+c,b.timestamp*1e3))}));b.receiverFetchId!=null&&d("EchoEncodingUtils").echoSetStringField(a,T,b.receiverFetchId)}g.ECHO_SERIALIZATION_ORIGIN=L;g.ECHO_MESSAGE_FIELD_NAME_EDIT_COUNT=O;g.ECHO_MESSAGE_FIELD_NAME_EDIT_CONTENT_PREFIX=P;g.ECHO_MESSAGE_FIELD_NAME_EDIT_TS_PREFIX=Q;g.ECHO_MESSAGE_FIELD_GROUP_ID=f;g.ECHO_MESSAGE_FIELD_GROUP_INDEX=R;g.ECHO_MESSAGE_FIELD_GROUP_SIZE=S;g.ECHO_MESSAGE_FIELD_RECEIVER_FETCH_ID=T;g.ECHO_MESSAGE_FIELD_NAME_EPHEMERALITY_TYPE=U;g.ECHO_MESSAGE_MIGRATION_DOCUMENT_VERSION=V;g.MessageTextSize=W;g.EchoMessageContentSubtype=X;g.EchoMessageContentType=Y;g.EchoXMessageContentType=aa;g.EchoMessagePlaceholderType=Z;g.EchoSerializationOriginType=$;g.encodeEchoMessage=a;g.decodeEchoMessage=e}),98);
__d("EchoMessageMediaFieldUtils",["$InternalEnum","EchoDecodingUtils","EchoEncodingUtils","EchoMessage","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing media fields for receiver fetch"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Invalid media attachment type: ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] multi blob media message: can not parse objects ids. "," msgType: "," mediaType: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing enum fields from media fields: attachmentType: "," mediaPreviewContentType: "," mediaAttachmentType: "," EchoOrigin: "," xOfflineThreadingId: ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing "," from media fields. AttachmentType: "," EchoOrigin: "," xOfflineThreadingId: ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing "," from media fields. AttachmentType: "," EchoOrigin: ",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing "," from media fields. xAttachmentType: ",", AttachmentType: ",". EchoOrigin: "," xOfflineThreadingId: ",""]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Unable to get primary and secondary attachment object ids"]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] multi blob media message: primary attachment object id is null. msgType: "," mediaType: ",""]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing xAttachmentType field from required media metadata fields, msgId: ",""]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing xContentType field from required media metadata fields, msgId: ",""]);r=function(){return a};return a}function s(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing plaintextHash field from required media metadata fields, msgId: ",""]);s=function(){return a};return a}function t(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing direct path field from required media metadata fields, msgId: ",""]);t=function(){return a};return a}function u(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing attachment type from required media metadata fields, msgId: ",""]);u=function(){return a};return a}function v(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing attachment object id from required media metadata fields, msgId: ",""]);v=function(){return a};return a}var w="X-Object-Id",x="X-Attachment-Object-Ids",y="Attachment-Type",z="Content-Type",A="X-Encrypted-Hash",B="X-Attachment-Type",C="X-Backup-Ent-Fbid",D="X-Backup-Status",E="X-Content-Type",F="X-Direct-Path",G="Height",H="X-Media-Key",I="X-Media-Key-Timestamp",J="Playable-Duration",K="Preview-Height",L="Preview-Content-Type",M="Preview-Width",N="Size",O="Width",P="X-Plaintext-Hash",Q="File-Name",R="Header-Attribution-Content-Type",S=(f=b("$InternalEnum"))({IMAGE:"image",STICKER:"sticker",VIDEO:"video",GIF:"animated_image",PTT:"audio",XMA:"xma",DOCUMENT:"document"}),T=f({IMAGE_JPEG:"image/jpeg",IMAGE_PNG:"image/png",STICKER:"image/webp",GIF:"image/gif",AUDIO_MP4:"audio/mp4",AUDIO_WAV:"audio/wav",XMA:"xma"}),U=f({INVALID:"-1",IMAGE:"0",PTT:"1",AUDIO:"2",DOCUMENT:"3",VIDEO:"4",GIF:"5",STICKER:"6",PROFILE_PICTURE:"7",APP_STATE:"8",HISTORY_SYNC:"9",THUMBNAIL_IMAGE:"10",THUMBNAIL_VIDEO:"11",THUMBNAIL_GIF:"12",THUMBNAIL_DOCUMENT:"13",THUMBNAIL_LINK:"14",NOVI_IMAGE:"15",NOVI_VIDEO:"16",KYCID:"17",WAFFLE_IMAGE:"18",WAFFLE_VIDEO:"19",WAFFLE_GIF:"20",PAYMENT_BG_IMAGE:"21",XMA_IMAGE:"22",PAYMENT_BR_DOCUMENT:"23",BIZ_COVER_PHOTO:"24",MESSENGER_PREVIEW:"25"}),V=f({FULL:"full",PREVIEW:"preview"});function W(a,b){var c=a.attachmentObjectId,e=a.attachmentType,f=a.backupEntFbid,g=a.directPath,h=a.filename,i=a.encryptedHash,j=a.height,k=a.mediaBackupStatus,l=a.mediaContentType,m=a.mediaKey,n=a.mediaKeyTimestamp,o=a.mediaPlayableDuration,p=a.plaintextHash,w=a.previewContentHeight,x=a.previewContentType,y=a.previewContentWidth,z=a.size,A=a.width,B=a.xAttachmentType,C=a.xContentType,D=a.xmaData;a=a.mediaEntryData;if(c==null)d("WALogger").ERROR(v(),b);else if(e==null)d("WALogger").ERROR(u(),b);else if(g==null)d("WALogger").ERROR(t(),b);else if(p==null)d("WALogger").ERROR(s(),b);else if(C==null)d("WALogger").ERROR(r(),b);else if(B==null)d("WALogger").ERROR(q(),b);else return{attachmentObjectId:c,attachmentType:e,backupEntFbid:f,directPath:g,encryptedHash:i,filename:h,height:j,mediaBackupStatus:k,mediaContentType:l,mediaEntryData:a,mediaKey:m,mediaKeyTimestamp:n,mediaPlayableDuration:o,plaintextHash:p,previewContentHeight:w,previewContentType:x,previewContentWidth:y,size:z,width:A,xAttachmentType:B,xContentType:C,xmaData:D}}function a(a,b){var c;(c=d("EchoEncodingUtils")).echoSetStringField(a,w,b.attachmentObjectId);c.echoSetStringField(a,y,b.attachmentType);c.echoSetStringField(a,P,b.plaintextHash);c.echoSetStringField(a,A,b.encryptedHash);c.echoSetIntField(a,N,b.size);c.echoSetStringField(a,H,b.mediaKey);c.echoSetIntField(a,I,b.mediaKeyTimestamp);c.echoSetStringField(a,F,b.directPath);b.mediaContentType!=null&&d("EchoEncodingUtils").echoSetStringField(a,z,b.mediaContentType);d("EchoEncodingUtils").echoSetIntField(a,O,b.width);d("EchoEncodingUtils").echoSetIntField(a,G,b.height);b.previewContentType!=null&&d("EchoEncodingUtils").echoSetStringField(a,L,b.previewContentType);b.headerAttributionContentType!=null&&d("EchoEncodingUtils").echoSetStringField(a,R,b.headerAttributionContentType);d("EchoEncodingUtils").echoSetIntField(a,M,b.previewContentWidth);d("EchoEncodingUtils").echoSetIntField(a,K,b.previewContentHeight);d("EchoEncodingUtils").echoSetIntField(a,J,b.mediaPlayableDuration);b.xAttachmentType!=null&&d("EchoEncodingUtils").echoSetStringField(a,B,b.xAttachmentType);d("EchoEncodingUtils").echoSetStringField(a,E,b.xContentType);d("EchoEncodingUtils").echoSetStringField(a,C,b.backupEntFbid);d("EchoEncodingUtils").echoSetStringField(a,D,b.mediaBackupStatus);d("EchoEncodingUtils").echoSetStringField(a,Q,b.filename)}function c(a,b,c){var e={},f=!1,g=!1,h=!1;if(ba(a)){var i=$(a,b,c);if(i==null){d("WALogger").ERROR(p(),b,c);return null}i.length!==2&&d("WALogger").ERROR(o());c=!1;var j=!1,k=i[0];i=i[1];var l={};f=Z(a,e,k);c=Z(a,l,i);g=Y(a,e,b,k,k);j=Y(a,l,b,i,k);h=X(a,e,k);k=X(a,l,i);if(!f||!g||!h||!c||!j||!k)return null;i=d("EchoDecodingUtils").echoDecodeStringField(a,"X-Offline-Threading-ID").result;c=W(e,i);j=W(l,i);if(c!=null&&j!=null)return[c,j]}else{f=Z(a,e);g=Y(a,e,b);h=X(a,e);if(!f||!g||!h)return null;k=W(e);if(k!=null)return[k]}return null}function X(a,b,c){var e,f=d("EchoDecodingUtils").echoDecodeStringField(a,"X-Offline-Threading-ID").result;e=(e=a.get(d("EchoMessage").ECHO_SERIALIZATION_ORIGIN))!=null?e:"";c=[{fieldName:"height",id:G},{fieldName:"width",id:O},{fieldName:"size",id:N},{fieldName:"previewContentHeight",id:K},{fieldName:"previewContentWidth",id:M},{fieldName:"mediaKeyTimestamp",id:c!=null?c+"-"+I:I}];var g=[{attachmentTypes:[U.VIDEO,U.AUDIO],fieldName:"mediaPlayableDuration",id:J}];for(g of g){var h=g.attachmentTypes,i=g.fieldName,j=g.id;j=d("EchoDecodingUtils").echoDecodeIntField(a,j);var k=j.result;j=j.success;if(j&&k!=null)b[i]=k;else if(!(b.xAttachmentType!=null&&!aa(h,b.xAttachmentType)||b.attachmentType===S.XMA)){d("WALogger").ERROR(n(),i,b.xAttachmentType,b.attachmentType,e,f);return!1}}c.map(function(f){var c=f.fieldName;f=f.id;f=d("EchoDecodingUtils").echoDecodeIntField(a,f);var e=f.result;f=f.success;f&&e!=null&&(b[c]=e)});return!0}function Y(a,b,c,e,f){var g,h=d("EchoDecodingUtils").echoDecodeStringField(a,"X-Offline-Threading-ID").result,i,j;g=(g=a.get(d("EchoMessage").ECHO_SERIALIZATION_ORIGIN))!=null?g:"";var k=[{fieldName:"filename",id:Q}];e!=null&&f!=null?(b.attachmentObjectId=e,i=[{fieldName:"plaintextHash",id:e+"-"+P},{fieldName:"directPath",id:e+"-"+F},{fieldName:"xContentType",id:e+"-"+E}],k.push({fieldName:"mediaKey",id:e+"-"+H}),j=f+"-"+C,e=e+"-"+A):(i=[{fieldName:"attachmentObjectId",id:w},{fieldName:"plaintextHash",id:P},{fieldName:"directPath",id:F},{fieldName:"xContentType",id:E}],k.push({fieldName:"mediaKey",id:H}),j=C,e=A);k.push({fieldName:"backupEntFbid",id:j});k.push({fieldName:"mediaContentType",id:z});k.push({fieldName:"encryptedHash",id:e});j=f!=null?f+"-"+D:D;k.push({fieldName:"mediaBackupStatus",id:j});e=[];for(f of i){j=f.fieldName;i=f.id;i=d("EchoDecodingUtils").echoDecodeStringField(a,i);var n=i.result;i=i.success;i&&n!=null?b[j]=n:e.push(j)}if(e.length>0){i=e.join(", ");c===d("EchoMessage").EchoMessageContentType.XMA?d("WALogger").WARN(m(),i,b.attachmentType,g):d("WALogger").ERROR(l(),i,b.attachmentType,g,h);return!1}k.map(function(e){var f=e.fieldName;e=e.id;e=d("EchoDecodingUtils").echoDecodeStringField(a,e);var c=e.result;e=e.success;e&&c!=null&&(b[f]=c)});return!0}function Z(a,b,c){var e,f=d("EchoDecodingUtils").echoDecodeStringField(a,"X-Offline-Threading-ID").result;e=(e=a.get(d("EchoMessage").ECHO_SERIALIZATION_ORIGIN))!=null?e:"";var g=d("EchoDecodingUtils").echoDecodeStringField(a,y);g=g.result==="file"?S.DOCUMENT:S.cast(g.result);g!=null&&(b.attachmentType=g);var h=d("EchoDecodingUtils").echoDecodeStringField(a,L);h=T.cast(h.result);h!=null&&(b.previewContentType=h);var i=d("EchoDecodingUtils").echoDecodeStringField(a,R);i=i.result;i!=null&&(b.headerAttributionContentType=i);i=d("EchoDecodingUtils").echoDecodeStringField(a,c!=null?c+"-"+B:B);i.success&&i.result!=null&&(a=ca(i.result),a!=null&&(b.xAttachmentType=a));if(g!=null&&(h!=null||g===S.DOCUMENT||g===S.PTT))return!0;else d("WALogger").ERROR(k(),g,h,i,e,f);return!1}function aa(a,b){return a.reduce(function(a,c){return a||c===b},!1)}function ba(a){return a.has(x)}function $(a,b,c){var e=d("EchoDecodingUtils").echoDecodeObjectIdListField(a,x),f=e.result;e=e.success;if(!e||f==null||f.length!==2){d("WALogger").ERROR(j(),f,b,c);return null}e=f.find(function(b){b=b+"-"+D;b=d("EchoDecodingUtils").echoDecodeStringField(a,b);var c=b.result;b=b.success;if(b&&c!=null)return!0});if(e!=null){b=e===f[0]?f[1]:f[0];return[e,b]}e=f.find(function(b){b=b+"-"+E;b=d("EchoDecodingUtils").echoDecodeStringField(a,b);var c=b.result;b=b.success;if(b&&c!=null&&V.cast(c)===V.FULL)return!0});if(e!=null){c=e===f[0]?f[1]:f[0];return[e,c]}return f}function ca(a){var b=U.cast(a);b==null&&d("WALogger").ERROR(i(),a);return(a=b)!=null?a:U.INVALID}function e(a){var b={};b=Z(a,b);if(!b)return null;b=d("EchoDecodingUtils").echoDecodeStringField(a,z);var c=d("EchoDecodingUtils").echoDecodeIntField(a,G),e=d("EchoDecodingUtils").echoDecodeIntField(a,O);a=d("EchoDecodingUtils").echoDecodeStringField(a,y);if(!b.success||!c.success||!e.success||!a.success||b.result==null||c.result==null||e.result==null||a.result==null){d("WALogger").ERROR(h());return null}return{mimetype:b.result,previewHeight:c.result,previewWidth:e.result,type:a.result}}g.ECHO_MESSAGE_FIELD_NAME_ATTACHMENT_OBJECT_ID=w;g.ECHO_MESSAGE_FIELD_NAME_ATTACHMENT_OBJECT_IDS=x;g.ECHO_MESSAGE_FIELD_NAME_ATTACHMENT_TYPE=y;g.AttachmentType=S;g.EchoMessageMediaPreviewType=T;g.EchoMessageActMediaAttachmentType=U;g.convertMediaMetadataDetailsToMediaMetadata=W;g.echoMessageSetMediaMetadataFields=a;g.echoMessageDecodeMediaDataFields=c;g.setMediaIntFields=X;g.setMediaEnumFields=Z;g.getAttachmentObjectIdsFromMultiBlobMediaMsg=$;g.decodeReceiverFetchData=e}),98);
__d("EchoMessageMediaGroupFieldUtil",["EchoDecodingUtils","EchoEncodingUtils","EchoMessage"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){b.groupId!=null&&d("EchoEncodingUtils").echoSetStringField(a,d("EchoMessage").ECHO_MESSAGE_FIELD_GROUP_ID,b.groupId),b.groupIndex!=null&&d("EchoEncodingUtils").echoSetIntField(a,d("EchoMessage").ECHO_MESSAGE_FIELD_GROUP_INDEX,b.groupIndex),b.groupSize!=null&&d("EchoEncodingUtils").echoSetIntField(a,d("EchoMessage").ECHO_MESSAGE_FIELD_GROUP_SIZE,b.groupSize)}function b(a,b){var c=d("EchoDecodingUtils").echoDecodeStringField(a,d("EchoMessage").ECHO_MESSAGE_FIELD_GROUP_ID);c.success&&c.result!=null&&(b.groupId=c.result);c=d("EchoDecodingUtils").echoDecodeIntField(a,d("EchoMessage").ECHO_MESSAGE_FIELD_GROUP_INDEX);c.success&&c.result!=null&&(b.groupIndex=c.result);c=d("EchoDecodingUtils").echoDecodeIntField(a,d("EchoMessage").ECHO_MESSAGE_FIELD_GROUP_SIZE);c.success&&c.result!=null&&(b.groupSize=c.result)}g.echoMessageSetMediaGroupFields=a;g.decodeMessageMediaGroupFields=b}),98);
__d("EchoMessageQuoteFieldUtils",["$InternalEnum","EchoDecodingUtils","EchoEncodingUtils"],(function(a,b,c,d,e,f,g){"use strict";var h="Reply-Message-Id",i="Reply-Message-Sender",j="Reply-Sort-Order",k="Reply-Type",l="Reply-Status",m=b("$InternalEnum").Mirrored(["BUMP"]),n=b("$InternalEnum")({VALID:"valid"});function a(a){var b={quoteMessageId:"<not set>",quoteMessageSender:{localKey:"<not set>",transportKey:"<not set>"},quoteSortOrderInMs:0},c=o(a,b),d=p(a,b),e=q(a,b);a=r(a,b);return!c||!d||!e||!a?null:b}function c(a,b){b=b.quoteData;if(b==null)return;d("EchoEncodingUtils").echoSetStringField(a,h,b.quoteMessageId);d("EchoEncodingUtils").echoSetAddressField(a,i,b.quoteMessageSender);d("EchoEncodingUtils").echoSetIntField(a,j,b.quoteSortOrderInMs);b.status!=null&&d("EchoEncodingUtils").echoSetStringField(a,l,b.status);b.replyType!=null&&d("EchoEncodingUtils").echoSetStringField(a,k,b.replyType)}function o(a,b){var c=[{fieldName:"quoteMessageSender",id:i}];for(c of c){var e=c.fieldName,f=c.id;f=d("EchoDecodingUtils").echoDecodeAddressField(a,f);var g=f.result;f=f.success;if(f&&g!=null)b[e]=g;else return!1}return!0}function p(a,b){var c=[{fieldName:"quoteMessageId",id:h}];for(c of c){var e=c.fieldName,f=c.id;f=d("EchoDecodingUtils").echoDecodeStringField(a,f);var g=f.result;f=f.success;if(f&&g!=null)b[e]=g;else return!1}return!0}function q(a,b){var c=[{fieldName:"quoteSortOrderInMs",id:j}];for(c of c){var e=c.fieldName,f=c.id;f=d("EchoDecodingUtils").echoDecodeIntField(a,f);var g=f.result;f=f.success;if(f&&g!=null)b[e]=g;else return!1}return!0}function r(a,b){var c=d("EchoDecodingUtils").echoDecodeStringField(a,k);c=m.cast(c.result);c!=null&&(b.replyType=c);c=d("EchoDecodingUtils").echoDecodeStringField(a,l);a=n.cast(c.result);a!=null&&(b.status=a);return!0}g.EchoMessageQuoteReplyType=m;g.EchoMessageQuoteStatus=n;g.echoMessageDecodeQuoteFields=a;g.echoMessageSetQuoteFields=c}),98);
__d("EchoMessageReceiptStatusFieldUtils",["$InternalEnum","EchoCommonUtils","EchoDecodingUtils","EchoEncodingUtils","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Error occurred while decoding participants from echo doc, error: ",""]);h=function(){return a};return a}var i="Receipt-Status",j="Receipt-Timestamp",k=b("$InternalEnum")({UNKNOWN:"unknown",SENDING:"sending",SERVER_RECEIVED:"server_received",DELIVERED:"delivered",READ:"read",ERROR:"error",NON_RETRYABLE_ERROR:"non_retryable_error"});function a(a,b){if(b==null||b.length===0)return;b.forEach(function(b){d("EchoEncodingUtils").echoSetStringField(a,d("EchoCommonUtils").getEchoAddressFieldNameWithSuffix(b.address,i),b.status),b.timestampMs!=null&&d("EchoEncodingUtils").echoSetIntField(a,d("EchoCommonUtils").getEchoAddressFieldNameWithSuffix(b.address,j),b.timestampMs)})}function c(a){var b=[];l(a).forEach(function(c){var e=d("EchoCommonUtils").getEchoAddressFieldNameWithSuffix(c,i);e=d("EchoDecodingUtils").echoDecodeStringField(a,e);if(e.success){e=(e=k.cast(e.result))!=null?e:k.UNKNOWN;var f=d("EchoCommonUtils").getEchoAddressFieldNameWithSuffix(c,j);f=d("EchoDecodingUtils").echoDecodeNullableIntField(a,f);f.result!=null?b.push({address:c,status:e,timestampMs:f.result}):b.push({address:c,status:e})}});return b}function l(a){var b=new Set();for(a of a.keys())if(a.includes(i))try{var c=a.split("@"),e=c[0];c=m(c[1]);b.add({localKey:e,transportKey:c})}catch(a){d("WALogger").ERROR(h(),a)}return Array.from(b)}function m(a){a=a.split(i);return a[0].split("-")[0]}g.MessageReceiptStatus=k;g.echoMessageSetReceiptStatusDataFields=a;g.echoMessageDecodeReceiptStatusDataFields=c}),98);
__d("EchoMessageXMAFieldUtils",["$InternalEnum","EchoDecodingUtils","EchoEncodingUtils","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing "," from xma fields"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing "," from xma fields"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing "," from media fields"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing xmaIsTombstoned from xma fields"]);k=function(){return a};return a}var l="XMA-Default-CTA",m="XMA-Gating-Type",n="XMA-Header-Subtitle",o="XMA-Header-Title",p="XMA-Is-Tombstoned",q="XMA-Layout-Type",r="XMA-Max-Subtitle-Num-Lines",s="XMA-Max-Title-Num-Lines",t="XMA-Subtitle-Text",u="XMA-Target-Expiry",v="XMA-Target-ID",w="XMA-Target-Type",x="XMA-Target-Username",y="XMA-Title-Text",z="XMA-Content-Ref",A="XMA-Dataclass",B=b("$InternalEnum").Mirrored(["SINGLE","HSCROLL","VSTACK","PORTRAIT","STANDARD_DXMA","LIST_DXMA","GRID"]),C=b("$InternalEnum").Mirrored(["NONE","IG_STORY_PHOTO_MENTION","IG_SINGLE_IMAGE_POST_SHARE","IG_MULTIPOST_SHARE","IG_SINGLE_VIDEO_POST_SHARE","IG_STORY_PHOTO_SHARE","IG_STORY_VIDEO_SHARE","IG_CLIPS_SHARE","IG_IGTV_SHARE","IG_SHOP_SHARE","IG_PROFILE_SHARE","IG_STORY_PHOTO_HIGHLIGHT_SHARE","IG_STORY_VIDEO_HIGHLIGHT_SHARE","IG_STORY_REPLY","IG_STORY_REACTION","FB_FEED_SHARE","FB_STORY_REPLY","FB_STORY_SHARE","FB_STORY_MENTION","FB_FEED_VIDEO_SHARE","FB_GAMING_CUSTOM_UPDATE","FB_PRODUCER_STORY_REPLY","MSG_EXTERNAL_LINK_SHARE","MSG_RECEIVER_FETCH","RTC_AUDIO_CALL","RTC_VIDEO_CALL","RTC_MISSED_AUDIO_CALL","RTC_MISSED_VIDEO_CALL","RTC_GROUP_AUDIO_CALL","RTC_GROUP_VIDEO_CALL","FB_EVENT","FB_SHORT","MSG_LOCATION_SHARING","MSG_LOCATION_SHARING_V2","MSG_MEMORIES_SHARE"]),D=b("$InternalEnum").Mirrored(["NONE","PRIVATE","SENSITIVE","MISINFORMATION","MEDIA_LABEL","POST_COVER","POST_LABEL","WARNING_SCREENS","INFO","EYE_OFF","NEWS_OFF","WARNING"]);function a(a,b){b.xmaLayoutType!=null&&d("EchoEncodingUtils").echoSetStringField(a,q,b.xmaLayoutType),b.xmaTargetType!=null&&d("EchoEncodingUtils").echoSetStringField(a,w,b.xmaTargetType),d("EchoEncodingUtils").echoSetStringField(a,x,b.xmaTargetUsername),d("EchoEncodingUtils").echoSetStringField(a,v,b.xmaTargetId),b.xmaTargetExpiry!=null&&d("EchoEncodingUtils").echoSetIntField(a,u,b.xmaTargetExpiry),d("EchoEncodingUtils").echoSetStringField(a,l,b.xmaDefaultCTA),d("EchoEncodingUtils").echoSetStringField(a,o,b.xmaHeaderTitle),d("EchoEncodingUtils").echoSetStringField(a,n,b.xmaHeaderSubtitle),d("EchoEncodingUtils").echoSetStringField(a,y,b.xmaTitleText),d("EchoEncodingUtils").echoSetStringField(a,t,b.xmaSubtitleText),b.xmaMaxTitleNumLines!=null&&d("EchoEncodingUtils").echoSetIntField(a,s,b.xmaMaxTitleNumLines),b.xmaMaxSubtitleNumLines!=null&&d("EchoEncodingUtils").echoSetIntField(a,r,b.xmaMaxSubtitleNumLines),b.xmaGatingType!=null&&d("EchoEncodingUtils").echoSetStringField(a,m,b.xmaGatingType),b.xmaDataclass!=null&&d("EchoEncodingUtils").echoSetStringField(a,A,b.xmaDataclass),d("EchoEncodingUtils").echoSetBooleanField(a,p,b.xmaIsTombstoned),b.xmaContentRef!=null&&d("EchoEncodingUtils").echoSetStringField(a,z,b.xmaContentRef)}function c(a){var b=G(a,p);if(b==null){d("WALogger").ERROR(k());return null}var c=D.cast(d("EchoDecodingUtils").echoDecodeStringField(a,m).result),e=B.cast(d("EchoDecodingUtils").echoDecodeStringField(a,q).result),f=C.cast(d("EchoDecodingUtils").echoDecodeStringField(a,w).result);return{xmaContentRef:E(a,z),xmaDataclass:E(a,A),xmaDefaultCTA:E(a,l),xmaGatingType:c,xmaHeaderSubtitle:E(a,n),xmaHeaderTitle:E(a,o),xmaIsTombstoned:b,xmaLayoutType:e,xmaMaxSubtitleNumLines:F(a,r),xmaMaxTitleNumLines:F(a,s),xmaSubtitleText:E(a,t),xmaTargetExpiry:F(a,u),xmaTargetId:E(a,v),xmaTargetType:f,xmaTargetUsername:E(a,x),xmaTitleText:E(a,y)}}function E(a,b){a=d("EchoDecodingUtils").echoDecodeStringField(a,b);var c=a.result;a=a.success;if(a&&c!=null)return c;else d("WALogger").WARN(j(),b)}function F(a,b){a=d("EchoDecodingUtils").echoDecodeIntField(a,b);var c=a.result;a=a.success;if(a&&c!=null)return c;else d("WALogger").WARN(i(),b)}function G(a,b){a=d("EchoDecodingUtils").echoDecodeBooleanField(a,b);var c=a.result;a=a.success;if(a&&c!=null)return c;else d("WALogger").WARN(h(),b)}g.XMALayoutType=B;g.XMAContentType=C;g.XMAGatingType=D;g.echoMessageSetXMAFields=a;g.decodeXMAFields=c}),98);
__d("EncryptedBackupTaskFailureFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(a,b,c,d,e,f,g){"use strict";a=c("getFalcoLogPolicy_DO_NOT_USE")("5725");b=d("FalcoLoggerInternal").create("encrypted_backup_task_failure",a);e=b;g["default"]=e}),98);
__d("EncryptedBackupUploadSuccessFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(a,b,c,d,e,f,g){"use strict";a=c("getFalcoLogPolicy_DO_NOT_USE")("5729");b=d("FalcoLoggerInternal").create("encrypted_backup_upload_success",a);e=b;g["default"]=e}),98);
__d("EncryptedBackupsConvertToLegacyAttachmentContext",["MAWCastToMsgrServerMediaType","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["invalid "," media type for legacy attachment upload"]);h=function(){return a};return a}function a(a){var b=[];for(a of a){var c=d("MAWCastToMsgrServerMediaType").castMediaAttachmentTypeToServerMediaType(a.mediaType);c==null?d("WALogger").ERROR(h(),a.mediaType):b.push({mediaObjectId:a.mediaObjectId,mediaType:c})}return b}g["default"]=a}),98);
__d("EncryptedBackupsDYIFileUtils",["FBLogger","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h="media";f="messages.zip";function i(){if(navigator.storage!=null&&navigator.storage.getDirectory!=null)return navigator.storage.getDirectory();throw c("FBLogger")("labyrinth_web").mustfixThrow("Storage management API is not supported. Please try one of the supported browsers.")}function a(){return j.apply(this,arguments)}function j(){j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=(yield i());return a.getDirectoryHandle(h,{create:!0})});return j.apply(this,arguments)}function d(a,b,c){return k.apply(this,arguments)}function k(){k=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,d){a=(yield a.getFileHandle(b,{create:!0}));try{b=(yield a.createSyncAccessHandle());b.write(d);b.flush();b.close()}catch(e){if(e instanceof Error){if(e instanceof TypeError)try{b=(yield a.createWritable());yield b.write(d);yield b.close();return}catch(a){if(a instanceof Error){if(a instanceof TypeError)throw c("FBLogger")("labyrinth_web").mustfixThrow("Write operation is not supported. Please try one of the supported browsers.");throw c("FBLogger")("labyrinth_web").mustfixThrow("Failed to write using writable: %e",a.message)}throw a}throw c("FBLogger")("labyrinth_web").mustfixThrow("Failed to write using sync access handle: %s",e.message)}throw e}});return k.apply(this,arguments)}function e(a,b){return l.apply(this,arguments)}function l(){l=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){a=(yield a.getFileHandle(b));try{var d=(yield a.createSyncAccessHandle()),e=new ArrayBuffer(d.getSize());d.read(e);d.close();return new Blob([e])}catch(d){if(d instanceof Error){if(d instanceof TypeError)return a.getFile();throw c("FBLogger")("labyrinth_web").mustfixThrow("Failed to read file %s, %s",b,d.message)}throw d}});return l.apply(this,arguments)}g.DyiMediaFolder=h;g.DyiArchiveFilename=f;g.getRootFolderHandle=i;g.getMediaFolderHandle=a;g.writeFile=d;g.readFile=e}),98);
__d("EncryptedBackupsDYIGenerateThreadMetadata",["CurrentUser","EncryptedBackupsDYISingleton","I64","IGDWebUtils","LSMessagingThreadTypeUtil","MAWThreadKeyUtils","Promise","ReQL","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Cannot find thread id for thread key ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Cannot find thread id for thread key ",""]);k=function(){return a};return a}function l(){return d("IGDWebUtils").isOnInstagramWeb()?(i||(i=d("I64"))).of_string(c("CurrentUser").getEIMU()):(i||(i=d("I64"))).of_string(c("CurrentUser").getAccountID())}function m(a,b){return d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.tables.threads).getKeyRange(d("MAWThreadKeyUtils").stringThreadKeyToI64(b)))}function n(a,b){return d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.tables.contacts).getKeyRange(b))}function a(a,b){return d("ReQL").toArrayAsync(d("ReQL").fromTableAscending(a.tables.contacts).filter(function(a){return b.has((i||(i=d("I64"))).to_string(a.id))}))}function o(a,b){var c;return(c=d("ReQL")).toArrayAsync(c.leftJoin(c.fromTableAscending(a.tables.participants,["contactId"]).getKeyRange(b),c.fromTableAscending(a.tables.contacts,["name"])))}function p(a){return d("LSMessagingThreadTypeUtil").isOneToOne(a)||d("LSMessagingThreadTypeUtil").isOpenOneToOne(a)}function q(a,b,c){if(c!=null&&c.trim()!=="")return c+"_"+b;switch(a.length){case 0:return"Thread_"+b;case 1:return a[0]+"_"+b;case 2:return a[0]+"and"+a[1]+"_"+b;case 3:return""+a[0]+a[1]+"and"+a[2]+"_"+b;case 4:return""+a[0]+a[1]+a[2]+"and1other_"+b;default:return""+a[0]+a[1]+a[2]+"and"+(a.length-3)+"others_"+b}}function r(a,b,c,d,e,f){return s.apply(this,arguments)}function s(){s=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c,e,f,g){var h=[],j=[f];f=(yield m(c,a));if(f!=null)if(p(f.threadType)){var l=b.getThreadIdForThreadKey(a);if(l==null){b.getLogger().WARN(k(),a);return}l=(yield n(c,(i||(i=d("I64"))).of_string(l)));(l==null?void 0:l.id)!=null&&(l==null?void 0:l.name)!=null&&b.setContactNameForContactId((i||(i=d("I64"))).to_string(l.id),l.name);l=(l==null?void 0:l.name)||"Unknown User";h.push(l);j.push(l);b.setThreadMetaDataByThreadKey(a,j,q(h,g,f.threadName))}else{l=(yield o(c,f.threadKey));l.forEach(function(a){var c=a[0];a=a[1];(c==null?void 0:c.contactId)!=null&&(a==null?void 0:a.name)!=null&&b.setContactNameForContactId((i||(i=d("I64"))).to_string(c.contactId),a.name);if(!(i||(i=d("I64"))).equal(c.contactId,e)){c=(a==null?void 0:a.name)||"Unknown User";h.push(c);j.push(c)}});b.setThreadMetaDataByThreadKey(a,j,q(h,g,f.threadName))}else b.setThreadMetaDataByThreadKey(a,j,q(h,g))});return s.apply(this,arguments)}function e(a){return t.apply(this,arguments)}function t(){t=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var c,e=d("EncryptedBackupsDYISingleton").getSingleton(),f=e.getLogger(),g=(yield e.getDB()),k=(yield n(g,l())),m=(c=k==null?void 0:k.id)!=null?c:(i||(i=d("I64"))).zero,o=(c=k==null?void 0:k.name)!=null?c:"Me";e.setContactNameForContactId((i||(i=d("I64"))).to_string(m),o);return a.reduce(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c){yield a;a=e.getThreadIdForThreadKey(b);a==null&&void f.WARN(j(),b);return r(b,e,g,m,o,c)});return function(b,c,d){return a.apply(this,arguments)}}(),(h||(h=b("Promise"))).resolve())});return t.apply(this,arguments)}g.getAllUnmappedContacts=a;g.EncryptedBackupsDYIGenerateThreadMetadata=e}),98);
__d("EncryptedBackupsDYIZipUtils",["EncryptedBackupsDYIFileUtils","Promise","asyncToGeneratorRuntime","jszip"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Generic stream error"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Error during end event"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Closed the writing stream"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["Finished ZIP file generation. Saving the results"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["Error during data event"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["Writing "," (","%)"]);n=function(){return a};return a}function a(a,b,c,d){return o.apply(this,arguments)}function o(){o=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,f,g){g("stream_file_start");var o=new(c("jszip"))();for(a of a){var q=a.threadName+".json";o.file(q,JSON.stringify(a,null,2))}e.forEach(function(a){return p(o,a)});var r=o.generateInternalStream({compression:"DEFLATE",compressionOptions:{level:6},type:"Uint8Array"});q=(yield d("EncryptedBackupsDYIFileUtils").getRootFolderHandle());a=(yield q.getFileHandle("messages.zip",{create:!0}));var s=(yield a.createWritable({keepExisting:!1,mode:"exclusive"}));return new(h||(h=b("Promise")))(function(a,b){var c=0;r.on("data",function(a,d){r.pause(),c++,c%1e3===0&&void f.LOG(n(),d.currentFile,d.percent),void s.write(a).then(function(){r.resume()},function(a){void f.ERROR(m()),g("stream_file_error"),b(a)})});r.on("end",function(){void f.LOG(l()),g("stream_file_end"),g("write_file_start"),void s.close().then(function(){g("write_file_end"),void f.LOG(k()),a()},function(a){void f.ERROR(j()),g("write_file_error"),b(a)})});r.on("error",function(a){void f.ERROR(i()),g("stream_file_error"),b(a)});r.resume()})});return o.apply(this,arguments)}function p(a,b){var c=b.split("/").pop(),e=d("EncryptedBackupsDYIFileUtils").getMediaFolderHandle().then(function(a){return d("EncryptedBackupsDYIFileUtils").readFile(a,(a=c)!=null?a:b)});a.file(b,e)}g.generateZipFile=a}),98);
__d("EncryptedBackupsDYISingleton",["EncryptedBackupsDYIFileUtils","EncryptedBackupsDYIGenerateThreadMetadata","EncryptedBackupsDYISingletonFactory","EncryptedBackupsDYITypes","EncryptedBackupsDYIZipUtils","FBLogger","I64","LSIntEnum","MAWBridge","MAWQplProxy","WAHashUtils","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["DYI Exiting Early - Found "," instamadillo threads"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to generate zip file: ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["Generating zip file"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["Generating output"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["Fetched remaining contact names, total of "," contacts"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["DYI flow complete - generating output"]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["Remaining attachments: ",""]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["Finished processing attachment with plaintext hash ",". "," attachments left"]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["Started processing attachment with plaintext hash ","."]);r=function(){return a};return a}function s(){var a=babelHelpers.taggedTemplateLiteralLoose(["DYI flow complete - generating output"]);s=function(){return a};return a}function t(){var a=babelHelpers.taggedTemplateLiteralLoose(["Finished handling message range queries for thread with thread key ",". "," threads left"]);t=function(){return a};return a}var u=null;function v(){try{return WorkerGlobalScope!==void 0&&self instanceof WorkerGlobalScope}catch(a){return!1}}function a(a,b,e){if(u==null)switch(a){case d("EncryptedBackupsDYITypes").EncryptedBackupsDYIConfig.Armadillo:if(v())throw c("FBLogger")("labyrinth_web").mustfixThrow("EncryptedBackupsDYISingleton for Armadillo can only be initialised in the main thread");u=d("EncryptedBackupsDYISingletonFactory").getMAWEncryptedBackupsDYISingleton(b,e);break;case d("EncryptedBackupsDYITypes").EncryptedBackupsDYIConfig.Instamadillo:if(!v())throw c("FBLogger")("labyrinth_web").mustfixThrow("EncryptedBackupsDYISingleton for Instamadillo can only be initialised in the worker");u=d("EncryptedBackupsDYISingletonFactory").getIGDEncryptedBackupsDYISingleton(b,e);break}}function e(){if(u==null)throw c("FBLogger")("labyrinth_web").mustfixThrow("EncryptedBackupsDYISingleton is not initialised. Please call EncryptedBackupsDYISingleton.initSingleton() first.");return u}var w=function(){var c=a.prototype;c.getDB=function(){return this.$1()};c.getLogger=function(){return this.$4};function a(a,b,c,d){this.$5=new Map(),this.$6=new Set(),this.$7=new Set(),this.$8=new Map(),this.$9=new Map(),this.$10=new Map(),this.$11=new Map(),this.$12=new Map(),this.$1=a,this.$2=b,this.$3=c,this.$4=d}c.getAllMediaUrls=function(){return Array.from(this.$5.values())};c.$13=function(a){return this.$5.get(a)};c.setMediaUrlByPlainTextHash=function(a,b){if(this.$5.has(a))return;this.$5.set(a,b)};c.addThreadKeyToThreadsRestoreInProgress=function(a){this.$6.add(a)};c.isThreadRestoreInProgressForThreadKey=function(a){return this.$6.has(a)};c.deleteThreadKeyFromThreadsRestoreInProgress=function(a){this.$6["delete"](a),this.$4.LOG(t(),a,this.$6.size),this.$14()&&(this.$4.LOG(s()),void this.$15())};c.isThreadsRestoreComplete=function(){return this.$6.size===0};c.addPlaintextHashToAttachmentDownloadsInProgress=function(a){this.$7.add(a),this.$4.LOG(r(),d("WAHashUtils").sanitisePlaintextHash(a))};c.deletePlaintextHashFromAttachmentDownloadsInProgress=function(a){this.$7["delete"](a),this.$4.LOG(q(),d("WAHashUtils").sanitisePlaintextHash(a),this.$7.size),this.$7.size<30&&this.$4.LOG(p(),Array.from(this.$7).map(d("WAHashUtils").sanitisePlaintextHash).join(", ")),this.$14()&&(this.$4.LOG(o()),void this.$15())};c.isAttachmentDownloadInProgressForPlaintextHash=function(a){return this.$7.has(a)};c.isAttachmentDownloadCompleteForPlaintextHash=function(a){return!!this.$5.get(a)};c.isAttachmentDownloadComplete=function(){return this.$7.size===0};c.setMessagesByThreadKey=function(a,b,c){a=this.getMessagesByThreadKey(a);a.set(b,c)};c.getMessagesByThreadKey=function(a){this.$16(a)||this.$8.set(a,new Map());return this.$8.get(a)};c.$16=function(a){return this.$8.has(a)};c.getThreadIdForThreadKey=function(a){return this.$10.get(a)};c.getThreadKeyForThreadId=function(a){return this.$11.get(a)};c.setThreadMapping=function(a,b){this.$10.set(a,b),this.$11.set(b,a)};c.setThreadMetaDataByThreadKey=function(a,b,c){this.$9.set(a,{participants:b,threadName:c})};c.getThreadMetadataMap=function(){return this.$9};c.setContactNameForContactId=function(a,b){this.$12.set(a,b)};c.getContactNameForContactId=function(a){return this.$12.get(a)};c.getContactNameMap=function(){return this.$12};c.getOutput=function(){var a=this;return Array.from(this.getThreadMetadataMap(),function(b){var c=b[0];b=b[1];var d=a.$16(c);d=d?Array.from(a.getMessagesByThreadKey(c),function(b){b[0];b=b[1];return babelHelpers["extends"]({},b,{media:Array.from(b.media,function(b){b=a.$13(b);return{uri:b!=null?"./"+b:"Failed to download media"}})})}):[];d=d.map(function(b){var c=b.senderId,d=babelHelpers.objectWithoutPropertiesLoose(b,["senderId"]);if(c!=null&&d.senderName==="Unknown User"){c=a.getContactNameForContactId(c);if(c!=null)return babelHelpers["extends"]({},d,{senderName:c})}return b});c=d.sort(function(a,b){return typeof a.timestamp==="number"&&typeof b.timestamp==="number"?a.timestamp-b.timestamp:0});return babelHelpers["extends"]({},b,{messages:c})})};c.$14=function(){return this.isAttachmentDownloadComplete()&&this.isThreadsRestoreComplete()};c.$17=function(a){switch(a){case 0:return d("EncryptedBackupsDYITypes").EncryptedBackupsDYIState.InProgress;case 1:return d("EncryptedBackupsDYITypes").EncryptedBackupsDYIState.Completed;case 2:return d("EncryptedBackupsDYITypes").EncryptedBackupsDYIState.Failed;case-1:default:return d("EncryptedBackupsDYITypes").EncryptedBackupsDYIState.NotStarted}};c.updateDYIStatus=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var c=(yield this.getDB());yield c.runInTransaction(function(){var c=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){yield b.encrypted_backups_dyi_backup_restore_status.put({currentStatus:(h||(h=d("LSIntEnum"))).ofNumber(a),pk:(i||(i=d("I64"))).zero})});return function(a){return c.apply(this,arguments)}}(),"readwrite",void 0,void 0,f.id+":509");d("MAWBridge").getBridge().fireAndForget("event","updateDYIStatus",{qplEvent:this.$2,qplInstanceKeyE2E:(c=this.$3)!=null?c:void 0,status:this.$17(a)})});function c(b){return a.apply(this,arguments)}return c}();c.$18=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=this,b=new Set();this.getContactNameMap().forEach(function(a,c){a==="Unknown User"&&b.add(c)});var c=(yield this.getDB());c=(yield d("EncryptedBackupsDYIGenerateThreadMetadata").getAllUnmappedContacts(c,b));c.forEach(function(b){var c=(i||(i=d("I64"))).to_string(b.id);a.setContactNameForContactId(c,b.name)});this.$4.LOG(n(),this.getContactNameMap().size.toString())});function c(){return a.apply(this,arguments)}return c}();c.$15=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=this;this.logDYIQPLPoint("complete_dyi_flow_start");yield this.$18();this.$4.LOG(m());var b=this.getOutput(),c=Array.from(this.$5.values());this.$4.LOG(l());try{yield d("EncryptedBackupsDYIZipUtils").generateZipFile(b,c,this.$4,function(b,c){a.logDYIQPLPoint(b,c)}),this.logDYIQPLPoint("complete_dyi_flow_end"),yield this.updateDYIStatus(1)}catch(a){this.$4.ERROR(k(),a),this.logDYIQPLPoint("complete_dyi_flow_error"),yield this.updateDYIStatus(2)}finally{void this.clear()}});function c(){return a.apply(this,arguments)}return c}();c.exitDYIEarly=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){b!=null&&this.$4.LOG(j(),b),this.logDYIQPLPoint("dyi_exit_early",{"int":{dyi_threads:b}}),yield this.updateDYIStatus(a?2:1),void this.clear()});function c(b,c){return a.apply(this,arguments)}return c}();c.clear=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){this.$5=new Map();this.$6=new Set();this.$7=new Set();this.$8=new Map();this.$9=new Map();var a=(yield d("EncryptedBackupsDYIFileUtils").getRootFolderHandle());yield a.removeEntry(d("EncryptedBackupsDYIFileUtils").DyiMediaFolder,{recursive:!0})});function c(){return a.apply(this,arguments)}return c}();c.logDYIQPLPoint=function(a,b){this.$3!=null&&d("MAWQplProxy").sendQplPointThroughBridge(this.$2,a,{annotations:b,instanceKey:this.$3})};return a}();g.initSingleton=a;g.getSingleton=e;g.EncryptedBackupsDYISingleton=w}),98);
__d("EncryptedBackupsDYISingletonFactory",["EncryptedBackupsDYISingleton","WATagsLogger","qpl"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){return new(d("EncryptedBackupsDYISingleton").EncryptedBackupsDYISingleton)(a,c("qpl")._(521478596,"1329"),b,d("WATagsLogger").TAGS(["labyrinth_web","labyrinth_dyi",b==null?"":b.toString()]))}function b(a,b){return new(d("EncryptedBackupsDYISingleton").EncryptedBackupsDYISingleton)(a,c("qpl")._(521479842,"2163"),b,d("WATagsLogger").TAGS(["igd_labyrinth_web","igd_dyi",b==null?"":b.toString()]))}g.getMAWEncryptedBackupsDYISingleton=a;g.getIGDEncryptedBackupsDYISingleton=b}),98);
__d("EncryptedBackupsDYIMediaDownloadHandlers",["EncryptedBackupsDYIFileUtils","EncryptedBackupsDYISingleton","FBLogger","Promise","WAResultOrError","asyncToGeneratorRuntime","uuidv4"],(function(a,b,c,d,e,f,g){"use strict";var h;a=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f){f=(yield d("EncryptedBackupsDYIFileUtils").getMediaFolderHandle());b=b.split("/")[1];b=c("uuidv4")()+"."+b;yield d("EncryptedBackupsDYIFileUtils").writeFile(f,b,e);f=d("EncryptedBackupsDYISingleton").getSingleton();f.setMediaUrlByPlainTextHash(a,d("EncryptedBackupsDYIFileUtils").DyiMediaFolder+"/"+b);f.deletePlaintextHashFromAttachmentDownloadsInProgress(a);return d("WAResultOrError").makeResult()});return function(b,c,d,e){return a.apply(this,arguments)}}();e=function(){c("FBLogger")("labyrinth_web").debug("[DYIMediaPreviewHandler] Skipping previews for DYI");return(h||(h=b("Promise"))).resolve(d("WAResultOrError").makeResult())};g.DYIMediaDownloadHandler=a;g.DYIMediaPreviewHandler=e}),98);
__d("EncryptedBackupsDYIMessageProcessingUtils",["EncryptedBackupsDYIMediaDownloadHandlers","EncryptedBackupsDYISingleton","FBLogger","MAWBridge","MAWFrontendMediaUtils","MebWAMediaDownloader","Promise","WAHashUtils","WAJids","WALongInt","WAMediaUtils","WAProgressiveJpegGetScanLengths","WAResultOrError","WATimeUtils","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to download media: ",", ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to download media: ",", ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to save media: ",", ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to save media: ",", ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to resign CDN URL: ",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to resign CDN URL: ",""]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["Media CDN URL has expired and should be renewed"]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["Successfully downloaded media"]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to download media"]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to download media"]);r=function(){return a};return a}function a(a,b){return{isUnsent:!1,media:new Set(),reactions:[],senderName:s(a),text:"",timestamp:(a=b)!=null?a:0,type:""}}function s(a){var b=d("EncryptedBackupsDYISingleton").getSingleton(),c="Unknown User";if(a!=null){b=b.getContactNameForContactId(a);b!=null&&(c=b)}return c}function e(a,b,c,d){return t.apply(this,arguments)}function t(){t=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f){var g=d("EncryptedBackupsDYISingleton").getSingleton(),h=g.getLogger(),m=h.TAGS([d("WAHashUtils").sanitisePlaintextHash(a)]);c("FBLogger")("labyrinth_web").tags(["labyrinth_dyi"]).debug("Sending the media download bridge call for plaintext hash: %s",d("WAHashUtils").sanitisePlaintextHash(a));f=(yield d("MAWBridge").getBridge().sendAndReceive("backend","dyiDownloadMediaV2",{mediaEntry:f,plaintextHash:a,protocolMsgId:b,sortOrderMs:e}));c("FBLogger")("labyrinth_web").tags(["labyrinth_dyi"]).debug("Received the media download result from the bridge for plaintext hash: %s, success: %s, error: %s",d("WAHashUtils").sanitisePlaintextHash(a),f.success?"true":"false",f.error);if(f.success){e=f.value;var n=e.unvalidatedMimeType;e=e.validatedResult;n=e.skipValidation?n:e.mimeType;n=(yield d("EncryptedBackupsDYIMediaDownloadHandlers").DYIMediaDownloadHandler(a,n,e.validatedPlaintext,b));if(!n.success){m.WARN(l(),n.error,n.payload);h.ERROR(k(),n.error,n.payload);g.deletePlaintextHashFromAttachmentDownloadsInProgress(a);return}}else{m.WARN(j(),f.error,f.payload);h.ERROR(i(),f.error,f.payload);g.deletePlaintextHashFromAttachmentDownloadsInProgress(a);return}});return t.apply(this,arguments)}function f(a,c,e,f,g,i,j,k,l,s,t){var u=d("EncryptedBackupsDYISingleton").getSingleton(),v=u.getLogger(),w=v.TAGS([d("WAHashUtils").sanitisePlaintextHash(l)]),x={author:d("WAJids").toMsgrUserJid(j),chat:d("WAJids").toMsgrUserJid(g),externalId:k},y={hash:l,isUrlRenewed:!1,mediaEntry:f,protocolMsgId:x,sortOrderMs:s};j={onDownloadError:function(){w.WARN(r());v.ERROR(q());u.deletePlaintextHashFromAttachmentDownloadsInProgress(y.hash);return(h||(h=b("Promise"))).resolve()},onDownloadSuccess:function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){w.LOG(p());var b=a.mimeType;a=a.plaintext;yield d("EncryptedBackupsDYIMediaDownloadHandlers").DYIMediaDownloadHandler(y.hash,b,a,x)});function c(b){return a.apply(this,arguments)}return c}(),onUrlExpired:function(){w.LOG(o());return(h||(h=b("Promise"))).resolve()}};var z=new(d("MebWAMediaDownloader").MebWAMediaDownloader)(y,j,a),A=f.serverMediaType;f=f.objectId;if(A!=null&&f!=null&&typeof s==="number"){c={backupEntFbid:c,deliveryObjectId:f,hash:l,mediaType:A,messageId:k,productType:e,sortOrder:s,threadId:g,threadKey:i};f={onResignCdnUrlFailure:function(a){w.WARN(n(),a.message);v.ERROR(m(),a.message);u.deletePlaintextHashFromAttachmentDownloadsInProgress(y.hash);return(h||(h=b("Promise"))).resolve()},onResignCdnUrlSuccess:function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){});function c(){return a.apply(this,arguments)}return c}()};l=t(c,f);z.setNextHandler(l);l.setNextHandler(new(d("MebWAMediaDownloader").MebWAMediaDownloader)(y,j,a))}void z.handle()}function u(a,b,c){var e,f,g,h;e=(e=a.integral)==null?void 0:(e=e.transport)==null?void 0:(e=e.ancillary)==null?void 0:e.mimetype;if(e==null)return d("WAResultOrError").makeError("mime-type-missing");e=d("MAWFrontendMediaUtils").getMediaTypeAndServerMediaTypeFromBlob(e,b).serverMediaType;if(e==null)return d("WAResultOrError").makeError("server-media-type-missing");b=(b=a.integral)==null?void 0:(b=b.transport)==null?void 0:(b=b.integral)==null?void 0:b.directPath;if(b==null)return d("WAResultOrError").makeError("direct-path-missing");f=(f=a.integral)==null?void 0:(f=f.transport)==null?void 0:(f=f.integral)==null?void 0:f.fileSha256;if(f==null)return d("WAResultOrError").makeError("plaintext-hash-missing");g=d("WALongInt").maybeNumber((g=a.integral)==null?void 0:(g=g.transport)==null?void 0:(g=g.integral)==null?void 0:g.mediaKeyTimestamp);if(g==null)return d("WAResultOrError").makeError("media-key-timestamp-missing");var i;if(((h=a.ancillary)==null?void 0:h.scanLengths)!=null&&((h=a.ancillary)==null?void 0:h.scansSidecar)!=null){h=a.ancillary;var j=h.scanLengths;h=h.scansSidecar;i={scanLengths:j.map(d("WAProgressiveJpegGetScanLengths").asProgressiveJpegScanLength),sidecar:h}}var k;if(((j=a.integral)==null?void 0:(h=j.transport)==null?void 0:(j=h.ancillary)==null?void 0:(h=j.thumbnail)==null?void 0:h.downloadableThumbnail)!=null){j=a.integral.transport.ancillary.thumbnail.downloadableThumbnail;h=j.directPath;var l=j.fileEncSha256,m=j.fileSha256,n=j.mediaKey,o=j.mediaKeyTimestamp;j=j.objectId;k={directPath:h,fileEncSha256:l,fileSha256:m,mediaKey:n,mediaKeyTimestamp:d("WALongInt").maybeNumber(o),objectId:j}}n={directPath:b,downloadableThumbnail:k,fileEncSha256:(h=a.integral)==null?void 0:(l=h.transport)==null?void 0:(m=l.integral)==null?void 0:m.fileEncSha256,filename:c,fileSha256:f,mediaKey:(n=a.integral)==null?void 0:(o=n.transport)==null?void 0:(j=o.integral)==null?void 0:j.mediaKey,mediaKeyTimestamp:d("WATimeUtils").castToUnixTime(g),objectId:(b=a.integral)==null?void 0:(h=b.transport)==null?void 0:(l=h.ancillary)==null?void 0:l.objectId,progressiveJpegDetails:i,serverMediaType:e,size:d("WALongInt").maybeNumber((m=a.integral)==null?void 0:(c=m.transport)==null?void 0:(f=c.ancillary)==null?void 0:f.fileLength)};return d("WAResultOrError").makeResult(d("WAMediaUtils").rawDataToMediaEntry(n))}g.buildBaseDyiMessage=a;g.getSenderName=s;g.downloadMediaWithMediaManager=e;g.startMediaDownloadChain=f;g.decodeMediaEntryFromAttachmentPayload=u}),98);
__d("WorkerUtils",[],(function(a,b,c,d,e,f){"use strict";function b(){try{return"WorkerGlobalScope"in a&&a instanceof a.WorkerGlobalScope}catch(a){return!1}}function c(){try{return"SharedWorkerGlobalScope"in a&&a instanceof a.SharedWorkerGlobalScope}catch(a){return!1}}f.isWorkerContext=b;f.isSharedWorkerContext=c}),66);
__d("getOrchestratorVersion",["qex"],(function(a,b,c,d,e,f,g){"use strict";function a(){var a;return(a=c("qex")._("263"))!=null?a:"default"}g["default"]=a}),98);
__d("MAWMainWebWorkerConfig",["MAWGK","MAWParseXMAFBConfig","WADbDeviceRegistration","WorkerUtils","getOrchestratorVersion","gkx","justknobx","qex"],(function(a,b,c,d,e,f,g){"use strict";var h,i=1;a={S508658PreventOldSessionLookupAndPromote:function(){return c("gkx")("12674")},armadilloWebProcessFutureproof:function(){return c("MAWGK").armadillo_web_process_futureproof},batchSize:function(){return c("justknobx")._("1866")},dynamicPullMode:function(){return c("gkx")("12141")},getDevicesV2:function(){return c("gkx")("4551")},getSignalFutureMessagesMax:function(){return c("justknobx")._("847")},handshakeRecovering:function(){return c("gkx")("13007")},icdcAlertTriggerFailureCounter:function(){return c("justknobx")._("1970")},icdcCooldownIntervalInMinutes:function(){return c("justknobx")._("1971")},icdcIntervalInMinutes:function(){return c("justknobx")._("1972")},ignoreReadReceipts:function(){return c("qex")._("3109")===!1},isDocumentReceiveEnabled:function(){return!c("gkx")("23924")},isEphemeralMessagesEnabled:function(){return!0},isFrankingDropOnInvalid:function(){return c("gkx")("23973")},isFrankingDropOnMissing:function(){return c("gkx")("23974")},isFrankingEnabled:function(){return c("justknobx")._("1347")},isGifEnabled:function(){return c("justknobx")._("1147")},isICDCErrorEnabled:function(){return c("gkx")("23975")},isImageHDSupportedEnabled:function(){return c("gkx")("9576")},isMediaFallbackToAlternativeHmacSaltsEnabled:function(){return c("gkx")("23976")},isMetaAiInvocationMessageRenderEnabled:function(){return c("gkx")("12661")},isOctetStreamAttachmentMimeTypeEnabled:function(){return c("gkx")("4644")},isPollsEnabled:function(){return c("qex")._("3169")===!0},isProgressiveJpegSendEnabled:function(){return c("justknobx")._("2412")},isSenderKeyPredistributionEnabled:function(){return c("gkx")("23981")},isSharedWorkerContext:function(){return(h||(h=d("WorkerUtils"))).isSharedWorkerContext()},isStickerEnabled:function(){return c("justknobx")._("2618")},isStickerReceiverFetchEnabled:function(){return c("justknobx")._("3677")},isStoryMentionXMAEnabled:function(){return!0},jpegThumbnailTargetByteSizeKB:function(){return c("justknobx")._("2338")},limitPullMode:function(){return c("gkx")("10270")},maxPrekeysToUpload:function(){return 200},maxUsersForNotifyDeviceChange:function(){return d("WADbDeviceRegistration").MAX_USERS_FOR_NOTIFY_DEVICE_CHANGE},offlineQueueStuckTimeoutMs:function(){return c("justknobx")._("3264")},oneQueueTimeoutMs:function(){return c("justknobx")._("2583")},orchestratorVersion:function(){return c("getOrchestratorVersion")()},pjpegPreviewAvoidLastScan:function(){return c("justknobx")._("67")},sendMsgWithoutJob:function(){return!0},sessionDropIfTooOld:function(){return c("justknobx")._("2240")},shouldDeviceStateTimesout:function(){return!0},simplifyPQ:function(){return c("gkx")("9588")},skipDownloadablePreviewForProgressiveJpeg:function(){return c("justknobx")._("2371")},skipProcessingGroupInvite:function(){return c("justknobx")._("3899")},useLongSessionDrop:function(){return c("gkx")("1244")},waDanglingQueue:function(){return c("justknobx")._("1921")}};b={productTypeForEBAttachments:"msgr",shouldFallbackToPreviewForFailedProgressiveJpeg:function(){return c("gkx")("2909")},supportedTypesVersion:function(){return c("MAWGK").armadillo_web_process_futureproof?i+1:i},supportedXMATargetTypes:function(){return d("MAWParseXMAFBConfig").FB_FULLY_SUPPORTED_TARGET_TYPES}};g.waConfig=a;g.mawConfig=b}),98);
__d("MAWConfig",["MAWMainWebWorkerConfig"],(function(a,b,c,d,e,f,g){"use strict";var h=d("MAWMainWebWorkerConfig").mawConfig;function a(){return h}function b(a){h=a}g.getConfig=a;g.setConfig=b}),98);
__d("EncryptedBackupsResignCdnUrl",["MAWBridge","MAWConfig","MAWLoggerUtils","WAGetSafeQPLError","WAJids","WAPromiseDelays","WAResolvable","WAResultOrError","asyncToGeneratorRuntime","cr:10071"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["resignCdnUrl runtime-error: ",""]);h=function(){return a};return a}var i=new Map();function a(a){return i.get(a)}function c(a){var b=a.deliveryObjectId,c=a.logger,e=a.mediaDownloadFlow,f=a.mediaType,g=a.msgId,i=a.protocolMsgId;a=a.sortOrderMs;e.addPoint("resign_cdn_url_start");return j({deliveryObjectId:b,mediaDownloadFlow:{addAnnotations:function(a){e==null?void 0:e.addAnnotations(babelHelpers["extends"]({},a))},addPoint:function(a,b){e==null?void 0:e.addPoint(a,babelHelpers["extends"]({},b))}},mediaType:f,msgId:g,protocolMsgId:i,sortOrderMs:a}).then(function(a){if(!a.success){e.addPoint("resign_cdn_url_fail",{string:{resignCdnUrlFailReason:a.error}});return a}e==null?void 0:e.addPoint("resign_cdn_url_end");return a})["catch"](function(a){c.ERROR(h(),a);e.addPoint("resign_cdn_url_fail",{string:{resignCdnUrlFailReason:d("WAGetSafeQPLError").getSafeQPLErrorMessage(a)}});return d("WAResultOrError").makeError("resign-cdn-url-runtime-error")})}function j(a){return k.apply(this,arguments)}function k(){k=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var c=a.deliveryObjectId,e=a.mediaDownloadFlow,f=a.mediaType,g=a.msgId,h=a.protocolMsgId;a=a.sortOrderMs;if(b("cr:10071")!==null){e=(yield b("cr:10071").eblsResignCdnUrlWithGraphQL({chatJid:h.chat,deliveryObjectId:c,externalId:h.externalId,mediaDownloadFlow:e,mediaType:f,sortOrderMs:a}));return!e.success?e:d("WAResultOrError").makeResult(e.value)}else{var j=d("MAWLoggerUtils").getInstanceKey();e=new(d("WAResolvable").Resolvable)();i.set(j,e);d("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"ResignAttachmentCDNUrl",value:{deliveryObjectId:c,mediaType:f,messageId:h.externalId,msgId:g,productType:d("MAWConfig").getConfig().productTypeForEBAttachments,skipLegacyMediaDownloadFlow:!0,sortOrder:a,threadId:d("WAJids").threadIdForChatJid(h.chat),threadJid:h.chat,traceId:j}}]});return d("WAPromiseDelays").withTimeout(e.promise,15*60*1e3,function(){return d("WAResultOrError").makeError("resign-cdn-url-timeout")})["finally"](function(){i["delete"](j)})}});return k.apply(this,arguments)}g.getRestoredCdnUrlResolvable=a;g.resignCdnUrl=c}),98);
__d("PersistedQueuesSchema",["MAWWormOdsLogger","WAHex","Worm","WormEAR","WormIDbDriver"],(function(a,b,c,d,e,f,g){"use strict";b={autoIncrement:!0,indexes:{"[jid+priority+stanzaId]":{fields:["jid","priority","stanzaId"],unique:!1},priority:{fields:["priority"],unique:!1}},nonEncryptedFields:new Set(["priority","stanzaId"]),primaryKey:"stanzaQueueId",secure:!0};c={autoIncrement:!0,indexes:{},nonEncryptedFields:new Set(["uploadStatus","uploadTsSec","backupActionType"]),primaryKey:"queueId",secure:!0};e={autoIncrement:!0,indexes:{},primaryKey:"queueId",secure:!0};f={autoIncrement:!0,indexes:{},primaryKey:"queueId",secure:!0};var h={danglingQueue:e,ebSenderUploadQueue:f,ebUploadQueue:c,stanzaQueue:b};function a(a,b,c,e,f,g){b=d("WAHex").parseHex(b);b=new(d("WormEAR").WormEAR)(h,b);return new(d("Worm").WormDatabase)(new(d("WormIDbDriver").WormIDbDriver)(a,"pqdb",h,b,d("MAWWormOdsLogger").wormOdsWorkerLogger,{blockingErrorThreshold:c,onBlockingError:e,onTransactionError:f}),g)}g.makePersistedQueueSchema=a}),98);
__d("PersistedQueueDB",["FBLogger","PersistedQueuesSchema","Promise","WAResolvable","WormEAR","asyncToGeneratorRuntime","err","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j=new(d("WAResolvable").Resolvable)();function a(a){return k.apply(this,arguments)}function k(){k=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var e=a.blockingErrorThreshold,f=a.dbName,g=a.onBlockingError,k=a.qplEvent;a=a.strEncKey;try{f=d("PersistedQueuesSchema").makePersistedQueueSchema(f,a,e,g,function(a){if(a instanceof d("WormEAR").DecryptionError){var e=a;c("FBLogger")("messenger_web").mustfix("EAR decryption error in store: %s. Dropping corrupted entity",e.store);c("promiseDone")((a=(a=i)==null?void 0:a.runInTransaction([e.store],"readwrite",function(a){a=a.stores[e.store];return e.maybeHashedPk!=null?a["delete"](e.maybeHashedPk):a.clear()},"delete-corrupted-entity"))!=null?a:(h||(h=b("Promise"))).resolve())}},k);i=f;yield f.init();j.resolve(f);return f}catch(a){c("FBLogger")("messenger_web").catching(a).mustfix("Error performing PersistedQueue init: %s",a);throw a}});return k.apply(this,arguments)}function e(){if(i==null)throw c("err")("PersistedQueue is not initialized");return i}function f(){return j.promise}g.makePersistedQueues=a;g.getPersistedQueues=e;g.getDbPromise=f}),98);
__d("WAThrottle",[],(function(a,b,c,d,e,f){"use strict";function a(a,b){var c=0,d=null,e;function f(){var f=Date.now(),g=f-c;for(var h=arguments.length,i=new Array(h),j=0;j<h;j++)i[j]=arguments[j];e=i;g>=b?(clearTimeout(d),d=null,a.apply(void 0,i),c=Date.now()):d==null&&(d=setTimeout(function(){return a.apply(void 0,e)},b-g))}return f}f.throttle=a}),66);
__d("PersistedQueueApi",["PersistedQueueDB","WALogger","WAThrottle","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[PersistedQueueV2] Error during PQ clear operation of ",": ",""]);h=function(){return a};return a}c=1e3*60*60;var i=function(a,b){return"PersistedQueue:"+a+":"+b};function a(){return{ack:k,clear:l,"delete":m,index:j,keys:o,read:n,write:p}}function j(a,c){return{equals:function(b){return{read:function(e){return d("PersistedQueueDB").getPersistedQueues().runInTransaction([a],"readonly",function(d){return d.stores[a].readIndexRange(c,{only:b},e)},i(a,"index-equal"))}}},keys:function(){return d("PersistedQueueDB").getPersistedQueues().runInTransaction([a],"readonly",function(b){return b.stores[a].readIndexKeys(c)},"index-keys")},read:function(){var e=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){var e=(yield d("PersistedQueueDB").getPersistedQueues().runInTransaction([a],"readonly",function(d){return d.stores[a].readIndex(c,void 0,b)},i(a,"index-read")));return e});function f(a){return e.apply(this,arguments)}return f}()}}function k(a,b){return m(a,b)}function l(a){return d("PersistedQueueDB").getPersistedQueues().runInTransaction([a],"readwrite",function(b){return b.stores[a].clear()},i(a,"clear"))}function m(a,c){return d("PersistedQueueDB").getPersistedQueues().runInTransaction([a],"readwrite",function(){var d=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){b=b.stores[a];yield b.bulkDelete(c);r(a)});return function(a){return d.apply(this,arguments)}}(),i(a,"delete"))}function n(a,b){return d("PersistedQueueDB").getPersistedQueues().runInTransaction([a],"readonly",function(c){return c.stores[a].readAll(b)},i(a,"read"))}function o(a){return d("PersistedQueueDB").getPersistedQueues().runInTransaction([a],"readonly",function(b){return b.stores[a].readKeys()},i(a,"keys"))}function p(a,b){return d("PersistedQueueDB").getPersistedQueues().runInTransaction([a],"readwrite",function(c){return c.stores[a].bulkAdd(b)},i(a,"write"))}function q(a){return d("PersistedQueueDB").getPersistedQueues().runInTransaction([a],"readwrite",function(){var c=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){b=b.stores[a];var c=(yield b.readAll({limit:1}));c.length===0&&(yield b.clear())});return function(a){return c.apply(this,arguments)}}(),i(a,"ClearIfEmpty"))}var r=d("WAThrottle").throttle(function(a){q(a)["catch"](function(b){d("WALogger").ERROR(h(),a,b)})},c);g.persistedQueueApi=a;g.persistedQueueIndex=j;g.persistedQueueAck=k;g.persistedQueueClear=l;g.persistedQueueDelete=m;g.persistedQueueRead=n;g.persistedQueueKeys=o;g.persistedQueueWrite=p;g.clearIfEmpty=q}),98);
__d("EncryptedBackupsUploadQueue",["EncryptedBackupsUploadEntity","MWEBODSEntityName.enum","MWEBODSUtils","PersistedQueueApi","Promise","QPLUserFlow","WAPersistedQueue","WATagsLogger","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to write to ebUploadQueue ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["EB Upload Queue is already initialized"]);j=function(){return a};return a}var k=d("WATagsLogger").TAGS(["EbUploadQueue"]),l=null;function m(){return l==null?n():l}function n(){l!=null&&k.ERROR(j());var a=d("WAPersistedQueue").initPersistedQueue("ebUploadQueue",d("PersistedQueueApi").persistedQueueApi());l=a;return a}function a(a){if(a.length===0)return(h||(h=b("Promise"))).resolve();d("MWEBODSUtils").markODSForEB(c("MWEBODSEntityName.enum").MAW_EB_UPLOAD_COUNTER,"upload.api.put",a.length);var e=m();return e.addAndCommit(a.map(d("EncryptedBackupsUploadEntity").asEBUploadEntity)).then(function(){a.forEach(function(a){(a==null?void 0:a.instanceKey)!=null&&c("QPLUserFlow").endSuccess(c("qpl")._(521477113,"2698"),{instanceKey:a.instanceKey})})})["catch"](function(a){k.ERROR(i(),a);return(h||(h=b("Promise"))).reject(a)})}g.logger=k;g.ebUploadQueue=m;g.initEbUploadQueue=n;g.putMsgsToEbUpload=a}),98);
__d("LSLogMEBUploadSuccessEvent.nop",["Promise","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h,i=c("requireDeferred")("EncryptedBackupUploadFailureFalcoEvent").__setRef("LSLogMEBUploadSuccessEvent.nop"),j=c("requireDeferred")("EncryptedBackupUploadSuccessFalcoEvent").__setRef("LSLogMEBUploadSuccessEvent.nop");a=function(a,c,d,e,f){if(d!=null){a=f?j.load():i.load();void a.then(function(a){return a.log(function(){return{message_id:d,trace_id:e}})})}return(h||(h=b("Promise"))).resolve()};a.__nop_name__="LSLogMEBUploadSuccessEvent";g["default"]=a}),98);
__d("LSDeleteBackupOnClient",["LSAppendDataTraceAddon","LSIsMobileClient","LSLogMEBUploadSuccessEvent.nop","LSLogMebClientEvent.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(e){return c.sequence([function(a){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsDeleteBackupOnClientStoredProcedure] Beginning execution."),c.i64.neq(void 0,void 0)?(d[9]=["deleteBackupOnClient reason: "," ",c.i64.to_string(void 0)].join(""),function(a){c.logger(a).info(a)}(["[EncryptedBackups][LSEncryptedBackupsDeleteBackupOnClientStoredProcedure] ","",d[9]].join("")),d[10]=c.createArray(),void 0!==void 0?d[11]=(d[10].push(void 0),d[10]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsDeleteBackupOnClientStoredProcedure",[d[9]].join(""),d[10],c.i64.cast([0,4]))):c.resolve()},function(a){return d[1]="Beginning deleteBackupOnClient stored procedure",function(a){c.logger(a).info(a)}(["[EncryptedBackups][deleteBackupOnClient] ","",d[1]].join("")),d[2]=c.createArray(),void 0!==void 0?d[9]=(d[2].push(void 0),d[2]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"deleteBackupOnClient",[d[1]].join(""),d[2],c.i64.cast([0,4]))},function(b){return c.i64.neq(a[0],void 0)?c.forEach(c.db.table(168).fetch([[[a[0]]]]),function(a){return a["delete"]()}):c.forEach(c.db.table(168).fetch(),function(a){return a["delete"]()})},function(b){return c.i64.neq(a[0],void 0)?c.forEach(c.db.table(169).fetch([[[a[0]]],"fk_secure_encrypted_backups_client_state"]),function(a){return a["delete"]()}):c.forEach(c.db.table(169).fetch(),function(a){return a["delete"]()})},function(a){return c.forEach(c.db.table(174).fetch(),function(a){return a["delete"]()})},function(b){return a[1]==="fetch_virtual_device"?c.db.table(178).put({pk:c.i64.cast([0,1]),recoveryCodeStatus:c.i64.cast([0,4])}):c.resolve()},function(e){return a[2]?c.sequence([function(a){return d[9]="Clearing state management backups tables",function(a){c.logger(a).info(a)}(["[EncryptedBackups][deleteBackupOnClient] ","",d[9]].join("")),d[10]=c.createArray(),void 0!==void 0?d[11]=(d[10].push(void 0),d[10]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"deleteBackupOnClient",[d[9]].join(""),d[10],c.i64.cast([0,4]))},function(a){return c.forEach(c.db.table(172).fetch([[[c.i64.cast([0,1])]]]),function(a){var b=a.update;a.item;return b({backupId:void 0})})},function(b){return c.i64.neq(a[0],void 0)?c.forEach(c.filter(c.db.table(184).fetch(),function(b){return c.i64.eq(b.backupId,a[0])}),function(a){return a["delete"]()}):c.forEach(c.db.table(184).fetch(),function(a){return a["delete"]()})},function(b){return c.i64.neq(a[0],void 0)?c.forEach(c.db.table(196).fetch([[[a[0]]]]),function(a){return a["delete"]()}):c.forEach(c.db.table(196).fetch(),function(a){return a["delete"]()})}]):c.resolve()},function(a){return!1===!1?c.sequence([function(a){return c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,1851]),c.i64.cast([0,2]),void 0,void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[10]=a[0],a})},function(a){return d[10]?d[11]=!0:d[11]=!1,d[11]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[13]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[13]].join("")),d[12]=c.createArray(),void 0!==void 0?d[14]=(d[12].push(void 0),d[12]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[13],d[12],c.i64.cast([0,3]))):c.resolve()}])},function(a){return c.forEach(c.db.table(177).fetch(),function(a){var d=a.item;return c.sequence([function(a){return c.forEach(c.db.table(2).fetch([[[d.pendingBackupTaskId]]]),function(a){return a["delete"]()})},function(a){return c.i64.eq(d.contentType,c.i64.cast([0,1]))?c.nativeOperation(b("LSLogMEBUploadSuccessEvent.nop"),d.uniqueKey,d.lsTraceId,!0):c.resolve()}])})},function(a){return c.count(c.db.table(177).fetch()).then(function(a){return d[9]=a})},function(a){return c.i64.eq(d[9],c.i64.cast([0,0]))?c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,1852]),c.i64.cast([0,2]),void 0,void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[10]=a[0],a})},function(a){return d[10]?d[11]=!0:d[11]=!1,d[11]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[13]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[13]].join("")),d[12]=c.createArray(),void 0!==void 0?d[14]=(d[12].push(void 0),d[12]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[13],d[12],c.i64.cast([0,3]))):c.resolve()}]):c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,1853]),c.i64.cast([0,2]),void 0,void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[10]=a[0],a})},function(a){return d[10]?d[11]=!0:d[11]=!1,d[11]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[13]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[13]].join("")),d[12]=c.createArray(),void 0!==void 0?d[14]=(d[12].push(void 0),d[12]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[13],d[12],c.i64.cast([0,3]))):c.resolve()}])}]):c.resolve()},function(e){return a[2]?(d[9]="Clearing data flow backups tables",function(a){c.logger(a).info(a)}(["[EncryptedBackups][deleteBackupOnClient] ","",d[9]].join("")),d[10]=c.createArray(),void 0!==void 0?d[11]=(d[10].push(void 0),d[10]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"deleteBackupOnClient",[d[9]].join(""),d[10],c.i64.cast([0,4]))):c.resolve()},function(e){return a[5]?c.resolve(0):a[4]!==void 0?(function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsDeleteBackupOnClientStoredProcedure] ","",a[4]].join("")),d[9]=c.createArray(),void 0!==void 0?d[10]=(d[9].push(void 0),d[9]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsDeleteBackupOnClientStoredProcedure",a[4],d[9],c.i64.cast([0,3]))):c.resolve()},function(a){return d[3]=c.i64.of_float(Date.now()),d[4]=c.i64.random(),d[6]="Finishing execution. Execution time: ",d[7]=c.i64.to_string(c.i64.sub(d[3],d[0])),d[8]=" ms",d[5]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][LSEncryptedBackupsDeleteBackupOnClientStoredProcedure] ",d[5],d[6],d[5],d[7],d[5],d[8]].join("")),c.i64.eq(c.i64.mod_(d[4],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[9]=",",d[10]=c.createArray(),void 0!==void 0?d[11]=(d[10].push(void 0),d[10]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsDeleteBackupOnClientStoredProcedure",[d[6],d[9],d[7],d[9],d[8]].join(""),d[10],c.i64.cast([0,4]))):c.resolve()}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsDeleteBackupOnClientStoredProcedure";a.__tables__=["secure_encrypted_backups_client_state","secure_encrypted_backups_epochs","secure_encrypted_backups_generated_recovery_code","secure_encrypted_backups_recovery_code_status","encrypted_backups","encrypted_backups_virtual_devices","encrypted_backups_metadata","pending_backups_context_v2","pending_tasks"];e.exports=a}),null);
__d("WAAckLevel",[],(function(a,b,c,d,e,f){"use strict";a={SENDER_BACKFILL_SENT:-7,INACTIVE_RECEIVED:-6,CONTENT_UNUPLOADABLE:-5,CONTENT_TOO_BIG:-4,CONTENT_GONE:-3,EXPIRED:-2,FAILED:-1,CLOCK:0,SENT:1,RECEIVED:2,READ:3,PLAYED:4};f.ACK=a}),66);
__d("MAWAdminMsgHelpers",["MAWCreateParticipantAdminMsg","MAWExternalId","MAWRemoveParticipantAdminMsg","WAAckLevel","WAGlobals","WAJids"],(function(a,b,c,d,e,f,g){"use strict";var h="Facebook User";function a(a){return a==null||a===""?h:a}function b(a){return a!=null?d("WAJids").userIdFromJid(a):h}function c(a,b,c,e){return{ack:d("WAAckLevel").ACK.SENT,id:{author:d("WAJids").AUTHOR_SYSTEM,chat:a,externalId:d("MAWExternalId").generateExternalId()},msgContent:d("MAWCreateParticipantAdminMsg").createParticipantAdminMessage(c==="@me"?d("WAGlobals").getMyUserJid():c,b),serverTs:e,ts:e,type:"Admin"}}function e(a,b,c,e){return{ack:d("WAAckLevel").ACK.SENT,id:{author:d("WAJids").AUTHOR_SYSTEM,chat:a,externalId:d("MAWExternalId").generateExternalId()},msgContent:d("MAWRemoveParticipantAdminMsg").removeParticipantAdminMessage(c==="@me"?d("WAGlobals").getMyUserJid():c,b),serverTs:e,ts:e,type:"Admin"}}function f(a,b,c,e){var f,g=d("WAGlobals").getMyUserJid();c=c==="@me"?g:c;if(c===g)f={adminMsgContent:[d("WAJids").userIdFromJid(b)],adminType:"currentUserPromotedParticipant"};else if(c==null)f=b===g?{adminMsgContent:[],adminType:"currentUserGotPromoted"}:{adminMsgContent:[d("WAJids").userIdFromJid(b)],adminType:"participantGotPromoted"};else{c=d("WAJids").userIdFromJid(c);f=b===g?{adminMsgContent:[c],adminType:"participantPromotedYou"}:{adminMsgContent:[c,d("WAJids").userIdFromJid(b)],adminType:"participantPromotedParticipant"}}return{ack:d("WAAckLevel").ACK.SENT,id:{author:d("WAJids").AUTHOR_SYSTEM,chat:a,externalId:d("MAWExternalId").generateExternalId()},msgContent:f,serverTs:e,ts:e,type:"Admin"}}function i(a,b,c,e){var f,g=d("WAGlobals").getMyUserJid();c=c==="@me"?g:c;if(c===g)f=b===g?{adminMsgContent:[],adminType:"currentUserSelfDemoted"}:{adminMsgContent:[d("WAJids").userIdFromJid(b)],adminType:"currentUserDemotedParticipant"};else if(c==null)f=b===g?{adminMsgContent:[],adminType:"currentUserGotDemoted"}:{adminMsgContent:[d("WAJids").userIdFromJid(b)],adminType:"participantGotDemoted"};else{var h=d("WAJids").userIdFromJid(c);f=b===g?{adminMsgContent:[h],adminType:"participantDemotedYou"}:{adminMsgContent:[h,d("WAJids").userIdFromJid(b)],adminType:c===b?"participantSelfDemoted":"participantDemotedParticipant"}}return{ack:d("WAAckLevel").ACK.SENT,id:{author:d("WAJids").AUTHOR_SYSTEM,chat:a,externalId:d("MAWExternalId").generateExternalId()},msgContent:f,serverTs:e,ts:e,type:"Admin"}}function j(a,b,c,e){var f=[],g=b.subject.content;if(g==null)return;b.subject.user===d("WAGlobals").getMyUserJid()?(b="currentUserNamedGroup",f.push(g)):c==null?(b="unkonwnUserNamedGroup",f.push(g)):(b="participantNamedGroup",f.push(c,g));return{ack:d("WAAckLevel").ACK.SENT,id:{author:d("WAJids").AUTHOR_SYSTEM,chat:a,externalId:d("MAWExternalId").generateExternalId()},msgContent:{adminMsgContent:f,adminType:b},serverTs:e,ts:e,type:"Admin"}}function k(a,b,c,e){var f,g=[];if(c===d("WAGlobals").getMyUserJid())switch(b){case"all_member_add":f="currentUserSetAddModeAllMembers";break;case"admin_add":f="currentUserSetAddModeAdminOnly";break}else if(c!=null){g.push(d("WAJids").userIdFromJid(c));switch(b){case"all_member_add":f="participantSetAddModeAllMembers";break;case"admin_add":f="participantSetAddModeAdminOnly";break}}else switch(b){case"all_member_add":f="serverSetAddModeAllMembers";break;case"admin_add":f="serverSetAddModeAdminOnly";break}if(f==null)return;return{ack:d("WAAckLevel").ACK.SENT,id:{author:d("WAJids").AUTHOR_SYSTEM,chat:a,externalId:d("MAWExternalId").generateExternalId()},msgContent:{adminMsgContent:g,adminType:f},serverTs:e,ts:e,type:"Admin"}}g.UNKNOWN_USER=h;g.maybeUnknownParticipantName=a;g.createAdminMsgContactId=b;g.createParticipantAddAdminMessage=c;g.createParticipantRemoveAdminMsg=e;g.createParticipantPromoteAdminMsg=f;g.createParticipantDemoteAdminMsg=i;g.createGroupNameChangeAdminMsg=j;g.createMemberAddModeChangeAdminMsg=k}),98);
__d("MAWCreateParticipantAdminMsg",["MAWAdminMsgHelpers","WAGlobals"],(function(a,b,c,d,e,f,g){"use strict";function h(a,b,c){switch(a){case 1:return{adminMsgContent:[b],adminType:"participantAddedYou"};case 2:return{adminMsgContent:[b,c],adminType:"participantAddedYouAndOneUser"};default:return{adminMsgContent:[b,a.toString()],adminType:"participantAddedYouAndMoreThanOneUsers"}}}function i(a,b,c){switch(a){case 1:return{adminMsgContent:[b],adminType:"currentUserAddedOneParticipant"};case 2:return{adminMsgContent:[b,c],adminType:"currentUserAddedTwoParticipant"};default:return{adminMsgContent:[b,a.toString()],adminType:"currentUserAddedMoreThanTwoParticipant"}}}function j(a,b,c,d){switch(a){case 1:return{adminMsgContent:[b,c],adminType:"participantAddedOneUser"};case 2:return{adminMsgContent:[b,c,d],adminType:"participantAddedTwoUser"}}return{adminMsgContent:[b,c,a.toString()],adminType:"participantAddedMoreThanTwoUser"}}function a(a,b,c,e){e=e==null?b.map(d("MAWAdminMsgHelpers").createAdminMsgContactId):e;var f=e[0];e=e[1];c=c==null?d("MAWAdminMsgHelpers").createAdminMsgContactId(a):d("MAWAdminMsgHelpers").maybeUnknownParticipantName(c);if(a===d("WAGlobals").getMyUserJid())return i(b.length,d("MAWAdminMsgHelpers").maybeUnknownParticipantName(f),d("MAWAdminMsgHelpers").maybeUnknownParticipantName(e));return b.includes(d("WAGlobals").getMyUserJid())?h(b.length,d("MAWAdminMsgHelpers").maybeUnknownParticipantName(c),d("MAWAdminMsgHelpers").maybeUnknownParticipantName(b[0]===d("WAGlobals").getMyUserJid()?e:f)):j(b.length,c,d("MAWAdminMsgHelpers").maybeUnknownParticipantName(f),d("MAWAdminMsgHelpers").maybeUnknownParticipantName(e))}g.createParticipantAdminMessage=a}),98);
__d("MAWRemoveParticipantAdminMsg",["MAWAdminMsgHelpers","WAGlobals"],(function(a,b,c,d,e,f,g){"use strict";function h(a,b,c){switch(a){case 1:return{adminMsgContent:[b],adminType:"participantRemovedYou"};case 2:return{adminMsgContent:[b,c],adminType:"participantRemovedYouAndOneUser"};default:return{adminMsgContent:[b,a.toString()],adminType:"participantRemovedYouAndMoreThanOneUsers"}}}function i(a,b,c,d){switch(a){case 1:return d?{adminMsgContent:[],adminType:"currentUserLeftGroup"}:{adminMsgContent:[b],adminType:"currentUserRemovedOneParticipant"};case 2:return{adminMsgContent:[b,c],adminType:"currentUserRemovedTwoParticipant"};default:return{adminMsgContent:[b,a.toString()],adminType:"currentUserRemovedMoreThanTwoParticipant"}}}function j(a,b,c,d,e){switch(a){case 1:return e?{adminMsgContent:[b],adminType:"participantLeftGroup"}:{adminMsgContent:[b,c],adminType:"participantRemovedOneUser"};case 2:return{adminMsgContent:[b,c,d],adminType:"participantRemovedTwoUser"}}return{adminMsgContent:[b,c,a.toString()],adminType:"participantRemovedMoreThanTwoUser"}}function a(a,b,c,e){e=e==null?b.map(d("MAWAdminMsgHelpers").createAdminMsgContactId):e;var f=e[0];e=e[1];c=c==null?d("MAWAdminMsgHelpers").createAdminMsgContactId(a):d("MAWAdminMsgHelpers").maybeUnknownParticipantName(c);if(a===d("WAGlobals").getMyUserJid())return i(b.length,d("MAWAdminMsgHelpers").maybeUnknownParticipantName(f),d("MAWAdminMsgHelpers").maybeUnknownParticipantName(e),b[0]===d("WAGlobals").getMyUserJid());return b.includes(d("WAGlobals").getMyUserJid())?h(b.length,c,d("MAWAdminMsgHelpers").maybeUnknownParticipantName(b[0]===d("WAGlobals").getMyUserJid()?e:f)):j(b.length,c,d("MAWAdminMsgHelpers").maybeUnknownParticipantName(f),d("MAWAdminMsgHelpers").maybeUnknownParticipantName(e),b[0]===a)}g.removeParticipantAdminMessage=a}),98);
__d("MAWBridgeThread",["FBLogger","MAWTimeUtils","WAJids","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,e,f,g,i){var j=d("WAJids").switchOnMsgrChatJidType(a.jid,{group:function(a){return!0},user:function(a){return!1}}),k=h(a.snippetMsgTs,g);k===d("WATimeUtils").castToMillisTime(0)&&c("FBLogger")("messenger_web").info("[VerifyThreadExists] Passing zero lastActivityTs. clientThreadkey: %s, authoritativeThreadKey: %s, snippetMsgTs: %s, newestMsgTs: %s",b,e,a.snippetMsgTs==null?"null":d("WATimeUtils").fromMillisTime(a.snippetMsgTs),g);return{authoritativeThreadKey:e,cannotReplyReason:a.cannotReplyReason,clientThreadKey:b,description:f,folder:a.folder,instanceKey:i,isGroup:j,jid:a.jid,lastActivityTs:k,lastReadTs:d("MAWTimeUtils").ensureValidMillisTime(a.lastReadMsgTs)||d("WATimeUtils").castToMillisTime(0)}}function b(a,b,c,d){return{lastActivityTimestampMs:c,lastReadWatermarkTs:b,markUnread:d,threadJid:a}}function h(a,b){return d("MAWTimeUtils").ensureValidMillisTime(a!=null&&d("WATimeUtils").fromMillisTime(a)!==0?a:b)||d("WATimeUtils").castToMillisTime(0)}g.createBridgeThread=a;g.createBridgeThreadTimestampsUpdated=b;g.getLastActivityTs=h}),98);
__d("MAWParseSubprotocolVersionConsts",[],(function(a,b,c,d,e,f){"use strict";a=2;b=2;c=1;d=2;e=1;var g=1;f.ASSOCIATED_MESSAGE_SUBPROTOCOL_VERSION=a;f.XMA_PREVIEW_SUBPROTOCOL_VERSION=b;f.XMA_FAVICON_SUBPROTOCOL_VERSION=c;f.XMA_HEADER_SUBPROTOCOL_VERSION=d;f.RAVEN_IMAGE_MESSAGE_SUBPROTOCOL_VERSION=e;f.RAVEN_VIDEO_MESSAGE_SUBPROTOCOL_VERSION=g}),66);
__d("MAWMsgCleaner",["MAWLoggerUtils","Promise","WAAssertUnreachable","WAShiftTimer","WATagsLogger","WATimeUtils","WorkerScheduler","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["","::_purgeNow "," msgs' content cleaned"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["","::_purgeNow"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["","::update ",""]);k=function(){return a};return a}a="Unsend";e="Ephemeral";f="DeleteForMe";var l="PendingStanza",m="Xma",n="IGDDM",o="Quote";f={DELETE_FOR_ME:f,EPHEMERAL:e,IGDDM:n,PENDING_STANZA:l,QUOTE:o,UNSEND:a,XMA:m};var p;function q(){p==null&&(p=d("WorkerScheduler").makeScheduler("cleaner",{concurrency:1,maxConcurrency:1,maxThrottleMs:8e3}));return p}e=function(){function a(a,b){var e=this;this.$1=new(d("WAShiftTimer").ShiftTimer)(function(){c("promiseDone")(e.$2())});this.getNextTs=a.getNextTs;this.removeExpired=a.removeExpired;this.cleanerType=b;this.purgeEnabled=a.purgeEnabled;this.$1.forceRunNow()}var e=a.prototype;e.update=function(a){var b=r(this.cleanerType);d("WATagsLogger").TAGS([b,d("MAWLoggerUtils").Tag.MsgCleaner,d("MAWLoggerUtils").Tag.CleanerUpdate]).LOG(k(),b,a);this.$1.onOrBefore(d("WATimeUtils").cappedMillisecondsUntil(a))};e.$2=function(){var a=this,c=function(){if(!a.purgeEnabled())return(h||(h=b("Promise"))).resolve();var c=r(a.cleanerType);d("WATagsLogger").TAGS([c,d("MAWLoggerUtils").Tag.MsgCleaner,d("MAWLoggerUtils").Tag.CleanerPurge]).LOG(j(),c);return a.removeExpired().then(function(b){b>0&&d("WATagsLogger").TAGS([c,d("MAWLoggerUtils").Tag.MsgCleaner,d("MAWLoggerUtils").Tag.CleanerPurge]).LOG(i(),c,b);return a.getNextTs()}).then(function(b){b!=null&&a.update(b)})};if(this.$3!=null)return(h||(h=b("Promise"))).resolve();this.$3=q().task({fn:c,name:this.cleanerType,priority:d("WorkerScheduler").BACKGROUND_PRIORITY});return this.$3.run()["finally"](function(){a.$3=null})};return a}();function r(a){switch(a){case"Unsend":return"UnsendMsgCleaner";case"Ephemeral":return"EphemeralCleaner";case"DeleteForMe":return"DeleteForMeCleaner";case"PendingStanza":return"PendingStanzaCleaner";case"Xma":return"XmaCleaner";case"IGDDM":return"IGDDisappearingMsgCleaner";case"Quote":return"QuoteCleaner";default:return c("WAAssertUnreachable")(a)}}n=e;g.CLEANER_TYPE=f;g.MsgCleaner=e;g.MSG_CLEANER_FOR_TESTING_ONLY=n}),98);
__d("MAWUpdateThreadListItemUtils",["MAWAckLevel","MAWDbMsg","MAWDbMsgOrReaction","MAWMsgType","MAWXMAUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a){return d("MAWDbMsgOrReaction").switchOnMsgOrReactionMaybeUnstored(a,{forMessage:function(a){return a.altIndex===d("MAWDbMsg").SPAM_ALT_INDEX||a.altIndex===d("MAWDbMsg").FUTUREPROOF_SPAM_ALT_INDEX},forReaction:function(){return!1}})}function b(a){return d("MAWDbMsgOrReaction").switchOnMsgOrReactionMaybeUnstored(a,{forMessage:function(a){return a.ack===d("MAWAckLevel").ACK.clock},forReaction:function(){return!1}})}function c(a){return a.msgId!=null&&a.type===d("MAWMsgType").MSG_TYPE.XMA&&((a=a.msgContent)==null?void 0:a.content)===""}function e(a){return a.type===d("MAWMsgType").MSG_TYPE.XMA&&d("MAWXMAUtils").isRtcXMA(a==null?void 0:a.xmaMessageType)}g.isSpamMessage=a;g.isOptimisticMessage=b;g.isXMAThreadSnippet=c;g.isRTCXMAMessage=e}),98);
__d("MAWBridgeParticipants",["MAWBridgeParticipantsUpdatedHandler","WAJids","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function h(a){var b=a.deliveredWatermarkTs,c=a.lastReadActionTs,e=a.lastReadWatermarkTs,f=a.threadJid,g=a.type;a=a.userJid;return babelHelpers["extends"]({deliveredWatermarkTs:b||d("WATimeUtils").castToUnixTime(0),fbid:d("WAJids").extractUserId(a)},d("MAWBridgeParticipantsUpdatedHandler").mawToLsParticipantTypeConversion(g),{lastReadActionTs:(b=c)!=null?b:d("WATimeUtils").castToUnixTime(0),readWatermarkTs:e||d("WATimeUtils").castToUnixTime(0),threadJid:f})}function a(a){return{participants:a.map(function(a){return h(a)})}}g.createBridgeParticipant=h;g.createBridgeParticipants=a}),98);
__d("MAWAdminWriteUserDeviceMsgTxn",["MAWAckLevel","MAWAdminMsgHelpers","MAWDbMsgTxns","MAWDexieTable","MAWExternalId","MAWLocalizationType","MAWLocalizationUtils","MAWMsgType","MAWUserJidWrapper","MAWWriteMsgTxns","WAJids","WATimeUtils","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";e={add:"add",remove:"remove",update:"update"};function h(a,b){switch(a){case"add":if(b)return d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_DEVICE;else return d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_DEVICE;case"remove":if(b)return d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_REMOVED_DEVICE;else return d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_DEVICE;case"update":if(b)return d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_UPDATED_DEVICE;else return d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_UPDATED_DEVICE}}function a(a,b,e,f,g){return d("MAWDbMsgTxns").getIsThreadEmpty(a,e.jid).then(function(i){if(i)return d("MAWDexieTable").dexieResolve();i=b===d("MAWUserJidWrapper").getMyUserJid();var j=h(f,i);i=i?[]:[d("WAJids").userIdFromJid(b)];i=d("MAWLocalizationUtils").buildUnstoredDbAdminMsg({adminMsgContent:i,adminType:j,version:1},e.jid,d("MAWExternalId").generateExternalId(),g);return d("MAWWriteMsgTxns").writeMsg(a,i,e,"MAWAdminWriteUsersConnectedMsgTxn::writeUserDeviceAdminMsg").then(c("emptyFunction"))})}function b(a,b,e,f){var g=d("MAWAdminMsgHelpers").UNKNOWN_USER,h=b===d("MAWUserJidWrapper").getMyUserJid();b={ack:d("MAWAckLevel").ACK.received,altIndex:void 0,author:h?d("WAJids").AUTHOR_ME:b,externalId:d("MAWExternalId").generateExternalId(),msgContent:{adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.ICDC_ALERT_ADMIN_MESSAGE,authorName:g},threadJid:e.jid,ts:(h=f)!=null?h:d("WATimeUtils").unixTime(),type:d("MAWMsgType").MSG_TYPE.ICDC_ALERT};return d("MAWWriteMsgTxns").writeMsg(a,b,e,"MAWAdminWriteUsersConnectedMsgTxn::writeICDCAlert").then(c("emptyFunction"))}g.DeviceChange=e;g.getUserDeviceAdminType=h;g.writeUserDeviceAdminMsg=a;g.writeICDCAlert=b}),98);
__d("MAWBridgeXMA",["MAWBridgeXMAUtils","MAWDbMedia","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["MAWBridge - createBridgeXMA received unexpected media type - ",""]);h=function(){return a};return a}function i(a){if(a==null)return void 0;switch(a){case"Image":case"Sticker":return"image/png";case"Gif":return"image/gif";case"Video":return"video/mp4";case"Ptt":return"audio/wav"}}function a(a,b,c){var e=b.author,f=b.contentRef,g=b.ctas,j=b.defaultCTA,k=b.defaultPreviewMediaId,l=b.defaultPreviewMediaPlaintextHash,m=b.faviconMediaId,n=b.faviconPlaintextHash,o=b.headerMediaId,p=b.headerMediaPlaintextHash,q=b.headerTitle,r=b.maxSubtitleNumOfLines,s=b.maxTitleNumOfLines,t=b.msgId,u=b.offlineAttachmentId,v=b.overlayIconGlyph,w=b.overlayTitle,x=b.subtitleText,y=b.targetId,z=b.targetType,A=b.targetUsername,B=b.threadJid,C=b.titleText,D=b.xmaDataclass,E=b.xmaId;b=b.xmaLayoutType;a!=null&&a.mediaType!==d("MAWDbMedia").IMAGE&&d("WALogger").WARN(h(),a.mediaType);y!=null&&d("MAWBridgeXMAUtils").maybeBridgeToLSTargetId(y,z);var F=c.hasMedia,G=c.hasXmaFaviconMedia;c=c.hasXmaHeaderMedia;return{author:e,contentRef:f,ctas:g==null?void 0:g.filter(function(a){return a.ctaType!=null}),defaultCTA:j,defaultPreviewMediaId:k,defaultPreviewMediaPlaintextHash:l,duration:null,faviconMediaId:m,faviconPlaintextHash:n,filesize:a==null?void 0:a.size,hasMedia:F,hasXmaFaviconMedia:G,hasXmaHeaderMedia:c,headerMediaId:o,headerMediaPlaintextHash:p,headerTitle:q,maxSubtitleNumOfLines:r,maxTitleNumOfLines:s,mediaType:a==null?void 0:a.mediaType,msgId:t,offlineAttachmentId:u,overlayIconGlyph:v,overlayTitle:w,playableUrlMimeType:i(a==null?void 0:a.mediaType),previewHeight:a==null?void 0:(e=a.validatedImageInfo)==null?void 0:e.jpegThumbnailHeight,previewHeightLarge:a==null?void 0:(f=a.validatedImageInfo)==null?void 0:f.height,previewUrlMimeType:i(a==null?void 0:a.mediaType),previewWidth:a==null?void 0:(g=a.validatedImageInfo)==null?void 0:g.jpegThumbnailWidth,previewWidthLarge:a==null?void 0:(j=a.validatedImageInfo)==null?void 0:j.width,subtitleText:x,targetId:y,targetType:z,targetUsername:A,threadJid:B,titleText:C,ts:a==null?void 0:a.ts,xmaDataclass:D,xmaId:E,xmaLayoutType:b}}function b(a,b){var c=a.msgId;a=a.threadJid;return{msgId:c,threadJid:a,xmaId:b}}function c(a,b){var c=a.msgId;a=a.threadJid;return{msgId:c,threadJid:a,xmaId:b}}g.createBridgeXMA=a;g.createBridgeXMAShareExpired=b;g.createBridgeXMAShareTombstoned=c}),98);
__d("MAWBulkEditMsgsTxns",["FBLogger","MAWAckLevel","MAWBridgeMsg","MAWDbEditMsgHistory","MAWDbEditMsgHistoryTxns","MAWDexieTable","MAWIndexedDb","MAWJidUtils","MAWLoadReplyMediaTxns","MAWUnsafeCoerce","MAWUserJidWrapper","WAJids","WAMsgMap","WAMsgType"],(function(a,b,c,d,e,f,g){"use strict";function h(a,b,e){var f=[];for(var g=0;g<a.length;g++){var h=a[g],i=d("MAWJidUtils").maybeToProtocolMsgId(h.author,h.threadJid,h.originalMsgExternalId);if(i!=null){i=(i=e.get(i))==null?void 0:i.msgId;i!=null?f.push(babelHelpers["extends"]({},h,{editMsgHistoryId:d("MAWDbEditMsgHistory").convertToEditMsgHistoryId64(b[g]),originalMsgId:i})):c("FBLogger")("messenger_web").warn("[edit messagehistory] Failed to get the original msgId for a msg that has been edited.")}}d("MAWIndexedDb").afterTransaction({tag:"EditMsgHistoryAdded",value:f})}function a(a,b){var c=new Set(),e=[];b.forEach(function(a){var b=a.chatJid;a=a.msg;c.add(b);e.push(a.originalMsgExternalId)});return d("MAWDexieTable").dexieAll([a.messages.where("externalId").anyOf(e).toArray(),a.messages.where("quoteExternalId").anyOf(e).toArray(),a.editMsgHistory.where("originalMsgExternalId").anyOf(e).toArray()]).then(function(a){var b=a[0],c=a[1];a=a[2];return{editMsgHistory:a,originalMsgs:b,quoteMessages:c}})}function b(a,b,e){var f=e.editMsgHistory,g=e.originalMsgs,i=e.quoteMessages,k=g.reduce(function(a,b){var c=d("MAWJidUtils").toProtocolMsgId(b);return c==null?a:a.set(c,b)},new(d("WAMsgMap").MsgMap)());e=f.reduce(function(a,b){var c=d("MAWJidUtils").toProtocolMsgId(b);return c==null?a:a.set(c,b)},new(d("WAMsgMap").MsgMap)());g=j(b,{messageHistoriesToEdit:e,messagesToEdit:k});var l=g[0],m=g[1],n=g[2];return d("MAWDbEditMsgHistoryTxns").bulkAddEditMsgHistory(a,l,!1).then(function(b){h(l,b,k);var e=new(d("WAMsgMap").MsgMap)();m.entries().forEach(function(a){var b=a[0];a=a[1];var f=k.get(b);if(f==null){c("FBLogger")("messenger_web").warn("Cannot find the original msg for the edit action.");return}if(f.type!==d("WAMsgType").MSG_TYPE.TEXT&&f.type!==d("WAMsgType").MSG_TYPE.CIPHERTEXT)throw c("FBLogger")("messenger_web").mustfixThrow("Only text or cipher text can be edited. Original msg type: %s",f.type);f=babelHelpers["extends"]({},f,{editCount:((f=f.editCount)!=null?f:0)+((f=n.get(b))!=null?f:0),msgContent:a.editMsgContent,type:d("WAMsgType").MSG_TYPE.TEXT});e.set(b,f)});var f=i.map(function(a){var b=a.quote,f=a.quoteExternalId,g=a.threadJid;if(b==null){c("FBLogger")("messenger_web").warn("[edit message] Failed to get the quoted content for a msg that has been quoted.",a.externalId);return}var h=b.content.author;h=d("MAWJidUtils").maybeToProtocolMsgId(h==="@me"?d("MAWUserJidWrapper").getMyUserJid():h,g,f);if(h==null)return;g=e.get(h);if(g==null)return;return babelHelpers["extends"]({},a,{quote:babelHelpers["extends"]({},b,{content:babelHelpers["extends"]({},b.content,{msgContent:babelHelpers["extends"]({},g.msgContent)})})})}).filter(Boolean);return a.messages.bulkPut(e.values().concat(f)).then(function(){e.values().forEach(function(b){return d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(a,b).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(b,void 0,a)})})})}).then(function(){f.forEach(function(a){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(a)})})})})}function i(a,b){var e;switch(a.type){case d("WAMsgType").MSG_TYPE.TEXT:case d("WAMsgType").MSG_TYPE.EDIT_ACTION:return{author:a.author,editExternalId:a.externalId,editTs:(e=a.serverTs)!=null?e:a.ts,msgContent:(e=a.editMsgContent)!=null?e:d("MAWUnsafeCoerce").unsafeCoerce(a.msgContent),originalMsgExternalId:(e=a.originalMsgExternalId)!=null?e:a.externalId,sendStatus:d("MAWAckLevel").ACK.sent,specialTextSize:a.specialTextSize,threadJid:b};case d("WAMsgType").MSG_TYPE.CIPHERTEXT:return{author:a.author,editExternalId:a.externalId,editTs:(e=a.serverTs)!=null?e:a.ts,msgContent:{content:""},originalMsgExternalId:a.externalId,sendStatus:d("MAWAckLevel").ACK.sent,specialTextSize:a.specialTextSize,threadJid:b};default:a.type;throw c("FBLogger")("messenger_web").mustfixThrow("MAWBulkEditMsgsTxns::getMessageHistory: Unexpected msg type")}}function j(a,b){var e=b.messageHistoriesToEdit,f=b.messagesToEdit,g=[],h=new(d("WAMsgMap").MsgMap)(),j=new(d("WAMsgMap").MsgMap)();a.forEach(function(a){var b=a.chatJid;a=a.msg;var k=d("MAWJidUtils").maybeToProtocolMsgId(a.author,b,a.originalMsgExternalId);if(k==null)throw c("FBLogger")("messenger_web").mustfixThrow("[protocolMsgId] Cannot get the protocol id for the edit action. isAuthorSystem = %s; chatJid = %s; externalId = %s",d("WAJids").isAuthorSystem(a.author),!!b,!!a.originalMsgExternalId);var l=d("MAWJidUtils").maybeToProtocolMsgId(a.author,b,a.externalId);if(l==null)throw c("FBLogger")("messenger_web").mustfixThrow("[editMsgProtocolMsgId] Cannot get the protocol id for the edit action. isAuthorSystem = %s; chatJid = %s; externalId = %s",d("WAJids").isAuthorSystem(a.author),!!b,!!a.externalId);if(e.get(l)==null){g.push(i(a,b));l=(l=j.get(k))!=null?l:0;var m=f.get(k);j.set(k,l+1);if(e.get(k)==null&&l===0&&m!=null){if(m.type!==d("WAMsgType").MSG_TYPE.TEXT&&m.type!==d("WAMsgType").MSG_TYPE.CIPHERTEXT)throw c("FBLogger")("messenger_web").mustfixThrow("Only text or cipher text can be edited. Original msg type: %s",m.type);g.push(i(m,b))}}l=h.get(k);m=l==null?void 0:l.serverTs;b=a==null?void 0:a.serverTs;(m==null||b==null||m<b)&&h.set(k,a)});return[g,h,j]}g.prepareDataForMessageEdit=a;g.bulkEditMsgs=b;g.getMessageHistory=i}),98);
__d("MAWDbReactionUtils",["MAWBridgeTypesCreators","MAWIndexedDb","qex"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b=a.author,e=a.reaction,f=a.reactToMsgId,g=a.threadJid;a=a.ts;if(f==null)return;c("qex")._("4298")||d("MAWIndexedDb").afterTransaction(e==null?{tag:"DeleteReaction",value:d("MAWBridgeTypesCreators").createBridgeDeleteReaction({author:b,chatJid:g,reactToMsgId:f})}:{tag:"UpsertReaction",value:d("MAWBridgeTypesCreators").createBridgeUpsertReaction({author:b,chatJid:g,reaction:e||"",reactToMsgId:f,ts:a})})}g.dispatchReaction=a}),98);
__d("MAWBulkPutReactionsWithThreadUpdateTxn",["FBLogger","MAWDbReaction","MAWDbReactionUtils","MAWDbReactionsTxns","MAWDexieTable","MAWJidUtils","MAWThreadSnippetBuildTxns","WAArrayGroupBy","WAJids","WAMsgMap","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";function h(a){return a.reduce(function(a,b){var c=d("MAWJidUtils").maybeToProtocolMsgId(b.author,b.threadJid,b.reactToExternalId);if(c==null)return a;a.set(c,d("MAWDbReactionsTxns").coerceToReaction(b));return a},new(d("WAMsgMap").MsgMap)()).values()}function a(a,b,e,f){if(b.length===0)return d("MAWDexieTable").dexieResolve();b=h(b);var g=b.map(function(a){var b=e.get(a.threadJid);if(b==null)throw c("FBLogger")("messenger_web").mustfixThrow("Should not have got here - expect thread to exist for flow");f!==!0&&d("MAWDbReactionUtils").dispatchReaction(a);return a});b=d("WAArrayGroupBy").groupBy(g,function(a){a=a.threadJid;return a});b=b.map(function(b){var c=b[0];b=b[1];c=e.get(c);if(c==null||b.length===0)return null;var f=null;for(var g=b.length-1;g>=0;g--){f=d("MAWDbReaction").maybeCastToIncomingDbReaction(b[g]);if(f!=null)break}g=b.filter(function(a){return a.reaction==null});b=d("WAJids").interpretAsGroupJid(c.jid)!=null;return d("MAWThreadSnippetBuildTxns").getThreadChangesetForReactionChanges(a,c,{newestReaction:f,reactionsToClear:g},b)}).filter(Boolean);return d("MAWDexieTable").dexieAll(b).then(function(b){return d("MAWDexieTable").dexieAll([a.threads.bulkPut(b.map(function(a){a=a.thread;return a})),a.reactions.bulkPut(g)]).then(c("emptyFunction"))})}g.bulkPutReactionsWithThreadUpdates=a}),98);
__d("MAWDeletedReactionsCache",["WAMsgMap"],(function(a,b,c,d,e,f,g){"use strict";a=new(d("WAMsgMap").MsgMap)();g.DeletedReactionsCache=a}),98);
__d("MAWBulkWriteReactionsTxns",["FBLogger","LSMEBTaskCreationSource","MAWAuthor","MAWBridgeEventTransmitter","MAWBulkPutReactionsWithThreadUpdateTxn","MAWDbMsg","MAWDbReaction","MAWDbReactionsTxns","MAWDeletedReactionsCache","MAWDexieTable","MAWEncryptedBackupCacheManager","MAWJidUtils","MAWODSProxy","MAWUseProtocolMsgIdForMsgId","WAArrayGroupBy","WAJids","WAOdsEnums"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){var e=[],f=[];b.forEach(function(a){var b=a.chatJid;a=a.unstoredReaction;a=a.reactToExternalId;e.push(b);f.push(a)});return d("MAWDexieTable").dexieAll([a.threads.where("jid").anyOf(e).toArray(),a.messages.where("externalId").anyOf(f).toArray(),a.reactions.where("reactToExternalId").anyOf(f).toArray()]).then(function(e){var f=e[0],g=e[1];e=e[2];var i=new Map(f.map(function(a){return[a.jid,a]})),j=new Map(d("WAArrayGroupBy").groupBy(g,function(a){return a.externalId})),k=new Map(d("WAArrayGroupBy").groupBy(e,function(a){return a.reactToExternalId})),l=[],m=d("MAWUseProtocolMsgIdForMsgId").shouldUseProtocolMsgIdForMsgId();g=function(a){b.forEach(function(b){var e=b.chatJid;b=b.unstoredReaction;var f=b.author,g=b.externalId,n=b.groupingKey,o=b.reaction,p=b.reactToAuthor,q=b.reactToExternalId,r=b.senderTimestampMs,s=b.ts;e=i.get(e);if(e==null)return"missing_thread";var t=null;if(!m&&a!=null){var u=new Map(a),v=u.get(e.jid);if(v==null)throw c("FBLogger")("messenger_web").mustfixThrow("nextInChatReactionId should not be null");u.set(e.jid,v+1);t=d("MAWDbMsg").craftReactionId(e.chatId,v)}else t=d("MAWJidUtils").formatProtocolMsgIdFromExternalId(e.jid,g);u=k.get(b.reactToExternalId)||[];v=d("MAWDbReaction").findMatchingReaction(u,e.jid,f);if(v!=null&&d("MAWDbReaction").getReactionTimeMs(v)>d("MAWDbReaction").getReactionTimeMs(b))return"newer_reaction_exists";if(v!=null&&b.reaction==null){u={author:b.author,chat:b.threadJid,externalId:b.externalId};d("MAWDeletedReactionsCache").DeletedReactionsCache.set(u,v)}u=d("MAWAuthor").getAuthorUserJid(p);var w=j.get(b.reactToExternalId);if(w==null&&!d("MAWEncryptedBackupCacheManager").peekRestoreCache(b.reactToExternalId)){var x=d("WAJids").threadIdForChatJid(e.jid);d("MAWEncryptedBackupCacheManager").addMsgEntryToReuploadCache(e.jid,b.reactToExternalId);b.reactToExternalId===b.externalId?c("FBLogger")("messenger_web").warn("reactToExternalId is same as externalId"):d("MAWBridgeEventTransmitter").issuePointQueryOutsideTxn(b.reactToExternalId,x,void 0,c("LSMEBTaskCreationSource").EB_POINT_QUERY_IN_ACT_REACTIONS,e.jid)}b=h(e,u,w);u=d("MAWDbReaction").formatReactionForDb(e.jid,g,t,q,o,n,p,b==null?void 0:b.msgId,s,(x=f)!=null?x:d("WAJids").AUTHOR_ME,v==null?void 0:v.rowId,void 0,r);l.push(u)});return{chatJidToDbThread:i,unstoredDbReactionsForInsertion:l}};if(!m){e=f.map(function(b){return d("MAWDbReactionsTxns").getNextReactionIdNumberForThread(a,b).then(function(a){return[b.jid,a]})});return d("MAWDexieTable").dexieAll(e).then(g)}return g(null)})}function h(a,b,e){e=(e=e==null?void 0:e.filter(function(c){return c.threadJid===a.jid&&b===d("MAWAuthor").getAuthorUserJid(c.author)}))!=null?e:[];e.length>1&&(c("FBLogger")("maw_mutation_validator").warn("%s matching duplicate messages found for a reaction",e.length),d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.MAW_MUTATION_VALIDATOR,key:"match_reaction_to_message.invalid"}));return e[0]}function b(a,b,c){var e=b.chatJidToDbThread;b=b.unstoredDbReactionsForInsertion;return d("MAWBulkPutReactionsWithThreadUpdateTxn").bulkPutReactionsWithThreadUpdates(a,b,e,c)}g.prepareReactionsData=a;g.bulkWriteReactions=b}),98);
__d("MAWCiphertextRecoveryLogging",["FBLogger","MAWMsgType","ODS"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b){var c=new Set(a.filter(function(a){return a.type===d("MAWMsgType").MSG_TYPE.CIPHERTEXT}).map(function(a){return a.externalId}));a=b.filter(function(a){return a.type!==d("MAWMsgType").MSG_TYPE.CIPHERTEXT&&c.has(a.externalId)});if(a.length===0)return;i(a.length)}function i(a){a===void 0&&(a=1),(h||(h=d("ODS"))).bumpEntityKey(3185,"mwchat_ciphertext_recovered_by_eb","Ciphertext recovered by EB",a),c("FBLogger")("messenger_web").info("Ciphertext recovered by EB, count: %s",a)}g.compareAndLogCiphertextRecoveredByEB=a;g.logCiphertextRecoveredByEB=i}),98);
__d("MAWConvertXMAGatingTypeToExtendedContentOverlayIconGlyph",["EchoMessageXMAFieldUtils","WAArmadilloXMA.pb","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Not a valid xmaGatingType: ",""]);h=function(){return a};return a}function a(a){switch(a){case d("EchoMessageXMAFieldUtils").XMAGatingType.INFO:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.INFO;case d("EchoMessageXMAFieldUtils").XMAGatingType.EYE_OFF:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.EYE_OFF;case d("EchoMessageXMAFieldUtils").XMAGatingType.NEWS_OFF:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.NEWS_OFF;case d("EchoMessageXMAFieldUtils").XMAGatingType.WARNING:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.WARNING;case d("EchoMessageXMAFieldUtils").XMAGatingType.PRIVATE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.PRIVATE;case d("EchoMessageXMAFieldUtils").XMAGatingType.NONE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.NONE;default:d("WALogger").ERROR(h(),a);return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.NONE}}g.convertXMAGatingTypeToExtendedContentOverlayIconGlyph=a}),98);
__d("MAWConvertXMALayoutTypeToExtendedContentXMLLayoutType",["EchoMessageXMAFieldUtils","WAArmadilloXMA.pb","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Not a valid xmaLayoutType: ",""]);h=function(){return a};return a}function a(a){switch(a){case d("EchoMessageXMAFieldUtils").XMALayoutType.SINGLE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.SINGLE;case d("EchoMessageXMAFieldUtils").XMALayoutType.PORTRAIT:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.PORTRAIT;case d("EchoMessageXMAFieldUtils").XMALayoutType.HSCROLL:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.HSCROLL;case d("EchoMessageXMAFieldUtils").XMALayoutType.STANDARD_DXMA:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.STANDARD_DXMA;case d("EchoMessageXMAFieldUtils").XMALayoutType.LIST_DXMA:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.LIST_DXMA;case d("EchoMessageXMAFieldUtils").XMALayoutType.GRID:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.GRID;default:d("WALogger").ERROR(h(),a);return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.SINGLE}}g.convertXMALayoutTypeToExtendedContentXMLLayoutType=a}),98);
__d("MAWConvertXMATargetTypeToExtendedContentTargetType",["EchoMessageXMAFieldUtils","WAArmadilloXMA.pb","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Not a valid xmaTargetType: ",""]);h=function(){return a};return a}function a(a){switch(a){case d("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_PHOTO_MENTION:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_MENTION;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_SINGLE_IMAGE_POST_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SINGLE_IMAGE_POST_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_MULTIPOST_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_MULTIPOST_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_SINGLE_VIDEO_POST_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SINGLE_VIDEO_POST_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_PHOTO_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_VIDEO_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_CLIPS_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_CLIPS_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_IGTV_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_IGTV_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_SHOP_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SHOP_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_PROFILE_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_PROFILE_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_PHOTO_HIGHLIGHT_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_HIGHLIGHT_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_VIDEO_HIGHLIGHT_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_HIGHLIGHT_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_REPLY:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_REPLY;case d("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_REACTION:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_REACTION;case d("EchoMessageXMAFieldUtils").XMAContentType.FB_FEED_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.FB_STORY_REPLY:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_REPLY;case d("EchoMessageXMAFieldUtils").XMAContentType.FB_STORY_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.FB_STORY_MENTION:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_MENTION;case d("EchoMessageXMAFieldUtils").XMAContentType.FB_FEED_VIDEO_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_VIDEO_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.FB_GAMING_CUSTOM_UPDATE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_GAMING_CUSTOM_UPDATE;case d("EchoMessageXMAFieldUtils").XMAContentType.FB_PRODUCER_STORY_REPLY:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_PRODUCER_STORY_REPLY;case d("EchoMessageXMAFieldUtils").XMAContentType.MSG_EXTERNAL_LINK_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE;case d("EchoMessageXMAFieldUtils").XMAContentType.RTC_AUDIO_CALL:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_AUDIO_CALL;case d("EchoMessageXMAFieldUtils").XMAContentType.RTC_VIDEO_CALL:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_VIDEO_CALL;case d("EchoMessageXMAFieldUtils").XMAContentType.RTC_MISSED_AUDIO_CALL:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_AUDIO_CALL;case d("EchoMessageXMAFieldUtils").XMAContentType.RTC_MISSED_VIDEO_CALL:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_VIDEO_CALL;case d("EchoMessageXMAFieldUtils").XMAContentType.RTC_GROUP_AUDIO_CALL:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_GROUP_AUDIO_CALL;case d("EchoMessageXMAFieldUtils").XMAContentType.RTC_GROUP_VIDEO_CALL:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_GROUP_VIDEO_CALL;case d("EchoMessageXMAFieldUtils").XMAContentType.FB_EVENT:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_EVENT;case d("EchoMessageXMAFieldUtils").XMAContentType.FB_SHORT:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_SHORT;case d("EchoMessageXMAFieldUtils").XMAContentType.MSG_RECEIVER_FETCH:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_RECEIVER_FETCH;case d("EchoMessageXMAFieldUtils").XMAContentType.MSG_LOCATION_SHARING:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_LOCATION_SHARING;case d("EchoMessageXMAFieldUtils").XMAContentType.MSG_LOCATION_SHARING_V2:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_LOCATION_SHARING_V2;case d("EchoMessageXMAFieldUtils").XMAContentType.MSG_MEMORIES_SHARE:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_MEMORIES_SHARE;default:d("WALogger").ERROR(h(),a);return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE}}g.convertXMATargetTypeToExtendedContentTargetType=a}),98);
__d("MAWDbAddDeviceChangeAlertsTxn",[],(function(a,b,c,d,e,f){"use strict";function a(a,b){return a.deviceChangeAlerts.add(b)}f.addDeviceChangeAlertsTxn=a}),66);
__d("MAWDbDeviceChangeAlerts",[],(function(a,b,c,d,e,f){"use strict";b="add";c="keyChange";d="remove";function a(a){return a}f.ADD=b;f.KEY_CHANGE=c;f.REMOVE=d;f.unsafeCoerceToDeviceChangeAlertsID=a}),66);
__d("MAWDbRavenActionTxns",["FBLogger","MAWBridgeTypesCreators","MAWDbMsg","MAWIndexedDb","MAWMsg","MAWRavenUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,e){return a.messages.where("externalId").equals(b.ravenActionToMsgExternalId).filter(function(a){return a.threadJid===e.jid}).first().then(function(f){var g=f==null?void 0:f.msgId;if(g==null){c("FBLogger")("maw_incoming_handlers").warn("[MAWDbRavenActionTxns] Cannot Write Raven Action without ID of Raven Message.");return}return h(a,f).then(function(c){var d=babelHelpers["extends"]({msgId:g,threadJid:e.jid},b);return a.unrenderedMessages.add(d).then(function(a){return babelHelpers["extends"]({rowId:a},d)})}).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"RavenActionUpdate",value:d("MAWBridgeTypesCreators").createBridgeRavenAction(a)});return})})}function h(a,b){if((b==null?void 0:b.type)!=="Raven")throw c("FBLogger")("messenger_web").mustfixThrow("Cannot Modify Message because Message is not Raven Message");var e=[d("MAWMsg").MAWRavenMsgEphemeralMediaState.cast(Number(b.ravenEphemeralMediaState)),d("MAWMsg").MAWRavenMsgEphemeralType.cast(Number(b.ravenEphemeralType))],f=e[0];e=e[1];if(f==null||e==null)throw c("FBLogger")("messenger_web").mustfixThrow("ravenEphemeralMediaStateEnum or ravenEphemeralTypeEnum is null");f=d("MAWRavenUtils").getNextRavenMessageEphemeralState(f,e);return a.messages.put(babelHelpers["extends"]({},b,{ravenEphemeralMediaState:f}))}function b(a,b,c){c=d("MAWDbMsg").isRavenActionMsgType(c)&&(b==null?void 0:b.externalId)!=null?[b.externalId]:[];return a.messages.where("externalId").anyOf(c).filter(function(a){return a.author===(b==null?void 0:b.author)&&a.threadJid===(b==null?void 0:b.chat)}).first()}g.writeRavenActionMsg=a;g.modifyRavenMsgWithActionMsg=h;g.maybeGetRavenMsgQueryByProtocolMsgId=b}),98);
__d("MAWJobPersistenceAccessorsApi",["MAWJobActionsV2","MAWJobsIndexedDb","MAWTransactionMode"],(function(a,b,c,d,e,f,g){"use strict";function a(){var a,b,c;return{deletePersistedJob:(a=d("MAWJobsIndexedDb")).makeJobsTransactor("jobs",(b=d("MAWTransactionMode")).READWRITE,"deletePersistedJob")((c=d("MAWJobActionsV2")).deletePersistedJob),loadAllJobs:a.makeJobsTransactor("jobs",b.READONLY,"loadAllJobs")(c.readAllPersistedJobs),maybeCreateJob:a.makeJobsTransactor("jobs",b.READWRITE,"maybeCreateJob")(c.maybeCreateJob),readPersistedJob:a.makeJobsTransactor("jobs",b.READONLY,"readPersistedJob")(c.readPersistedJob),updatePersistedJob:a.makeJobsTransactor("jobs",b.READWRITE,"updatePersistedJob")(c.updatePersistedJob)}}g.getJobPersistenceAccessors=a}),98);
__d("WAJobPriorityBucket",["WAJobOrchestratorTypes","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Assertion failed::markJobTaskDone found jobId: "," in scheduled tasks"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Assertion failed::markJobTaskPending found jobId: "," in pending tasks"]);i=function(){return a};return a}a=function(){function a(a){this.tasks=[];this.pendingTasks=[];this.lastJobStartedTimestampMs=null;this.jobMaxConcurrency=(a=a.jobMaxConcurrencyMap)!=null?a:{}}var b=a.prototype;b.updateConfig=function(a){this.jobMaxConcurrency=(a=a.jobMaxConcurrencyMap)!=null?a:{}};b.getStats=function(){return[].concat(this.tasks,this.pendingTasks).reduce(function(a,b){var c;c=(c=a[b.jobName])!=null?c:0;a[b.jobName]=c+1;return a},{})};b.next=function(){var a=this;if(this.tasks.length===0)return null;var b=this.pendingTasks.reduce(function(a,b){var c;c=(c=a.get(b.jobName))!=null?c:0;a.set(b.jobName,c+1);return a},new Map()),c=this.tasks.filter(function(c){var e;return((e=b.get(c.jobName))!=null?e:0)<((e=a.jobMaxConcurrency[c.jobName])!=null?e:d("WAJobOrchestratorTypes").DEFAULT_CONCURRENCY)});return c.length>0?[c[0]]:null};b.add=function(a,b,c,d){c={jobId:c,jobInfo:b,jobName:a,run:d};this.tasks.push(c);return c};b.markJobTaskPending=function(a){this.pendingTasks.includes(function(b){return b.jobId===a.jobId})&&d("WALogger").ERROR(i(),a.jobId).sendLogs("JobOrchestrator::markJobTaskPending"),this.lastJobStartedTimestampMs=Date.now(),this.pendingTasks.push(a),this.tasks=this.tasks.filter(function(b){return b.jobId!==a.jobId})};b.markJobTaskDone=function(a){this.pendingTasks=this.pendingTasks.filter(function(b){return b.jobId!==a}),this.tasks.includes(function(b){return b.jobId===a})&&d("WALogger").ERROR(h(),a).sendLogs("JobOrchestrator::markJobTaskDone")};b.count=function(){return this.tasks.length};b.pendingCount=function(){return this.pendingTasks.length};b.clearWaitingTasks=function(){this.tasks=[]};b.clear=function(){this.tasks=[],this.pendingTasks=[]};b.getLastJobStartedTimestamp=function(){return this.lastJobStartedTimestampMs};return a}();b=function(a){babelHelpers.inheritsLoose(b,a);function b(){return a.apply(this,arguments)||this}var c=b.prototype;c.next=function(){var a=this,b,c;if(this.tasks.length===0)return null;var d=this.pendingTasks.reduce(function(a,b){var c;c=(c=a.get(b.jobName))!=null?c:0;a.set(b.jobName,c+1);return a},new Map()),e=this.tasks.filter(function(b){var c;return((c=d.get(b.jobName))!=null?c:0)<((c=a.jobMaxConcurrency[b.jobName])!=null?c:1)});if(e.length===0)return null;b=(b=this.jobMaxConcurrency[e[0].jobName])!=null?b:1;c=(c=d.get(e[0].jobName))!=null?c:0;if(b>1&&c<b){var f=e.filter(function(a){return a.jobName===e[0].jobName});b=Math.min(f.length,b-c);return f.slice(0,b)}return[e[0]]};return b}(a);g.BaseJobBucket=a;g.LowJobBucket=b}),98);
__d("WAMetrics",["Promise","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(){var a=d("WATimeUtils").performanceAbsoluteNow();return new(h||(h=b("Promise")))(function(b){setTimeout(function(){b(d("WATimeUtils").performanceAbsoluteNow()-a)},0)})}g.getEventLoopDelay=a}),98);
__d("WAConcurrentBucketJobQueue",["Promise","WABase64","WACustomError","WAJobOrchestratorTypes","WAJobPriorityBucket","WALogger","WAMetrics","WANullthrows","WAPromiseTimeout","asyncToGeneratorRuntime","err"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[job-orchestator]: "," exceeding the timeout, release the thread."]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[job-orchestator]: updated WAConcurrentBucketJobQueue config"]);j=function(){return a};return a}var k=30,l=new Map([[d("WAJobOrchestratorTypes").JOB_PRIORITY.HIGH,5],[d("WAJobOrchestratorTypes").JOB_PRIORITY.LOW,1]]);a=function(){function a(){this.$1=!1,this.$2=0,this.$3=0,this.$4=0,this.$5=new Map(),this.$6=new Map(),this.$7=new Map(),this.$9=0}var e=a.prototype;e.init=function(a,b){var e,f,g;if(this.$1)throw c("err")("WAConcurrentBucketJobQueue has already initialized");this.$4=(e=a==null?void 0:a.bestEffortWaitTimeoutSec)!=null?e:k;this.$2=a.maxConcurrency;this.$3=a.maxConcurrency;this.$8=b;this.$7=this.$11(a==null?void 0:a.jobPrioritiesQuota);this.$6=new Map(this.$7);this.$5=new Map();this.$9=Date.now();b=new(d("WAJobPriorityBucket").BaseJobBucket)({jobMaxConcurrencyMap:(e=a.maxConcurrencyPerJob)!=null?e:{}});e=new(d("WAJobPriorityBucket").LowJobBucket)({jobMaxConcurrencyMap:(e=a.maxConcurrencyPerJob)!=null?e:{}});f=new(d("WAJobPriorityBucket").LowJobBucket)({jobMaxConcurrencyMap:(f=a.maxConcurrencyPerJob)!=null?f:{}});g=new(d("WAJobPriorityBucket").BaseJobBucket)({jobMaxConcurrencyMap:(g=a.maxConcurrencyPerJob)!=null?g:{}});a=new(d("WAJobPriorityBucket").BaseJobBucket)({jobMaxConcurrencyMap:(a=a.maxConcurrencyPerJob)!=null?a:{}});this.$5.set(d("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION,b);this.$5.set(d("WAJobOrchestratorTypes").JOB_PRIORITY.HIGH,b);this.$5.set(d("WAJobOrchestratorTypes").JOB_PRIORITY.OFFLINE,g);this.$5.set(d("WAJobOrchestratorTypes").JOB_PRIORITY.HISTORY_SYNC,a);this.$5.set(d("WAJobOrchestratorTypes").JOB_PRIORITY.LOW,e);this.$5.set(d("WAJobOrchestratorTypes").JOB_PRIORITY.BEST_EFFORT,f);this.$1=!0};e.updateConfig=function(a){this.$3+=a.maxConcurrency-this.$2,this.$2=a.maxConcurrency,this.$5.forEach(function(b){return b.updateConfig({jobMaxConcurrencyMap:(b=a.maxConcurrencyPerJob)!=null?b:{}})}),this.$7=this.$11(a==null?void 0:a.jobPrioritiesQuota),d("WALogger").LOG(j())};e.isInitialized=function(){return this.$1};e.clearQueue=function(){if(!this.$1)throw c("err")("WAConcurrentBucketJobQueue not initialized");this.$5.forEach(function(a){return a.clear()})};e.clearQueueByPriority=function(a){if(!this.$1)throw c("err")("WAConcurrentBucketJobQueue not initialized");(a=this.$5.get(a))==null?void 0:a.clearWaitingTasks()};e.getIntStats=function(){var a=this,b=function(b){var c;b=a.$5.get(b);return((c=b==null?void 0:b.count())!=null?c:0)+((c=b==null?void 0:b.pendingCount())!=null?c:0)};return{highPriorityBucketSize:b(d("WAJobOrchestratorTypes").JOB_PRIORITY.HIGH),lowPriorityBucketSize:b(d("WAJobOrchestratorTypes").JOB_PRIORITY.LOW),bestEffortPriorityBucketSize:b(d("WAJobOrchestratorTypes").JOB_PRIORITY.BEST_EFFORT)}};e.getStringStats=function(){var a=this,b=function(b){var c=(b=(b=a.$5.get(b))==null?void 0:b.getStats())!=null?b:{};b=Object.keys(c).reduce(function(a,b){var d=a[0];a=a[1];var e=c[b];return e>d?[e,b]:[d,a]},[0,null]);b=b[1];return b};return{highPriorityMaxJob:b(d("WAJobOrchestratorTypes").JOB_PRIORITY.HIGH),lowPriorityMaxJob:b(d("WAJobOrchestratorTypes").JOB_PRIORITY.LOW),bestEffortPriorityMaxJob:b(d("WAJobOrchestratorTypes").JOB_PRIORITY.BEST_EFFORT)}};e.enqueue=function(a,e,f,g){var i,j=this;if(!this.$1)return(h||(h=b("Promise"))).reject(c("err")("WAConcurrentBucketJobQueue not initialized"));var k,l,m=new(h||(h=b("Promise")))(function(a,b){k=a,l=b}),n=babelHelpers["extends"]({priority:d("WAJobOrchestratorTypes").DEFAULT_JOB_PRIORITY},f),o=this.getJobBucketByType(n.priority);if(!o)return(h||(h=b("Promise"))).reject(c("err")("WAConcurrentBucketJobQueue no bucket for job with name "+a+" was found."));void d("WAMetrics").getEventLoopDelay().then(function(a){(g==null?void 0:g.isActive())&&(g==null?void 0:g.addPoint("measure_event_loop_delay",{"int":{eventLoopDelay:a}}))});g==null?void 0:g.addPoint("scheduling_job",{string:babelHelpers["extends"]({},this.getStringStats(),{priority:n.priority}),"int":babelHelpers["extends"]({},this.getIntStats(),{maxTimeoutMs:(i=f==null?void 0:f.maxTimeoutMs)!=null?i:0})});var p=n.priority+"-"+a+"-"+((i=f==null?void 0:f.jobId)!=null?i:d("WABase64").randomBase64(8));i=o.add(a,n,p,b("asyncToGeneratorRuntime").asyncToGenerator(function*(){try{j.$8.logJobStarted(p);var a=(yield j.$12(e(),f==null?void 0:f.maxTimeoutMs));j.$8.logJobCompleted(p);k(a)}catch(a){a instanceof d("WACustomError").TimeoutError?j.$8.logJobTimeout(p):j.$8.logJobError(p),l(a)}}));this.$8.logJobCreated({jobId:p,jobName:a,jobPriority:n.priority,pendingJobsCount:o.count()});f&&f.priority===d("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION&&void this.$13(i);this.$14();return m};e.getAvailableThreadsCount=function(){return this.$3};e.getJobQuotaConfig=function(){return this.$7};e.getRemainingJobCountMap=function(){return this.$6};e.getJobBucketByType=function(a){return this.$5.get(a)};e.getSnapshot=function(a){a=this.getJobBucketByType(a);return!a?null:a.getStats()};e.$11=function(a){var b;!a?b=new Map(l):b=new Map(a);b.set(d("WAJobOrchestratorTypes").JOB_PRIORITY.BEST_EFFORT,0);return b};e.$15=function(a){return(a=this.$6.get(a))!=null?a:0};e.$16=function(){this.$6=new Map(this.$7)};e.$17=function(a){var b=this;a===void 0&&(a=!0);var c=0,e=null,f=0;this.$5.forEach(function(a,d){c+=a==null?void 0:a.count();f+=b.$15(d);if(e!=null)return;a.count()>0&&b.$15(d)>0&&(e=a)});var g=e==null||f===0;g&&this.$16();if(this.$18(c,g))return this.getJobBucketByType(d("WAJobOrchestratorTypes").JOB_PRIORITY.BEST_EFFORT);return e==null&&a?this.$17(!1):e};e.$18=function(a,b){var c=this;function e(a,b){var c=Date.now();return a>c?!1:c-a<b*1e3}function f(a,b){a=Math.ceil(a-Date.now())+b*1e3;return a>0?a:0}var g=this.getJobBucketByType(d("WAJobOrchestratorTypes").JOB_PRIORITY.BEST_EFFORT);a=a-((a=g==null?void 0:g.count())!=null?a:0);var h=g==null?void 0:g.getLastJobStartedTimestamp();if((g==null?void 0:g.count())===0)return!1;if(h==null&&e(this.$9,this.$4)){if(this.$10==null){g=f(this.$9,this.$4);this.$10=setTimeout(function(){c.$14(),c.$10=null},g)}return!1}return a>0&&h!=null&&e(h,this.$4)?!1:b};e.$19=function(a){a=this.$20(a);return c("WANullthrows")(this.$5.get(a))};e.$20=function(a){var b=a.split("-")[0];b=d("WAJobOrchestratorTypes").JOB_PRIORITY.cast(b);if(!b)throw c("err")("ConcurrentBucketQueue cannot extract known job priority type from id: "+a);return b};e.$21=function(a){a=this.$20(a);this.$15(a)>0?this.$6.set(a,this.$15(a)-1):this.$6.set(a,0)};e.$14=function(){var a=this;while(this.$3>0){var b=this.$17();b=b==null?void 0:b.next();if(b==null)break;b.forEach(function(b){a.$21(b.jobId),void a.$13(b)})}};e.$12=function(a,b){return b!==void 0?d("WAPromiseTimeout").promiseTimeout(a,b):a};e.$13=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=this,c=this.$19(a.jobId);this.$3--;c.markJobTaskPending(a);var e=a.run,f=a.jobId,g=a.jobName;try{yield this.$12(e(),((e=a.jobInfo)==null?void 0:e.maxTimeoutMs)===void 0?d("WAJobOrchestratorTypes").DEFAULT_JOB_TIMEOUT_MS:void 0)}catch(a){if(a instanceof d("WACustomError").TimeoutError)this.$8.logJobTimeout(f),d("WALogger").LOG(i(),g);else throw a}finally{this.$3++,c.markJobTaskDone(f),this.$3>0&&setTimeout(function(){return b.$14()},0)}});function c(b){return a.apply(this,arguments)}return c}();return a}();g.WAConcurrentBucketJobQueue=a}),98);
__d("WAConcurrentPreemptiveJobQueue",["Promise","WACustomError","WAJobOrchestratorTypes","WALogger","WAPromiseTimeout","WARandomHex","asyncToGeneratorRuntime","err"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Assertion failed::markJobTaskDone found jobId: "," in scheduled tasks"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Assertion failed::markJobTaskPending found jobId: "," in pending tasks"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[job-orchestator]: "," exceeding the timeout, release the thread."]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[job-orchestator]: updated ConcurrentPreemptiveJobQueue config"]);l=function(){return a};return a}a=function(){function a(){this.$1=!1,this.$2=0,this.$3=0,this.$4={},this.$5=[],this.$6=[]}var e=a.prototype;e.init=function(a,b){if(this.$1)throw c("err")("ConcurrentPreemptiveJobQueue has already initialized");this.$2=a.maxConcurrency;this.$3=a.maxConcurrency;this.$4=(a=a.maxConcurrencyPerJob)!=null?a:{};this.$7=b;this.$1=!0};e.updateConfig=function(a){this.$3+=a.maxConcurrency-this.$2;this.$2=a.maxConcurrency;this.$4=(a=a.maxConcurrencyPerJob)!=null?a:{};d("WALogger").LOG(l())};e.isInitialized=function(){return this.$1};e.clearQueueByPriority=function(a){if(!this.$1)throw c("err")("ConcurrentPreemptiveJobQueue not initialized");this.$5=this.$5.filter(function(b){return((b=b.jobInfo)==null?void 0:b.priority)!==a})};e.clearQueue=function(){if(!this.$1)throw c("err")("ConcurrentPreemptiveJobQueue not initialized");this.$5=[];this.$6=[]};e.enqueue=function(a,e,f){var g,i=this;if(!this.$1)return(h||(h=b("Promise"))).reject(c("err")("ConcurrentPreemptiveJobQueue not initialized"));var j,k,l=new(h||(h=b("Promise")))(function(a,b){j=a,k=b}),m=babelHelpers["extends"]({priority:d("WAJobOrchestratorTypes").DEFAULT_JOB_PRIORITY},f),n=(g=f==null?void 0:f.jobId)!=null?g:d("WARandomHex").randomHex(8).substr(0,64);g=this.$8(a,m,n,b("asyncToGeneratorRuntime").asyncToGenerator(function*(){try{i.$7.logJobStarted(n);var a=(yield i.$9(e(),f==null?void 0:f.maxTimeoutMs));i.$7.logJobCompleted(n);j(a)}catch(a){a instanceof d("WACustomError").TimeoutError?i.$7.logJobTimeout(n):i.$7.logJobError(n),k(a)}}));f&&f.priority===d("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION&&this.$10(g);this.$11();return l};e.getAvailableThreadsCount=function(){return this.$3};e.getJobMaxConcurrency=function(){return this.$4};e.getSnapshot=function(a){};e.$11=function(){while(this.$3>0){var a=this.$12();if(a==null)break;this.$10(a)}};e.$9=function(a,b){return b!==void 0?d("WAPromiseTimeout").promiseTimeout(a,b):a};e.$10=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=this;this.$3--;this.$13(a);var c=a.run,e=a.jobId,f=a.jobName;try{yield this.$9(c(),((c=a.jobInfo)==null?void 0:c.maxTimeoutMs)===void 0?d("WAJobOrchestratorTypes").DEFAULT_JOB_TIMEOUT_MS:void 0)}catch(a){if(a instanceof d("WACustomError").TimeoutError)this.$7.logJobTimeout(e),d("WALogger").LOG(k(),f);else throw a}finally{this.$3++,this.$14(e),setTimeout(function(){return b.$11()},0)}});function c(b){return a.apply(this,arguments)}return c}();e.$8=function(a,b,c,d){d={jobId:c,jobInfo:b,jobName:a,run:d};this.$7.logJobCreated({jobId:c,jobName:a,jobPriority:b.priority,pendingJobsCount:this.$5.length});this.$5.push(d);return d};e.$13=function(a){this.$6.includes(function(b){return b.jobId===a.jobId})&&d("WALogger").ERROR(j(),a.jobId).sendLogs("JobOrchestrator::markJobTaskPending"),this.$6.push(a),this.$5=this.$5.filter(function(b){return b.jobId!==a.jobId})};e.$14=function(a){this.$6=this.$6.filter(function(b){return b.jobId!==a}),this.$5.includes(function(b){return b.jobId===a})&&d("WALogger").ERROR(i(),a).sendLogs("JobOrchestrator::markJobTaskDone")};e.$12=function(){var a=this;if(this.$5.length===0)return null;var b=this.$6.reduce(function(a,b){var c;c=(c=a.get(b.jobName))!=null?c:0;a.set(b.jobName,c+1);return a},new Map()),c=this.$5.filter(function(c){var d;return((d=b.get(c.jobName))!=null?d:0)<((d=a.$4[c.jobName])!=null?d:1)});return c[0]};return a}();g.WAConcurrentPreemptiveJobQueue=a}),98);
__d("WADefaultJobNoQueue",["WAJobOrchestratorTypes","WARandomHex","asyncToGeneratorRuntime","err"],(function(a,b,c,d,e,f,g){"use strict";a=function(){function a(){this.$2=!1}var e=a.prototype;e.init=function(a,b){if(this.$2)throw c("err")("DefaultNoQueue has already initialized");this.$1=b;this.$2=!0};e.updateConfig=function(a){};e.isInitialized=function(){return this.$2};e.clearQueue=function(){};e.clearQueueByPriority=function(a){};e.getSnapshot=function(){throw c("err")("getSnapshot is not implemented for DefaultNoQueue")};e.enqueue=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c){var e;e=(e=c==null?void 0:c.jobId)!=null?e:d("WARandomHex").randomHex(8).substr(0,64);this.$1.logJobCreated({jobId:e,jobName:a,jobPriority:(a=c==null?void 0:c.priority)!=null?a:d("WAJobOrchestratorTypes").JOB_PRIORITY.LOW,pendingJobsCount:0});try{this.$1.logJobStarted(e);c=(yield b());this.$1.logJobCompleted(e);return c}catch(a){this.$1.logJobError(e);throw a}});function c(b,c,d){return a.apply(this,arguments)}return c}();return a}();g.WADefaultJobNoQueue=a}),98);
__d("WAOrchestratorJobStatsLogger",["WAGlobals","WAPREList","WAPREMetrics"],(function(a,b,c,d,e,f,g){"use strict";var h=function(){function a(a,b,c){this.jobName=a,this.pendingJobsCount=c,this.jobPriority=b}var b=a.prototype;b.logJobAdded=function(){this.webcJobAddedT=Date.now(),this.eventFlow=d("WAPREMetrics").startMetric(d("WAPREList").PRE_METRIC.WA_JOBS_ORCHESTRATOR,{string:{name:this.jobName,jobPriority:this.jobPriority,orchestratorVersion:d("WAGlobals").getConfig().orchestratorVersion()},"int":{pendingJobsCount:this.pendingJobsCount,addedAt:this.webcJobAddedT}})};b.logJobStarted=function(){this.webcJobStartedT=Date.now(),this.eventFlow.addPoint("start_job",{"int":{startedAt:this.webcJobStartedT}})};b.logJobCompleted=function(a){this.webcJobCompletedT=Date.now();this.jobResultType=a;var b={"int":{pendingJobsCount:this.pendingJobsCount,completedAt:this.webcJobCompletedT}};a==="completed"?this.eventFlow.endSuccess(b):this.eventFlow.endFail(a,b)};return a}();a=function(){function a(){this.$1=new Map()}var b=a.prototype;b.logJobCreated=function(a){var b=a.jobName,c=a.jobId,d=a.jobPriority;a=a.pendingJobsCount;b=new h(b,d,a);b.logJobAdded();this.$1.set(c,b)};b.logJobStarted=function(a){a=this.$1.get(a);a==null?void 0:a.logJobStarted()};b.logJobCompleted=function(a){this.$2(a,"completed")};b.logJobError=function(a){this.$2(a,"error")};b.logJobTimeout=function(a){this.$2(a,"timeout")};b.logJobAborted=function(a){this.$2(a,"aborted")};b.$2=function(a,b){var c=this.$1.get(a);c==null?void 0:c.logJobCompleted(b);this.$1["delete"](a)};return a}();g.JobInfoEvent=h;g.JobStatsLogger=a}),98);
__d("WAOrchestrator",["WAConcurrentBucketJobQueue","WAConcurrentPreemptiveJobQueue","WADefaultJobNoQueue","WAGlobals","WAJobOrchestratorTypes","WAOrchestratorJobStatsLogger"],(function(a,b,c,d,e,f,g){"use strict";function a(){var a={maxConcurrency:1},b="default",c={},e=a,f=new(d("WAOrchestratorJobStatsLogger").JobStatsLogger)();return function(g,j){var k;g===void 0&&(g=!1);g=g?b:d("WAGlobals").getConfig().orchestratorVersion();k=(k=i())!=null?k:a;var l;j==null?void 0:j.addPoint("get_orchestrator",{string:{orchestrator:g},"int":{maxConcurrency:k.maxConcurrency,highPriorityQuota:(j=(j=k.jobPrioritiesQuota)==null?void 0:j.get(d("WAJobOrchestratorTypes").JOB_PRIORITY.HIGH))!=null?j:0,lowPriorityQuota:(j=(j=k.jobPrioritiesQuota)==null?void 0:j.get(d("WAJobOrchestratorTypes").JOB_PRIORITY.LOW))!=null?j:0}});if(c[g]){h(e,k)&&(e=k,c[g].updateConfig(k));return c[g]}switch(g){case"preemptive":l=new(d("WAConcurrentPreemptiveJobQueue").WAConcurrentPreemptiveJobQueue)();break;case"bucket":l=new(d("WAConcurrentBucketJobQueue").WAConcurrentBucketJobQueue)();break;default:l=new(d("WADefaultJobNoQueue").WADefaultJobNoQueue)();break}l.init(k,f);c[g]=l;e=k;return l}}function h(a,b){var c;if(a.maxConcurrency!==b.maxConcurrency)return!0;if(((c=a.jobPrioritiesQuota)==null?void 0:c.size)!==((c=b.jobPrioritiesQuota)==null?void 0:c.size))return!0;return Object.keys((c=a.maxConcurrencyPerJob)!=null?c:{}).length!==Object.keys((c=b.maxConcurrencyPerJob)!=null?c:{}).length?!0:JSON.stringify(a)!==JSON.stringify(b)}function i(){var a={jobPrioritiesQuota:new Map([[d("WAJobOrchestratorTypes").JOB_PRIORITY.HIGH,5],[d("WAJobOrchestratorTypes").JOB_PRIORITY.LOW,1]]),maxConcurrency:5,maxConcurrencyPerJob:{}};return a}g.getInstanceDelegate=a}),98);
__d("WaJobInMemoryAccessors",["Promise","WARandomHex","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(){var a=-1,c=new Map();return{deletePersistedJob:function(a){return(h||(h=b("Promise"))).resolve(c["delete"](a))},loadAllJobs:function(){return(h||(h=b("Promise"))).resolve(Array.from(c.values()))},maybeCreateJob:function(e){var f,g=JSON.stringify([e.type,(f=e.uniqKey)!=null?f:d("WARandomHex").randomHex(32)]),i={backedOffCount:0,current:e.args,original:e.args,startTime:d("WATimeUtils").unixTime(),step:"$unstarted",stepFirstStartTime:null,stepHardStartCountAfterTimeout:0,stepUnexpectedErrorCount:0,type:e.type,uniqKey:g,version:e.version,waitUntil:null,scheduleConfig:e.scheduleConfig};f=function(){var d=a--,e=babelHelpers["extends"]({},i,{jobId:d});c.set(d,e);return(h||(h=b("Promise"))).resolve({id:d,newlyCreated:!0})};if(e.uniqKey!=null){e=Array.from(c.values()).filter(function(a){return a.uniqKey===g});if(e.length===0)return f();var j=null;e.forEach(function(a){a.step!=="$finished"?j=a:c["delete"](a.jobId)});return j!=null?(h||(h=b("Promise"))).resolve({id:j.jobId,newlyCreated:!1}):f()}return f()},readPersistedJob:function(a){a=c.get(a);return(h||(h=b("Promise"))).resolve(a&&babelHelpers["extends"]({},a))},updatePersistedJob:function(a){return(h||(h=b("Promise"))).resolve(c.set(a.jobId,babelHelpers["extends"]({},a)))}}}g.getJobInMemoryAccessors=a}),98);
__d("WAPersistedJobManagerV2",["Promise","WAGlobals","WAJids","WAJobOrchestratorTypes","WAJobRequirement","WALogger","WAOrchestrator","WAPREList","WAPREMetrics","WAPersistedJobManager","WAPromiseBackoffs","WAResolvable","WATimeUtils","WaJobInMemoryAccessors","asyncToGeneratorRuntime","err"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose([""," waiting on ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose([""," halting because of ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": running in persisted mode"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": running in forced non-persisted mode"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": running in persisted mode"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": running in forced non-persisted mode"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": running in persisted mode"]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": running in forced non-persisted mode"]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose([""," has been loaded and is marked as deprecated"]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["addPersistedJobImplementation called twice for ",""]);r=function(){return a};return a}function s(){var a=babelHelpers.taggedTemplateLiteralLoose(["onJobStarted for "," threw exception ",""]);s=function(){return a};return a}function t(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": "," step not found"]);t=function(){return a};return a}function u(){var a=babelHelpers.taggedTemplateLiteralLoose([""," failed with error ",""]);u=function(){return a};return a}function v(){var a=babelHelpers.taggedTemplateLiteralLoose(["onJobFinished for "," threw exception ",""]);v=function(){return a};return a}function w(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": finished job"]);w=function(){return a};return a}function x(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": Unhandled exception: ",""]);x=function(){return a};return a}function y(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": Unhandled exception. Tried "," times"]);y=function(){return a};return a}function z(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": RetryOnBackoff"]);z=function(){return a};return a}function A(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": delaying until ",""]);A=function(){return a};return a}function B(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": trim wait from "," to ",""]);B=function(){return a};return a}function C(){var a=babelHelpers.taggedTemplateLiteralLoose(["No implementation for ",".",""]);C=function(){return a};return a}function D(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": removing completed, expired job from db"]);D=function(){return a};return a}function E(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": skew detected, adjusting accordingly"]);E=function(){return a};return a}function F(){var a=babelHelpers.taggedTemplateLiteralLoose(["Running deprecated job ",""]);F=function(){return a};return a}function G(){var a=babelHelpers.taggedTemplateLiteralLoose(["No implementation for deprecated ",", job deleted"]);G=function(){return a};return a}function H(){var a=babelHelpers.taggedTemplateLiteralLoose(["No implementation for ",". Maybe it should have been put to the deprecated list?"]);H=function(){return a};return a}function I(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": InterruptJob"]);I=function(){return a};return a}function J(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": running step"]);J=function(){return a};return a}function K(){var a=babelHelpers.taggedTemplateLiteralLoose(["Persisted job missing for given ID"]);K=function(){return a};return a}function L(){var a=babelHelpers.taggedTemplateLiteralLoose(["[JOB MANAGER] Restarting job with the same id"]);L=function(){return a};return a}function M(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": stuck on the step ",", aborting the job"]);M=function(){return a};return a}var N=1;function O(a){var b=a.code,c=a.annotations;c=c===void 0?{}:c;a=a.eventFlow;var d=a===void 0?P(c):a;return b(d).then(function(a){d.endSuccess();return a})["catch"](function(a){d.endFail("error",{string:{error:""+a}});throw a})}function P(a){a===void 0&&(a={});return d("WAPREMetrics").startMetric(d("WAPREList").PRE_METRIC.WA_JOB_MANAGER,babelHelpers["extends"]({},a,{string:babelHelpers["extends"]({},(a=(a=a)==null?void 0:a.string)!=null?a:{},{userHash:d("WAGlobals").getDependencies().isEmployee()&&d("WAGlobals").getDependencies().isUseridAnnotationEnabled()?d("WAJids").extractUserId(d("WAGlobals").getMyUserJid()).slice(-5):null})}))}a=function(){function a(a){var c=this;this.$1=[];var e=a.isRestartAfterCrash,f=a.accessors,g=a.unfinishedJobEntries,i=a.ignoreForceNonPersistedJobList;this.getOrchestratorDelegate=d("WAOrchestrator").getInstanceDelegate();this.activeJobs=new Map();this.implementationLoaders=new Map();this.implementations=new Map();this.stepBlockers=new WeakMap();this.accessors=f;this.isRestartAfterCrash=e||!1;this.listeners=a.listeners;this.deprecatedJobs=a.deprecatedJobs;this.inMemoryAccessors=d("WaJobInMemoryAccessors").getJobInMemoryAccessors();this.offlineQueueMode=!0;this.$1=i;a.offlineQueueCompletePromise!=null?a.offlineQueueCompletePromise["finally"](function(){c.offlineQueueMode=!1}):this.offlineQueueMode=!1;this.initialJobsPromise=g.then(function(a){var e=[],f=[];a.forEach(function(a){a.stepHardStartCountAfterTimeout>=5?e.push(a):f.push(a)});return(h||(h=b("Promise"))).all(e.map(function(a){d("WALogger").ERROR(M(),R(a),a.step).devConsole(Q(a)).sendLogs("job-stuck-"+a.type);return c.accessors.deletePersistedJob(a.jobId)})).then(function(){f.forEach(function(a){var b=c.$2(a.jobId);if(b.alreadyActive===!0){d("WALogger").ERROR(L());return}b.deferred.resolve(O({code:function(b){return c.$3(a,c.accessors,{eventFlow:b})},annotations:{string:{name:a.type},bool:{offlineQueueMode:c.offlineQueueMode}}}))})})})}var e=a.prototype;e.$4=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e){var f;e===void 0&&(e={});var g=this.$2(a);(f=e.eventFlow)==null?void 0:f.addPoint("start_load_and_run",{bool:{skipped:g.alreadyActive}});if(g.alreadyActive===!0)return g.deferred;f=(yield b.readPersistedJob(a));if(f==null){d("WALogger").ERROR(K()).sendLogs("missing-job-entry");throw c("err")("Persisted job missing for given ID "+a)}g.deferred.resolve(this.$3(f,b,e));return g.deferred.promise});function e(b,c,d){return a.apply(this,arguments)}return e}();e.$3=function(a,b,c){var e;c===void 0&&(c={});(e=c.eventFlow)==null?void 0:e.addPoint("enqueueing_job",{string:{name:a.type}});return this.getOrchestratorDelegate(((e=a.scheduleConfig)==null?void 0:e.priority)===d("WAJobOrchestratorTypes").JOB_PRIORITY.SKIP,c.eventFlow).enqueue(a.type,this.$5(a,b,c),a.scheduleConfig,c.eventFlow)};e.$6=function(a,b,c){var d=this;c===void 0&&(c={});return b.maybeCreateJob(a).then(function(a){var e;a=a.id;(e=c.eventFlow)==null?void 0:e.addPoint("job_persisted",{"int":{jobId:a},bool:{nonPersisted:b===d.inMemoryAccessors}});return a})};e.$2=function(a){var b=this.activeJobs.get(a);if(b!=null)return{alreadyActive:!0,deferred:b};b=new(d("WAResolvable").Resolvable)();this.activeJobs.set(a,b.promise);return{alreadyActive:!1,deferred:b}};e.$5=function(a,b,c){var d=this;return function(){return d.$7(a,b,c)}};e.$8=function(a){var b=this.implementations,c=this.implementationLoaders,d=b.get(a);if(d)return d;d=c.get(a);if(!d)return null;c=d();b.set(a,c);return c};e.$9=function(a,c){if(c==null||c.length===0)return(h||(h=b("Promise"))).resolve();var e=this.stepBlockers,f=e.get(c);f==null&&(f=d("WAJobRequirement").joinRequirements(c.map(function(a){return a()}),T),e.set(c,f));return f(a)};e.$10=function(a,b,c,e,f){var g,h=this;f===void 0&&(f={});var i=a.step;(g=f.eventFlow)==null?void 0:g.addPoint("start_step");var j=b.findIndex(function(a){return a.stepName===i});g=b[j].info(a.current,a.original,U(a,this.isRestartAfterCrash));var k=g.requirements,l=g.code;g=this.$9(a,k);e&&(g=g.then(e));return g.then(function(){var b;d("WALogger").LOG(J(),S(a));(b=f.eventFlow)==null?void 0:b.addPoint("run_step");return l(a.current,a.original,U(a,h.isRestartAfterCrash,f.eventFlow))}).then(function(e){var g;(g=f.eventFlow)==null?void 0:g.addPoint("step_is_complete");if(e instanceof d("WAPersistedJobManager").InterruptJob){d("WALogger").LOG(I(),S(a));return e.result}g=j+1;if(g>=b.length)return e;g=b[g];a.step=g.stepName;a.current=e;a.stepHardStartCountAfterTimeout=0;a.stepFirstStartTime=d("WATimeUtils").unixTime();a.stepUnexpectedErrorCount=0;a.waitUntil=null;a.backedOffCount=0;return c.updatePersistedJob(a).then(function(){return h.$10(a,b,c,void 0,f)})})};e.$7=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,c,e){var f,g=this;e===void 0&&(e={});var i=this.activeJobs,j=this.deprecatedJobs,k=this.listeners,l=k.onJobFinished;k=k.onJobStarted;(f=e.eventFlow)==null?void 0:f.addPoint("run_job");f=(yield this.$8(a.type));j=j[a.type];if(!f){if(!j){d("WALogger").ERROR(H(),a.type).sendLogs("missing-job-implementation");yield c.deletePersistedJob(a.jobId);return null}else if(j==="NOOP"){d("WALogger").WARN(G(),a.type);yield c.deletePersistedJob(a.jobId);return null}f=(yield j())}var m=f;j&&d("WALogger").LOG(F(),a.type);var n=(j=a.stepFirstStartTime)!=null?j:d("WATimeUtils").unixTime();a.stepFirstStartTime=n;a.stepUnexpectedErrorCount=a.stepUnexpectedErrorCount||0;a.backedOffCount=a.backedOffCount||0;if(a.step===d("WAPersistedJobManager").FINISHED_JOB){j=a.waitUntil;var o=d("WATimeUtils").secondsUntil(n);j!=null&&d("WATimeUtils").isInFuture(j)&&o>0&&(d("WALogger").LOG(E(),Q(a)),j=d("WATimeUtils").castToUnixTime(j-o),d("WATimeUtils").isInFuture(j)&&(a.stepFirstStartTime=d("WATimeUtils").castToUnixTime(n-o),a.waitUntil=j,yield c.updatePersistedJob(a)));(j==null||!d("WATimeUtils").isInFuture(j))&&(d("WALogger").LOG(D(),Q(a)),yield c.deletePersistedJob(a.jobId));i["delete"](a.jobId);return a.current}o=a.step!==d("WAPersistedJobManager").UNSTARTED_JOB?f.find(function(b){return b.stepName===a.step}):f[0];if(!o){d("WALogger").ERROR(C(),a.type,a.step).sendLogs("missing-job-step");yield c.deletePersistedJob(a.jobId);return null}a.step=o.stepName;j=function f(){var i=a.waitUntil,j=(h||(h=b("Promise"))).resolve();if(i!=null){var k=d("WATimeUtils").futureUnixTime(d("WATimeUtils").DAY_SECONDS);i>k?(d("WALogger").LOG(B(),S(a),i,k),a.waitUntil=k,j=c.updatePersistedJob(a).then(function(){return d("WATimeUtils").delayUntil(k)})):(d("WALogger").LOG(A(),S(a),i),j=d("WATimeUtils").delayUntil(i))}return j.then(function(){var b=function(){a.waitUntil=null;d("WATimeUtils").happenedWithin(n,d("WATimeUtils").DAY_SECONDS)||a.stepHardStartCountAfterTimeout++;return c.updatePersistedJob(a)};return g.$10(a,m,c,b,e)["catch"](function(b){if(b instanceof d("WAPersistedJobManager").RetryOnBackoff){var g;d("WALogger").LOG(z(),S(a));(g=e.eventFlow)==null?void 0:g.addPoint("retry_on_backoff");g=d("WAPromiseBackoffs").getDelay(++a.backedOffCount,b.backoffOptions);a.waitUntil=d("WATimeUtils").futureUnixTime(Math.ceil(g/1e3));a.stepHardStartCountAfterTimeout>0&&--a.stepHardStartCountAfterTimeout;return c.updatePersistedJob(a).then(f)}else{if(!(b instanceof d("WAPersistedJobManager").NonRetryableError)&&a.stepUnexpectedErrorCount<N){(g=e.eventFlow)==null?void 0:g.addPoint("retry_on_unexpected_error");d("WALogger").WARN(y(),S(a),a.stepUnexpectedErrorCount);d("WALogger").WARN(x(),S(a),b);a.stepUnexpectedErrorCount++;return c.updatePersistedJob(a).then(f)}throw b}})})};var p=j();f=p.then(function(){var e=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){d("WALogger").LOG(w(),S(a));var e=null;try{e=l(a.jobId,a.type,a.original,b)}catch(b){d("WALogger").ERROR(v(),a.type,b).sendLogs("onJobFinished-threw")}e!=null&&e>0?(a.waitUntil=d("WATimeUtils").futureUnixTime(Math.ceil(e/1e3)),a.step=d("WAPersistedJobManager").FINISHED_JOB,a.current=b,a.stepFirstStartTime=d("WATimeUtils").unixTime(),yield c.updatePersistedJob(a)):(yield c.deletePersistedJob(a.jobId),i["delete"](a.jobId))});return function(a){return e.apply(this,arguments)}}(),function(){var e=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){d("WALogger").ERROR(u(),a.type,b).sendLogs("job-threw-exception-"+a.type);b=m.find(function(b){return b.stepName===a.step});if(!b)d("WALogger").ERROR(t(),a.type,a.step);else{b=b.info(a.current,a.original,U(a,g.isRestartAfterCrash));b.stopRetryIf!=null&&(yield b.stopRetryIf.onStopRetry(a.current,a.original,U(a,g.isRestartAfterCrash)))}yield c.deletePersistedJob(a.jobId);i["delete"](a.jobId)});return function(a){return e.apply(this,arguments)}}());try{k(a.jobId,a.type,a.original)}catch(b){d("WALogger").ERROR(s(),a.type,b).sendLogs("onJobStarted-threw")}return f.then(function(){return p})});function c(b,c,d){return a.apply(this,arguments)}return c}();e.addPersistedJobImplementation=function(a,b){var c=this.implementationLoaders,e=this.deprecatedJobs;if(c.has(a)){d("WALogger").ERROR(r(),a).sendLogs("repeat-job-loader");return}e&&e[a]&&d("WALogger").DEV(q(),a);c.set(a,b)};e.fireAndForget=function(a){var c=this;if(this.$1.indexOf(a.type)===-1){d("WALogger").LOG(p(),a.type);this.fireAndForgetNonPersisted(a);return}d("WALogger").LOG(o(),a.type);O({code:function(){var d=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){var d={eventFlow:b};yield c.initialJobsPromise;b.addPoint("initial_jobs_promise_fulfilled");return c.$6(a,c.accessors,d).then(function(a){return c.$4(a,c.accessors,d)})});function e(a){return d.apply(this,arguments)}return e}(),annotations:{string:{name:a.type},bool:{offlineQueueMode:this.offlineQueueMode}}})};e.waitUntilPersisted=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var c=this;if(this.$1.indexOf(a.type)===-1){d("WALogger").LOG(n(),a.type);this.fireAndForgetNonPersisted(a);return(h||(h=b("Promise"))).resolve()}d("WALogger").LOG(m(),a.type);var e=P({string:{name:a.type},bool:{offlineQueueMode:this.offlineQueueMode}});yield this.initialJobsPromise;e.addPoint("initial_jobs_promise_fulfilled");return this.$6(a,this.accessors,{eventFlow:e}).then(function(a){O({code:function(b){b={eventFlow:b};return c.$4(a,c.accessors,b)},eventFlow:e})})["catch"](function(a){e.endFail("error",{string:{error:""+a}});throw a})});function c(b){return a.apply(this,arguments)}return c}();e.waitUntilCompleted=function(a){var c=this;if(this.$1.indexOf(a.type)===-1){d("WALogger").LOG(l(),a.type);return this.waitUntilCompletedNonPersisted(a)}d("WALogger").LOG(k(),a.type);return O({code:function(){var d=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){var d={eventFlow:b};yield c.initialJobsPromise;b.addPoint("initial_jobs_promise_fulfilled");return c.$6(a,c.accessors,d).then(function(a){return c.$4(a,c.accessors,d)})});function e(a){return d.apply(this,arguments)}return e}(),annotations:{string:{name:a.type},bool:{offlineQueueMode:this.offlineQueueMode}}})};e.fireAndForgetNonPersisted=function(a){var c=this;O({code:function(){var d=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){var d={eventFlow:b};yield c.initialJobsPromise;b.addPoint("initial_jobs_promise_fulfilled");return c.$6(a,c.inMemoryAccessors,d).then(function(a){return c.$4(a,c.inMemoryAccessors,d)})});function e(a){return d.apply(this,arguments)}return e}(),annotations:{string:{name:a.type},bool:{offlineQueueMode:this.offlineQueueMode}}})};e.waitUntilCompletedNonPersisted=function(a){var c=this;return O({code:function(){var d=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){var d={eventFlow:b};yield c.initialJobsPromise;b.addPoint("initial_jobs_promise_fulfilled");return c.$6(a,c.inMemoryAccessors,d).then(function(a){return c.$4(a,c.inMemoryAccessors,d)})});function e(a){return d.apply(this,arguments)}return e}(),annotations:{string:{name:a.type},bool:{offlineQueueMode:this.offlineQueueMode}}})};return a}();function Q(a){return"Job["+a.jobId+"] ("+a.type+")"}function R(a){return"[Job "+a.type+"] "}function S(a){return"Job["+a.jobId+"] ("+a.type+"."+a.step+")"}function T(a,b,c){a==="unsatisfiable"?d("WALogger").LOG(j(),S(c),b):a==="unsatisfied"?d("WALogger").LOG(i(),S(c),b):a}function U(a,b,c){b===void 0&&(b=!1);return{jobStartTime:a.startTime,afterCrash:b,interruptJob:V,eventFlow:c}}function V(a){return new(d("WAPersistedJobManager").InterruptJob)(a)}g.PersistedJobManager=a}),98);
__d("MAWJobManager",["MAWBridge","MAWDefinePersistedJob","MAWJobPersistenceAccessorsApi","WAPersistedJobManagerV2","WAWaitForComms","WAWaitForUserUnblocked","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";var h=new(d("WAPersistedJobManagerV2").PersistedJobManager)({accessors:d("MAWJobPersistenceAccessorsApi").getJobPersistenceAccessors(),deprecatedJobs:{removeCurrentDevice:"NOOP"},ignoreForceNonPersistedJobList:["sendMsg","sendBumpMsg","sendReactionMsg","sendMediaMsg","sendWrittenMsg","downloadAndHandleMedia"],isRestartAfterCrash:!1,listeners:{onJobFinished:function(a,b,c,e){d("MAWBridge").getBridge().fireAndForget("event","onJobFinished",{id:a,originalArgs:c,result:e,type:b},!0);return null},onJobStarted:c("emptyFunction")},offlineQueueCompletePromise:d("WAWaitForUserUnblocked").waitForUserUnblocked(),unfinishedJobEntries:d("WAWaitForComms").waitForComms().then(function(){return d("MAWJobPersistenceAccessorsApi").getJobPersistenceAccessors().loadAllJobs()})});function a(){return d("MAWDefinePersistedJob").persistedJobsApi}function b(){return h}g.getPersistedJobsApi=a;g.getJobManager=b}),98);
__d("WAJobBuilder",["Promise","WAPersistedJobManager","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h,i=function(){function a(a){this.steps=a}var b=a.prototype;b.step=function(a,b){return this.$1(a,typeof b==="function"?{code:b}:b)};b.$1=function(b,c){var e=c.stopRetryIf,f=c.requirements;c=c.code;f=k(f,c,e);if(e){var g=e.timePassedSeconds;c=e.appCrashed;var h=e.onStopRetry;h=k(null,l(h),e);g!=null&&(f=j(function(a,b,c){a=c.jobStartTime;return d("WATimeUtils").happenedWithin(a,g)},f,h));c&&(f=j(function(a,b,c){a=c.afterCrash;return!a},f,h))}return new a([].concat(this.steps,[{stepName:b,info:f}]))};b.finalStep=function(a,b){var c=this.step(a,b);return{end:function(){return c.steps}}};return a}();function a(){return new i([])}function j(a,b,c){return function(d,e,f){return a(d,e,f)?b(d,e,f):c(d,e,f)}}function k(a,b,c){var d={requirements:a,code:b,stopRetryIf:c};return function(){return d}}function l(a){return function(c,e,f){return(h||(h=b("Promise"))).resolve(a(c,e,f)).then(function(a){return a instanceof d("WAPersistedJobManager").InterruptJob?a:new(d("WAPersistedJobManager").InterruptJob)(a)})}}g.JobBuilder=i;g.definePersistedJob=a}),98);
__d("MAWDefinePersistedJob",["MAWJobManager","Promise","WAJobBuilder"],(function(a,b,c,d,e,f,g){"use strict";var h;e={definePersistedJob:function(){return d("WAJobBuilder").definePersistedJob()}};function a(a){var c=d("MAWJobManager").getJobManager();Object.keys(a).forEach(function(d){var e=a[d];c.addPersistedJobImplementation(d,function(){return(h||(h=b("Promise"))).resolve(e)})})}function c(a){var b=d("MAWJobManager").getJobManager();Object.keys(a).forEach(function(c){var d=a[c];b.addPersistedJobImplementation(c,d)})}g.persistedJobsApi=e;g.setMsgrJobImplementations=a;g.setMsgrDeferredJobImplementations=c}),98);
__d("MAWEchoToProtobufConversionLoggingUtils",["QPLUserFlow","qpl"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){c("QPLUserFlow").start(c("qpl")._(521484676,"2684"),{annotations:b,instanceKey:a})}function b(a,b,d){c("QPLUserFlow").endFailure(c("qpl")._(521484676,"2684"),b,{annotations:d,instanceKey:a})}function d(a,b){c("QPLUserFlow").endSuccess(c("qpl")._(521484676,"2684"),{annotations:b,instanceKey:a})}function e(a,b,d){d&&c("QPLUserFlow").addAnnotations(c("qpl")._(521484676,"2684"),d,{instanceKey:a}),c("QPLUserFlow").addPoint(c("qpl")._(521484676,"2684"),b,{instanceKey:a})}g.startQplUserFlow=a;g.endFailure=b;g.endSuccess=d;g.addPoint=e}),98);
__d("MAWGetMsgForProtocolMsgIdTxn",["MAWDbMsgTxns","MAWIndexedDb","MAWTransactionMode","WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor({messages:d("MAWTransactionMode").READONLY,threads:d("MAWTransactionMode").READONLY},"getMsgForProtocolMsgIdTxn",function(a){return function(b){return d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,b).then(function(a){return a!=null?d("WAResultOrError").makeResult(a):d("WAResultOrError").makeError("message-not-found")})}});g.getMsgForProtocolMsgIdTxn=a}),98);
__d("MAWHandleXmaTransactionUtil",["MAWBridgeXMA","MAWDbChunkTxns","MAWDexieCastToPromise","MAWDexieTable","MAWIndexedDb","MAWTransactionMode","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){return h.apply(this,arguments)}function h(){h=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){var c=!1;a!=null&&b.defaultPreviewMediaId===a.mediaId&&(c=(yield l(a)));return d("MAWBridgeXMA").createBridgeXMA(a,b,{hasMedia:c,hasXmaFaviconMedia:!1,hasXmaHeaderMedia:!1})});return h.apply(this,arguments)}function c(a,b,c){return i(a,b,c).then(function(a){return d("MAWIndexedDb").afterTransaction({tag:"NewXMA",value:a})})}function i(a,b,c){a=c==null?d("MAWDexieTable").dexieResolve(!1):d("MAWDbChunkTxns").hasMediaChunk(a,c.hashedPlaintextHash);return a.then(function(a){return d("MAWBridgeXMA").createBridgeXMA(c,b,{hasMedia:a,hasXmaFaviconMedia:!1,hasXmaHeaderMedia:!1})})}function e(a,b,c,e,f){return j(a,b,c,e,f).then(function(a){return d("MAWIndexedDb").afterTransaction({tag:"NewXMA",value:a})})}function j(a,b,c,e,f){e=k(c,e,f,a);return e.then(function(a){var e=a.hasMedia,f=a.hasXmaFaviconMedia;a=a.hasXmaHeaderMedia;return d("MAWBridgeXMA").createBridgeXMA(c,b,{hasMedia:e,hasXmaFaviconMedia:f,hasXmaHeaderMedia:a})})}function k(a,b,c,e){if(a!=null||b!=null||c!=null){var f=[a,b,c].filter(Boolean).map(function(a){return a.hashedPlaintextHash});return d("MAWDbChunkTxns").hasMediaChunks(e,f).then(function(d){return{hasMedia:a!=null&&d.get(a.hashedPlaintextHash)===!0,hasXmaFaviconMedia:b!=null&&d.get(b.hashedPlaintextHash)===!0,hasXmaHeaderMedia:c!=null&&d.get(c.hashedPlaintextHash)===!0}})}else return d("MAWDexieTable").dexieResolve({hasMedia:!1,hasXmaFaviconMedia:!1,hasXmaHeaderMedia:!1})}function f(a,b,c,e,f){return d("MAWDexieCastToPromise").dexieCastToPromise(k(a,b,c,f).then(function(b){var c=b.hasMedia,f=b.hasXmaFaviconMedia;b=b.hasXmaHeaderMedia;return d("MAWBridgeXMA").createBridgeXMA(a,e,{hasMedia:c,hasXmaFaviconMedia:f,hasXmaHeaderMedia:b})}))}var l=d("MAWIndexedDb").makeMsgrTransactor({chunk:d("MAWTransactionMode").READONLY},"MAWHandleXmaTransactionUtil.hasMediaChunkTransaction",function(a){return function(b){return d("MAWDbChunkTxns").hasMediaChunk(a,b.hashedPlaintextHash)}});g.checkMediaChunkTransactionAndCreatedBridgeXma=a;g.checkMediaChunkAndHandleXmaAfterTransaction=c;g.checkMediaChunkAndCreatedBridgeXma=i;g.checkAllMediaChunksAndHandleXmaAfterTransaction=e;g.checkAllMediaChunksAndCreateBridgeXma=j;g.verifyAllMediaChunksForXMA=k;g.checkAllMediaChunksAndCreateBridgeXma_DEPRECATED=f}),98);
__d("MAWVideoAudioValidationUtils",[],(function(a,b,c,d,e,f){"use strict";function a(a){return{audioAvgBitsPerSecond:a.audioAvgBitsPerSecond!=null?Math.round(a.audioAvgBitsPerSecond):null,audioNumberOfChannels:a.audioNumberOfChannels!=null?Math.round(a.audioNumberOfChannels):null,audioSamplingRate:a.audioSamplingRate!=null?Math.round(a.audioSamplingRate):null,audioStreamType:a.audioStreamType,validatedMimeType:a.validatedMimeType,videoAvgBitsPerSecond:a.videoAvgBitsPerSecond!=null?Math.round(a.videoAvgBitsPerSecond):null,videoCalculatedFps:a.videoCalculatedFps!=null?Math.round(a.videoCalculatedFps):null,videoDuration:a.videoDuration!=null?Math.round(a.videoDuration):null,videoHeight:a.videoHeight!=null?Math.round(a.videoHeight):null,videoNominalFps:a.videoNominalFps!=null?Math.round(a.videoNominalFps):null,videoStreamType:a.videoStreamType,videoWidth:a.videoWidth!=null?Math.round(a.videoWidth):null}}f.normalizeValidationResult=a}),66);
__d("MAWHandleMediaDownloadApi",["MAWBridgeMsg","MAWBridgeTypesCreators","MAWDbChunkTxns","MAWDbMedia","MAWDbMediaTxns","MAWDbMsgTxns","MAWDbXMATxns","MAWDexieTable","MAWGetMsgQuoteTxn","MAWHandleXmaTransactionUtil","MAWIndexedDb","MAWLegacyMediaDownloadManager","MAWLoadReplyMediaTxns","MAWLoggerUtils","MAWMediaAfterTxns","MAWMediaUtils","MAWMsgType","MAWTransactionMode","MAWVideoAudioValidationUtils","MAWXMAUtils","MWFBLogger","Promise","WAArmadilloXMA.pb","WAResultOrError","gkx"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["resolve MediaPlaintextDownloadManager promise"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Media is null when storing downloaded blob"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["start persisting media blob"]);k=function(){return a};return a}var l=d("MWFBLogger").MWMediaLogger.tags([d("MAWLoggerUtils").Tag.MediaDownload,d("MAWLoggerUtils").Tag.MessageReceive]);e=d("MAWIndexedDb").makeMsgrTransactor({chunk:(a=d("MAWTransactionMode")).READWRITE,media:a.READWRITE,messages:a.READONLY,receiverFetchInfo:a.READONLY,threads:a.READONLY,xma:a.READONLY},"handleMediaDownload",function(a){return function(e,f,g,o,p){l.DEBUG(k());var q=d("MAWMediaUtils").genHMACPlaintextHash(e);return d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,o),a.media.where("hashedPlaintextHash").equals(q).first(),d("MAWDbChunkTxns").getOrCreateMediaChunkWithPlaintextHash(a,e,g,f)]).then(function(k){var o=k[0],q=k[1];k[2];if(q==null){l.MUSTFIX(j());return d("WAResultOrError").makeError("missing-media-on-save")}var r;k=!1;r=d("MAWLegacyMediaDownloadManager").getFromMediaPlaintextDownloadManager(e);r==null&&!c("gkx")("6417")&&(r=d("MAWLegacyMediaDownloadManager").getFromMediaDownloadManager(q.mediaId),k=!0);r!=null&&(l.DEBUG(i()),r((h||(h=b("Promise"))).resolve(new Blob([g],{type:f}))),d("MAWLegacyMediaDownloadManager").removeFromMediaPlaintextDownloadManager(e),k&&d("MAWLegacyMediaDownloadManager").removeFromMediaDownloadManager(q.mediaId));return m(a,o).then(function(b){if(!b)return a.messages.where("msgId").anyOf(q.msgIds).toArray().then(function(b){a.threads.where("jid").anyOf(b.map(function(a){return a.threadJid})).toArray().then(function(c){c.forEach(function(c){if(c!=null){var e=d("MAWMediaUtils").createHdTypesForBridgeMedia(b);c=d("MAWBridgeTypesCreators").createBridgeMedia({chatJid:c.jid,filteredMsgIds:d("MAWBridgeTypesCreators").getMsgIdsFilteredByJid(b,c.jid),hasMediaForUI:!0,hdTypes:e,media:q,sortOrderMs:o==null?void 0:o.sortOrderMs});d("MAWMediaAfterTxns").handleNewMediaAfterTxnWithBridgeMedia(a,c,b)}})});return b}).then(function(b){return n(a,b)});else return a.messages.where("msgId").anyOf(q.msgIds).toArray().then(function(b){a.threads.where("jid").anyOf(b.map(function(a){return a.threadJid})).toArray().then(function(c){c.forEach(function(c){if(c!=null)return d("MAWDbXMATxns").getXMAFromMsgs(a,b).then(function(b){return d("MAWDexieTable").dexieAll(b.map(function(b){if(d("MAWXMAUtils").isXMAStoryReply(b.targetType))return;if(b.defaultPreviewMediaId!==q.mediaId)return;return d("MAWHandleXmaTransactionUtil").checkMediaChunkAndHandleXmaAfterTransaction(a,b,q)}))})})});return b}).then(function(b){return n(a,b)})}).then(function(){var b;b=q.mediaType===d("MAWDbMedia").MEDIA_TYPE.VIDEO?d("MAWVideoAudioValidationUtils").normalizeValidationResult({audioAvgBitsPerSecond:p==null?void 0:(b=p.audioStreamReport)==null?void 0:b.avgBitsPerSecond,audioNumberOfChannels:p==null?void 0:(b=p.audioStreamReport)==null?void 0:b.numberOfChannels,audioSamplingRate:p==null?void 0:(b=p.audioStreamReport)==null?void 0:b.samplingRate,audioStreamType:p==null?void 0:(b=p.audioStreamReport)==null?void 0:b.streamType,validatedMimeType:p==null?void 0:p.mimeType,videoAvgBitsPerSecond:p==null?void 0:(b=p.videoStreamReport)==null?void 0:b.avgBitsPerSecond,videoCalculatedFps:p==null?void 0:(b=p.videoStreamReport)==null?void 0:b.calculatedFps,videoDuration:p==null?void 0:(b=p.videoStreamReport)==null?void 0:b.duration,videoHeight:p==null?void 0:(b=p.videoStreamReport)==null?void 0:b.videoHeight,videoNominalFps:p==null?void 0:(b=p.videoStreamReport)==null?void 0:b.nominalFps,videoStreamType:p==null?void 0:(b=p.videoStreamReport)==null?void 0:b.streamType,videoWidth:p==null?void 0:(b=p.videoStreamReport)==null?void 0:b.videoWidth}):void 0;d("MAWDbMediaTxns").updateMedia(a,q,{size:g.byteLength,validatedResult:b})}).then(function(){return d("WAResultOrError").makeResult()})})}});function m(a,b){var c;if(b==null)return d("MAWDexieTable").dexieResolve(!1);if(b.type===d("MAWMsgType").MSG_TYPE.XMA)return d("MAWDexieTable").dexieResolve(!0);return((c=b.quote)==null?void 0:c.content.xmaMessageType)===d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_REPLY?d("MAWDexieTable").dexieResolve(b.type===d("MAWMsgType").MSG_TYPE.TEXT):d("MAWDbXMATxns").maybeGetXMAFromAssociatedMsgId(a,b.msgId).then(function(a){return a!=null})}function n(a,b){return d("MAWGetMsgQuoteTxn").maybeBatchGetMsgsByQuoteExternalId(a,b.map(function(a){return a.externalId})).then(function(b){return b.map(function(b){return d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(a,b).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(b,void 0,a,"EncryptedBackups")})})})})}g.handleMediaDownload=e}),98);
__d("MAWSupportedDocumentTypes",[],(function(a,b,c,d,e,f){"use strict";var g=["apk","pyc","7z","z","gz","xz","rar","zip","zipx","ace","arc","zpaq","quad","balz","cab","arj","lzh","uue","bz","bz2","bzip2","jar","iso","tar","ade","adp","air","app","application","bas","bat","chm","cmd","com","command","cpl","crt","dll","dmg","dpkg","exe","hlp","hta","inf","ins","isp","jnlp","js","jse","lib","lnk","lua","mde","msc","msi","msp","mst","ocx","pcd","pif","pkg","ps1","reg","scr","sct","sh","shb","shs","sys","term","url","vb","vbe","vbs","vxd","webarchive","wsc","wsf","wsh","xbap"];function a(a){if(a==null)return!1;a=a.includes(".")?a.split(".").pop():null;return a!=null&&!g.includes(a)}f.isAllowedType=a}),66);
__d("MAWMediaManagementTxns",["EBLogger","MAWBridgeTypesCreators","MAWDbChunkTxns","MAWDbMediaTxns","MAWDbMsgTxns","MAWDexieCastToPromise","MAWDexieTable","MAWMediaAfterTxns","MAWMediaBackupTxns","MAWMediaUtils","MAWMsgType","MAWODSProxy","MAWSupportedDocumentTypes","MAWWriteMsgTxns","MWFBLogger","WAErrorMessage","WAHashUtils","WAMediaUtils","WAOdsEnums","WASortedLists","WATimeUtils","emptyFunction","gkx","justknobx","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Same FBId assigned for different mediaIds. fbId: "," - shared by hashedPlaintextHashes: "," ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Same objectId assigned for different mediaIds. objectId: "," shared by  hashedPlaintextHashes: "," ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][updateMediaWithEncodedMediaEntryData] media entry is missing, can't upate media with encoded data"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] media entry is missing, can't update media info"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["Media failed to link. Possible duplicate? Will attempt a retry. For plaintextHash: ",", hashedPlaintextHash: ",". Error: ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["Media failed to link after retry."]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["Media failed to link after retry: plaintextHash: ",", hashedPlaintextHash: ",". Error: ",""]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["Media found after retry for plaintextHash: ",""]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["Inserted media with plaintextHash: ",""]);p=function(){return a};return a}var q=d("MWFBLogger").MWMediaLogger.tags(["MAWMediaManagementTxns"]),r=c("gkx")("23924");function a(a,b,c,e){var f=c==null||b.type===d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE&&(r||!d("MAWSupportedDocumentTypes").isAllowedType((c=c.validatedDocumentFileInfo)==null?void 0:c.filename));return d("MAWWriteMsgTxns").prepareMsgWriteData(a,b,e).then(function(a){return babelHelpers["extends"]({},a,{shouldDropDocument:f})})}function b(a,b,e,f,g,h,i,j){g===void 0&&(g=!1);h===void 0;j===void 0&&(j=!0);f={validatedAudioInfo:b.validatedAudioInfo,validatedDocumentFileInfo:b.validatedDocumentFileInfo,validatedImageInfo:b.validatedImageInfo,validatedVideoInfo:b.validatedVideoInfo};h=d("MAWMediaUtils").genHMACPlaintextHash(b.plaintextHash);var k=d("WAMediaUtils").decodeMediaEntryData(b.mediaEntry);k=k.objectId!=null?d("WAMediaUtils").stringToDeliveryObjectId(k.objectId):null;return d("MAWDexieTable").dexieAll([s(a,e,b.plaintextHash,b.mediaType,b.size,b.mediaEntry,f,k,void 0,g,b.accessibilitySummaryText),d("MAWDbChunkTxns").hasMediaChunk(a,h)]).then(function(b){var f=b[0];b=b[1];d("EBLogger").EBLogger.tags(["restore","handleUnstoredDbMedia"]).DEBUG(p(),d("WAHashUtils").sanitisePlaintextHash(f.plaintextHash));var h=c("justknobx")._("2010")&&!j;e.type!==d("MAWMsgType").MSG_TYPE.REVOKED&&!g&&!h&&d("MAWMediaAfterTxns").handleNewMediaAfterTxn(e,f,b,a,void 0,i);return f})}function s(a,b,c,e,f,g,h,i,j,k,l){k===void 0&&(k=!1);return t(a,b,c,e,f,g,h,i,j,k,void 0,l).then(function(c){var e=k?d("MAWDexieTable").dexieResolve():d("MAWDbMsgTxns").updateMediaId(a,b,c.mediaId,c.plaintextHash);return e.then(function(){return d("MAWMediaBackupTxns").linkMediaBackup(a,c.mediaId,b.msgId,i,j).then(function(){return c})})})}function t(a,b,c,e,f,g,h,i,j,k,p,r){k===void 0&&(k=!1);p===void 0&&(p=0);r===void 0&&(r=null);return d("MAWDbMediaTxns").maybeGetMediaFromPlaintextHash(a,c).then(function(s){var u=new Map(s==null?void 0:s.mediaEntries),v=x(g,i,j);v!=null&&u.set(b.msgId,v);if(s){p>0&&q.DEBUG(o(),d("WAHashUtils").sanitisePlaintextHash(c));s.msgIds||q.mustfix("Media missing msgIds: media type=%s",s.mediaType);s.mediaType||q.mustfix("Media missing mediaType: type=%s ; msg type=%s",e,b.type);var w=babelHelpers["extends"]({},s,h,{accessibilitySummaryText:(v=r)!=null?v:void 0,mediaEntries:u,mediaType:(v=s.mediaType)!=null?v:e,msgIds:d("WASortedLists").addToSet(s.msgIds||d("WASortedLists").emptySet(),b.msgId)});return a.media.put(w).then(function(){return w})}else{var y=d("MAWMediaUtils").genHMACPlaintextHash(c),z=babelHelpers["extends"]({accessibilitySummaryText:(v=r)!=null?v:void 0,fbid:(s=j)!=null?s:void 0,hashedPlaintextHash:y,mediaEntries:u,mediaType:e,msgIds:d("WASortedLists").singleElement(b.msgId),objectId:(v=i)!=null?v:void 0,plaintextHash:c,size:f,ts:d("WATimeUtils").unixTime()},h);return a.media.add(z).then(function(a){return babelHelpers["extends"]({},z,{mediaId:a})})["catch"](function(o){var s=d("WAErrorMessage").maybeGetMessageFromError(o);if(p>0){q.DEBUG(n(),d("WAHashUtils").sanitisePlaintextHash(c),y,s);q.catching(o).MUSTFIX(m());throw o}else{q.DEBUG(l(),d("WAHashUtils").sanitisePlaintextHash(c),y,s);d("MAWODSProxy").odsBumpEntityKey({amount:1,entity:d("WAOdsEnums").Entity.MAW_MEDIA_DB_DUPLICATE_MEDIA,key:"retry"});return t(a,b,c,e,f,g,h,i,j,k,p+1,r)}})}})}var u=function(a,b,c,e,f,g,h,i,j,k,l){j===void 0&&(j=!1);return d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,b).then(function(b){if(b==null)throw q.mustfixThrow("Do not have the media message in db when attachHashToMediaMsg");else return s(a,b,c,g,h,l,i,e,f,j,k)})},v=function(a,b,e){return d("MAWDbMediaTxns").maybeGetMediaFromHashedPlaintextHash(a,b).then(function(b){if(b!=null){var d=babelHelpers["extends"]({},b);e.validatedAudioInfo!=null&&(d.validatedAudioInfo=babelHelpers["extends"]({},b.validatedAudioInfo,e.validatedAudioInfo));e.validatedVideoInfo!=null&&(d.validatedVideoInfo=babelHelpers["extends"]({},b.validatedVideoInfo,e.validatedVideoInfo));e.validatedImageInfo!=null&&(d.validatedImageInfo=babelHelpers["extends"]({},b.validatedImageInfo,e.validatedImageInfo));e.validatedDocumentFileInfo!=null&&(d.validatedDocumentFileInfo=babelHelpers["extends"]({},b.validatedDocumentFileInfo,e.validatedDocumentFileInfo));return a.media.update(d.mediaId,d).then(c("emptyFunction"))}else q.WARN(k())})},w=function(a,b,c,e){return d("MAWDbMediaTxns").maybeGetMediaFromHashedPlaintextHash(a,b).then(function(b){if(b!=null){var f=e?b.mediaEntries.set(c,e):b.mediaEntries;b=babelHelpers["extends"]({},b,{mediaEntries:f});return a.media.update(b.mediaId,b)}else{q.MUSTFIX(j());return d("MAWDexieTable").dexieResolve()}})};function e(a,b,c,e,f,g,h,i,j,k){k===void 0&&(k=!1);return d("MAWDexieTable").dexieAll([u(a,b,e,f,g,h,j.size,i,k),d("MAWDbChunkTxns").getOrCreateMediaChunkWithPlaintextHash(a,e,c,j.type)]).then(function(a){a=a[0];return a})}function x(a,b,c){var e;a=a;a!=null&&b!=null&&(e=d("WAMediaUtils").decodeMediaEntryData(a),a=d("WAMediaUtils").encodeMediaEntryWithUpdatedObjectId(e,b));a!=null&&c!=null&&(e=d("WAMediaUtils").decodeMediaEntryData(a),a=d("WAMediaUtils").encodeMediaEntryWithUpdatedFbid(e,c));return a}function f(a,b,c){var e=new Map();a.mediaEntries.forEach(function(a,f){var g=d("WAMediaUtils").decodeMediaEntryData(a);g=g.objectId===b?d("WAMediaUtils").encodeMediaEntryWithUpdatedFbid(g,c):a;e.set(f,g)});return e}function y(a,b,c,e,f){f===void 0&&(f=!0);var g=new Map();b.forEach(function(a){var b;b=(b=g.get(a.hashedPlaintextHash))!=null?b:[];b.push(a);g.set(a.hashedPlaintextHash,b)});return d("MAWDbMediaTxns").maybeBulkGetMediaFromHashedPlaintextHash(a,[].concat(Array.from(g.keys()))).then(function(h){var i=new Map(h.map(function(a){return[a.hashedPlaintextHash,a]})),j=new Map();b.forEach(function(a){var b=i.get(a.hashedPlaintextHash);if(a==null)return;var c=x(a==null?void 0:a.entry,a==null?void 0:a.objectId,a==null?void 0:a.fbId);if(b){var e=c?b.mediaEntries.set(a.msgId,c):b.mediaEntries;e=babelHelpers["extends"]({},b,{mediaEntries:e,msgIds:d("WASortedLists").addToSet(b.msgIds,a.msgId)});i.set(a.hashedPlaintextHash,e)}else F(j,a,c)});var k=new Map(),l=new Map();h=Array.from(j.values()).filter(function(a){return z(a,k,l)});return d("MAWDexieTable").dexieAll([a.media.bulkAdd(h),a.media.bulkPut(Array.from(i.values()))]).then(function(){return A(a,[].concat(Array.from(g.keys())),g,c,e,f)})})}function z(a,b,c){if(a.objectId!=null){var d=b.get(a.objectId);if(d!=null&&d!==a.hashedPlaintextHash){q.MUSTFIX(i(),a.objectId,d,a.hashedPlaintextHash);return!1}}if(a.fbid!=null){d=c.get(a.fbid);if(d!=null&&d!==a.hashedPlaintextHash){q.MUSTFIX(h(),a.fbid,d,a.hashedPlaintextHash);return!1}}a.objectId!=null&&b.set(a.objectId,a.hashedPlaintextHash);a.fbid!=null&&c.set(a.fbid,a.hashedPlaintextHash);return!0}function A(a,b,c,e,f,g){return d("MAWDbMediaTxns").maybeBulkGetMediaFromHashedPlaintextHash(a,b).then(function(b){return d("MAWDexieTable").dexieAll([D(a,b,c)]).then(function(){g&&B(b,c,e,a,f);return b})})}function B(a,b,e,f,g){a.forEach(function(a){var h=b.get(a.hashedPlaintextHash);h!=null&&!C(h)&&c("promiseDone")(d("MAWDexieCastToPromise").dexieCastToPromise(f.messages.where("msgId").anyOf(a.msgIds).toArray().then(function(b){var c=d("MAWMediaUtils").createHdTypesForBridgeMedia(b);b=d("MAWBridgeTypesCreators").createBridgeMedia({chatJid:e,filteredMsgIds:d("MAWBridgeTypesCreators").getMsgIdsFilteredByJid(b,e),hasMediaForUI:!1,hdTypes:c,media:a,transportKey:g});d("MAWMediaAfterTxns").handleNewMediaAfterTxnWithBridgeMedia(f,b)})))})}function C(a){return a.reduce(function(a,b){return a||b.isXMAShare},!1)}function D(a,b,c){b=b.reduce(function(a,b){var d;(d=c.get(b.hashedPlaintextHash))==null?void 0:d.filter(function(a){return a!=null&&!a.isXMAShare}).forEach(function(c){return a.set(c.msgId,b.mediaId)});return a},new Map());return d("MAWDbMsgTxns").bulkUpdateMediaId(a,b)}function E(a,b){var c;a=a?new Map([[b.msgId,a]]):new Map();return babelHelpers["extends"]({fbid:(c=b.fbId)!=null?c:void 0,hashedPlaintextHash:b.hashedPlaintextHash,mediaEntries:a,mediaType:b.mediaType,msgIds:d("WASortedLists").singleElement(b.msgId),objectId:(c=b.objectId)!=null?c:void 0,plaintextHash:b.plaintextHash,size:b.size,ts:d("WATimeUtils").unixTime()},b.mediaInfo)}function F(a,b,c){var d=a.get(b.hashedPlaintextHash);d==null?a.set(b.hashedPlaintextHash,E(c,b)):(c!=null&&d.mediaEntries.set(b.msgId,c),d.msgIds.push(b.msgId))}g.prepareMediaWriteData=a;g.handleUnstoredDbMedia=b;g.linkMedia=s;g.createOrUpdateMediaRow=t;g.attachHashToMediaMsg=u;g.updateMediaEntryWithValidatedMediaInfo=v;g.updateMediaWithEncodedMediaEntryData=w;g.attachHashAndSaveMedia=e;g.updateBackupFbidInMediaEntries=f;g.bulkLinkMedia=y;g.linkMessageAndMediaBackupForMediaList=A}),98);
__d("MAWMediaRetryInfo",[],(function(a,b,c,d,e,f){"use strict";var g=new Map();function a(a,b){g.set(a,b)}function b(a){return g.get(a)}function c(a){g.has(a)&&g["delete"](a)}f.setRetriedMediaInfo=a;f.getRetriedMediaInfo=b;f.clearRetriedMediaInfo=c}),66);
__d("MAWHandleEchoMediaMsgsRestoreV2",["EchoMessage","EchoMessageMediaFieldUtils","LSMEBTaskCreationSource","MAWAsConsumerApplication","MAWBridge","MAWBridgeTypesCreators","MAWCastToMsgrServerMediaType","MAWConfig","MAWDbChunkTxns","MAWDbMediaTxns","MAWDbMsg","MAWDbMsgTxns","MAWFrontendMediaUtils","MAWGetMsgForProtocolMsgIdTxn","MAWHandleMediaDownloadApi","MAWIndexedDb","MAWJids","MAWJobDefinitions","MAWJobManager","MAWMediaDownloadStatus","MAWMediaDownloadStatusForUI","MAWMediaGalleryM2Utils","MAWMediaManagementTxns","MAWMediaRetryInfo","MAWMediaUtils","MAWSupportedDocumentTypes","MAWTransactionMode","MAWUpdateMediaEntryForMsgApi","Promise","WAAPI","WAArmadilloXMA.pb","WABase64","WAGetAgeBucketForMediaKeyTimestamp","WAGetStorageQplAnnotations","WAHashUtils","WAIsMediaExpiredError","WAJids","WAJobOrchestratorTypes","WALogger","WAMediaUtils","WAStartMediaDownloadQplFlow","WATagsLogger","WATimeUtils","asyncToGeneratorRuntime","cr:10071","gkx","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["resign cdn url start [sproc]. hash: ",". msgId: ",". traceId: ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["resign cdn url gql error: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["resign cdn url gql success. hash: ",". externalId ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["resign cdn url gql failed: ",". hash: ",". externalId ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["resign cdn url start [gql]. hash: ",". msgId: ",". traceId: ",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["start restore media from backup. hash: ",". msgId: ",". traceId: ",""]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Skipping media restore for expirable XMA. externalId ",". xmamessageType: ",""]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Cannot find the media entry for message"]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Cannot find the media entry for message, plaintextHash: ",", msg id: ",""]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Cannot find the media entry for message with mediaKey ",""]);r=function(){return a};return a}function s(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] media for message: "," is already downloaded on the device"]);s=function(){return a};return a}function t(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Unable to construct downloadableThumbnail from previewMediaData: ",""]);t=function(){return a};return a}function u(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Unable to construct downloadableThumbnail from previewMediaData: ",", msg id: ",""]);u=function(){return a};return a}function v(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth] downloadableThumbnail was created without metadata, source: echo"]);v=function(){return a};return a}function w(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Media key cannot be null"]);w=function(){return a};return a}function x(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Media key cannot be null, msg id: ",""]);x=function(){return a};return a}function y(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Encrypted hash cannot be null"]);y=function(){return a};return a}function z(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Encrypted hash cannot be null, msg id: ",""]);z=function(){return a};return a}function A(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Cannot download media - document extension is disallowed, msg id: ",""]);A=function(){return a};return a}function B(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Cannot download media - media content type null"]);B=function(){return a};return a}function C(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Cannot download media - media content type null, msg id: ",""]);C=function(){return a};return a}function D(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] media entry is missing from index db. It is required to retry download by resigning cdn url: externalId: ","."]);D=function(){return a};return a}function E(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] media entry is missing from index db. It is required to retry download by resigning cdn url: externalId: ",". traceId: ",""]);E=function(){return a};return a}function F(){var a=babelHelpers.taggedTemplateLiteralLoose(["start resign cdn url through sproc"]);F=function(){return a};return a}function G(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] media download failed with error: ",""]);G=function(){return a};return a}function H(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] media download failed with error: "," "," when downloading. Message timestamp: ",". traceId: ",""]);H=function(){return a};return a}function I(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Retry download media as signature has expired and should be renewed. externalId ",". traceId: ",""]);I=function(){return a};return a}function J(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] media download complete. externalId ",". traceId: ",""]);J=function(){return a};return a}function K(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] media entry validation failed. error: ","."]);K=function(){return a};return a}function L(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] media entry validation failed. externalId ",". traceId: ",". error: ","."]);L=function(){return a};return a}function M(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] downloading media from MI directly. externalId ","."]);M=function(){return a};return a}function N(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] start media download from whatsapp infra. traceId: ",""]);N=function(){return a};return a}function O(){var a=babelHelpers.taggedTemplateLiteralLoose(["Encrypted hash is null - unable to download thumbnail"]);O=function(){return a};return a}function P(a){var c=aa(a);return c.then(function(c){var d=new Map();a.forEach(function(a){var b=c.get(a);b=b==null?void 0:b.blobData;d.set(a,b)});return(h||(h=b("Promise"))).resolve(d)})}function Q(a){switch(a){case d("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.IMAGE_JPEG:return"image/jpeg";case d("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.IMAGE_PNG:return"image/png";case d("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.STICKER:return"image/webp";case d("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.GIF:return"image/gif";case d("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.AUDIO_MP4:return"audio/mp4";case d("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.AUDIO_WAV:return"audio/wav";case d("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.XMA:return"xma"}}function a(a,b,c){return R.apply(this,arguments)}function R(){R=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,f){if(a.length===0)return(h||(h=b("Promise"))).resolve();var g=[],i=[],j=new Map(),k=new Map();a.map(function(a){var c=a.mediaData,e=a.messageTimestamp,f=T(c.plaintextHash),l=c.attachmentObjectId,m=c.attachmentType,n=c.backupEntFbid,o=c.directPath,p=c.filename,q=c.height,r=c.mediaContentType,s=c.mediaKeyTimestamp,D=c.mediaPlayableDuration,E=c.previewContentHeight,F=c.previewContentType,G=c.previewContentWidth,H=c.size;c=c.width;var I=d("WAHashUtils").stringToPlaintextHash(f),J=d("MAWMediaUtils").genHMACPlaintextHash(I);i.push(J);r=r!=null?d("MAWFrontendMediaUtils").getMediaTypeAndServerMediaTypeFromBlob(r,a.isXMA):F!=null?d("MAWFrontendMediaUtils").getMediaTypeAndServerMediaTypeFromBlob(Q(F)):null;if(r==null){d("WALogger").WARN(C(),a.externalId);d("WALogger").ERROR(B());return(h||(h=b("Promise"))).resolve()}if(m===d("EchoMessageMediaFieldUtils").AttachmentType.DOCUMENT&&!d("MAWSupportedDocumentTypes").isAllowedType(p)){d("WALogger").LOG(A(),a.externalId);return(h||(h=b("Promise"))).resolve()}F=a.mediaData.encryptedHash;if(F==null){d("WALogger").WARN(z(),a.externalId);d("WALogger").ERROR(y());return(h||(h=b("Promise"))).resolve()}m=a.mediaData.mediaKey;if(m==null){d("WALogger").WARN(x(),a.externalId);d("WALogger").ERROR(w());return(h||(h=b("Promise"))).resolve()}var K=r.mediaType;r=r.serverMediaType;l=d("WAMediaUtils").stringToDeliveryObjectId(l);n=n!=null?d("WAMediaUtils").stringToBackupEntFbid(n):void 0;var L=a.threadJId,M=U({filename:p,height:q,mediaPlayableDuration:D,mediaType:K,previewContentHeight:E,previewContentWidth:G,width:c});k.set(l,{filename:p,height:q,mediaPlayableDuration:D,mediaType:K,messageTimestamp:e,plaintextHash:I,previewContentHeight:E,previewContentWidth:G,serverMediaType:r,threadJId:L,width:c});q=null;if(a.previewMediaData!=null)try{q=W(a.previewMediaData),q!=null&&q.objectId==null&&d("WALogger").ERROR(v())}catch(b){d("WALogger").WARN(u(),b,a.externalId),d("WALogger").ERROR(t(),b)}if(F!=null){D=V(f,F,m,o,s,r,p,n,l,q,H);g.push({entry:D,fbId:n,hashedPlaintextHash:J,isXMAShare:a.isXMA,mediaInfo:M,mediaType:K,msgId:a.msgId,objectId:l,plaintextHash:I,size:(e=H)!=null?e:0})}G=(E=j.get(J))!=null?E:[];G.push(a);j.set(J,G)});a=!(c("justknobx")._("3060")&&d("MAWMediaGalleryM2Utils").isMediaGalleryM2Enabled()&&f===c("LSMEBTaskCreationSource").MEDIA_GALLERY_RESTORE);var l=(yield S(g,e,a));a=(yield P(i));var m=[];a.forEach(function(a,b){var h=j.get(b);h==null?void 0:h.forEach(function(h){if(h==null)return;if(a!=null){d("WALogger").LOG(s(),h.externalId);var i=l.find(function(a){return a.plaintextHash===h.mediaData.plaintextHash});if(i==null){d("WALogger").LOG(r(),h.mediaData.mediaKey);return}return ba(i.msgIds).then(function(a){a=a.filter(function(a){return d("MAWDbMsg").isMediaMsg(a)});if(a.length>0){var b=d("MAWMediaUtils").createHdTypesForBridgeMedia(a);b=d("MAWBridgeTypesCreators").createBridgeMedia({chatJid:h.threadJId,filteredMsgIds:d("MAWBridgeTypesCreators").getMsgIdsFilteredByJid(a,e),hasMediaForUI:!0,hdTypes:b,media:i,transportKey:"EncryptedBackups"});c("justknobx")._("1254")&&d("MAWMediaGalleryM2Utils").isMediaGalleryM2Enabled()?a=d("MAWMediaUtils").annotateBridgeMediaForDisplay(b,a):a=b;d("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"NewMedia",value:a}]})}})}var j=k.get(d("WAMediaUtils").stringToDeliveryObjectId(h.mediaData.attachmentObjectId));if(h==null||j==null)return;var n=j.filename,o=j.height,t=j.mediaPlayableDuration,u=j.mediaType,v=j.messageTimestamp,w=j.plaintextHash,x=j.previewContentHeight,y=j.previewContentWidth,z=j.serverMediaType,A=j.threadJId;j=j.width;var B=d("WAJids").extractUserId(d("MAWJids").toUserJid(h.threadJId));z=d("MAWCastToMsgrServerMediaType").castToMsgrServerMediaType(z,h.isXMA);if(z!=null){z={attachmentObjectId:d("WAMediaUtils").stringToDeliveryObjectId(h.mediaData.attachmentObjectId),mediaType:z,messageId:h.externalId,messageTimeStamp:h.messageTimestamp,msgId:h.msgId,plaintextHash:w,productType:d("MAWConfig").getConfig().productTypeForEBAttachments,threadId:B,threadJid:A};B=g.find(function(a){return a.hashedPlaintextHash===b});B=B==null?void 0:B.entry;if(B==null){d("WALogger").WARN(q(),d("WAHashUtils").sanitisePlaintextHash(d("WAHashUtils").stringToPlaintextHash(h.mediaData.plaintextHash)),h.externalId);d("WALogger").ERROR(p());return}if(f===c("LSMEBTaskCreationSource").MEDIA_GALLERY_RESTORE&&c("gkx")("4219"))return;var C=d("WAStartMediaDownloadQplFlow").startMediaDownloadQplFlow({downloadEntry:"handleEchoMediaMsgsRestore",msgType:null,protocolMsgId:{author:h.author,chat:h.threadJId,externalId:h.externalId},triggerUIView:null});m.push(X({author:h.author,directPath:h.mediaData.directPath,echoMsg:h.echoMsg,externalId:h.externalId,filename:n,hashedPlaintextHash:b,height:o,isXMA:h.isXMA,mediaPlayableDuration:t,mediaType:u,messageTimestamp:v,plaintextHash:w,previewContentHeight:x,previewContentWidth:y,threadJId:A,width:j},void 0,z,void 0,d("WAMediaUtils").decodeMediaEntryData(B),C))}})});yield (h||(h=b("Promise"))).all(m)});return R.apply(this,arguments)}var S=(e=d("MAWIndexedDb")).makeMsgrTransactor({media:(f=d("MAWTransactionMode")).READWRITE,mediaBackup:f.READWRITE,messages:f.READWRITE},"restoreLinkMedias",function(a){return function(b,c,e){return d("MAWMediaManagementTxns").bulkLinkMedia(a,b,c,"EncryptedBackups",e)}}),aa=e.makeMsgrTransactor({chunk:f.READONLY},"getChunksByHash",function(a){return function(b){return d("MAWDbChunkTxns").maybeBulkGetChunksFromHash(a,b)}}),ba=e.makeMsgrTransactor({messages:f.READONLY},"getMessagesForMsgIds",function(a){return function(b){return a.messages.where("msgId").anyOf(b).toArray()}});function T(a){if(a.endsWith("=")){var b="";for(var c=0;c<a.length;c++){var d=a.charAt(c);if(d==="=")return b;b+=d}}return a}function U(a){var b=a.height,c=a.mediaType,e=a.width,f=a.previewContentHeight,g=a.previewContentWidth,h=a.mediaPlayableDuration;a=a.filename;return{validatedAudioInfo:c==="Ptt"&&h!=null?{duration:da(h),mimetype:d("MAWAsConsumerApplication").AUDIO_WAV_MIME_TYPE,played:!1}:null,validatedDocumentFileInfo:c==="DocumentFile"?{filename:a,mimetype:d("MAWAsConsumerApplication").FILE_MIME_TYPE}:null,validatedImageInfo:c==="Image"?{height:b,jpegThumbnailHeight:f,jpegThumbnailWidth:g,width:e}:c==="Gif"||c==="Sticker"?{height:b,jpegThumbnailHeight:b,jpegThumbnailWidth:e,width:e}:null,validatedVideoInfo:c==="Video"?{duration:h,height:b,jpegThumbnailHeight:f,jpegThumbnailWidth:g,mimetype:d("MAWAsConsumerApplication").VIDEO_MIME_TYPE,width:e}:null}}function V(a,b,c,e,f,g,h,i,j,k,l){a=d("WABase64").decodeB64UrlSafe(a,!0);b=d("WABase64").decodeB64UrlSafe(b,!0);c=d("WABase64").decodeB64UrlSafe(c,!0);return d("WAMediaUtils").rawDataToMediaEntry({directPath:e,downloadableThumbnail:k!=null?k:void 0,fbid:i!=null?i:void 0,fileEncSha256:b,filename:h,fileSha256:a,mediaKey:c,mediaKeyTimestamp:f!=null?d("WATimeUtils").castToUnixTime(f):void 0,objectId:j!=null?j:void 0,serverMediaType:g,size:l!=null?l:void 0})}function W(a){var b=a.attachmentObjectId,c=a.directPath,e=a.encryptedHash,f=a.mediaKey,g=a.mediaKeyTimestamp;a=a.plaintextHash;if(e==null){d("WALogger").ERROR(O());return}else{g=g!=null?d("WATimeUtils").castToUnixTime(g):void 0;f=f!=null?d("WAMediaUtils").castToMediaKey(d("WABase64").decodeB64UrlSafe(f,!0)):void 0;a=d("WABase64").decodeB64UrlSafe(a,!0);e=d("WABase64").decodeB64UrlSafe(e,!0);return{directPath:c,fileEncSha256:e,fileSha256:a,mediaKey:f,mediaKeyTimestamp:g,objectId:b}}}var X=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f,g,h){d("WALogger").LOG(N(),b);var i=a.author,j=a.externalId,k=a.filename,l=a.hashedPlaintextHash,m=a.height,n=a.mediaPlayableDuration,o=a.mediaType,p=a.messageTimestamp,q=a.plaintextHash,r=a.previewContentHeight,s=a.previewContentWidth,t=a.threadJId,u=a.width;i={author:i,chat:t,externalId:j};var v=(t=h)!=null?t:d("WAStartMediaDownloadQplFlow").startMediaDownloadQplFlow({downloadEntry:"handleEchoMediaMsgsRestore",msgType:null,protocolMsgId:i,triggerUIView:null});d("MAWMediaDownloadStatusForUI").sendMediaDownloadStatusToUI({details:"handle_echo_media_msgs_restore",hash:q,status:c("MAWMediaDownloadStatus").DOWNLOADING,type:"main"});t=((t=(h=d("MAWMediaRetryInfo").getRetriedMediaInfo(j))==null?void 0:h.isXMA)!=null?t:!1)||((h=a==null?void 0:a.isXMA)!=null?h:!1);h=((h=d("MAWMediaRetryInfo").getRetriedMediaInfo(j))==null?void 0:(h=h.echoMsg)==null?void 0:h.serializationOrigin)||(a==null?void 0:(h=a.echoMsg)==null?void 0:h.serializationOrigin)||d("EchoMessage").EchoSerializationOriginType.UNKNOWN;var w=c("gkx")("23960");v.addPoint("download_media_start",{bool:{isEBDownloadEnforced:e==null&&w,isRetryFromMI:e==null,isXMA:t,pathMismatch:f!==g.directPath},"int":{mediaEntrySize:g.size},string:{oldDirectPath:(t=a==null?void 0:a.oldDirectPath)!=null?t:"",origin:h,restorationCdnUrl:(t=f)!=null?t:""}});void d("WAGetStorageQplAnnotations").getStorageQplAnnotations().then(function(a){v.addAnnotations(a)});if(e!=null&&w){d("WALogger").LOG(M(),i.externalId);return Z({decodedMediaEntry:g,isEBDownloadEnforced:w,mediaDownloadRequest:a,protocolMsgId:i,retryPayload:e})}h=d("WAMediaUtils").validateDecodedMediaEntryForDownload(g);if(!h.success){d("WALogger").WARN(L(),i.externalId,b,h.error);d("WALogger").ERROR(K(),h.error);v.endFail("download_media_fail",{string:{failReason:h.error}});return}t=(yield c("WAAPI").cachedDownloadFullMediaOnly({downloadMediaMetric:v,hash:q,mediaEntry:h.value,protocolMsgId:i,updateMediaEntryForMsg:d("MAWUpdateMediaEntryForMsgApi").updateMediaEntryForMsg}));if(t.success){v.addPoint("download_media_end");w=t.value;h=w.mimeType;w=w.plaintext;yield d("MAWHandleMediaDownloadApi").handleMediaDownload(q,h,w,i);d("MAWMediaRetryInfo").clearRetriedMediaInfo(j);h=U({filename:k,height:m,mediaPlayableDuration:n,mediaType:o,previewContentHeight:r,previewContentWidth:s,width:u});yield ca(l,h);d("WALogger").LOG(J(),i.externalId,b);v.endSuccess();d("MAWMediaDownloadStatusForUI").sendMediaDownloadStatusToUI({details:"handle_echo_media_msgs_restore_success",hash:q,status:c("MAWMediaDownloadStatus").SUCCESS,type:"main"})}else{w=t.error;if(d("WAIsMediaExpiredError").isMediaExpiredError(w)&&e)v.addPoint("eb_resign_requested"),v.endSuccess(),d("WALogger").WARN(I(),i.externalId,b),yield Z({decodedMediaEntry:g,isEBDownloadEnforced:!1,mediaDownloadRequest:a,protocolMsgId:i,retryPayload:e});else{d("WALogger").WARN(H(),j,w,p,b);d("WALogger").ERROR(G(),w);m={string:{directPath:g.directPath,error:"media_download_failure",restorationCdnUrl:(k=f)!=null?k:""}};v.endFail(w,m);d("MAWMediaRetryInfo").clearRetriedMediaInfo(j);d("MAWMediaDownloadStatusForUI").sendMediaDownloadStatusToUI({details:w,hash:q,status:d("MAWMediaDownloadStatusForUI").getStatusFromWAAPIDownloadMediaError(w),type:"main"})}}});return function(b,c,d,e,f,g){return a.apply(this,arguments)}}(),Y=e.makeMsgrTransactor({media:f.READONLY,mediaBackup:f.READONLY,messages:f.READONLY},"invokeRestoreAccessCheckSprocToDownloadAttachment",function(a){return function(b,c,e){return d("MAWDbMediaTxns").maybeGetMediaFromPlaintextHash(a,c.plaintextHash).then(function(f){if(f){d("WATagsLogger").TAGS(["labyrinth_web","media_restore",""+e.getFlowDetails().instanceKey]).LOG(F());var g=fa(f,c.attachmentObjectId);return d("MAWDbMsgTxns").getMsgsByMsgIds(a,g).then(function(a){var g,h=a.find(function(a){return a.externalId===b});e.addPoint("resign_cdn_url_bridge_call",{bool:{isForwarded:(g=h==null?void 0:h.isForwarded)!=null?g:!1},"int":{duplicateMsgsCount:a.length,msgXMAType:h==null?void 0:h.xmaMessageType,totalMediaEntries:f.mediaEntries.size},int_array:{duplicateXMATypes:a.map(function(a){return(a=a.xmaMessageType)!=null?a:0})},string:{msgType:h==null?void 0:h.type},string_array:{duplicateMsgs:a.map(function(a){return a.externalId}),duplicateMsgTypes:a.map(function(a){return a.type})}});d("MAWIndexedDb").afterTransaction({tag:"ResignAttachmentCDNUrl",value:{deliveryObjectId:c.attachmentObjectId,mediaType:c.mediaType,messageId:b,msgId:c.msgId,plaintextHash:c.plaintextHash,productType:d("MAWConfig").getConfig().productTypeForEBAttachments,sortOrder:c.messageTimeStamp,threadId:c.threadId,threadJid:c.threadJid,traceId:e.getFlowDetails().instanceKey}})})}else d("WALogger").WARN(E(),b,e.getFlowDetails().instanceKey),d("WALogger").ERROR(D(),b),e.endFail("missing-media")})}}),ca=e.makeMsgrTransactor({media:f.READWRITE,messages:f.READWRITE},"updateMediaWithDownloadedChunkBlob",function(a){return function(b,c){return d("MAWMediaManagementTxns").updateMediaEntryWithValidatedMediaInfo(a,b,c)}});function da(a){var b=Math.floor(a/1e3);if(b>0)return b;else return a}function ea(a){return a==null?!1:a===d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_REPLY||a===d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_MENTION}function Z(a){return $.apply(this,arguments)}function $(){$=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var c=a.decodedMediaEntry,e=a.isEBDownloadEnforced,f=a.mediaDownloadRequest,g=a.protocolMsgId,p=a.retryPayload;a=(yield d("MAWGetMsgForProtocolMsgIdTxn").getMsgForProtocolMsgIdTxn(g));if(a.success===!0&&ea(a.value.xmaMessageType)){d("WALogger").LOG(o(),g.externalId,a.value.xmaMessageType);return(h||(h=b("Promise"))).resolve()}var q=g.externalId;d("MAWMediaRetryInfo").setRetriedMediaInfo(g.externalId,f);f=((a=c.mediaKeyTimestamp)!=null?a:0)>1725105600;a={bool:{is_after_S441705_fix:f,isEBDownloadEnforced:e},"int":{mediaKeyTimestamp:c.mediaKeyTimestamp},string:{externalId:q,mediaKeyAge:d("WAGetAgeBucketForMediaKeyTimestamp").getAgeBucketForMediaKeyTimestamp(c.mediaKeyTimestamp),mediaType:p.mediaType,objectId:p.attachmentObjectId,restoreEntry:"EB",restoreMethod:b("cr:10071")==null?"sproc":"gql"}};var r=d("WAStartMediaDownloadQplFlow").startMediaDownloadQplFlow({downloadEntry:"handleEchoMediaMsgsRestore",msgType:null,protocolMsgId:g,triggerUIView:null});r.addAnnotations(a);d("WALogger").LOG(n(),d("WAHashUtils").sanitisePlaintextHash(p.plaintextHash),q,r.getFlowDetails().instanceKey);if(b("cr:10071")!=null){d("WALogger").LOG(m(),d("WAHashUtils").sanitisePlaintextHash(p.plaintextHash),q,r.getFlowDetails().instanceKey);return b("cr:10071").eblsResignCdnUrlWithGraphQL({chatJid:g.chat,deliveryObjectId:p.attachmentObjectId,externalId:q,mediaType:p.mediaType,sortOrderMs:p.messageTimeStamp}).then(function(a){if(a.success===!1){d("WALogger").LOG(l(),a.error,d("WAHashUtils").sanitisePlaintextHash(p.plaintextHash),q);r.endFail(a.error);return}d("WALogger").LOG(k(),d("WAHashUtils").sanitisePlaintextHash(p.plaintextHash),q);a=d("MAWJobDefinitions").createStartJobInfo("downloadAndRestoreMedia",{deliveryObjectId:p.attachmentObjectId,msgId:p.msgId,plaintextHash:p.plaintextHash,restorationCdnUrl:a.value,scheduleConfig:{priority:d("WAJobOrchestratorTypes").JOB_PRIORITY.LOW},traceId:r.getFlowDetails().instanceKey});return d("MAWJobManager").getJobManager().fireAndForget(a)})["catch"](function(a){d("WALogger").ERROR(j(),a),r.endFail("runtime-error",{string:{restoreError:a.toString()}})})}d("WALogger").LOG(i(),d("WAHashUtils").sanitisePlaintextHash(p.plaintextHash),q,r.getFlowDetails().instanceKey);return Y(q,p,r)});return $.apply(this,arguments)}function fa(a,b){var c=[];(a=a.mediaEntries)==null?void 0:a.forEach(function(a,e){a=d("WAMediaUtils").decodeMediaEntryData(a);a.objectId===b&&c.push(e)});return c}g.downloadMediaAndWriteToMediaStore=a;g.getBase64WithoutPadding=T;g.getMediaInfo=U;g.constructMediaEntry=V;g.constructRawDownloadableThumbnail=W;g.handleDownloadMedia=X;g.invokeRestoreAccessCheckSprocToDownloadAttachment=Y}),98);
__d("MAWHandleEchoMsgsRestoreApiUtils",["$InternalEnum","EBLogger","EchoMessage","EchoMessageMediaFieldUtils","MAWAckLevel","MAWConvertXMATargetTypeToExtendedContentTargetType","MAWEBRestoreTrackingUtils","MAWJids","MAWMsgType","MAWRepliesRestoreUtils","WAJids","WAResultOrError","WAStanzaUtils","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Message content is empty for the message: ",", type: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Mandatory receiver fetch data missing for receiver fetch message: ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Mandatory XMA Data missing for XMA message: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Unsupported media message type: ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["Encountered unsupported media type: ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["Author info is missing from msg: ",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["Message has unsupported message content type: ",""]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["Message has unsupported message content type: ",", xContentType: ",",\n      subcontent type: "," ,\n      origin: ",""]);o=function(){return a};return a}var p=d("EBLogger").EBLogger.tags(["restore"]);c=b("$InternalEnum")({INITIAL_RESTORE:"initial_restore",POINT_RESTORE:"point_restore",PAGINATED_RESTORE:"paginated_restore"});function q(a,b){b=b==null?p:p.tags([b]);var c=a.contentType;switch(c){case d("EchoMessage").EchoMessageContentType.TEXT:return a.xContentType===d("EchoMessage").EchoXMessageContentType.BUMP?d("WAResultOrError").makeResult(d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE):d("WAResultOrError").makeResult(d("MAWMsgType").MSG_TYPE.TEXT);case d("EchoMessage").EchoMessageContentType.MEDIA:return a.receiverFetchId!=null&&a.receiverFetchData!=null?d("WAResultOrError").makeResult(d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH):a.mediaData==null?d("WAResultOrError").makeError("media_mandatory_fields_missing"):d("WAResultOrError").makeResult(r(a.mediaData));case d("EchoMessage").EchoMessageContentType.PLACEHOLDER:if(a.contentSubtype===d("EchoMessage").EchoMessageContentSubtype.UNSEND)return d("WAResultOrError").makeResult(d("MAWMsgType").MSG_TYPE.REVOKED);b.MUSTFIX(o(),d("EchoMessage").EchoMessageContentType.getName(c),a.xContentType!=null?d("EchoMessage").EchoXMessageContentType.getName(a.xContentType):"unknown",d("EchoMessage").EchoMessageContentSubtype.getName(a.contentSubtype),a.serializationOrigin!=null?d("EchoMessage").EchoSerializationOriginType.getName(a.serializationOrigin):"unknown");return d("WAResultOrError").makeError("unsupported_message_type");case d("EchoMessage").EchoMessageContentType.XMA:return d("WAResultOrError").makeResult(d("MAWMsgType").MSG_TYPE.XMA);case d("EchoMessage").EchoMessageContentType.DECRYPTION_FAILURE:return d("WAResultOrError").makeResult(d("MAWMsgType").MSG_TYPE.CIPHERTEXT);default:b.MUSTFIX(n(),d("EchoMessage").EchoMessageContentType.getName(c));return d("WAResultOrError").makeError("unsupported_message_type")}}function r(a){switch(a.attachmentType){case d("EchoMessageMediaFieldUtils").AttachmentType.IMAGE:return d("MAWMsgType").MSG_TYPE.IMAGE;case d("EchoMessageMediaFieldUtils").AttachmentType.STICKER:return d("MAWMsgType").MSG_TYPE.STICKER;case d("EchoMessageMediaFieldUtils").AttachmentType.VIDEO:return d("MAWMsgType").MSG_TYPE.VIDEO;case d("EchoMessageMediaFieldUtils").AttachmentType.GIF:return d("MAWMsgType").MSG_TYPE.GIF;case d("EchoMessageMediaFieldUtils").AttachmentType.PTT:return d("MAWMsgType").MSG_TYPE.PTT;case d("EchoMessageMediaFieldUtils").AttachmentType.XMA:return d("MAWMsgType").MSG_TYPE.XMA;case d("EchoMessageMediaFieldUtils").AttachmentType.DOCUMENT:return d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE}}function a(a,b,c,e,f,g){var h,i=a.from;if(i==null){p.MUSTFIX(m(),e);return d("WAResultOrError").makeError("author_missing")}var j=q(a,f);if(j.success===!1)return d("WAResultOrError").makeError(j.error);if(j==null)return d("WAResultOrError").makeError("unsupported_message_type");j=j.value;if((h=a.isTombstoned)!=null?h:!1)return d("WAResultOrError").makeError("message_tombstoned");switch(j){case d("MAWMsgType").MSG_TYPE.TEXT:case d("MAWMsgType").MSG_TYPE.REVOKED:case d("MAWMsgType").MSG_TYPE.CIPHERTEXT:return y(a,b,c,i,j,e,f,g);case d("MAWMsgType").MSG_TYPE.IMAGE:case d("MAWMsgType").MSG_TYPE.VIDEO:case d("MAWMsgType").MSG_TYPE.STICKER:case d("MAWMsgType").MSG_TYPE.GIF:case d("MAWMsgType").MSG_TYPE.PTT:case d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return s(a,b,c,i,j,e);case d("MAWMsgType").MSG_TYPE.XMA:return u(a,b,c,i,j,e);case d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:return d("WAResultOrError").makeResult(B(a,b,c,i,j,e));case d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH:return v(a,b,c,i,j,e);default:p.MUSTFIX(l(),j);return d("WAResultOrError").makeError("unsupported_message_type")}}function s(a,b,c,d,e,f){a=z(a,b,c,d,e,f);return t(e,a)}function t(a,b){switch(a){case d("MAWMsgType").MSG_TYPE.IMAGE:return d("WAResultOrError").makeResult(babelHelpers["extends"]({},b,{type:d("MAWMsgType").MSG_TYPE.IMAGE}));case d("MAWMsgType").MSG_TYPE.STICKER:return d("WAResultOrError").makeResult(babelHelpers["extends"]({},b,{type:d("MAWMsgType").MSG_TYPE.STICKER}));case d("MAWMsgType").MSG_TYPE.VIDEO:return d("WAResultOrError").makeResult(babelHelpers["extends"]({},b,{type:d("MAWMsgType").MSG_TYPE.VIDEO}));case d("MAWMsgType").MSG_TYPE.GIF:return d("WAResultOrError").makeResult(babelHelpers["extends"]({},b,{type:d("MAWMsgType").MSG_TYPE.GIF}));case d("MAWMsgType").MSG_TYPE.PTT:return d("WAResultOrError").makeResult(babelHelpers["extends"]({},b,{type:d("MAWMsgType").MSG_TYPE.PTT}));case d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return d("WAResultOrError").makeResult(babelHelpers["extends"]({},b,{type:d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE}));default:p.MUSTFIX(k(),a);return d("WAResultOrError").makeError("unsupported_media_type")}}function u(a,b,c,e,f,g){var h;if(((h=a.xmaData)==null?void 0:h.xmaTargetType)==null){p.MUSTFIX(j(),g);return d("WAResultOrError").makeError("xma_mandatory_fields_missing")}h=a.xmaData.xmaTargetType;b=z(a,b,c,e,f,g);c=babelHelpers["extends"]({},b,{type:d("MAWMsgType").MSG_TYPE.XMA,xmaMessageType:d("MAWConvertXMATargetTypeToExtendedContentTargetType").convertXMATargetTypeToExtendedContentTargetType(h)});e=a.text;e!=null&&(c.msgContent={content:e});return d("WAResultOrError").makeResult(c)}function v(a,b,c,e,f,g){if(a.receiverFetchData==null){p.MUSTFIX(i(),g);return d("WAResultOrError").makeError("receiver_fetch_mandatory_fields_missing")}b=z(a,b,c,e,f,g);return d("WAResultOrError").makeResult(babelHelpers["extends"]({},b,{receiverFetchId:a.receiverFetchId,type:d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH}))}function w(a){if(a==null)return void 0;else switch(a){case d("EchoMessage").MessageTextSize.SMALL:return 1;case d("EchoMessage").MessageTextSize.MEDIUM:return 2;case d("EchoMessage").MessageTextSize.LARGE:return 3;default:return void 0}}function x(a){if(a.text==null)return null;return a.editHistory.length===0?a.text:a.editHistory.sort(function(a,b){return a.timestamp-b.timestamp})[0].text}function y(a,b,c,e,f,g,i,j){var k=i==null?p:p.tags([i]);j=j==="first_edit_content"?x(a):a.text;if(j==null){d("MAWEBRestoreTrackingUtils").addQPLRestorePointWithAnnotationsWorker({annotations:{string:{empty_content_msg_type:f}},pointName:"unstored_text_message_empty",traceId:i});k.MUSTFIX(h(),g,f);return d("WAResultOrError").makeError("text_message_content_empty")}k=z(a,b,c,e,f,g,i);if(f===d("MAWMsgType").MSG_TYPE.REVOKED){j!=null&&(k.msgContent={content:j});a.revokeSentTimestampMs!=null&&(k.originalTs=d("WATimeUtils").castToUnixTime(a.revokeSentTimestampMs));return d("WAResultOrError").makeResult(babelHelpers["extends"]({},k,{revokedExternalId:d("WAStanzaUtils").toStanzaId("0"),type:d("MAWMsgType").MSG_TYPE.REVOKED,unsendMsgContentDeleteTs:a.revokeUnsentTimestampMS!=null?d("WATimeUtils").castToUnixTime(a.revokeUnsentTimestampMS):k.ts}))}if(f===d("MAWMsgType").MSG_TYPE.CIPHERTEXT)return d("WAResultOrError").makeResult(babelHelpers["extends"]({},k,{msgContent:{content:j},specialTextSize:w(a.textSize),type:d("MAWMsgType").MSG_TYPE.CIPHERTEXT}));b=babelHelpers["extends"]({},k,{msgContent:{content:j},specialTextSize:w(a.textSize),type:d("MAWMsgType").MSG_TYPE.TEXT});return d("WAResultOrError").makeResult(babelHelpers["extends"]({},b,{editCount:Math.max(a.editHistory.length-1,0),groupId:a.groupId,groupIndex:a.groupIndex,groupSize:a.groupSize}))}function z(a,b,c,e,f,g,h){h=A(e,c);e={ack:h===d("WAJids").AUTHOR_ME?d("MAWAckLevel").ACK.sent:d("MAWAckLevel").ACK.received,altIndex:void 0,author:h,externalId:g,groupId:a.groupId,groupIndex:a.groupIndex,groupSize:a.groupSize,isForwarded:a.isForwarded,sortOrderMs:a.sortOrderMs,threadJid:b,ts:d("WATimeUtils").castToUnixTime(a.displayTimestampMs/1e3),type:f};a.authoritativeTimestampMs!=null?e.serverTs=d("WATimeUtils").castToUnixTime(a.authoritativeTimestampMs/1e3):e.serverTs=d("WATimeUtils").castToUnixTime(a.sortOrderMs/1e3);if(a.quoteData!=null){h=d("MAWRepliesRestoreUtils").getQuoteDataFromEchoMessage(a,c);h!=null&&(e.quote=h,e.quoteExternalId=h.content.externalId)}return e}function A(a,b){a=d("MAWJids").toUserJid(a.localKey);return a===b?d("WAJids").AUTHOR_ME:a}function B(a,b,c,e,f,g){a=z(a,b,c,e,f,g);return babelHelpers["extends"]({},a,{type:d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE})}g.MAWRestoreType=c;g.getDbMsgTypeFromEchoMessage=q;g.getUnstoredDbMessageFromEchoMessage=a;g.resolveAuthorFromEchoAddress=A}),98);
__d("MAWRepliesRestoreUtils",["FBLogger","MAWBridgeMsg","MAWDexieTable","MAWGetMsgQuoteTxn","MAWHandleEchoMsgsRestoreApiUtils","MAWIndexedDb","MAWLoadReplyMediaTxns","MAWMsgType","MAWTransactionMode","MAWUpdateQuotedMsgTxns","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Quote data is missing for message: ",""]);h=function(){return a};return a}function a(a,b){if(b==null||!d("MAWMsgType").isQuotedMsgType(b.type))return a;else{b={author:b.author,externalId:b.externalId,ts:b.ts,type:b.type};b={content:b,remoteJid:null};return babelHelpers["extends"]({},a,{quote:b})}}function b(a,b){if(a.quoteData!=null&&a.quoteData.quoteMessageId!=null&&a.quoteData.quoteMessageSender!=null){b={author:d("MAWHandleEchoMsgsRestoreApiUtils").resolveAuthorFromEchoAddress(a.quoteData.quoteMessageSender,b),externalId:(b=a.quoteData)==null?void 0:b.quoteMessageId,ts:a.displayTimestampMs,type:d("MAWMsgType").MSG_TYPE.TEXT};return{content:b,remoteJid:null}}else d("WALogger").ERROR(h(),a.messageId);return null}f=d("MAWIndexedDb").makeMsgrTransactor({chunk:(e=d("MAWTransactionMode")).READONLY,media:e.READONLY,messages:e.READWRITE,threads:e.READWRITE,xma:e.READONLY},"updateQuoteDataForReplyMessages",function(a){return function(b,c,e){c==null?void 0:c.addPoint("replies_restore_start");b=b.restoredMsgsData;if(b){var f=b.existingMsgs;b=b.newlyAddedMsgs;b=b.concat(f);return d("MAWDexieTable").dexieAll(b.map(function(b){return d("MAWUpdateQuotedMsgTxns").associateQuotedMessage(a,b.threadJid,b).then(function(a){var c=[];b.quoteExternalId!=null&&c.push(b);a!=null&&c.push.apply(c,a);return c})})).then(function(b){b=b.flat();return i(a,b,e)}).then(function(a){c==null?void 0:c.addPoint("replies_restore_end",{"int":{replies:a}});return a})}return d("MAWDexieTable").dexieResolve(0)}});function i(a,b,e){return d("MAWDexieTable").dexieAll(b.map(function(b){var e=j(b);if(b.threadJid!=null)return d("MAWGetMsgQuoteTxn").enhanceMsgWithQuoteInfo(a,e,b.threadJid).then(function(a){return babelHelpers["extends"]({},a,{msgId:b.msgId,originalTs:b.originalTs,protocolMsgId:b.protocolMsgId,rowId:b.rowId,threadJid:b.threadJid,unsendMsgContentDeleteTs:b.unsendMsgContentDeleteTs})});else c("FBLogger")("labyrinth_web","thread_id_absent").mustfix("Reply restore: threadId cannot be null for a restored msg")})).then(function(a){return a.filter(Boolean).filter(function(a){return a.quote!=null})}).then(function(b){return a.messages.bulkPut(b).then(function(c){return b.map(function(b){return d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(a,b).then(function(a){if(e===!0)return;d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(b,void 0,a,"EncryptedBackups")})})})}).then(function(a){return(a=b==null?void 0:b.length)!=null?a:0})})}function j(a){a.msgId;a.originalTs;a.rowId;a.threadJid;a.unsendMsgContentDeleteTs;a=babelHelpers.objectWithoutPropertiesLoose(a,["msgId","originalTs","rowId","threadJid","unsendMsgContentDeleteTs"]);return a}g.addQuoteDataToReplyMessage=a;g.getQuoteDataFromEchoMessage=b;g.updateQuoteDataForReplyMessages=f;g.enhanceAndPersistReplyMessagesWithQuoteData=i}),98);
__d("MAWHandleEchoReactionsRestore",["MAWAckLevel","MAWAuthor","MAWBulkWriteReactionsTxns","MAWHandleEchoMsgsRestoreApiUtils","MAWIndexedDb","MAWTransactionMode","Promise","WAJids","WALogger","WAStanzaUtils","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] reaction fields in backup data uneven in length"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] reactToAuthor field is null"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] reaction external id missing"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] reaction string is not a single character"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Cannot have reactions empty author"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Cannot have reactions for system author"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] echo document is absent for a restored msg"]);o=function(){return a};return a}function a(a,c,d,e){d==null?void 0:d.addPoint("reactions_restore_start");var f=a.echoMsgMap,g=a.restoredMsgsData,i=0;if(g){a=g.existingMsgs;var j=g.newlyAddedMsgs;j=j.concat(a);var k=g.threadJid;a=j.filter(function(a){var b=f.get(a.externalId);return q(f,a)&&b!=null&&r(b)});if(a.length===0)return(h||(h=b("Promise"))).resolve();var l=a.flatMap(function(a){var b=f.get(a.externalId);a=u(g.threadJid,c,a.externalId,a.msgId,a.author,b);return a.map(function(a){return{chatJid:k,unstoredReaction:a}})});return l.length===0?(h||(h=b("Promise"))).resolve():p(l,e).then(function(a){i+=l.length,d==null?void 0:d.addPoint("reactions_restore_end",{"int":{reactions:i}})})}return(h||(h=b("Promise"))).resolve()}var p=d("MAWIndexedDb").makeMsgrTransactor({groupInfo:(c=d("MAWTransactionMode")).READWRITE,messages:c.READWRITE,reactions:c.READWRITE,threads:c.READWRITE},"restoreWriteReactionsToDb",function(a){return function(b,c){return d("MAWBulkWriteReactionsTxns").prepareReactionsData(a,b).then(function(b){return d("MAWBulkWriteReactionsTxns").bulkWriteReactions(a,b,c)})}});function q(a,b){a=a.get(b.externalId);if(a==null){d("WALogger").ERROR(o());return!1}if(d("WAJids").isAuthorSystem(b.author)){d("WALogger").ERROR(n());return!1}if(d("MAWAuthor").getAuthorUserJid(b.author)==null){d("WALogger").ERROR(m());return!1}return!0}function r(a){return a.reactions!=null&&a.reactions.length!==0&&a.reactionXOfflineThreadingIds!=null&&a.reactionXOfflineThreadingIds.length!==0&&a.reactionAuthoritativeTimestampMs!=null&&a.reactionAuthoritativeTimestampMs.length!==0}function s(a,b,c){if((a==null?void 0:a.length)===0){d("WALogger").ERROR(l());return!1}if(b==null){d("WALogger").ERROR(k());return!1}if(c==null){d("WALogger").ERROR(j());return!1}return!0}function t(a,b,c){return(a||[]).map(function(a,e){if(c==null||b==null||(c==null?void 0:c.length)<=e||(b==null?void 0:b.length)<=e){d("WALogger").WARN(i());return[]}return[a,b[e],c[e]]})}function u(a,b,c,e,f,g){var h=d("MAWAuthor").getAuthorUserJid(f);if(g==null||h==null)return[];var i=g.reactionAuthoritativeTimestampMs;i=i===void 0?[]:i;var j=g.reactionXOfflineThreadingIds;j=j===void 0?[]:j;g=g.reactions;return t(g,j,i).filter(function(a){var b=a[0];a=a[1];return a!=null&&s(b.displayName,a.displayName,d("MAWAuthor").getAuthorUserJid(f))}).map(function(f){var g=f[0],i=f[1];f=f[2];var j=g.displayName;g=d("MAWHandleEchoMsgsRestoreApiUtils").resolveAuthorFromEchoAddress(g,b);g={ack:g===d("WAJids").AUTHOR_ME?d("MAWAckLevel").ACK.sent:d("MAWAckLevel").ACK.received,author:g,externalId:d("WAStanzaUtils").toStanzaId(i.displayName||""),groupingKey:j,reaction:j,reactToAuthor:h,reactToExternalId:c,senderTimestampMs:null,threadJid:a,ts:d("WATimeUtils").castToUnixTime(Number(f.displayName)/1e3)};return e!=null?babelHelpers["extends"]({},g,{reactToMsgId:e}):g})}g.writeEchoReactionsToReactionsStore=a;g.getReactionsForReactionStore=u}),98);
__d("MAWMessageParseError",[],(function(a,b,c,d,e,f){"use strict";a=function(a){babelHelpers.inheritsLoose(b,a);function b(b){var c;c=a.call(this,b)||this;c.name="MAWMessageParseError";c.message=b;return c}return b}(babelHelpers.wrapNativeSuper(Error));f.MAWMessageParseError=a}),66);
__d("WAMessageKey",["WAGlobals","WAJids","WAStanzaUtils","err"],(function(a,b,c,d,e,f,g){"use strict";function h(a){return a===d("WAJids").AUTHOR_ME||a==d("WAGlobals").getMyUserJid()}function a(a,b,e){if(e==null)throw c("err")("messageKey is null");var f=e.id,g=e.remoteJid;if(f==null)throw c("err")("messageKey.id is null");else if(g==null)throw c("err")("messageKey.remoteJid is null");g=d("WAJids").interpretAndValidateJid(g);if(g.jidType==="unknown")throw c("err")("messageKey.remoteJid is invalid");var i,j=d("WAJids").AUTHOR_ME;if(g.jidType==="group"){i=g.groupJid;if(h(b)&&e.fromMe===!0)j=d("WAJids").AUTHOR_ME;else if(e.fromMe==!0)j=b;else{var k=e.participant;if(k==null)throw c("err")("key.participant is null");k=d("WAJids").interpretAndValidateJid(k);if(k.jidType==="msgrUser")j=k.userJid;else throw c("err")("key.participant is invalid")}}else if(g.jidType==="msgrUser"||g.jidType==="msgrDevice"){k=d("WAJids").interpretAndValidateJid(a);if(k.jidType!=="msgrUser")throw c("err")("expected user type jid.");i=k.userJid;h(b)?e.fromMe===!0?j=d("WAJids").AUTHOR_ME:j=k.userJid:e.fromMe===!0&&(j=k.userJid)}else throw c("err")("Unsupported jidtype type");return{chat:i,author:h(j)?d("WAJids").AUTHOR_ME:j,externalId:d("WAStanzaUtils").toStanzaId(f)}}g.extractProtocolMessageId=a}),98);
__d("WAParseConsumerMessagePollCreation",["WAGlobals","WAHex","WAMsgType"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c,e){a={unstoredMsg:{type:d("WAMsgType").MSG_TYPE.FUTUREPROOF,msgContent:{protobuf:d("WAHex").bytesToBuffer(a),subtype:"pollCreationMessage"},id:b.id,ts:b.ts,sentTs:b.sentTs,serverTs:b.serverTs,ack:b.ack,reportingMeta:c},unstoredMedia:null,unstoredQuotedMedia:null};if(!e||!d("WAGlobals").getConfig().isPollsEnabled())return a;c=e.encKey;var f=e.options,g=e.name;e=e.selectableOptionsCount;var h=b.id,i=b.ts;b=b.ack;if(c==null||g==null||e==null)return a;a=f.map(function(a){return a.optionName}).filter(Boolean);return{unstoredMsg:{ack:b,id:h,ts:i,type:d("WAMsgType").MSG_TYPE.GROUP_POLL_CREATE},unstoredGroupPollCreateInfo:{encKey:c,name:g,selectableOptionsCount:e,options:a},unstoredMedia:null,unstoredQuotedMedia:null}}g["default"]=a}),98);
__d("WAParseConsumerMessagePollUpdate",["WAGlobals","WAMsgType"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c,e){a=b.id;c=b.ts;b=b.ack;return e==null||!d("WAGlobals").getConfig().isPollsEnabled()?{unstoredMsg:null,unstoredMedia:null,unstoredQuotedMedia:null}:{unstoredMsg:{ack:b,id:a,ts:c,type:d("WAMsgType").MSG_TYPE.GROUP_POLL_UPDATE},unstoredGroupPollUpdateInfo:{pollUpdateMessage:e,type:d("WAMsgType").MSG_TYPE.GROUP_POLL_UPDATE},unstoredMedia:null,unstoredQuotedMedia:null}}g["default"]=a}),98);
__d("WAParseProtocolUtils",["WAGlobals","WALogger","WALongInt","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Unsupported franking version ",""]);h=function(){return a};return a}function a(a,b){b=i(b,a.serverTs);a=b==null?void 0:b.expirationTs;var c=b==null?void 0:b.deleteTs;b=b==null?void 0:b.ephemeralSetting;return{expirationTs:a,deleteTs:c,ephemeralSetting:b}}function b(a,b){b=j(b);b!=null&&(a.reportingMeta=b);return b}function i(a,b){var c;c=a==null?void 0:(c=a.chatEphemeralSetting)==null?void 0:c.ephemeralExpiration;a=a==null?void 0:(a=a.chatEphemeralSetting)==null?void 0:a.ephemeralSettingTimestamp;if(c==null||a==null||c===0||!d("WAGlobals").getConfig().isEphemeralMessagesEnabled())return null;b=d("WATimeUtils").castToUnixTime(b+d("WAGlobals").getDependencies().ephemeralMaxDeletionWindowForUnseenMessage());var e=b,f=null;try{a=d("WALongInt").numberOrThrowIfTooLarge(a)/1e3;f=d("WATimeUtils").castToUnixTime(a)}catch(a){return null}return{expirationTs:b,deleteTs:e,ephemeralSetting:{expirationTs:c,updatedTs:f}}}function j(a){a=a==null?void 0:a.frankingVersion;a!=null&&a!==0&&d("WALogger").ERROR(h(),a);return{frankingKey:void 0,frankingTag:void 0,frankingVersion:a,reportingContent:void 0,reportingTag:void 0}}g.parseEphemerality=a;g.enhanceReportingMeta=b}),98);
__d("WAParseReadOnlyMetadataDataclassToUnsafeObject",["err"],(function(a,b,c,d,e,f,g){"use strict";function a(a){if((a==null?void 0:a.readonlyMetadataDataclass)!=null)try{a=JSON.parse(a==null?void 0:a.readonlyMetadataDataclass);return a}catch(a){throw c("err")("Failed to parse readonly metadata dataclass JSON")}return null}g["default"]=a}),98);
__d("WAParseConsumerMessageProtocol",["WACommon.pb","WAConsumerApplication.pb","WAGlobals","WAHex","WAJids","WALogger","WAMediaTransport.pb","WAMessageKey","WAMsgType","WAParseConsumerMessagePollCreation","WAParseConsumerMessagePollUpdate","WAParseMediaTransportProtocol","WAParseProtocolUtils","WAParseReadOnlyMetadataDataclassToUnsafeObject","WAResultOrError","WAStanzaUtils","WATimeUtils","decodeProtobuf","err","maybeConvertMessageTextMentionsV2ToV1"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["parseConsumerMessageProtocol error :",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["WAParseConsumerMessageProtocol - ephemeralSetting duration is invalid ",", jidType: ",""]);i=function(){return a};return a}var j=90*d("WATimeUtils").DAY_SECONDS;b=1;e=0;f=1;f=d("WAGlobals").getConfig().armadilloWebProcessFutureproof()?f+1:f;function a(a,b,e,f,g,k){var l;b=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAConsumerApplication.pb").ConsumerApplicationSpec,b);l=(l=b.payload)==null?void 0:(l=l.applicationData)==null?void 0:(l=l.revoke)==null?void 0:(l=l.key)==null?void 0:l.id;if(l!=null)return{unstoredMsg:{type:d("WAMsgType").MSG_TYPE.REVOKED,id:e.id,ts:e.ts,sentTs:e.sentTs,serverTs:e.serverTs,ack:e.ack,reportingMeta:e.reportingMeta,revokedExternalId:d("WAStanzaUtils").toStanzaId(l),unsendMsgContentDeleteTs:null,msgContent:null,ebTimestampMs:k},unstoredMedia:null,unstoredQuotedMedia:null};var m=(g==null?void 0:g.isForwarded)||!1;l=d("WAParseProtocolUtils").parseEphemerality(e,g);var x=l.expirationTs,y=l.deleteTs,z=l.ephemeralSetting;if(z!=null&&(z.expirationTs<0||z.expirationTs>j)){l=d("WAJids").interpretAndValidateJid(a);l=l.jidType;var A=z.expirationTs;d("WALogger").ERROR(i(),A,l)}var B=d("WAParseProtocolUtils").enhanceReportingMeta(e,g),C=(A=o(g))!=null?A:void 0,D=(l=b.payload)==null?void 0:l.content;if(!D)return{unstoredMsg:null,unstoredMedia:null,unstoredQuotedMedia:null};var E=(A=b.metadata)==null?void 0:A.specialTextSize,F=t(D),G={contentTypeForLogging:F,unstoredMsg:{type:d("WAMsgType").MSG_TYPE.FUTUREPROOF,msgContent:{protobuf:d("WAHex").bytesToBuffer(f),subtype:null},id:e.id,ts:e.ts,sentTs:e.sentTs,serverTs:e.serverTs,ack:e.ack,reportingMeta:B},unstoredMedia:null,unstoredQuotedMedia:null},H=function(a){return babelHelpers["extends"]({},G,{unstoredMsg:babelHelpers["extends"]({},G.unstoredMsg,{msgContent:babelHelpers["extends"]({},G.unstoredMsg.msgContent,{subtype:a})})})};l=function(){try{switch(F){case"messageText":var b,i=c("maybeConvertMessageTextMentionsV2ToV1")(D[F]);if(i==null)throw c("err")("consumerMessage has no messageText");b=((b=i.commands)==null?void 0:b.some(function(a){return a.commandType===d("WACommon.pb").COMMAND_COMMAND_TYPE.AI}))===!0;if(b&&!d("WAGlobals").getConfig().isMetaAiInvocationMessageRenderEnabled())return H("metaAiMessage");if(w(g))return H("noteMention");if(i.text==null)throw c("err")("consumerMessage has no messageText");return{unstoredMsg:babelHelpers["extends"]({type:d("WAMsgType").MSG_TYPE.TEXT,msgContent:{content:i.text,mentionedJids:i.mentionedJid.map(d("WAJids").validateUserJid).filter(Boolean),commands:i.commands},quote:C,expirationTs:x,deleteTs:y,ephemeralSetting:z,isForwarded:m},e,{specialTextSize:E,ebTimestampMs:k}),unstoredMedia:null,unstoredQuotedMedia:null};case"reactionMessage":return{unstoredMsg:n(a,e,D[F]),unstoredMedia:null,unstoredQuotedMedia:null};case"imageMessage":b=p(D,e.ts);return{unstoredMsg:babelHelpers["extends"]({type:d("WAMsgType").MSG_TYPE.IMAGE,quote:C,expirationTs:x,deleteTs:y,ephemeralSetting:z,isForwarded:m,mediaId:b.plaintextHash},e,{ebTimestampMs:k}),unstoredMedia:b,unstoredQuotedMedia:null};case"videoMessage":var j,l;i=D[F];if(i==null)throw c("err")("consumerMessage has no videoMessage");b=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAMediaTransport.pb").VideoTransportSpec,i==null?void 0:(b=i.video)==null?void 0:b.payload);j=b==null?void 0:(j=b.integral)==null?void 0:(j=j.transport)==null?void 0:(j=j.ancillary)==null?void 0:j.mimetype;l=(b==null?void 0:(l=b.ancillary)==null?void 0:l.gifPlayback)===!0&&j==="image/gif";if(l&&!d("WAGlobals").getConfig().isGifEnabled())return G;j=d("WAParseMediaTransportProtocol").parseVideoMsg(b,e.ts,l);if(j==null)throw c("err")("consumerMessage has no video media info");if(v(g)&&((b=i.caption)==null?void 0:b.text)!=null){return{unstoredMsg:babelHelpers["extends"]({type:d("WAMsgType").MSG_TYPE.TEXT,msgContent:{content:(b=i.caption)==null?void 0:b.text,mentionedJids:i.caption.mentionedJid.map(d("WAJids").validateUserJid).filter(Boolean)},quote:C,expirationTs:x,deleteTs:y,ephemeralSetting:z,isForwarded:m},e,{specialTextSize:E,ebTimestampMs:k}),unstoredMedia:null,unstoredQuotedMedia:null}}return{unstoredMsg:l?babelHelpers["extends"]({type:d("WAMsgType").MSG_TYPE.GIF},e,{quote:C,expirationTs:x,deleteTs:y,ephemeralSetting:z,isForwarded:m,reportingMeta:B,mediaId:j.plaintextHash}):babelHelpers["extends"]({type:d("WAMsgType").MSG_TYPE.VIDEO},e,{quote:C,expirationTs:x,deleteTs:y,ephemeralSetting:z,isForwarded:m,mediaId:j.plaintextHash}),unstoredMedia:j,unstoredQuotedMedia:null};case"audioMessage":b=q(D,e.ts);return{unstoredMsg:babelHelpers["extends"]({type:d("WAMsgType").MSG_TYPE.PTT,quote:C,expirationTs:x,deleteTs:y,ephemeralSetting:z,isForwarded:m,mediaId:b.plaintextHash},e,{ebTimestampMs:k}),unstoredMedia:b,unstoredQuotedMedia:null};case"stickerMessage":if(d("WAGlobals").getConfig().isStickerEnabled()){i=r(D);l=d("WAParseMediaTransportProtocol").parseStickerMsg(i,e.ts);j=((j=i.integral)==null?void 0:j.receiverFetchId)!=null||((b=i.ancillary)==null?void 0:b.receiverFetchId)!=null;b=d("WAGlobals").getConfig().isStickerReceiverFetchEnabled();if(l==null){if(j){if(b){j=d("WAParseMediaTransportProtocol").parseStickerReceiverFetchInfo(i);if(j==null)throw c("err")("consumerMessage has no sticker receiver fetch info");return{unstoredMsg:babelHelpers["extends"]({type:d("WAMsgType").MSG_TYPE.RECEIVER_FETCH,quote:C,expirationTs:x,deleteTs:y,ephemeralSetting:z,isForwarded:m,reportingMeta:B},e,{ebTimestampMs:k}),unstoredMedia:null,unstoredQuotedMedia:null,unstoredReceiverFetchInfo:j}}return H("stickerReceiverFetchMessage")}throw c("err")("consumerMessage has no sticker media info")}return{unstoredMsg:babelHelpers["extends"]({type:d("WAMsgType").MSG_TYPE.STICKER,quote:C,expirationTs:x,deleteTs:y,ephemeralSetting:z,isForwarded:m,reportingMeta:B,mediaId:l.plaintextHash},e,{ebTimestampMs:k}),unstoredMedia:l,unstoredQuotedMedia:null}}return G;case"documentMessage":if(d("WAGlobals").getConfig().isDocumentReceiveEnabled()){b=s(D,e.ts);return{unstoredMsg:babelHelpers["extends"]({type:d("WAMsgType").MSG_TYPE.DOCUMENT_FILE,quote:C,expirationTs:x,deleteTs:y,ephemeralSetting:z,isForwarded:m,reportingMeta:B,mediaId:b.plaintextHash},e,{ebTimestampMs:k}),unstoredMedia:b,unstoredQuotedMedia:null}}return G;case"groupInviteMessage":return{unstoredMsg:null,unstoredMedia:null,unstoredQuotedMedia:null,unstoredIncomingGroupInvite:u(e,D)};case"editMessage":i=D[F];j=i==null?void 0:i.message;l=j==null?void 0:j.text;b=i==null?void 0:(b=i.key)==null?void 0:b.id;if(i==null||j==null||l==null)throw c("err")("consumerMessage with editMessage type has no editMessage");if(b==null)throw c("err")("consumerMessage with editMessage type has no original Msg External Id.");i=d("WAStanzaUtils").toStanzaId(b);return{unstoredEditMsg:{type:d("WAMsgType").MSG_TYPE.EDIT_ACTION,editMsgContent:{content:l,mentionedJids:j.mentionedJid.map(d("WAJids").validateUserJid).filter(Boolean),commands:j.commands},originalMsgExternalId:i,id:e.id,ts:e.ts,sentTs:e.sentTs,serverTs:e.serverTs,ack:e.ack,reportingMeta:B,specialTextSize:E},unstoredMsg:null,unstoredMedia:null,unstoredQuotedMedia:null};case"pollCreationMessage":return c("WAParseConsumerMessagePollCreation")(f,e,B,D[F]);case"pollUpdateMessage":return c("WAParseConsumerMessagePollUpdate")(f,e,B,D[F]);case"contactMessage":case"locationMessage":case"extendedTextMessage":case"statusTextMessage":case"contactsArrayMessage":case"liveLocationMessage":case"viewOnceMessage":default:return G}}catch(a){d("WALogger").ERROR(h(),a);return{unstoredMsg:null,unstoredMedia:null,unstoredQuotedMedia:null}}}();return babelHelpers["extends"]({},l,{contentTypeForLogging:F})}function k(a){if(d("WAJids").isAuthorSystem(a))throw c("err")("Got system author");return a}var l=30;function m(a){if(a==null)return d("WAResultOrError").makeResult(null);return a.length>l?d("WAResultOrError").makeError("invalid-reaction-text-length"):d("WAResultOrError").makeResult(a)}function n(a,b,e){if(e==null)throw c("err")("consumerMessage has no reactionMessage");var f=k(b.id.author);a=d("WAMessageKey").extractProtocolMessageId(a,f,e.key);f=e.text;var g=e.groupingKey;e=e.senderTimestampMs;var h=m(f);if(!h.success){throw c("err")('"'+((f=f)!=null?f:"")+'" is not a valid reaction ['+h.error+"]")}return{type:d("WAMsgType").MSG_TYPE.REACTION,ack:b.ack,id:b.id,reactToExternalId:a.externalId,reactToAuthor:a.author,reaction:h.value,groupingKey:g,ts:b.ts,senderTimestampMs:e}}function o(a){var b,e;b=a==null?void 0:(b=a.quotedMessage)==null?void 0:b.stanzaId;e=a==null?void 0:(e=a.quotedMessage)==null?void 0:e.participant;a=a==null?void 0:(a=a.quotedMessage)==null?void 0:a.remoteJid;e=e!=null?d("WAJids").interpretAndValidateJid(e):null;var f;(e==null?void 0:e.jidType)==="msgrUser"&&e.userJid===d("WAGlobals").getMyUserJid()?f=d("WAJids").AUTHOR_ME:(e==null?void 0:e.jidType)==="msgrUser"?f=e.userJid:f=d("WAJids").AUTHOR_ME;if(b==null)return null;e={type:d("WAMsgType").MSG_TYPE.UNAVAILABLE,author:f,externalId:d("WAStanzaUtils").toStanzaId(b),ts:null};if(a!=null){f=d("WAJids").interpretAndValidateJid(a);if(f.jidType==="group")return{remoteJid:f.groupJid,content:e};else throw c("err")("not supported")}else return{remoteJid:null,content:e}}function p(a,b){a=a.imageMessage;if(a==null)throw c("err")("consumerMessage has no imageMessage");return d("WAParseMediaTransportProtocol").decodeImageTransport(a==null?void 0:(a=a.image)==null?void 0:a.payload,b,"image")}function q(a,b){var e;a=a.audioMessage;if(a==null)throw c("err")("consumerMessage has no audioMessage");e=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAMediaTransport.pb").AudioTransportSpec,a==null?void 0:(e=a.audio)==null?void 0:e.payload);e=d("WAParseMediaTransportProtocol").parseAudioMsg(e,(a==null?void 0:a.ptt)||!1,b);if(e==null)throw c("err")("consumerMessage has no audio media info");return e}function r(a){a=a.stickerMessage;if(a==null)throw c("err")("consumerMessage has no stickerMessage");return d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAMediaTransport.pb").StickerTransportSpec,a==null?void 0:(a=a.sticker)==null?void 0:a.payload)}function s(a,b){var e;a=a.documentMessage;if(a==null)throw c("err")("consumerMessage has no documentMessage");e=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAMediaTransport.pb").DocumentTransportSpec,a==null?void 0:(e=a.document)==null?void 0:e.payload);a=a==null?void 0:a.fileName;e=d("WAParseMediaTransportProtocol").parseDocumentMsg(e,a,b);if(e==null)throw c("err")("consumerMessage has no document media info");return e}function t(a){var b=Object.keys(a).filter(function(a){return a!=="$$unknownFieldCount"});if(b.length!==1)throw c("err")(JSON.stringify(a)+" consumerMessage payload content should have exactly one field, instead found "+JSON.stringify(b));return b[0]}function u(a,b){b=b.groupInviteMessage;if(b==null)throw c("err")("consumerMessage has no GroupInvite Data");return babelHelpers["extends"]({ack:a.ack,author:a.id.author,externalId:a.id.externalId,ts:a.ts},b)}function v(a){a=c("WAParseReadOnlyMetadataDataclassToUnsafeObject")(a);return(a==null?void 0:(a=a.power_up)==null?void 0:a.power_up_style)!=null}function w(a){a=c("WAParseReadOnlyMetadataDataclassToUnsafeObject")(a);return(a==null?void 0:(a=a.note_metadata)==null?void 0:a.message_type)==="MENTION"}g.MINIMAL_MEDIA_DURATION=b;g.DEFAULT_FILE_SIZE=e;g.SUPPORTED_TYPES_VERSION=f;g.parseConsumerMessageProtocol=a;g.interpretAsNonSystemAuthor=k;g.validReactionMessageText=m;g.parseReactionMessage=n;g.parsedQuotedConsumerMessage=o;g.parseOneOfContentType=t}),98);
__d("WAMedia",[],(function(a,b,c,d,e,f){"use strict";a="Image";b="Video";c="Ptt";d="Gif";e="Sticker";var g="DocumentFile",h={IMAGE:a,VIDEO:b,PTT:c,GIF:d,STICKER:e,DOCUMENT_FILE:g};f.IMAGE=a;f.VIDEO=b;f.PTT=c;f.GIF=d;f.STICKER=e;f.DOCUMENT_FILE=g;f.MEDIA_TYPE=h}),66);
__d("WAParseMediaTransportProtocol",["WAGlobals","WAHashUtils","WALogger","WALongInt","WAMedia","WAMediaHdType","WAMediaTransport.pb","WAMediaUtils","WAMsgMap","WAParseConsumerMessageProtocol","WAProgressiveJpegGetScanLengths","WATimeUtils","decodeProtobuf","err"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["cannot compose mediaEntry with the media message"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["protobuf msg with no plaintext hash"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["There is unknown fileds in integral of VideoTransport"]);j=function(){return a};return a}function k(a,b,c,e){var f,g,k;if(!((f=a.integral)==null?void 0:f.transport))return null;f=(f=a.integral)==null?void 0:f.transport;if(d("decodeProtobuf").getUnknownFields(f.integral)!=null){d("WALogger").ERROR(j());return null}g=(g=f.integral)==null?void 0:g.fileSha256;if(!g){c||d("WALogger").ERROR(i());return null}c=null;if(((k=a.ancillary)==null?void 0:k.scansSidecar)!=null&&((k=a.ancillary)==null?void 0:k.scanLengths)!=null){c={sidecar:(k=a.ancillary)==null?void 0:k.scansSidecar,scanLengths:(k=a.ancillary)==null?void 0:(a=k.scanLengths)==null?void 0:a.map(d("WAProgressiveJpegGetScanLengths").asProgressiveJpegScanLength)}}if(((k=f.integral)==null?void 0:k.fileSha256)==null||((a=f.integral)==null?void 0:a.fileEncSha256)==null||((k=f.integral)==null?void 0:k.mediaKey)==null||((a=f.integral)==null?void 0:a.directPath)==null||((k=f.integral)==null?void 0:k.mediaKeyTimestamp)==null||((a=f.ancillary)==null?void 0:a.objectId)==null){d("WALogger").ERROR(h());return null}a=(k=f.ancillary)==null?void 0:k.fileLength;k=(k=f.ancillary.thumbnail)==null?void 0:k.downloadableThumbnail;f=d("WAMediaUtils").rawDataToMediaEntry({fileSha256:f.integral.fileSha256,fileEncSha256:f.integral.fileEncSha256,mediaKey:f.integral.mediaKey,directPath:f.integral.directPath,mediaKeyTimestamp:d("WATimeUtils").castLongIntToUnixTime(f.integral.mediaKeyTimestamp),serverMediaType:b,objectId:(b=f.ancillary)==null?void 0:b.objectId,fbid:void 0,downloadableThumbnail:{directPath:k==null?void 0:k.directPath,fileEncSha256:k==null?void 0:k.fileEncSha256,fileSha256:k==null?void 0:k.fileSha256,mediaKey:k==null?void 0:k.mediaKey,mediaKeyTimestamp:(k==null?void 0:k.mediaKeyTimestamp)==null?null:d("WATimeUtils").castLongIntToUnixTime(k==null?void 0:k.mediaKeyTimestamp),objectId:k==null?void 0:k.objectId},filename:e,progressiveJpegDetails:c,size:a==null?a:d("WALongInt").numberOrThrowIfTooLarge(a)});return{size:a==null?d("WAParseConsumerMessageProtocol").DEFAULT_FILE_SIZE:d("WALongInt").numberOrThrowIfTooLarge(a),plaintextHash:d("WAHashUtils").toPlaintextHash(new Uint8Array(g)),mediaEntry:f}}function l(a){switch(a){case d("WAMediaTransport.pb").IMAGE_TRANSPORT_ANCILLARY_HD_TYPE.NONE:return d("WAMediaHdType").HD_TYPE_NONE;case d("WAMediaTransport.pb").IMAGE_TRANSPORT_ANCILLARY_HD_TYPE.LQ_4K:return d("WAMediaHdType").HD_TYPE_LQ_4K;case d("WAMediaTransport.pb").IMAGE_TRANSPORT_ANCILLARY_HD_TYPE.HQ_4K:return d("WAMediaHdType").HD_TYPE_HQ_4K;default:a;return d("WAMediaHdType").HD_TYPE_NONE}}function m(a,b,c){var e;c=k(a,c,!1);if(!c)return null;c=p(c,b);b=(b=a.ancillary)==null?void 0:b.width;e=(e=a.ancillary)==null?void 0:e.height;a.ancillary!=null&&(a.ancillary.width!=null&&a.ancillary.width===4294967295&&(b=void 0),a.ancillary.height!=null&&a.ancillary.height===4294967295&&(e=void 0));b=babelHelpers["extends"]({},c,{mediaType:d("WAMedia").MEDIA_TYPE.IMAGE,validatedVideoInfo:null,validatedImageInfo:{width:b,height:e,jpegThumbnail:(c=a.integral)==null?void 0:(b=c.transport)==null?void 0:(e=b.ancillary)==null?void 0:(c=e.thumbnail)==null?void 0:c.jpegThumbnail,jpegThumbnailHeight:(b=a.integral)==null?void 0:(e=b.transport)==null?void 0:(c=e.ancillary)==null?void 0:(b=c.thumbnail)==null?void 0:b.thumbnailHeight,jpegThumbnailWidth:(e=a.integral)==null?void 0:(c=e.transport)==null?void 0:(b=c.ancillary)==null?void 0:(e=b.thumbnail)==null?void 0:e.thumbnailWidth,hdType:d("WAGlobals").getConfig().isImageHDSupportedEnabled()?l((c=a.ancillary)==null?void 0:c.hdType):void 0},validatedAudioInfo:null,validatedDocumentFileInfo:null});return b}function a(a,b,e){a=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAMediaTransport.pb").ImageTransportSpec,a);a=m(a,b,e);if(a==null)throw c("err")("consumerMessage has no image media info");return a}function b(a,b,c){var e;if(!((e=a.integral)==null?void 0:e.transport))return null;e=k(a,c?"gif":"video",!1);if(!e)return null;e=p(e,b);b=babelHelpers["extends"]({},e,{accessibilitySummaryText:(b=a.ancillary)==null?void 0:b.accessibilityLabel,mediaType:c?d("WAMedia").MEDIA_TYPE.GIF:d("WAMedia").MEDIA_TYPE.VIDEO,validatedVideoInfo:c?null:{duration:(a==null?void 0:(e=a.ancillary)==null?void 0:e.seconds)!=null&&(a==null?void 0:(b=a.ancillary)==null?void 0:b.seconds)>d("WAParseConsumerMessageProtocol").MINIMAL_MEDIA_DURATION?a==null?void 0:(e=a.ancillary)==null?void 0:e.seconds:d("WAParseConsumerMessageProtocol").MINIMAL_MEDIA_DURATION,width:a==null?void 0:(b=a.ancillary)==null?void 0:b.width,height:a==null?void 0:(e=a.ancillary)==null?void 0:e.height,mimetype:a==null?void 0:(b=a.integral)==null?void 0:(e=b.transport)==null?void 0:(b=e.ancillary)==null?void 0:b.mimetype,jpegThumbnail:(e=a.integral)==null?void 0:(b=e.transport)==null?void 0:(e=b.ancillary)==null?void 0:(b=e.thumbnail)==null?void 0:b.jpegThumbnail,jpegThumbnailHeight:(e=a.integral)==null?void 0:(b=e.transport)==null?void 0:(e=b.ancillary)==null?void 0:(b=e.thumbnail)==null?void 0:b.thumbnailHeight,jpegThumbnailWidth:(e=a.integral)==null?void 0:(b=e.transport)==null?void 0:(e=b.ancillary)==null?void 0:(b=e.thumbnail)==null?void 0:b.thumbnailWidth},validatedImageInfo:c?{width:(e=a.ancillary)==null?void 0:e.width,height:(b=a.ancillary)==null?void 0:b.height,jpegThumbnail:(c=a.integral)==null?void 0:(e=c.transport)==null?void 0:(b=e.ancillary)==null?void 0:(c=b.thumbnail)==null?void 0:c.jpegThumbnail,jpegThumbnailHeight:(e=a.integral)==null?void 0:(b=e.transport)==null?void 0:(c=b.ancillary)==null?void 0:(e=c.thumbnail)==null?void 0:e.thumbnailHeight,jpegThumbnailWidth:(b=a.integral)==null?void 0:(c=b.transport)==null?void 0:(e=c.ancillary)==null?void 0:(a=e.thumbnail)==null?void 0:a.thumbnailWidth}:null,validatedAudioInfo:null,validatedDocumentFileInfo:null});return b}function e(a,b,c){if(!((b=a.integral)==null?void 0:b.transport))return null;b=k(a,"ptt",!1);if(!b)return null;b=p(b,c);b=babelHelpers["extends"]({},b,{mediaType:d("WAMedia").MEDIA_TYPE.PTT,validatedVideoInfo:null,validatedImageInfo:null,validatedDocumentFileInfo:null,validatedAudioInfo:{duration:(a==null?void 0:(c=a.ancillary)==null?void 0:c.seconds)!=null&&(a==null?void 0:(b=a.ancillary)==null?void 0:b.seconds)>d("WAParseConsumerMessageProtocol").MINIMAL_MEDIA_DURATION?a==null?void 0:(c=a.ancillary)==null?void 0:c.seconds:d("WAParseConsumerMessageProtocol").MINIMAL_MEDIA_DURATION,mimetype:a==null?void 0:(b=a.integral)==null?void 0:(c=b.transport)==null?void 0:(a=c.ancillary)==null?void 0:a.mimetype,played:!1}});return b}function f(a,b){var c;if(!((c=a.integral)==null?void 0:c.transport))return null;c=((c=a.integral)==null?void 0:c.receiverFetchId)!=null;c=k(a,"sticker",c);if(!c)return null;c=p(c,b);b=babelHelpers["extends"]({},c,{accessibilitySummaryText:(b=a.ancillary)==null?void 0:b.accessibilityLabel,mediaType:d("WAMedia").MEDIA_TYPE.STICKER,validatedVideoInfo:null,validatedImageInfo:{width:(c=a.ancillary)==null?void 0:c.width,height:(b=a.ancillary)==null?void 0:b.height,jpegThumbnail:(c=a.integral)==null?void 0:(b=c.transport)==null?void 0:(c=b.ancillary)==null?void 0:(b=c.thumbnail)==null?void 0:b.jpegThumbnail,jpegThumbnailHeight:(c=a.integral)==null?void 0:(b=c.transport)==null?void 0:(c=b.ancillary)==null?void 0:(b=c.thumbnail)==null?void 0:b.thumbnailHeight,jpegThumbnailWidth:(c=a.integral)==null?void 0:(b=c.transport)==null?void 0:(a=b.ancillary)==null?void 0:(c=a.thumbnail)==null?void 0:c.thumbnailWidth},validatedAudioInfo:null,validatedDocumentFileInfo:null});return b}function n(a){var b,c,d;if(!((b=a.integral)==null?void 0:b.transport))return null;b=(b=a.ancillary)==null?void 0:b.width;c=(c=a.ancillary)==null?void 0:c.height;d=(d=(d=a.integral)==null?void 0:d.receiverFetchId)!=null?d:(d=a.ancillary)==null?void 0:d.receiverFetchId;a=a==null?void 0:(a=a.integral)==null?void 0:(a=a.transport)==null?void 0:(a=a.ancillary)==null?void 0:a.mimetype;if(b==null||c==null||d==null||a==null)return null;d={receiverFetchId:d,previewWidth:b,previewHeight:c,mimetype:a,type:"sticker"};return d}function o(a,b,c){var e;if(!((e=a.integral)==null?void 0:e.transport))return null;e=k(a,"document",!1,b);if(!e)return null;e=p(e,c);return babelHelpers["extends"]({},e,{mediaType:d("WAMedia").MEDIA_TYPE.DOCUMENT_FILE,validatedVideoInfo:null,validatedImageInfo:null,validatedAudioInfo:null,validatedDocumentFileInfo:{mimetype:a==null?void 0:(c=a.integral)==null?void 0:(e=c.transport)==null?void 0:(a=e.ancillary)==null?void 0:a.mimetype,filename:(c=b)!=null?c:void 0}})}function p(a,b){return{mediaEntry:a.mediaEntry,plaintextHash:a.plaintextHash,size:a.size,msgIds:[],mediaEntries:new(d("WAMsgMap").MsgMap)(),ts:b}}g.getMediaMeta=k;g.decodeImageTransport=a;g.parseVideoMsg=b;g.parseAudioMsg=e;g.parseStickerMsg=f;g.parseStickerReceiverFetchInfo=n;g.parseDocumentMsg=o}),98);
__d("MAWParseBumpExistingMessageMsg",["FBLogger","WAMessageKey","WAParseConsumerMessageProtocol","WAParseProtocolUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b=a.chat,e=a.content,f=a.meta;a=a.metadata;e=e.bumpExistingMessage;if(e==null)throw c("FBLogger")("messenger_web").mustfixThrow("bumpExistingMessage has no content");e=e.key;if(e==null)throw c("FBLogger")("messenger_web").mustfixThrow("bumpExistingMessage has no message key");var g=d("WAParseConsumerMessageProtocol").interpretAsNonSystemAuthor(f.id.author);g=d("WAMessageKey").extractProtocolMessageId(b,g,e);e=g.author;g=g.externalId;a=d("WAParseProtocolUtils").parseEphemerality(f,a);var h=a.deleteTs,i=a.ephemeralSetting;a=a.expirationTs;h={ack:f.ack,deleteTs:h,ephemeralSetting:i,expirationTs:a,id:{author:f.id.author,chat:f.id.chat,externalId:f.id.externalId},quote:{content:{author:e,externalId:g,ts:null,type:"Unavailable"},remoteJid:b},reportingMeta:f.reportingMeta,sentTs:f.sentTs,serverTs:f.serverTs,ts:f.serverTs,type:"BumpExistingMessage"};return{contentTypeForLogging:"bumpExistingMessage",unstoredMedia:null,unstoredMsg:h,unstoredQuotedMedia:null,unstoredXMA:null}}g["default"]=a}),98);
__d("MAWMessageDropError",[],(function(a,b,c,d,e,f){"use strict";a=function(a){babelHelpers.inheritsLoose(b,a);function b(b){var c;c=a.call(this,b)||this;c.name="MAWMessageDropError";c.message=b;return c}return b}(babelHelpers.wrapNativeSuper(Error));f.MAWMessageDropError=a}),66);
__d("MAWParseNetworkVerificationMsg",["MAWMessageDropError","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Web does not support network verification code"]);h=function(){return a};return a}function a(a){d("WALogger").EXPECTED_ERROR(h());throw new(d("MAWMessageDropError").MAWMessageDropError)("Web does not support network verification")}g.parseNetworkVerificationMsg=a}),98);
__d("MAWParseNoteReplyMsg",["FBLogger","MAWJids","MAWMsgType","WAGlobals","WAJids","WALongInt","WAMediaTransport.pb","WAMsgType","WAParseMediaTransportProtocol","WAParseProtocolUtils","WAParseReadOnlyMetadataDataclassToUnsafeObject","WATimeUtils","decodeProtobuf"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b,e=a.content,f=a.ebTimestampMs,g=a.meta;a=a.metadata;e=e.noteReplyMessage;if(h(a))return"noteMention";if(e==null)throw c("FBLogger")("messenger_web").mustfixThrow("noteReplyMessage has no content");b=(b=e.noteText)==null?void 0:b.text;if(b==null)throw c("FBLogger")("messenger_web").mustfixThrow("noteReplyMessage has no note text");var i=e.noteTimestampMs!=null?d("WATimeUtils").castMilliSecondsToUnixTime(d("WALongInt").numberOrThrowIfTooLarge(e.noteTimestampMs)):void 0,j=d("MAWJids").toUserJid(g.id.author),k=d("MAWJids").toUserJid(g.id.chat);j=k===j?d("WAJids").AUTHOR_ME:k;k=d("WAParseProtocolUtils").parseEphemerality(g,a);a=k.deleteTs;var l=k.ephemeralSetting;k=k.expirationTs;a={ack:g.ack,deleteTs:a,ebTimestampMs:f,ephemeralSetting:l,expirationTs:k,forwardingScore:g.forwardingScore,id:{author:g.id.author,chat:g.id.chat,externalId:g.id.externalId},quote:{content:{author:j,expirationTs:i,externalId:g.id.externalId,msgContent:{content:b},ts:g.serverTs,type:d("WAMsgType").NOTE_REPLY},remoteJid:g.id.chat},ts:g.serverTs};var m,n;l=(f=e.textContent)==null?void 0:f.text;k=e.stickerContent;j=e.videoContent;if(l!=null){i=babelHelpers["extends"]({msgContent:{content:l},type:d("MAWMsgType").MSG_TYPE.TEXT},a);b=i}else if(k!=null){f=d("decodeProtobuf").decodeProtobuf(d("WAMediaTransport.pb").StickerTransportSpec,k==null?void 0:k.payload);m=d("WAParseMediaTransportProtocol").parseStickerMsg(f,g.ts);if(m){e=babelHelpers["extends"]({mediaId:m.plaintextHash,type:d("MAWMsgType").MSG_TYPE.STICKER},a);b=e}else{if(((l=f.integral)==null?void 0:l.receiverFetchId)!=null)if(d("WAGlobals").getConfig().isStickerReceiverFetchEnabled()){n=d("WAParseMediaTransportProtocol").parseStickerReceiverFetchInfo(f);if(n==null)throw c("FBLogger")("messenger_web").mustfixThrow("consumerMessage has no sticker receiver fetch info");i=babelHelpers["extends"]({type:d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH},a);b=i}else throw c("FBLogger")("messenger_web").mustfixThrow("noteReplyMessage sticker receiver fetch is not enabled");else throw c("FBLogger")("messenger_web").mustfixThrow("noteReplyMessage sticker has no media")}}else if(j!=null){k=d("decodeProtobuf").decodeProtobuf(d("WAMediaTransport.pb").VideoTransportSpec,j==null?void 0:j.payload);i=k==null?void 0:(e=k.integral)==null?void 0:(l=e.transport)==null?void 0:(f=l.ancillary)==null?void 0:f.mimetype;e=(k==null?void 0:(j=k.ancillary)==null?void 0:j.gifPlayback)===!0&&i==="image/gif";m=d("WAParseMediaTransportProtocol").parseVideoMsg(k,g.ts,e);if(m&&e){l=babelHelpers["extends"]({mediaId:m.plaintextHash,type:d("MAWMsgType").MSG_TYPE.GIF},a);b=l}else if(!m)throw c("FBLogger")("messenger_web").mustfixThrow("noteReplyMessage video has no media");else throw c("FBLogger")("messenger_web").mustfixThrow("noteReplyMessage video is not a gif")}else throw c("FBLogger")("messenger_web").mustfixThrow("noteReplyMessage has no valid content");return{contentTypeForLogging:"noteReplyMessage",unstoredMedia:m,unstoredMsg:b,unstoredQuotedMedia:null,unstoredReceiverFetchInfo:n,unstoredXMA:null}}function h(a){a=c("WAParseReadOnlyMetadataDataclassToUnsafeObject")(a);return(a==null?void 0:(a=a.note_metadata)==null?void 0:a.message_type)==="MENTION"}g["default"]=a}),98);
__d("MAWParseRavenActionNotificationMsg",["FBLogger","MAWMsg","WAStanzaUtils","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b,e,f=a.content;a=a.meta;b=(b=f.ravenActionNotifMessage)==null?void 0:b.actionType;b=d("MAWMsg").MAWRavenActionNotifType.cast(b);e=(e=f.ravenActionNotifMessage)==null?void 0:e.actionTimestamp;var g;if(e!=null){e=Number(e);e>d("WATimeUtils").MAX_INT?g=d("WATimeUtils").castMilliSecondsToUnixTime(e):g=d("WATimeUtils").castToUnixTime(e)}e=((e=f.ravenActionNotifMessage)==null?void 0:(e=e.key)==null?void 0:e.id)!=null?d("WAStanzaUtils").toStanzaId((e=f.ravenActionNotifMessage)==null?void 0:(f=e.key)==null?void 0:f.id):null;if(b==null)throw c("FBLogger")("messenger_web").mustfixThrow("Error when getting actionType for RavenNotificationMessage "+a.id.externalId);if(g==null)throw c("FBLogger")("messenger_web").mustfixThrow("Error when getting actionTimestamp for RavenNotificationMessage "+a.id.externalId);if(e==null)throw c("FBLogger")("messenger_web").mustfixThrow("Error when getting ravenActionToMsgExternalId for RavenNotificationMessage "+a.id.externalId);f={ack:a.ack,actionTimestamp:g,actionType:b,id:a.id,ravenActionToMsgExternalId:e,sentTs:a.sentTs,serverTs:a.serverTs,ts:a.serverTs,type:"RavenAction"};return{unstoredMedia:null,unstoredMsg:f,unstoredQuotedMedia:null,unstoredXMA:null}}g.parseRavenActionNotificationMessage=a}),98);
__d("MAWParseRavenMsg",["FBLogger","MAWMsg","MAWMsgType","MAWParseSubprotocolVersionConsts","WALogger","WAMediaTransport.pb","WAParseMediaTransportProtocol","WAParseProtocolUtils","decodeProtobuf"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["\n        received video messsage version is older than expected ",". "]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["\n        received image messsage version is older than expected ",". "]);i=function(){return a};return a}function a(a){var b=a.content,e=a.ebTimestampMs,f=a.meta;a=a.metadata;b=b.ravenMessageMsgr;if(b==null)throw c("FBLogger")("messenger_web").mustfixThrow("Raven message payload has no content");var g=d("MAWMsg").MAWRavenMsgEphemeralType.cast(b.ephemeralType);if(g==null)throw c("FBLogger")("messenger_web").mustfixThrow("Error when casting ephemeralType for Raven message");var j=void 0,k=void 0;if(b.imageMessage)(b.imageMessage.version==null||b.imageMessage.version<d("MAWParseSubprotocolVersionConsts").RAVEN_IMAGE_MESSAGE_SUBPROTOCOL_VERSION)&&d("WALogger").WARN(i(),d("MAWParseSubprotocolVersionConsts").RAVEN_IMAGE_MESSAGE_SUBPROTOCOL_VERSION),j=d("WAParseMediaTransportProtocol").decodeImageTransport(b.imageMessage.payload,f.ts,"image"),k=d("MAWMsg").MAWRavenMsgMediaType.IMAGE;else if(b.videoMessage){(b.videoMessage.version==null||b.videoMessage.version<d("MAWParseSubprotocolVersionConsts").RAVEN_VIDEO_MESSAGE_SUBPROTOCOL_VERSION)&&d("WALogger").WARN(h(),d("MAWParseSubprotocolVersionConsts").RAVEN_VIDEO_MESSAGE_SUBPROTOCOL_VERSION);b=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAMediaTransport.pb").VideoTransportSpec,b.videoMessage.payload);j=d("WAParseMediaTransportProtocol").parseVideoMsg(b,f.ts,!1);k=d("MAWMsg").MAWRavenMsgMediaType.VIDEO}else throw c("FBLogger")("messenger_web").mustfixThrow("Error unsupported Raven message type");if(j==null)throw c("FBLogger")("messenger_web").mustfixThrow("Error Raven message has no associated image or video");b=d("WAParseProtocolUtils").parseEphemerality(f,a);a=b.deleteTs;var l=b.ephemeralSetting;b=b.expirationTs;a={ack:f.ack,deleteTs:a,ebTimestampMs:e,ephemeralSetting:l,expirationTs:b,id:f.id,mediaId:j.plaintextHash,ravenEphemeralMediaState:g===d("MAWMsg").MAWRavenMsgEphemeralType.KEEP_IN_CHAT?d("MAWMsg").MAWRavenMsgEphemeralMediaState.PERMANENT:d("MAWMsg").MAWRavenMsgEphemeralMediaState.UNSEEN,ravenEphemeralType:g,ravenMediaType:k,reportingMeta:f.reportingMeta,sentTs:f.sentTs,serverTs:f.serverTs,ts:f.ts,type:d("MAWMsgType").MSG_TYPE.RAVEN};return{unstoredMedia:j,unstoredMsg:a,unstoredQuotedMedia:null,unstoredXMA:null}}g.parseRavenMessage=a}),98);
__d("MAWParseScreenshotActionMsg",["FBLogger","MAWExternalId","MAWMsgType","WAAckLevel","WAArmadilloApplication.pb","WAJids"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b=a.content;a=a.meta;b=b.screenshotAction;if(b==null)throw c("FBLogger")("messenger_web").mustfixThrow("screenshotAction has no content");b=b.screenshotType;if(b==null)throw c("FBLogger")("messenger_web").mustfixThrow("Missing screenshot type in payload");if(![d("WAArmadilloApplication.pb").ARMADILLO_CONTENT_SCREENSHOT_ACTION_SCREENSHOT_TYPE.SCREENSHOT_IMAGE,d("WAArmadilloApplication.pb").ARMADILLO_CONTENT_SCREENSHOT_ACTION_SCREENSHOT_TYPE.SCREEN_RECORDING].includes(b))throw c("FBLogger")("messenger_web").mustfixThrow("Received unexpected screenshot action type");b={ack:d("WAAckLevel").ACK.SENT,id:{author:d("WAJids").AUTHOR_SYSTEM,chat:a.id.chat,externalId:d("MAWExternalId").generateExternalId()},msgContent:{adminMsgContent:[],adminType:"youEphemeralTakeScreenshot",screenshotActionType:b},ts:a.serverTs,type:d("MAWMsgType").EPHEMERAL_SCREENSHOT_ACTION};return{contentTypeForLogging:"screenshotAction",unstoredMedia:null,unstoredMsg:b,unstoredQuotedMedia:null,unstoredXMA:null}}g.parseEphemeralScreenshotActionProtocol=a}),98);
__d("MAWParseArmadilloProtocol",["FBLogger","MAWMessageParseError","MAWMsgType","MAWParseBumpExistingMessageMsg","MAWParseNetworkVerificationMsg","MAWParseNoteReplyMsg","MAWParseRavenActionNotificationMsg","MAWParseRavenMsg","MAWParseScreenshotActionMsg","MAWParseXMAProtocol","WAArmadilloApplication.pb","WAHex","WALogger","decodeProtobuf"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["MAWParseArmadilloProtocol - Dropping message. contentType: ",", reason: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["MAWParseArmadilloProtocol - handling futureproof message for contentType: ",""]);i=function(){return a};return a}b={unstoredMedia:null,unstoredMsg:null,unstoredQuotedMedia:null,unstoredXMA:null};var j=new Map([["screenshotAction",d("MAWParseScreenshotActionMsg").parseEphemeralScreenshotActionProtocol],["extendedContentMessage",d("MAWParseXMAProtocol").parseXMAProtocol],["paymentsTransactionMessage",d("MAWParseXMAProtocol").parseXMAProtocol],["noteReplyMessage",c("MAWParseNoteReplyMsg")],["bumpExistingMessage",c("MAWParseBumpExistingMessageMsg")],["ravenMessageMsgr",d("MAWParseRavenMsg").parseRavenMessage],["ravenActionNotifMessage",d("MAWParseRavenActionNotificationMsg").parseRavenActionNotificationMessage],["networkVerificationMessage",d("MAWParseNetworkVerificationMsg").parseNetworkVerificationMsg]]);function a(a,b,c,e,f,g,m){b=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAArmadilloApplication.pb").ArmadilloSpec,b);b=(b=b.payload)==null?void 0:b.content;if(!b)throw new(d("MAWMessageParseError").MAWMessageParseError)("parse_armadillo_protocol_error:: empty_payload_content");var n=l(b);try{var o=j.get(n),p=null;if(o!=null){o=o({chat:a,content:b,ebTimestampMs:m,meta:c,metadata:g,protobuf:e},f);if(typeof o!=="string")return o;else p=o}d("WALogger").LOG(i(),n);return{contentTypeForLogging:n,unstoredMedia:null,unstoredMsg:{ack:c.ack,id:c.id,msgContent:{protobuf:d("WAHex").bytesToBuffer(e),subtype:(a=p)!=null?a:k(n)},reportingMeta:c.reportingMeta,sentTs:c.sentTs,serverTs:c.serverTs,ts:c.ts,type:d("MAWMsgType").MSG_TYPE.FUTUREPROOF},unstoredQuotedMedia:null,unstoredXMA:null}}catch(a){d("WALogger").ERROR(h(),n,a);throw new(d("MAWMessageParseError").MAWMessageParseError)("parse_armadillo_protocol_error:: contentType:: "+n+" reason:: "+a)}}function k(a){switch(a){case"bumpExistingMessage":return"bumpMessage";default:return null}}function l(a){var b=Object.keys(a).filter(function(a){return a!=="$$unknownFieldCount"});if(b.length!==1)throw c("FBLogger")("messenger_web").mustfixThrow(JSON.stringify(a)+" armadillo payload content should only have one field");a=b[0];return a}g.EMPTY_CONTENT=b;g.parseArmadilloProtocol=a;g.parseOneOfContentType=l}),98);
__d("MAWParseCollapsibleIdFromXMADataClass",["FBLogger","MWXMAV2IsDataclassLiveLocationXMA"],(function(a,b,c,d,e,f,g){"use strict";function a(a){if(a==null)throw c("FBLogger")("messenger_web").mustfixThrow("xmaDataclass is missing or invalid");var b=d("MWXMAV2IsDataclassLiveLocationXMA").isDataclassLiveLocationXMA(a);if(b)return h(a);b=JSON.parse(a);a=b.layout_config;if(a==null||typeof a.collapsible_id!=="number")throw c("FBLogger")("messenger_web").mustfixThrow("Layout config or collapsible_id is missing or invalid");return a.collapsible_id}function h(a){a=JSON.parse(a);a=(a=a.content)==null?void 0:a.custom_template_data;if((a==null?void 0:a.__typename)!=="XMSGXmaLocationTemplateData"||a==null)throw c("FBLogger")("messenger_web").mustfixThrow("Live location metadata or session_id is missing");return parseInt(a.location_metadata.session_id,10)}g.parseCollapsibleIdFromXMADataClass=a}),98);
__d("MAWXMALoggingUtils",["WAArmadilloXMA.pb","objectEntries"],(function(a,b,c,d,e,f,g){"use strict";var h=c("objectEntries")(d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE).reduce(function(a,b){var c=b[0];b=b[1];a.set(b,c);return a},new Map());function a(a){return a!=null?h.get(a):void 0}g.getXmaTargetTypeStringFromEnum=a}),98);
__d("MWXMAV2IsCollapsibleXMA",["FBLogger","MWXMAV2IsDataclassLiveLocationXMA"],(function(a,b,c,d,e,f,g){"use strict";function a(a){if(a==null)return!1;var b;try{b=JSON.parse(a)}catch(a){c("FBLogger")("messenger_web_sharing").mustfix("Error parsing xma dataclass");return!1}if(b==null)return!1;var e=b.layout_config;return(e==null?void 0:e.collapsible_id)==null&&!d("MWXMAV2IsDataclassLiveLocationXMA").isDataclassLiveLocationXMA(a)?!1:!0}g.isCollapsibleXMA=a}),98);
__d("MAWParseXMAProtocol",["ACTSanitizerApiTypes","FBLogger","MAWMsgType","MAWODSProxy","MAWParseArmadilloProtocol","MAWParseCollapsibleIdFromXMADataClass","MAWParseSubprotocolVersionConsts","MAWParseXMAFBConfig","MAWXMALoggingUtils","MWXMAV2IsCollapsibleXMA","MWXMAV2IsDataclassLiveLocationXMA","WAArmadilloXMA.pb","WAGetPlatformFromStanzaId","WAHex","WAJids","WALogger","WAMedia","WAMsgApplication.pb","WAOdsEnums","WAParseConsumerMessageProtocol","WAParseMediaTransportProtocol","WAParseMessageApplication","WAParseProtocolUtils","WAStanzaUtils","WATimeUtils","decodeProtobuf"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["S410301 The url contains RTL characters"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(['S410301 The url is invalid. It contains a colon separator, but not "://"']);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Invalid message text during XMA restore"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Invalid url prefix during XMA restore"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose([""," XMA has invalid native URL for target type: ",". hasNativeUrl: ",". hasActionUrl: ","."]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose([""," XMA has invalid action URL for target type: ",". hasNativeUrl: ",". hasActionUrl: ","."]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose([""," XMA has invalid action and native URL for target type: ",". hasNativeUrl: ",". hasActionUrl: ","."]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["ExternalId: "," textId: ",""]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["\n      received previews version is older than expected ",". "]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["\n    received favicon version is older than expected ",". "]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["\n    received headerImage version is older than expected ",". "]);r=function(){return a};return a}function s(){var a=babelHelpers.taggedTemplateLiteralLoose(["\n      received associatedMessage version is older than expected "," as expected. "]);s=function(){return a};return a}function t(){var a=babelHelpers.taggedTemplateLiteralLoose(["[XMA] received associated message with incorrect version ",""]);t=function(){return a};return a}var u=new Set([d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_REPLY]);function v(a,b){return a==null||a.payload==null?void 0:d("WAParseMediaTransportProtocol").decodeImageTransport(a.payload,b,"xma-image")}function aa(a,b,e,f,g){if(b==null||b.payload==null)return null;b.version!==d("MAWParseSubprotocolVersionConsts").ASSOCIATED_MESSAGE_SUBPROTOCOL_VERSION&&d("WALogger").ERROR(t(),b.version);b=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAMsgApplication.pb").MessageApplicationSpec,b.payload);b=d("WAParseMessageApplication").parseMessageApplication(b);if(b.type==="error")throw c("FBLogger")("messenger_web").mustfixThrow("XMA contains unparseable message application.");b=b;if(b.subprotocolType!=="consumerMessage")throw c("FBLogger")("messenger_web").mustfixThrow("XMA contains incorrect message application type: "+b.subprotocolType);return d("WAParseConsumerMessageProtocol").parseConsumerMessageProtocol(a,b.payload,e,f,g)}var w="https://www.instagram.com/stories/",x="https://www.instagram.com/reel/",y="https://www.instagram.com/tv/",z="https://www.instagram.com/_n/profile_shop?",A="https://www.instagram.com/",B="https://www.alpha.facebook.com/share/",C="https://m.facebook.com/share/",D="https://www.facebook.com/share/",E="https://m.alpha.facebook.com/share/",F="https://facebook.com/share/",G="https://www.alpha.facebook.com/stories/",H="https://www.facebook.com/stories/",I="https://fb.gg/",J="https://www.facebook.com/",K="https://m.facebook.com/",L="https://www.alpha.facebook.com/",M="https://m.alpha.facebook.com/",N="https://facebook.com/",O="https://fb.watch/",P="https://www.facebook.com/l.php",Q="https://m.facebook.com/l.php",R="https://www.alpha.facebook.com/l.php",S="https://m.alpha.facebook.com/l.php",T="https://facebook.com/l.php",U="https://l.facebook.com/l.php",V="https://facebook.com/events/",W="https://www.facebook.com/events/",X="https://www.alpha.facebook.com/events/",Y="https://m.facebook.com/events/",Z="https://m.alpha.facebook.com/events/",ba="fb-messenger://payments/receipt?product_id=",ca="messenger://location_share",da="http://m.me/",ea=":",fa="http://",ga="https://";function a(a,b){var e=a.chat,f=a.content,g=a.ebTimestampMs,h=a.meta,i=a.metadata;a=a.protobuf;var j=d("MAWParseArmadilloProtocol").parseOneOfContentType(f);j=j==="paymentsTransactionMessage";var k=null;if(j){var l;k=(l=f.paymentsTransactionMessage)==null?void 0:l.extendedContentMessage}else k=f.extendedContentMessage;if(k==null&&j)return"paymentsTransactionMessage";if(k==null)throw c("FBLogger")("messenger_web").mustfixThrow("extendedContentMessage has no content");l=k;f=l.targetType;l=l.xmaDataclass;var m=d("WAGetPlatformFromStanzaId").getPlatformFromStanzaId(h.id.externalId),n;try{n=b(k)}catch(a){d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.MAW_XMA_PROTOCOL_PARSING,key:"xma_validation."+m+"."+(f||0)+".error"});throw c("FBLogger")("messenger_web").mustfixThrow("Unexpected error trying to validate XMA content: "+a.message)}if(n===d("ACTSanitizerApiTypes").ACTSanitizerValidationResult.Valid)d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.MAW_XMA_PROTOCOL_PARSING,key:"xma_validation."+m+"."+(f||0)+".valid"});else{d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.MAW_XMA_PROTOCOL_PARSING,key:"xma_validation."+m+"."+(f||0)+".invalid."+n});throw c("FBLogger")("messenger_web").mustfixThrow("extendedContentMessage does not have valid XMA content")}if(l!=null){d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.MAW_XMA_PROTOCOL_PARSING,key:"xma_dataclass.exists."+((b=f)!=null?b:"null")})}if(f==null||!d("MAWParseXMAFBConfig").isFBSupportedTargetType({fbTargetType:f,xmaDataclass:l}))return{contentTypeForLogging:"extendedContentMessage",unstoredMedia:null,unstoredMsg:{ack:h.ack,id:h.id,msgContent:{protobuf:d("WAHex").bytesToBuffer(a),subtype:ia(f,l,j)},reportingMeta:h.reportingMeta,sentTs:h.sentTs,serverTs:h.serverTs,ts:h.ts,type:d("MAWMsgType").MSG_TYPE.FUTUREPROOF},unstoredQuotedMedia:null,unstoredXMA:null,xmaTargetTypeForLogging:f};b=d("WAParseProtocolUtils").parseEphemerality(h,i);j=b.deleteTs;var t=b.ephemeralSetting;b=b.expirationTs;var w=d("WAParseProtocolUtils").enhanceReportingMeta(h,i),x=k,y=x.associatedMessage,z=x.commands,A=x.contentRef,B=x.ctas,C=x.favicon,D=x.headerImage,E=x.headerTitle,F=x.maxSubtitleNumOfLines,G=x.maxTitleNumOfLines,H=x.mentionedJid,I=x.messageText,J=x.overlayDescription,K=x.overlayIconGlyph,L=x.overlayTitle,M=x.previews,N=x.sentWithMessageId,O=x.subtitleText,P=x.targetId,Q=x.targetUsername,R=x.titleText;x=x.xmaLayoutType;y!=null&&(y.version==null||y.version<d("MAWParseSubprotocolVersionConsts").ASSOCIATED_MESSAGE_SUBPROTOCOL_VERSION)&&d("WALogger").WARN(s(),d("MAWParseSubprotocolVersionConsts").ASSOCIATED_MESSAGE_SUBPROTOCOL_VERSION);D!=null&&(D.version==null||D.version<d("MAWParseSubprotocolVersionConsts").XMA_HEADER_SUBPROTOCOL_VERSION)&&d("WALogger").WARN(r(),d("MAWParseSubprotocolVersionConsts").XMA_HEADER_SUBPROTOCOL_VERSION);C!=null&&(C.version==null||C.version<d("MAWParseSubprotocolVersionConsts").XMA_FAVICON_SUBPROTOCOL_VERSION)&&d("WALogger").WARN(q(),d("MAWParseSubprotocolVersionConsts").XMA_FAVICON_SUBPROTOCOL_VERSION);M.every(function(a){(a.version==null||a.version<d("MAWParseSubprotocolVersionConsts").XMA_PREVIEW_SUBPROTOCOL_VERSION)&&d("WALogger").WARN(p(),d("MAWParseSubprotocolVersionConsts").XMA_PREVIEW_SUBPROTOCOL_VERSION)});k=k.targetExpiringAtSec!=null?d("WATimeUtils").castLongIntToUnixTime(k.targetExpiringAtSec):void 0;var S=y!=null&&N!=null?[d("WAStanzaUtils").toStanzaId(N),h.id.externalId]:[h.id.externalId,void 0],T=S[0];S=S[1];var U=[];if(M!=null)for(var V=0;V<M.length;V++){var W,X=v(M[V],h.ts);X!=null&&!((f===d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE||f===d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_SHARE)&&X.mediaType===d("WAMedia").MEDIA_TYPE.IMAGE&&((W=X.validatedImageInfo)==null?void 0:W.height)===1&&((W=X.validatedImageInfo)==null?void 0:W.width)===1)&&U.push(X)}W=v(D,h.ts);X=v(C,h.ts);M=(V=d("WAParseConsumerMessageProtocol").parsedQuotedConsumerMessage(i))!=null?V:void 0;var Y;if(d("MWXMAV2IsCollapsibleXMA").isCollapsibleXMA(l))try{Y=d("MAWParseCollapsibleIdFromXMADataClass").parseCollapsibleIdFromXMADataClass(l)}catch(a){d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.MAW_XMA_PROTOCOL_PARSING,key:"xma_validation."+m+"."+(f||0)+".error"});throw c("FBLogger")("messenger_web").mustfixThrow("Unexpected error trying to parse collapsible ID: "+a.message)}D=babelHelpers["extends"]({collapsibleId:Y,deleteTs:j,ebTimestampMs:g,ephemeralSetting:t,expirationTs:b,id:babelHelpers["extends"]({},h.id,{externalId:T}),quote:M,reportingMeta:w,type:d("MAWMsgType").MSG_TYPE.XMA},h);C=B.map(function(a){a.actionContentBlob;a=babelHelpers.objectWithoutPropertiesLoose(a,["actionContentBlob"]);return a});V=C.slice(1);f===d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_GAMING_CUSTOM_UPDATE&&B.length===1&&(V=C);m=f===d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_CONTACT;M={author:h.id.author,commands:z,contentRef:A,ctas:V,defaultCTA:C[0],externalId:T,faviconMediaId:m?(j=W==null?void 0:W.plaintextHash)!=null?j:void 0:(g=X==null?void 0:X.plaintextHash)!=null?g:void 0,headerMediaId:m?(t=X==null?void 0:X.plaintextHash)!=null?t:void 0:(b=W==null?void 0:W.plaintextHash)!=null?b:void 0,headerTitle:E,isTombstoned:k!=null?d("WATimeUtils").unixTime()>k:!1,maxSubtitleNumOfLines:F,maxTitleNumOfLines:G,mentionedJids:H.map(d("WAJids").validateUserJid).filter(Boolean),overlayDescription:J,overlayIconGlyph:K,overlayTitle:L,previewMediaIds:U.length>0?U.map(function(a){return a.plaintextHash}):void 0,sentWithMessage:I,subtitleText:O,targetExpiringAtSec:k,targetId:P,targetType:f,targetUsername:Q,threadJid:e,titleText:R,xmaDataclass:l,xmaLayoutType:x};var Z;if(y!=null&&N==null)throw c("FBLogger")("messenger_web").mustfixThrow("XMA associatedMessage cannot be received without sentWithMessageId field");y!=null&&S!=null&&(Z=aa(e,y,h,a,i));z=(B=(w=Z)==null?void 0:w.unstoredMedia)!=null?B:null;A=u.has(f);if(z!=null&&!A){V=d("MAWXMALoggingUtils").getXmaTargetTypeStringFromEnum(f);d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.MAW_XMA_PROTOCOL_PARSING,key:"assoc_msg_media_"+((C=V)!=null?C:"unknown")});throw c("FBLogger")("messenger_web").mustfixThrow("XMA associated msg cannot have additioinal dbMedia")}t=(g=(j=Z)==null?void 0:j.unstoredMsg)!=null?g:null;S!=null&&t!=null&&(d("WALogger").DEV(o(),T,S),t.id=babelHelpers["extends"]({},t.id,{externalId:S}),D.id=babelHelpers["extends"]({},t.id,{externalId:T}),M.externalId=T);if(A&&z!=null&&((t==null?void 0:t.type)==="Gif"||(t==null?void 0:t.type)==="Sticker"))return{contentTypeForLogging:"extendedContentMessage",unstoredMedia:null,unstoredMsg:D,unstoredQuotedMedia:null,unstoredXMA:{unstoredAssociatedMedia:z!=null?z:void 0,unstoredAssociatedMsg:t!=null?t:void 0,unstoredFavicon:m?U[0]:X,unstoredHeaderMedia:W,unstoredPreviews:U.length>0?U:void 0,xma:M},xmaTargetTypeForLogging:f};if(t!=null&&t.type!=="Text")throw c("FBLogger")("messenger_web").mustfixThrow('XMA associated msg cannot have type different from "Text". Received type: '+t.type);return{contentTypeForLogging:"extendedContentMessage",unstoredMedia:null,unstoredMsg:D,unstoredQuotedMedia:null,unstoredXMA:{unstoredAssociatedMedia:void 0,unstoredAssociatedMsg:t!=null?t:void 0,unstoredFavicon:m?U[0]:X,unstoredHeaderMedia:W,unstoredPreviews:U.length>0&&!m?U:void 0,xma:M},xmaTargetTypeForLogging:f}}function ha(a){var b=a.ebRestore,c=a.hasActionUrl,e=a.hasNativeUrl,f=a.isActionUrlValid,g=a.isNativeUrlValid;a=a.targetType;!g&&!f?d("WALogger").ERROR(n(),b!=null&&b?"[labyrinth_web]":"[S410301][transport]",a,e,c):g&&!f?d("WALogger").ERROR(m(),b!=null&&b?"[labyrinth_web]":"[S410301][transport]",a,e,c):f&&!g&&d("WALogger").ERROR(l(),b!=null&&b?"[labyrinth_web]":"[S410301][transport]",a,e,c)}function b(a,b,c){var d=a.nativeUrl;a=a.actionUrl;var e=$(d,b,c),f=$(a,b,c);ha({ebRestore:c,hasActionUrl:a!=null,hasNativeUrl:d!=null,isActionUrlValid:f,isNativeUrlValid:e,targetType:b});return e&&f}function ia(a,b,c){c===void 0&&(c=!1);if(a==null)return null;if(c)return"paymentsTransactionMessage";switch(a){case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_LOCATION_SHARING:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_LOCATION_SHARING_V2:return d("MWXMAV2IsDataclassLiveLocationXMA").isDataclassLiveLocationXMA(b)?"liveLocationMessage":"locationMessage";case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_CONTACT:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_AI_CONTACT:return"contactShareMessage";case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_MENTION:return"storyMentionMessage";case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_POST_MENTION:return"postMentionMessage";case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_MEMORIES_SHARE:return"messengerMemory";default:return null}}function $(a,b,c,e){e===void 0&&(e=!1);if(a==null)return!0;if(na(a,b)===!1){c!=null&&c&&!e&&d("WALogger").ERROR(k());return!1}if(!oa(a)){c!=null&&c&&!e&&d("WALogger").ERROR(j());return!1}return!0}function ja(a){return a.startsWith(B)||a.startsWith(C)||a.startsWith(D)||a.startsWith(E)||a.startsWith(F)}function ka(a){return a.startsWith(P)||a.startsWith(Q)||a.startsWith(R)||a.startsWith(S)||a.startsWith(T)||a.startsWith(U)}function la(a){return a.startsWith(J)||a.startsWith(K)||a.startsWith(L)||a.startsWith(M)||a.startsWith(N)}function ma(a){return a.startsWith(V)||a.startsWith(W)||a.startsWith(X)||a.startsWith(Y)||a.startsWith(Z)}function na(a,b){if(a==null)return!0;switch(b){case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_MENTION:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_HIGHLIGHT_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_HIGHLIGHT_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_REPLY:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_HIGHLIGHT_REPLY:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_REACTION:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_HIGHLIGHT_REACTION:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_MENTION:return a.startsWith(w);case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_CLIPS_SHARE:return a.startsWith(x);case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_IGTV_SHARE:return a.startsWith(y);case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SHOP_SHARE:return a.startsWith(z);case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SINGLE_IMAGE_POST_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_MULTIPOST_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SINGLE_VIDEO_POST_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_PROFILE_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_IG_MEDIA_SHARE:return a.startsWith(A);case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_REPLY:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_PRODUCER_STORY_REPLY:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_MENTION:return a.startsWith(H)||a.startsWith(G)||ja(a);case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_GAMING_CUSTOM_UPDATE:return a.startsWith(I);case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_POST_PRIVATE_REPLY:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_SHORT:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_VIDEO_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_HIGHLIGHTS_TAB_FRIEND_UPDATES_REPLY:return(la(a)||a.startsWith(O))&&!ka(a);case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_LOCATION_SHARING:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_LOCATION_SHARING_V2:return a.startsWith(ca);case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_HIGHLIGHTS_TAB_LOCAL_EVENT_REPLY:return ma(a);case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_EVENT:return ma(a)||ja(a);case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_CONTACT:return la(a)||a.startsWith(da);case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_EXTERNAL_LINK:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_AUDIO_CALL:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_VIDEO_CALL:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_AUDIO_CALL:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_VIDEO_CALL:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_GROUP_AUDIO_CALL:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_GROUP_VIDEO_CALL:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_GROUP_AUDIO_CALL:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_GROUP_VIDEO_CALL:if(a.includes(ea)&&(!a.startsWith(fa)&&!a.startsWith(ga))){b=a.indexOf("://");b===-1&&d("WALogger").ERROR(i());return!1}break;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_RECEIVER_FETCH:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.DATACLASS_SENDER_COPY:return!0;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_P2P_PAYMENT:return a.startsWith(ba)}return!0}function oa(a){for(var b=0;b<a.length;b++){var c=a.charAt(b);switch(c){case"\u202c":case"\u202d":case"\u202e":d("WALogger").ERROR(h());return!1;default:break}}return!0}g.SUPPORTED_XMA_ASSOC_MEDIA_TARGET_TYPES=u;g.kIGStoryCtaPrefix=w;g.kIGClipsCtaPrefix=x;g.kIGTVCtaPrefix=y;g.kIGShopCtaPrefix=z;g.kIGDefaultCtaPrefix=A;g.kFBStoryCtaPrefix=H;g.kFBGamingCustomUpdateCtaPrefix=I;g.kFBDefaultWWWCtaPrefix=J;g.kFBEventCtaPrefix=V;g.kMSGP2PPaymentUrlPrefix=ba;g.kMessengerLocationSharePrefix=ca;g.kHttpPrefix=fa;g.parseXMAProtocol=a;g.isValidCTA=b;g.getUnsupportedMessageType=ia;g.isURLValid=$}),98);
__d("MAWHandleEchoXMARestoreV2",["EchoMessage","LSDataTraceCheckPoint","LSIntEnum","MAWBridge","MAWConvertXMAGatingTypeToExtendedContentOverlayIconGlyph","MAWConvertXMALayoutTypeToExtendedContentXMLLayoutType","MAWConvertXMATargetTypeToExtendedContentTargetType","MAWDbMediaTxns","MAWDbMsg","MAWHandleEchoMediaMsgsRestoreV2","MAWHandleXmaTransactionUtil","MAWIndexedDb","MAWODSProxy","MAWParseXMAProtocol","MAWTraceUtils","MAWTransactionMode","Promise","WAArmadilloXMA.pb","WAHashUtils","WALogger","WAMediaUtils","WAOdsEnums","WATimeUtils","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] invalid CTA observed while restoring XMA. Echo message origin ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] threadJid field is not present in the restoredMsg. Echo message origin ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] xmaLayoutType field is not present in the echo doc. Echo message origin ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] xmaGatingType field is not present in the echo doc. Echo message origin ",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] xmaTargetType field is not present in the echo doc. Echo message origin ",""]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] xmaDefaultCTA field is not present in the echo doc. Echo message origin ",""]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] xmaData is missing in the echo doc. Echo message origin ",""]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][getMediaForXMAByObjectIds] mediaEntry is null for media restore"]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] msgContent is null for external link share XMA on Restore. Echo message origin ",""]);r=function(){return a};return a}function s(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] dbXMA is null. EchoMessage origin ",""]);s=function(){return a};return a}a=function(a,e,f,g){e==null?void 0:e.addPoint("xma_restore_start");d("MAWTraceUtils").recordCheckpointForTrace(f,(i||(i=d("LSIntEnum"))).ofNumber(c("LSDataTraceCheckPoint").LABYRINTH_WEB_XMA_RESTORE_STARTED),[],!1);var j=a.restoredMsgsData;if(j){var k=j.newlyAddedMsgs;k=k.concat(j.existingMsgs);var l=[];k.map(function(b){var c=b.externalId;c=a.echoMsgMap.get(c);c!=null&&(c.contentType===d("EchoMessage").EchoMessageContentType.XMA&&l.push(b))});return l.length===0?(h||(h=b("Promise"))).resolve():t(l,a.echoMsgMap,f,g).then(function(a){e==null?void 0:e.addPoint("xma_restore_end",{"int":{xma:a.length}});d("MAWTraceUtils").recordCheckpointForTrace(f,(i||(i=d("LSIntEnum"))).ofNumber(c("LSDataTraceCheckPoint").LABYRINTH_WEB_XMA_RESTORE_ENDED),[],!1);return(h||(h=b("Promise"))).resolve()})}e==null?void 0:e.addPoint("xma_restore_end",{"int":{xma:0}});return(h||(h=b("Promise"))).resolve()};function t(a,e,f,g){var h=new Map(),j=new Map();a.forEach(function(a){var b,c=e.get(a.externalId);b=c==null?void 0:(b=c.mediaData)==null?void 0:b.attachmentObjectId;b!=null&&h.set(d("WAMediaUtils").stringToDeliveryObjectId(b),a);c=c==null?void 0:(b=c.mediaData)==null?void 0:b.plaintextHash;if(c!=null){b=d("WAHashUtils").stringToPlaintextHash(d("MAWHandleEchoMediaMsgsRestoreV2").getBase64WithoutPadding(c));c=j.get(b);j.set(b,c!=null?[].concat(c,[a.msgId]):[a.msgId])}});var k=Array.from(h.keys()),l=new Map();return u(j).then(function(j){var m=[];k.forEach(function(a){var b;b=(b=h.get(a))==null?void 0:b.externalId;b!=null&&l.set(b,a)});a.filter(function(a){return d("MAWDbMsg").isXMAMsg(a)}).forEach(function(a){var b=e.get(a.externalId);if(b){var g=l.get(a.externalId),h;if(g!=null){g=j.get(g);g!=null&&(h=g.mediaId)}g=b.serializationOrigin;g==null&&(g=d("EchoMessage").EchoSerializationOriginType.UNKNOWN);b=w(a,b,h,g);b==null?(d("WALogger").ERROR(s(),g),d("MAWTraceUtils").recordCheckpointForTrace(f,(i||(i=d("LSIntEnum"))).ofNumber(c("LSDataTraceCheckPoint").LABYRINTH_WEB_XMA_RESTORE_DBXMA_NULL),[],!1)):(b.targetType===d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE&&a.msgContent==null&&(d("WALogger").WARN(r(),g),d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.EB_RESTORE,key:"missing_msg_content_external_link_xma"})),m.push(b))}});return v(m).then(function(a){if(a.length>0){a.map(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=l.get(a.externalId);if(g!==!0){var c;b!=null&&(c=j.get(b));b=(yield d("MAWHandleXmaTransactionUtil").checkMediaChunkTransactionAndCreatedBridgeXma(c,a));d("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"NewXMA",value:b}]})}});return function(b){return a.apply(this,arguments)}}());return a}return a})})}var u=d("MAWIndexedDb").makeMsgrTransactor({media:d("MAWTransactionMode").READONLY,mediaBackup:d("MAWTransactionMode").READONLY},"restoreGetMediaForXMAByObjectIds",function(a){return function(b){var c=Array.from(b.keys());return d("MAWDbMediaTxns").maybeBulkGetMediaFromPlaintextHash(a,c).then(function(a){var c=new Map();a.forEach(function(a){var e=b.get(a.plaintextHash);e==null?void 0:e.forEach(function(b){b=a==null?void 0:a.mediaEntries.get(b);if(a!=null&&b!=null){b=d("WAMediaUtils").decodeMediaEntryData(b);b.objectId!=null&&c.set(d("WAMediaUtils").stringToDeliveryObjectId(b.objectId),a)}else d("WALogger").ERROR(q())})});return c})}}),v=d("MAWIndexedDb").makeMsgrTransactor({xma:d("MAWTransactionMode").READWRITE},"restoreWriteXMAsToDb",function(a){return function(b){return a.xma.bulkAdd(b,{allKeys:!0}).then(function(a){return a.map(function(a,c){return babelHelpers["extends"]({},b[c],{xmaId:a})})})}});function w(a,b,c,e){var f;if(b.xmaData==null){d("WALogger").ERROR(p(),e);return null}var g;if(b.xmaData.xmaDefaultCTA!=null){var h;g=x((h=b.xmaData)==null?void 0:h.xmaDefaultCTA)}else d("WALogger").WARN(o(),e);if(((h=b.xmaData)==null?void 0:h.xmaTargetType)!=null)h=d("MAWConvertXMATargetTypeToExtendedContentTargetType").convertXMATargetTypeToExtendedContentTargetType(b.xmaData.xmaTargetType);else{d("WALogger").ERROR(n(),e);return null}var i;((f=b.xmaData)==null?void 0:f.xmaGatingType)!=null?i=d("MAWConvertXMAGatingTypeToExtendedContentOverlayIconGlyph").convertXMAGatingTypeToExtendedContentOverlayIconGlyph(b.xmaData.xmaGatingType):d("WALogger").WARN(m(),e);var q;((f=b.xmaData)==null?void 0:f.xmaLayoutType)!=null?q=d("MAWConvertXMALayoutTypeToExtendedContentXMLLayoutType").convertXMALayoutTypeToExtendedContentXMLLayoutType(b.xmaData.xmaLayoutType):d("WALogger").WARN(l(),e);if(a.threadJid!=null)f=a.threadJid;else{d("WALogger").ERROR(k(),e);return null}if(g!=null&&!d("MAWParseXMAProtocol").isValidCTA(g,h,!0)){d("WALogger").ERROR(j(),e);return null}var r;((e=b.xmaData)==null?void 0:e.xmaContentRef)!=null&&(r=b.xmaData.xmaContentRef);return{author:a.author,contentRef:r,ctas:[],defaultCTA:g,defaultPreviewMediaId:(e=c)!=null?e:void 0,externalId:a.externalId,headerTitle:b==null?void 0:(e=b.xmaData)==null?void 0:e.xmaHeaderTitle,isTombstoned:b==null?void 0:(e=b.xmaData)==null?void 0:e.xmaIsTombstoned,maxSubtitleNumOfLines:b==null?void 0:(e=b.xmaData)==null?void 0:e.xmaMaxSubtitleNumLines,maxTitleNumOfLines:b==null?void 0:(e=b.xmaData)==null?void 0:e.xmaMaxTitleNumLines,msgId:a.msgId,overlayIconGlyph:i,overlayTitle:b==null?void 0:(e=b.xmaData)==null?void 0:e.xmaHeaderSubtitle,previewMediaIds:c!=null?[c]:[],subtitleText:b==null?void 0:(a=b.xmaData)==null?void 0:a.xmaSubtitleText,targetExpiringAtSec:((e=b.xmaData)==null?void 0:e.xmaTargetExpiry)!=null?d("WATimeUtils").castToUnixTime(Number((c=b.xmaData)==null?void 0:c.xmaTargetExpiry)):void 0,targetId:b==null?void 0:(a=b.xmaData)==null?void 0:a.xmaTargetId,targetType:h,targetUsername:b==null?void 0:(e=b.xmaData)==null?void 0:e.xmaTargetUsername,threadJid:f,titleText:(c=b.xmaData)==null?void 0:c.xmaTitleText,xmaDataclass:(a=b.xmaData)==null?void 0:a.xmaDataclass,xmaLayoutType:q}}function x(a){return{actionUrl:a,buttonType:d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_CTA_BUTTON_TYPE.OPEN_NATIVE,nativeUrl:a}}g.writeXMAToXMAStore=a;g.getMediaForXMAByObjectIds=u;g.writeXMAsToDb=v;g.getDefaultCTA=x}),98);
__d("MessageBackupSupplementalKeyGenerator",["$InternalEnum","MAWJids","WAGlobals","WAJids","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h=b("$InternalEnum")({REACTION:"reaction",EDIT:"edit",RAVEN_ACTION_MESSAGE:"raven_action_message"}),i=":";function a(a,b){return""+a+i+b}function c(a){return a.split(i)[1]}function j(a,b){b=b.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&");b=new RegExp("^"+b,"i");return b.test(a)}function e(a){return j(a,h.REACTION)}function f(a){return j(a,h.EDIT)}function k(a){return j(a,h.RAVEN_ACTION_MESSAGE)}function l(a){var b=a.split(i);if(b.length===1)return{rawIdentifierString:a,type:"poll_update"};var c=b[0];if(b.length<2||b.length>3)return{prefix:c,rawIdentifierString:a,type:"unknown"};var e=b[1];e=d("MAWJids").toUserJid(e);if(c===h.REACTION)return{senderJid:e,type:"reaction"};b=b.length===3?d("WATimeUtils").castToMillisTime(Number(b[2])):null;if(c===h.RAVEN_ACTION_MESSAGE)return{senderJid:e,type:"raven_action_message"};if(b==null)return{prefix:c,rawIdentifierString:a,type:"unknown"};return c===h.EDIT?{senderJid:e,ts:b,type:"edit"}:{prefix:c,rawIdentifierString:a,type:"unknown"}}function m(a){switch(a.type){case"edit":return""+h.EDIT+i+d("WAJids").extractUserId(a.senderJid)+i+a.ts.toString();case"reaction":return""+h.REACTION+i+d("WAJids").extractUserId(a.senderJid);case"raven_action_message":return""+h.RAVEN_ACTION_MESSAGE+i+d("WAJids").extractUserId(a.senderJid);case"poll_update":return a.rawIdentifierString}}function n(a){var b;if(d("WAJids").isAuthorMe(a))b=d("WAGlobals").getMyUserJid();else{a=d("WAJids").interpretAndValidateJid(a);if(a.jidType==="msgrUser")b=a.userJid;else return null}a=d("WAJids").userIdFromJid(b);return""+h.REACTION+i+a}function o(a,b){var c;if(d("WAJids").isAuthorMe(a))c=d("WAGlobals").getMyUserJid();else{a=d("WAJids").interpretAndValidateJid(a);if(a.jidType==="msgrUser")c=a.userJid;else return null}a=d("WAJids").userIdFromJid(c);return""+h.EDIT+i+a+i+b.toString()}g.SupplementalKeyPrefix=h;g.SUPPLEMENTAL_KEY_DELIMITER=i;g.createMessageSupplementalKey_DEPRECATED=a;g.getSupplementalSenderId_DEPRECATED=c;g.isSupplementalProtobufAReaction=e;g.isSupplementalProtobufAnEdit=f;g.isSupplementalProtobufARavenAction=k;g.parseIdentifierString=l;g.toIdentifierString=m;g.createReactionSupplementalKey=n;g.createEditSupplementalKey=o}),98);
__d("MAWHandleEBRestoreWithHIM",["EBAPIWorkerCheck","EchoMessage","EncryptedBackupsUploadEntity","FBLogger","MAWAckLevel","MAWAsMessageApplication","MAWBulkEditMsgsTxns","MAWConvertXMAGatingTypeToExtendedContentOverlayIconGlyph","MAWConvertXMALayoutTypeToExtendedContentXMLLayoutType","MAWConvertXMATargetTypeToExtendedContentTargetType","MAWDbMsg","MAWEchoToProtobufConversionLoggingUtils","MAWFrontendMediaUtils","MAWHandleEchoMediaMsgsRestoreV2","MAWHandleEchoMsgsRestoreApiUtils","MAWHandleEchoReactionsRestore","MAWHandleEchoXMARestoreV2","MAWJids","MAWMsgType","MAWODSProxy","MAWParseXMAProtocol","MAWUnsafeCoerce","MAWUserJidWrapper","MessageBackupSupplementalKeyGenerator","Random","WAGlobals","WAHashUtils","WAJids","WALogger","WALongInt","WAOdsEnums","WAProtocolQueue","WAResultOrError","WASortedLists","WAStanzaUtils","WATimeUtils","justknobx"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Exception when trying to encode reaction supplemental protobuf: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] Failed to create reaction supplemental key"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Exception when trying to encode edit supplemental protobuf: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] Failed to fetch edit external id"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] Failed to create edit supplemental key"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] Exception when trying to encode top-level protobuf: ",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] Failed to extract UnstoredDbMsg from EchoMessage: unstoredDbMsg missing in UnstoredDbContent"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] Failed to extract UnstoredDbMsg from EchoMessage: ",""]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] One of the mandatory fields is null for Echo message. Echo message origin ",""]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] Failed to decode echo message"]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to convert all echo messages to protobuf. Chat: ",", echo messages count: ",", converted echo messages count: ",""]);r=function(){return a};return a}function s(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to decode echo message: ",""]);s=function(){return a};return a}function t(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Unsupported receiver fetch message type: ",". Echo message origin ",""]);t=function(){return a};return a}function u(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] defautlCTA failed validation check. Echo message origin ",""]);u=function(){return a};return a}function v(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Mandatory XMA Data missing for XMA message. Echo message origin ",""]);v=function(){return a};return a}function w(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Unable to construct downloadableThumbnail from previewMediaData: ",", msg id: ",". Echo message origin ",""]);w=function(){return a};return a}function x(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] downloadableThumbnail was created without metadata, source: protobuf"]);x=function(){return a};return a}function y(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] messageId is null in edit, original externalId: ",""]);y=function(){return a};return a}function z(a,b){if(a==="@me"||a==="@system")return b;else return a}function A(a,b,c,e,f){var g=[];if(a.reactionXOfflineThreadingIds!=null)for(var h=0;h<a.reactionXOfflineThreadingIds.length;++h){var i=d("MAWHandleEchoReactionsRestore").getReactionsForReactionStore(b,c,e,null,f,a);i=i.map(function(a){return{decodedMsg:{unstoredDbMedia:void 0,unstoredDbMsg:void 0,unstoredDbReaction:a,unstoredDbReceiverFetchInfo:void 0},stanza:D(a.externalId,a.ts,z(a.author,c),b,"reaction")}});g.push.apply(g,i)}return g}function B(a,b,c,e,f){return e.map(function(e){if(e.messageId==null){d("WALogger").ERROR(y(),a);f!=null&&d("MAWEchoToProtobufConversionLoggingUtils").addPoint(f,"getUnstoredDbEditsFromEcho_messageId_missing");return null}var g=e.messageId;return{decodedMsg:{unstoredDbEditActionMsg:{ack:d("MAWAckLevel").ACK.sent,author:c,editMsgContent:{content:e.text},externalId:d("WAStanzaUtils").toStanzaId(g),originalMsgExternalId:a,serverTs:d("WATimeUtils").castToUnixTime(e.timestamp),ts:d("WATimeUtils").castToUnixTime(e.timestamp),type:d("MAWMsgType").MSG_TYPE.EDIT_ACTION},unstoredDbMedia:void 0,unstoredDbMsg:void 0,unstoredDbReaction:void 0},stanza:D(d("WAStanzaUtils").toStanzaId(g),d("WATimeUtils").castToUnixTime(e.timestamp),c,b,"text")}}).filter(Boolean)}function a(a,b){return a.map(I).filter(Boolean).map(function(a){return C(a,b)})}function C(a,b){var e,f=d("MAWUserJidWrapper").getMyUserJid(),g=a.from,h=d("MAWHandleEchoMsgsRestoreApiUtils").getDbMsgTypeFromEchoMessage(a);if(g==null||h==null)return[];h=a.xOfflineThreadingId;if(h==null){c("FBLogger")("labyrinth_web").warn("xOfflineThreadingId is null for Echo message");return[]}h=d("WAStanzaUtils").toStanzaId(h);e=d("WATimeUtils").castToUnixTime(((e=a.authoritativeTimestampMs)!=null?e:a.sortOrderMs)/1e3);g=d("MAWJids").toUserJid(g.localKey);var i=H(a,b,f,h,"echo_content");if(i.success===!1)return[];i=i.value;f=A(a,b,f,h,g);var j=a.contentType===d("EchoMessage").EchoMessageContentType.TEXT||a.contentType===d("EchoMessage").EchoMessageContentType.PLACEHOLDER?"text":"media";a=B(h,b,g,a.editHistory);return[{decodedMsg:i,stanza:D(h,e,g,b,j)}].concat(f,a)}function D(a,b,c,e,f){var g={applicationPayload:new Uint8Array(0).buffer,backupDirective:null,icdc:null,metadata:null,protobuf:new Uint8Array(0),subprotocol:new Uint8Array(0),subprotocolType:"consumerMessage",type:"subprotocol",version:"v3"};g={folder:null,id:{author:c,chat:e,externalId:a},msg:g,recipientsCount:null,reportingMeta:null,ts:b,type:"IncomingMsg"};return{incomingType:"ebrestore",jid:e,message:{decrypted:g,details:{count:0,externalId:a,from:d("WAJids").switchOnMsgrChatJidType(e,{group:function(a){return{author:d("WAJids").defaultDeviceJidForUser(c),chat:a,groupJid:a,type:"group"}},user:function(a){return{author:d("WAJids").defaultDeviceJidForUser(c),chat:a,deviceJid:d("WAJids").defaultDeviceJidForUser(c),type:"device"}}}),hideDecryptionFailure:!0,isInstamadillo:!1,offline:null,recipient:null,reportingMeta:null,retryCount:0,ts:b,type:f}},priority:d("WAProtocolQueue").WAProtocolQueuePriorityLow,stanzaId:a,stanzaQueueId:d("MAWUnsafeCoerce").unsafeCoerce(-1),type:"message"}}function E(a){if(a.mediaData==null)return d("WAResultOrError").makeResult(null);var b=a.previewMediaData,c=a.sortOrderMs,e=a.xOfflineThreadingId,f=a.mediaData,g=f.attachmentObjectId,h=f.backupEntFbid,i=f.directPath,j=f.encryptedHash,k=f.filename,l=f.height,m=f.mediaContentType,n=f.mediaKey,o=f.mediaKeyTimestamp,p=f.mediaPlayableDuration,q=f.plaintextHash,r=f.previewContentHeight,s=f.previewContentWidth,t=f.size;f=f.width;var u=a.contentType===d("EchoMessage").EchoMessageContentType.XMA;m=d("MAWFrontendMediaUtils").getMediaTypeAndServerMediaTypeFromBlob(m||"",u);u=m.mediaType;m=m.serverMediaType;var v=d("WAHashUtils").stringToPlaintextHash(d("MAWHandleEchoMediaMsgsRestoreV2").getBase64WithoutPadding(q)),y=null;if(b!=null)try{y=d("MAWHandleEchoMediaMsgsRestoreV2").constructRawDownloadableThumbnail(b),y!=null&&y.objectId==null&&d("WALogger").ERROR(x())}catch(b){d("WALogger").ERROR(w(),b,e,a.serializationOrigin)}if(n==null)return d("WAResultOrError").makeError("missing_media_key");if(j==null)return d("WAResultOrError").makeError("missing_encrypted_hash");b=d("MAWHandleEchoMediaMsgsRestoreV2").constructMediaEntry(v,j,n,i,o,m,k,h,g,y,t);e=d("MAWHandleEchoMediaMsgsRestoreV2").getMediaInfo({filename:k,height:l,mediaPlayableDuration:p,mediaType:u,previewContentHeight:r,previewContentWidth:s,width:f});a=e.validatedAudioInfo;v=e.validatedDocumentFileInfo;j=e.validatedImageInfo;n=e.validatedVideoInfo;return d("WAResultOrError").makeResult({mediaEntry:b,mediaType:u,msgIds:d("WASortedLists").asSortedSet(new Set()),plaintextHash:d("WAHashUtils").stringToPlaintextHash(q),size:t||0,ts:o!=null?d("WATimeUtils").castToUnixTime(o):d("WATimeUtils").castMilliSecondsToUnixTime(c),validatedAudioInfo:a,validatedDocumentFileInfo:v,validatedImageInfo:j,validatedVideoInfo:n})}function F(a,b){if(a.xmaData==null||a.from==null||a.xOfflineThreadingId==null)return d("WAResultOrError").makeResult(null);var c=a.from,e=a.serializationOrigin,f=a.xmaData;a=a.xOfflineThreadingId;var g=f.xmaContentRef,h=f.xmaDataclass,i=f.xmaDefaultCTA,j=f.xmaGatingType,k=f.xmaHeaderSubtitle,l=f.xmaHeaderTitle,m=f.xmaIsTombstoned,n=f.xmaLayoutType,o=f.xmaMaxSubtitleNumLines,p=f.xmaMaxTitleNumLines,q=f.xmaSubtitleText,r=f.xmaTargetExpiry,s=f.xmaTargetId,t=f.xmaTargetType,w=f.xmaTargetUsername;f=f.xmaTitleText;if(t==null){d("WALogger").ERROR(v(),e);return d("WAResultOrError").makeError("xma_mandatory_fields_missing")}t=d("MAWConvertXMATargetTypeToExtendedContentTargetType").convertXMATargetTypeToExtendedContentTargetType(t);var x;i!=null&&(x=d("MAWHandleEchoXMARestoreV2").getDefaultCTA(i));if(x!=null&&!d("MAWParseXMAProtocol").isValidCTA(x,t,!0)){d("WALogger").ERROR(u(),e);return d("WAResultOrError").makeError("xma_cta_validation_failure")}var y;j!=null&&(y=d("MAWConvertXMAGatingTypeToExtendedContentOverlayIconGlyph").convertXMAGatingTypeToExtendedContentOverlayIconGlyph(j));var z;r!=null&&(z=d("WATimeUtils").castToUnixTime(r));var A;n!=null&&(A=d("MAWConvertXMALayoutTypeToExtendedContentXMLLayoutType").convertXMALayoutTypeToExtendedContentXMLLayoutType(n));return d("WAResultOrError").makeResult({unstoredDbXMA:{author:d("MAWJids").toUserJid(c.localKey),contentRef:g,ctas:[],defaultCTA:x,externalId:d("WAStanzaUtils").toStanzaId(a),headerTitle:l,isTombstoned:m,maxSubtitleNumOfLines:o,maxTitleNumOfLines:p,overlayDescription:k,overlayIconGlyph:y,overlayTitle:l,subtitleText:q,targetExpiringAtSec:z,targetId:s,targetType:t,targetUsername:w,threadJid:b,titleText:f,xmaDataclass:h,xmaLayoutType:A}})}function G(a){if(a.receiverFetchId==null||a.receiverFetchData==null)return d("WAResultOrError").makeResult(null);var b=a.receiverFetchData,c=a.receiverFetchId;if(b.type!=="sticker"){d("WALogger").ERROR(t(),b.type,a.serializationOrigin);return d("WAResultOrError").makeError("unsupported_message_type")}return d("WAResultOrError").makeResult({mimetype:b.mimetype,previewHeight:b.previewHeight,previewWidth:b.previewWidth,receiverFetchId:c,type:b.type})}function H(a,b,c,e,f){c=d("MAWHandleEchoMsgsRestoreApiUtils").getUnstoredDbMessageFromEchoMessage(a,b,c,e,void 0,f);if(c.success===!1)return d("WAResultOrError").makeError(c.error);e=c.value;e.originalTs;e.threadJid;e.unsendMsgContentDeleteTs;f=babelHelpers.objectWithoutPropertiesLoose(e,["originalTs","threadJid","unsendMsgContentDeleteTs"]);f.sortOrderMs=a.sortOrderMs;c=E(a);if(c.success===!1)return c;e=F(a,b);if(e.success===!1)return d("WAResultOrError").makeError(e.error);b=e.value;e=G(a);if(e.success===!1)return d("WAResultOrError").makeError(e.error);a=e.value;return d("WAResultOrError").makeResult({unstoredDbMedia:c.value,unstoredDbMsg:f,unstoredDbReaction:void 0,unstoredDbReceiverFetchInfo:(e=a)!=null?e:void 0,unstoredXMA:(c=b)!=null?c:void 0})}function I(a){try{return d("EchoMessage").decodeEchoMessage(a)}catch(a){d("WALogger").ERROR(s(),a);return null}}function b(a,b){if(!d("EBAPIWorkerCheck").runningInWorker)throw c("FBLogger")("messenger_web").mustfixThrow("convertEchoMessagesToEBProtobufs should be called from the worker thread");var e=a.map(function(a){return J(a,b)}).filter(Boolean);d("MAWODSProxy").odsBumpEntityKey({amount:e.length,entity:d("WAOdsEnums").Entity.EB_RESTORE,key:"echo2protobuf.success"});e.length!==a.length&&(d("WALogger").WARN(r(),b,a.length,e.length),d("MAWODSProxy").odsBumpEntityKey({amount:a.length-e.length,entity:d("WAOdsEnums").Entity.EB_RESTORE,key:"echo2protobuf.fail"}));return e}function J(a,b){var e=c("Random").uint32();d("MAWEchoToProtobufConversionLoggingUtils").startQplUserFlow(e);a=I(a);if(a==null){d("WALogger").ERROR(q());d("MAWEchoToProtobufConversionLoggingUtils").endFailure(e,"echo_decode_failure");return null}var f=d("WAGlobals").getMyUserJid(),g=a.from,r=a.sortOrderMs,s=a.xOfflineThreadingId;r=d("WATimeUtils").castToMillisTime(r);if(s==null||g==null){d("WALogger").ERROR(p(),a.serializationOrigin);d("MAWEchoToProtobufConversionLoggingUtils").endFailure(e,"mandatory_fields_missing");return null}var t=d("MAWJids").toUserJid(g.localKey);g=d("WAStanzaUtils").toStanzaId(s);s=H(a,b,f,g,"first_edit_content");if(s.success===!1){d("WALogger").ERROR(o(),s.error);d("MAWEchoToProtobufConversionLoggingUtils").endFailure(e,"echo_message_parsing_failure_"+s.error);return null}if(s.value.unstoredDbMsg==null){d("WALogger").ERROR(n());d("MAWEchoToProtobufConversionLoggingUtils").endFailure(e,"unstoredDbMsg_conversion_failure_unstoredDbMsg_missing");return null}s=s.value;var u=s.unstoredDbMedia,v=s.unstoredDbMsg,w=s.unstoredDbReceiverFetchInfo;s=s.unstoredXMA;var x={author:t,chat:b,externalId:g};v!=null&&(v.msgId=d("MAWDbMsg").stanzaIdToMsgId(g));(s==null?void 0:s.unstoredDbXMA)!=null&&(s.unstoredDbXMA.msgId=d("MAWDbMsg").stanzaIdToMsgId(g));u!=null&&(u.msgIds=d("WASortedLists").asSortedSet(new Set([d("MAWDbMsg").stanzaIdToMsgId(g)])));var y;if((s==null?void 0:s.unstoredDbXMA)!=null){var z;y={associatedMessage:null,defaultPreview:(z=u)!=null?z:null,favicon:null,header:(z=u)!=null?z:null,previews:u!=null?[u]:null,xma:s.unstoredDbXMA}}var C={frankingKey:null,frankingTag:null,frankingVersion:null,reportingContent:null,reportingTag:null},D;try{D={decryptedProtobuf:d("EncryptedBackupsUploadEntity").getEbBackupMessageBytesBuffer(d("EncryptedBackupsUploadEntity").encodeBackupMessage({messageApplication:d("MAWAsMessageApplication").encodeMessageApplication(v,u,null,y,b,c("justknobx")._("3632")?w:null),msgId:x,reportingMeta:C,sortOrderMs:r})),protobufTimestampMS:r}}catch(a){d("MAWEchoToProtobufConversionLoggingUtils").endFailure(e,"top_level_protobuf_encoding_failure");d("WALogger").ERROR(m(),a);return null}var E=new Map();z=B(g,b,t,a.editHistory).map(function(a){return(a=a.decodedMsg)==null?void 0:a.unstoredDbEditActionMsg}).filter(Boolean).filter(function(a){return a.externalId!==a.originalMsgExternalId}).map(function(a){return d("MAWBulkEditMsgsTxns").getMessageHistory(a,b)});z.length>0&&d("MAWEchoToProtobufConversionLoggingUtils").addPoint(e,"convert_edits");z.forEach(function(a){var c=a.author,f=a.editTs;c=d("MessageBackupSupplementalKeyGenerator").createEditSupplementalKey(c,d("WATimeUtils").castUnixTimeToMillisTime(f));if(c==null){d("MAWEchoToProtobufConversionLoggingUtils").addPoint(e,"edit_supplemental_key_generation_failure");d("WALogger").ERROR(l());return}if(a.editExternalId==null){d("MAWEchoToProtobufConversionLoggingUtils").addPoint(e,"edit_supplemental_key_generation_failure");d("WALogger").ERROR(k());return}var g=a.editExternalId;try{E.set(c,{decryptedProtobuf:d("EncryptedBackupsUploadEntity").getEbBackupMessageBytesBuffer(d("EncryptedBackupsUploadEntity").encodeBackupMessage({messageApplication:d("MAWAsMessageApplication").encodeEditMessageApplication(a),msgId:{author:t,chat:b,externalId:g},reportingMeta:C,sortOrderMs:d("WATimeUtils").castUnixTimeToMillisTime(a.editTs)})),protobufTimestampMS:d("WATimeUtils").castUnixTimeToMillisTime(f)})}catch(a){d("MAWEchoToProtobufConversionLoggingUtils").addPoint(e,"edit_supplemental_protobuf_encoding_failure"),d("WALogger").ERROR(j(),a)}});s=A(a,b,f,g,t).map(function(a){return(a=a.decodedMsg)==null?void 0:a.unstoredDbReaction}).filter(Boolean);s.length>0&&d("MAWEchoToProtobufConversionLoggingUtils").addPoint(e,"convert_reactions");s.forEach(function(a){var c=a.author,f=a.senderTimestampMs,g=a.ts;f=f!=null?d("WATimeUtils").castToMillisTime(d("WALongInt").numberOrThrowIfTooLarge(f)):d("WATimeUtils").castUnixTimeToMillisTime(g);g=d("MessageBackupSupplementalKeyGenerator").createReactionSupplementalKey(c);if(g==null){d("MAWEchoToProtobufConversionLoggingUtils").addPoint(e,"reaction_supplemental_key_generation_failure");d("WALogger").ERROR(i());return}try{E.set(g,{decryptedProtobuf:d("EncryptedBackupsUploadEntity").getEbBackupMessageBytesBuffer(d("EncryptedBackupsUploadEntity").encodeBackupMessage({messageApplication:d("MAWAsMessageApplication").encodeReactionMessageApplication(a),msgId:{author:t,chat:b,externalId:a.externalId},reportingMeta:C,sortOrderMs:f})),protobufTimestampMS:f})}catch(a){d("MAWEchoToProtobufConversionLoggingUtils").addPoint(e,"reaction_supplemental_protobuf_encoding_failure"),d("WALogger").ERROR(h(),a)}});d("MAWEchoToProtobufConversionLoggingUtils").endSuccess(e);return{otid:g,supplementalProtobufs:E,toplevelProtobuf:D}}g.convertEchoMessages=a;g.convertEchoMessagesToEBProtobufs=b}),98);
__d("MAWHandlePendingStanzasInRestoreV2",["EBUploadMessages","LSMEBTaskCreationSource","MAWBridgeEventTransmitter","MAWDbPendingStanza","MAWDbPendingStanzaTxns","MAWDexieTable","MAWEBUploadTrackingUtils","MAWEncryptedBackupCacheManager","MAWIndexedDb","MAWTransactionMode","MAWWriteRevokeMessageTxns","Promise","WAJids","WALogger","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] pendingStanza type "," is not supported"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] revokedExternalId is null for pendingStanza"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] revokedExternalId is null for pendingStanza"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] threadJid is null for pendingStanza"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] pendingStanzaTs is null for pendingStanza"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] revokedExternalId is null for pendingStanza"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] externalId is null for pendingStanza"]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Delete For Me pending stanza does not need to be applied."]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] thread is null"]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] pendingStanza type "," is not supported"]);r=function(){return a};return a}function s(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Pending Stanza not found in the cache. This shouldn't happen."]);s=function(){return a};return a}function t(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Could not find thread for chatId "," for pendingStanza"]);t=function(){return a};return a}function u(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] externalId is null for pendingStanza"]);u=function(){return a};return a}a=function(a,c,d){a=a.restoredMsgsData;if(a){var e=a.newlyAddedMsgs;e=e.concat(a.existingMsgs);return v(e,c,d)}return(h||(h=b("Promise"))).resolve()};var v=function(a,e,f){f==null?void 0:f.addPoint("apply_pending_stanza_start");var g=0,i=0,j=0,k=0,l=new Map();return D().then(function(a){a==null?void 0:a.map(function(a){var b=a.pendingContent.content.externalId;if(b==null){d("WALogger").WARN(u());return}l.set(a.externalIdWithType,a)}),k=l.size}).then(function(){var b=new Set();return z(a).then(function(f){return d("MAWDexieTable").dexieAll(a.map(function(a){var c=a.externalId,h=f.get(a.threadJid);if(h==null){d("WALogger").ERROR(t(),a.threadJid);return d("MAWDexieTable").dexieResolve()}if(e)if(d("MAWEncryptedBackupCacheManager").peekPendingStanzaCache(c)){var k=d("MAWEncryptedBackupCacheManager").getPendingStanzaCacheValue(c);if(k==null){d("WALogger").ERROR(s());return}return y(k,a,h,e).then(function(a){a!=null&&b.add(k);d("MAWEncryptedBackupCacheManager").removePendingStanzaCacheValue(c);l["delete"](k.externalIdWithType);a=k.pendingContent.type;a===d("MAWDbPendingStanza").PENDING_TYPE.REVOKED&&g++;i++})}else l.clear();else{var m=c+"_"+d("MAWDbPendingStanza").PENDING_REVOKED,n=l.get(m);if(n!=null)return y(n,a,h,e).then(function(a){a!=null&&(b.add(n),g++,j++),l["delete"](n.externalIdWithType)})}})).then(function(){if(!e){var a=w(l);g+=a[1];i+=a[0]+a[1];c("promiseDone")(x(Array.from(b)))}})})}).then(function(a){f==null?void 0:f.addPoint("apply_pending_stanza_end",{"int":{initialRestorePendingStanzaCount:j,pendingStanzasToBeUploadedCount:k,pointRestorePendingStanzaCount:i,revokedCount:g}});return(h||(h=b("Promise"))).resolve()})},w=function(a){var b=0,c=0;a.forEach(function(a){var e=a.pendingContent.type;e===d("MAWDbPendingStanza").PENDING_TYPE.REVOKED?c++:e===d("MAWDbPendingStanza").PENDING_TYPE.DELETE_FOR_ME&&b++;C(a)});a.clear();return[b,c]},x=(e=d("MAWIndexedDb")).makeMsgrTransactor({pendingStanzas:(f=d("MAWTransactionMode")).READWRITE},"deletePendingStanzasFromIndexedDB",function(a){return function(b){return d("MAWDbPendingStanzaTxns").deletePendingStanzas(a,b)}}),y=function(a,e,f,g){var i=a.pendingContent.type;if(i===d("MAWDbPendingStanza").PENDING_TYPE.REVOKED)return B(a,e,f,g).then(function(a){if(a!=null){var b=d("MAWEBUploadTrackingUtils").genInstanceKeyOnly();d("MAWEBUploadTrackingUtils").startUploadTracking(a.externalId,a.type,"upload-pending-stanza",b,!1,!1,void 0,"echo_only");c("promiseDone")(d("EBUploadMessages").uploadUniqueMessage([a],void 0,new Map([[a.externalId,b]]),void 0,"revoked_message"))}});else if(i===d("MAWDbPendingStanza").PENDING_TYPE.DELETE_FOR_ME)return A(a);else{d("WALogger").WARN(r(),i);return(h||(h=b("Promise"))).resolve()}},z=e.makeMsgrTransactor({threads:f.READONLY},"getThreadsForMessages",function(a){return function(b){var c=[];b.forEach(function(a){c.push(a.threadJid)});return a.threads.where("jid").anyOf(c).toArray().then(function(a){var b=new Map();a.forEach(function(a){if(a==null){d("WALogger").WARN(q());return d("MAWDexieTable").dexieResolve()}b.set(a.jid,a)});return b})}}),A=e.makeMsgrTransactor({pendingStanzas:f.READWRITE},"deleteForMeMsg",function(a){return function(b){d("WALogger").LOG(p());return d("MAWDexieTable").dexieAll([a.pendingStanzas["delete"](b.rowId)]).then(function(){return d("MAWDexieTable").dexieResolve(b)})}}),B=e.makeMsgrTransactor({chunk:f.READONLY,deletedMessages:f.READWRITE,ftsPurgeBacklog:f.READWRITE,groupInfo:f.READWRITE,media:f.READONLY,messages:f.READWRITE,pendingStanzas:f.READWRITE,reactions:f.READWRITE,threads:f.READWRITE,xma:f.READONLY},"revokeMessage",function(a){return function(b,c,e,f){var g=b.pendingContent.content.externalId;if(g==null){d("WALogger").ERROR(o());return d("MAWDexieTable").dexieResolve()}var h=b.pendingContent.content.revokedExternalId;if(h==null){d("WALogger").ERROR(n());return d("MAWDexieTable").dexieResolve()}var i=b.pendingContent.content.ts;if(i==null){d("WALogger").ERROR(m());return d("MAWDexieTable").dexieResolve()}return d("MAWWriteRevokeMessageTxns").revokeUnstoredMsg(a,c,e,g,h,c.serverTs,c.ts,f).then(function(c){a.pendingStanzas["delete"](b.rowId);return d("MAWDexieTable").dexieResolve(c)})}});function C(a){var b=a.pendingContent.content.threadJid;if(b==null){d("WALogger").WARN(l());return}var e=d("WAJids").threadIdForChatJid(b),f=a.pendingContent.type;if(f===d("MAWDbPendingStanza").PENDING_TYPE.REVOKED){var g=a.pendingContent.content.revokedExternalId;if(g==null){d("WALogger").WARN(k());return}g=g}else if(f===d("MAWDbPendingStanza").PENDING_TYPE.DELETE_FOR_ME){var h=a.pendingContent.content.externalId;if(h==null){d("WALogger").WARN(j());return}g=h}else{d("WALogger").WARN(i(),f);return}d("MAWEncryptedBackupCacheManager").addPendingStanzaToPendingStanzaCache(g,a);d("MAWBridgeEventTransmitter").issuePointQueryOutsideTxn(g,e,void 0,c("LSMEBTaskCreationSource").POINT_QUERY_FROM_EB,b)}var D=e.makeMsgrTransactor({pendingStanzas:f.READONLY},"getAllPendingStanzas",function(a){return function(){return d("MAWDbPendingStanzaTxns").getAllPendingStanzas(a)}});g.applyPendingStanzas=a;g.issuePointQueryForPendingStanza=C}),98);
__d("MAWHandlePointRestoredMsgV2",["EBUploadMessages","MAWEBUploadTrackingUtils","MAWEncryptedBackupCacheManager","MAWGetMsgQuoteTxn","Promise","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Completed handling of point restored message"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Completed handling of point restored message"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Started handling of point restored message"]);k=function(){return a};return a}function a(a){d("WALogger").LOG(k());a=a.restoredMsgsData;if(a){var c=a.existingMsgs;a=a.newlyAddedMsgs;a=a.concat(c);var e=[],f=new Map(),g=[],l=new Map();a.filter(function(a){return d("MAWEncryptedBackupCacheManager").checkForMsgEntryInReuploadCache(a.threadJid,a.externalId)}).forEach(function(a){e.push(a);g.push(a.externalId);var b=d("MAWEBUploadTrackingUtils").genInstanceKeyOnly();l.set(a.externalId,b);d("MAWEBUploadTrackingUtils").startUploadTracking(a.externalId,a.type,"point-restore",b,!1,!1,void 0,"echo_only")});c=d("MAWGetMsgQuoteTxn").maybeBatchGetMsgsByQuoteExternalIdWithTransaction(g);return c.then(function(a){a.forEach(function(a){var b=a.quoteExternalId;b!=null&&f.set(b,a)});return e.length>0?d("EBUploadMessages").uploadUniqueMessage(e,f,l,void 0,"point_restore").then(function(a){e.forEach(function(a){d("MAWEncryptedBackupCacheManager").removeMsgEntryFromReuploadCache(a.threadJid,a.externalId)})}):(h||(h=b("Promise"))).resolve()}).then(function(a){d("WALogger").LOG(j())})}d("WALogger").LOG(i());return(h||(h=b("Promise"))).resolve()}g.uploadPointRestoredMessageIfRequired=a}),98);
__d("MAWRestoreMsgsUiUpdator",["MAWBridgeEventTransmitter","MAWDbMsg","MAWDbThread","MAWDexieTable","MAWFolderTypes","MAWThreadSnippetBuildTxns","emptyFunction","gkx"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,e,f,g,j,l,m,n,o,p){g=h(a,g,e,f,l,m);return g.then(function(c){if(m==null||j){var e=k(c);e&&d("MAWBridgeEventTransmitter").updateThreadOutsideTxn(c.cannotReplyReason,d("MAWFolderTypes").FOLDER_ID.INBOX,c.jid);return i(a,b,c,n,o,p,m).then(function(){return c})}return c}).then(function(b){return d("MAWThreadSnippetBuildTxns").refreshThreadSnippet(a,b)}).then(c("emptyFunction"))}function h(a,b,c,e,f,g){var h=babelHelpers["extends"]({},b,{lastReadMsg:f,lastReadMsgTs:e,newestMsgTs:c,oldestMsg:g,threadOrder:d("MAWDbThread").craftThreadOrder(c,b.jid)});return a.threads.put(h).then(function(){return h})}function i(a,b,e,f,g,h,i){var k=b.map(function(a){return a}).reverse(),l=e.jid;if(f!=null){b=d("MAWDbMsg").toMsgId(f);if(b!=null)return a.messages.get({msgId:b}).then(function(b){if(b!=null){b=b.sortOrderMs;var f;c("gkx")("23906")?f=d("MAWDexieTable").dexieResolve(0):f=a.messages.where(["threadJid","sortOrderMs"]).between([l,k[0].sortOrderMs],[l,b],!1,!1).count();return f.then(function(a){a===0&&(j(k,g,e),d("MAWBridgeEventTransmitter").issueMsgLoadedEventAfterTxn(e.jid,k,i===null,h,!1))})}})}d("MAWBridgeEventTransmitter").issueMsgLoadedEventAfterTxn(e.jid,k,i===null,h,!1);return d("MAWDexieTable").dexieResolve()}function j(a,b,c){var e=b==null?void 0:b.sortOrderMs,f=a[a.length-1],g=f.sortOrderMs;b!=null&&f!=null&&e!=null&&g!=null&&e<g&&(a.push(b),d("MAWBridgeEventTransmitter").deleteMessageRangesV2AfterTxn(b.msgId,d("MAWDbMsg").getSortOrderWithFallback(b),c.jid))}function k(a){return a.archived===!0&&a.cannotReplyReason!=="viewer_not_subscribed"}g.updateThreadAndMessages=a;g.shouldThreadBeUnarchived=k}),98);
__d("MAWRestoreMsgsTxns",["ArmadilloDataTraceType","FBLogger","LSMEBTaskCreationSource","MAWBridgeEventTransmitter","MAWDbMsg","MAWDbMsgTxns","MAWDexieTable","MAWFTSTxns","MAWIndexedDb","MAWJidUtils","MAWLocalizationType","MAWMessageHasUniqueExternalIdValidator","MAWMsgType","MAWQplProxy","MAWRestoreMsgsUiUpdator","MAWTimeUtils","MAWTransactionMode","MAWUseProtocolMsgIdForMsgId","WAHashStringToNumber","WAJids","WALogger","WATimeUtils","emptyFunction","justknobx","qpl"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to create restored messages and update thread metadata ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Thread with jid "," does not exist for restore"]);i=function(){return a};return a}function j(a,b,c){return c!=null?a.messages.where(["threadJid","sortOrderMs"]).between([b.jid,c.ts],[b.jid,d("MAWDbMsg").MAX_MSG_SORT_ORDER],!1,!0).limit(1).first():d("MAWDexieTable").dexieResolve()}function a(a,b,c){return d("MAWDbMsgTxns").maybeGetMsg(a,c).then(function(c){if(c!=null)return a.messages.where(["threadJid","sortOrderMs"]).between([b.jid,c.sortOrderMs],[b.jid,d("MAWDbMsg").MAX_MSG_SORT_ORDER],!1,!0).limit(1).first();else return d("MAWDexieTable").dexieResolve()})}function k(a){return a!=null&&a.type===d("MAWMsgType").MSG_TYPE.ADMIN&&(a.msgContent.adminType===d("MAWLocalizationType").LOCALIZATION_TYPE.E2EE_THREAD_DESCRIPTION||a.msgContent.adminType===d("MAWLocalizationType").LOCALIZATION_TYPE.CUTOVER_THREAD_ADMIN_MESSAGE||a.msgContent.adminType===d("MAWLocalizationType").LOCALIZATION_TYPE.CUTOVER_IGD_THREAD_ADMIN_MESSAGE||a.msgContent.adminType===d("MAWLocalizationType").LOCALIZATION_TYPE.DUAL_THREAD_CUTOVER_ADMIN_MESSAGE)}var l=(e=d("MAWIndexedDb")).makeMsgrTransactor({messages:(f=d("MAWTransactionMode")).READONLY},"checkForDecryptionFailuresToPointRestore",function(a){return function(){return a.messages.filter(function(a){return a.type===d("MAWMsgType").MSG_TYPE.UNAVAILABLE||a.type===d("MAWMsgType").MSG_TYPE.CIPHERTEXT}).toArray().then(function(a){a.forEach(function(a){a.threadJid!=null&&d("MAWBridgeEventTransmitter").issuePointQueryOutsideTxn(a.externalId,d("WAJids").threadIdForChatJid(a.threadJid),void 0,c("LSMEBTaskCreationSource").EB_POINT_QUERY_RETRY_DECRYPTION_FAILURES,a.threadJid)})})}});function m(a,b,c,e,f,g,h,i,j){var k=g.isOldestMsgUpdated,l=g.lastReadMsg,m=g.lastReadMsgTs,n=g.newestMsgTs;g=g.oldestMsgId;var p=!0;b&&(p=o(n,e));b=d("MAWDexieTable").dexieResolve();p&&(f.length>0&&(b=d("MAWRestoreMsgsUiUpdator").updateThreadAndMessages(a,f,n,m,c,k,l,g,h,i,j)));return b.then(function(){return d("MAWDexieTable").dexieResolve()})}function b(a){var b=a.existingMsgs,e=a.hasMoreBefore,f=a.instanceKey,g=a.isPointRestore,h=a.maybeNewestMsg,i=a.maybeOldestAdminMsg,j=a.maybeOldestMsg,k=a.minMsgId,l=a.newMsgs,m=a.optimisticMsgs,n=a.shouldSkipSyncToUI,o=a.taskSource;a=a.thread;o=o===c("LSMEBTaskCreationSource").EB_POINT_QUERY_RETRY_DECRYPTION_FAILURES;var p=new Map(),q=[];b.map(function(a){a.type===d("MAWMsgType").MSG_TYPE.UNAVAILABLE||a.type===d("MAWMsgType").MSG_TYPE.CIPHERTEXT?q.push(a):p.set(a.externalId,a)});var r=[];return x(l,b,a.jid,p,h,g,i,j,r,m,f,e,k,o,q,n).then(function(a){return a})}function n(a,b,c){a.altIndex!==d("MAWDbMsg").SPAM_ALT_INDEX&&a.altIndex!==d("MAWDbMsg").FUTUREPROOF_SPAM_ALT_INDEX&&(d("MAWBridgeEventTransmitter").startTraceOutsideTxn(a,b,d("ArmadilloDataTraceType").armadilloMessageSend),d("MAWBridgeEventTransmitter").issueNewMsgUiEventOutsideTxn(a,c))}function o(a,b){return a==null?!0:b.some(function(b){return b.sortOrderMs!=null&&b.sortOrderMs>=a})}var p=e.makeMsgrTransactor({messages:f.READONLY},"getMsgsByProtocolMsgIds",function(a){return function(){for(var b=arguments.length,c=new Array(b),e=0;e<b;e++)c[e]=arguments[e];return d("MAWDbMsgTxns").getMsgsByProtocolMsgId.apply(void 0,[a].concat(c))}}),q=e.makeMsgrTransactor({messages:f.READONLY},"restoreGetMsg",function(a){return function(b){return d("MAWDbMsgTxns").maybeGetMsg(a,b)}}),r=e.makeMsgrTransactor({messages:f.READONLY},"restoreGetThreadNewestMessage",function(a){return function(b){return d("MAWDbMsgTxns").getThreadNewestMessageBySortOrder(a,b.jid)}}),s=e.makeMsgrTransactor({messages:f.READONLY},"restoreMaybeGetOldestNonAdminMessage",function(a){return function(b){return d("MAWDbMsgTxns").getThreadOldestMessageBySortOrder(a,b.jid).then(function(c){if(c==null)return d("MAWDexieTable").dexieResolve({maybeOldestAdminMsg:null,maybeOldestMsg:null});else if(k(c))return j(a,b,c).then(function(a){return{maybeOldestAdminMsg:c,maybeOldestMsg:a}});return{maybeOldestAdminMsg:null,maybeOldestMsg:c}})}});function t(a,b,e,f,g,h,i,j,l){return d("MAWDexieTable").dexieAll(b.map(function(b){return d("MAWDbMsgTxns").maybeGetMsgByExternalId(a,b.externalId,e.jid,b.author).then(function(a){if(a!=null)return;a=f.get(b.externalId);if(a==null){a=d("WATimeUtils").castUnixTimeToMillisTime(b.ts);j.newestMsgTs=a>j.newestMsgTs?a:j.newestMsgTs;var c=d("MAWUseProtocolMsgIdForMsgId").shouldUseProtocolMsgIdForMsgId()?d("MAWJidUtils").formatProtocolMsgIdFromMsg(b):d("MAWDbMsg").craftMsgIdV2(e.chatId,j.msgNextInChatMsgId,b);j.msgNextInChatMsgId+=1;(j.oldestMsgId==null||!h&&a<j.oldestMsgTs)&&(j.isOldestMsgUpdated=!0,j.oldestMsgId=i!=null&&d("WATimeUtils").castUnixTimeToMillisTime(i.ts)<a?i.msgId:c,j.oldestMsgTs=i!=null&&d("WATimeUtils").castUnixTimeToMillisTime(i.ts)<a?d("WATimeUtils").castUnixTimeToMillisTime(i.ts):a);(j.newestMsgTs===a||k(g))&&(j.newestMsgId=c);b.author===d("WAJids").AUTHOR_ME&&(j.lastReadMsgTs==null||a>j.lastReadMsgTs)&&(j.lastReadMsg=c,j.lastReadMsgTs=a);a=babelHelpers["extends"]({},b,{msgId:c,sortOrderMs:d("MAWDbMsg").getSortOrderWithFallback(b)});l.push(a)}})})).then(c("emptyFunction"))}function u(a,b){return d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").getThreadNewestMessageId(a,b.jid),d("MAWDbMsgTxns").getThreadNewestMessageTs(a,b),d("MAWUseProtocolMsgIdForMsgId").shouldUseProtocolMsgIdForMsgId()?d("MAWDexieTable").dexieResolve(0):d("MAWDbMsgTxns").getNextMsgIdNumberForThread(a,b)]).then(function(a){var b=a[0],c=a[1];a=a[2];return{newestMsgId:b,newestMsgTs:c,nextInChatMsgId:a}})}function v(a,b,e,f,g,h,i,j,k,l,m){return t(a,b,e,f,g,h,i,j,k).then(function(b){if(l!=null)for(b of k){var g=b.externalId;g=l.get(g);g!=null&&(b.ts=d("WATimeUtils").castMilliSecondsToUnixTime(g.ts))}d("MAWMessageHasUniqueExternalIdValidator").logMessageAddSource(k.map(function(a){return a.externalId}),"MAWRestoreMsgsTxns.js::createRestoredMessages",{isPointRestore:h==null?void 0:h.toString()});var i=c("justknobx")._("3227")?k.map(function(a){return babelHelpers["extends"]({},a,{source:m===!0?"media_restore":"eb_restore"})}):k;return d("MAWDexieTable").dexieAll([a.messages.bulkAdd(i,{allKeys:!0}).then(function(a){return a.map(function(a,b){return babelHelpers["extends"]({},i[b],{rowId:a})})}),m!==!0&&c("justknobx")._("3227")?a.messages.bulkPut(Array.from(f.values()).map(function(a){return babelHelpers["extends"]({},a,{source:"eb_restore"})})):d("MAWDexieTable").dexieResolve()]).then(function(b){var c=b[0];return a.threads.put(e).then(function(){return c})})})}function w(a,b,c){b=b.map(function(a){var b=c.find(function(b){return b.externalId===a.externalId});if(b==null)return null;b=babelHelpers["extends"]({externalId:b.externalId,msgId:b.msgId,protocolMsgId:b.protocolMsgId,rowId:b.rowId},a);return b}).filter(Boolean);return a.messages.bulkPut(b).then(function(){})}var x=e.makeMsgrTransactor({ftsBackloggedMessages:f.READWRITE,groupInfo:f.READWRITE,messages:f.READWRITE,threads:f.READWRITE},"createRestoredMessagesAndUpdateThread",function(a){return function(b,c,e,f,g,j,k,l,o,p,q,r,s,t,x,y){return a.threads.get({jid:e}).then(function(q){if(q==null){d("WALogger").ERROR(i(),e);return d("MAWDexieTable").dexieResolve()}return u(a,q).then(function(e){var i=e.newestMsgId,t=e.newestMsgTs;e=e.nextInChatMsgId;var u={isOldestMsgUpdated:!1,lastReadMsg:q.lastReadMsg,lastReadMsgTs:d("MAWTimeUtils").ensureValidMillisTime(q.lastReadMsgTs),msgNextInChatMsgId:e,newestMsgId:i,newestMsgTs:d("MAWTimeUtils").ensureValidMillisTime(t)||d("WATimeUtils").castToMillisTime(0),oldestMsgId:l==null?void 0:l.msgId,oldestMsgTs:d("WATimeUtils").castUnixTimeToMillisTime((e=l==null?void 0:l.ts)!=null?e:d("WATimeUtils").castToUnixTime(0))};i=w(a,b,x);return i.then(function(){return d("MAWDexieTable").dexieAll([v(a,b,q,f,g,j,k,u,o,p,y),d("MAWFTSTxns").maybePutMessagesToBacklog(a,b.map(function(a){return a.externalId}))]).then(function(b){b=b[0];if(y!==!0)for(var e of b)n(e,q.jid,p);e=c.concat(b);var f={existingMsgs:c,newlyAddedMsgs:b,threadJid:q.jid};e=y!==!0?m(a,j,q,e,b,u,s,k,r):d("MAWDexieTable").dexieResolve();return e.then(function(){return f})})["catch"](function(a){d("WALogger").ERROR(h(),a)})})})})}});g.getNextMsgBasedOnSortOrderMs=a;g.isE2eeOrCutoverAdminMsg=k;g.checkForDecryptionFailuresToPointRestore=l;g.restoreMsgsForThread=b;g.getMsgsByProtocolMsgIds=p;g.getMsg=q;g.maybeGetThreadNewestMessage=r;g.maybeGetOldestNonAdminMessage=s;g.prepareUnstoredMsgArrayAndUpdateKeyVariables=t}),98);
__d("MAWRestoreValidationUtils",["MAWEBRestoreTrackingUtils"],(function(a,b,c,d,e,f,g){"use strict";function h(a){return a.reduce(function(a,b){if(b.externalId!=null){a[b.externalId]=((b=a[b.externalId])!=null?b:0)+1;return a}return a},{})}function a(a){var b=a.dbMsgArray,c=a.deanonData,e=a.echoMsgExternalIds,f=a.protobufMsgs,g=a.restoreQplFlow;a=a.traceId;var i=h(b);if(f==null&&e==null)return;b=f!=null?f.map(function(a){return{externalId:a.otid}}):e!=null?e:[];var j=h(b);f=Object.entries(i).filter(function(a){a[0];a=a[1];return a>1});e=Object.entries(j).filter(function(a){a[0];a=a[1];return a>1});b=Object.keys(j).filter(function(a){return!i[a]});var k=Object.keys(i).filter(function(a){return!j[a]});e={"int":{duplicates_in_eb_restore:e.length,duplicates_in_maw:f.length,maw_vs_eb_restore_missing_in_reference:k.length,maw_vs_eb_restore_missing_in_target:b.length}};if(c!=null){var l=h(c);f=Object.keys(i).filter(function(a){return!l[a]});k=Object.keys(l).filter(function(a){return!i[a]});b=Object.keys(l).filter(function(a){return!j[a]});c=Object.keys(j).filter(function(a){return!l[a]});var m=Object.entries(l).filter(function(a){a[0];a=a[1];return a>1});e["int"]=babelHelpers["extends"]({},e["int"],{duplicates_in_deanon:m.length,eb_restore_vs_deanon_missing_in_reference:c.length,eb_restore_vs_deanon_missing_in_target:b.length,maw_vs_deanon_missing_in_reference:f.length,maw_vs_deanon_missing_in_target:k.length})}g==null?void 0:g.addPoint("restore_validation",e);d("MAWEBRestoreTrackingUtils").addQPLRestorePointWithAnnotationsWorker({annotations:e,pointName:"restore_validation",traceId:a});return e}g.compareRestoredMsgstoDeanonData=a}),98);
__d("MAWWriteReceiverFetchTxns",["FBLogger","MAWBridgeReceiverFetchInfo","MAWDbReceiverFetchTxns","MAWDexieTable","MAWIndexedDb","WALogger","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Receiver fetch info not found for receiver fetch id: ",""]);h=function(){return a};return a}function a(a,b,e){return d("MAWDbReceiverFetchTxns").maybeGetReceiverFetchInfoFromReceiverFetchId(a,e.receiverFetchId).then(function(f){if(f==null)return a.receiverFetchInfo.add(e).then(function(){d("MAWIndexedDb").afterTransaction({tag:"NewReceiverFetchInfo",value:d("MAWBridgeReceiverFetchInfo").createBridgeReceiverFetchInfoPayloadFromUnstoredInfo(b,e)})})["catch"](function(a){c("FBLogger")("messenger_web_media").mustfix("Failed to add receiver fetch info to db, error: %s",a.message)});else{var g=babelHelpers["extends"]({},f,e);return a.receiverFetchInfo.update(e.receiverFetchId,g).then(function(){d("MAWIndexedDb").afterTransaction({tag:"NewReceiverFetchInfo",value:d("MAWBridgeReceiverFetchInfo").createBridgeReceiverFetchInfoPayloadFromDbInfo(b,g)})})["catch"](function(a){c("FBLogger")("messenger_web_media").mustfix("Failed to update receiver fetch info in db, error: %s",a.message)})}})}function b(a,b,e,f,g){return d("MAWDbReceiverFetchTxns").maybeGetReceiverFetchInfoFromReceiverFetchId(a,f).then(function(i){if(i==null){d("WALogger").ERROR(h(),f);return d("MAWDexieTable").dexieResolve()}else{i=babelHelpers["extends"]({},i,{accessibilitySummaryText:(i=g)!=null?i:void 0,previewUrl:b,previewUrlExpirationTimestampMs:e});return a.receiverFetchInfo.update(f,i).then(c("emptyFunction"))["catch"](function(a){c("FBLogger")("messenger_web_media").mustfix("Failed to update receiver fetch info in db, error: %s",a.message)})}})}g.handleUnstoredReceiverFetchInfo=a;g.updateReceiverFetchInfoWithPreviewUrl=b}),98);
__d("MAWHandleEchoMsgsRestoreApiV2",["EBLogger","EchoBackupCompareUtils","EchoMessage","LSDataTraceCheckPoint","LSIntEnum","LSMEBTaskCreationSource","MAWAckLevel","MAWBridgeEventTransmitter","MAWCiphertextRecoveryLogging","MAWDbEditMsgHistoryTxns","MAWDbMsg","MAWDbThreadTxns","MAWDexieTable","MAWEncryptedBackupCacheManager","MAWHandleEchoMediaMsgsRestoreV2","MAWHandleEchoMsgsRestoreApiUtils","MAWHandleEchoReactionsRestore","MAWHandleEchoXMARestoreV2","MAWHandlePendingStanzasInRestoreV2","MAWHandlePointRestoredMsgV2","MAWIndexedDb","MAWJids","MAWMediaGalleryM2Utils","MAWMsgType","MAWQplProxy","MAWRepliesRestoreUtils","MAWRestoreMsgsTxns","MAWRestoreValidationUtils","MAWTraceUtils","MAWTransactionMode","MAWWriteReceiverFetchTxns","Promise","WAGlobals","WAJids","WAResultOrError","WAStanzaUtils","WATimeUtils","asyncToGeneratorRuntime","gkx","promiseDone","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Oldest message timestamp: "," and newest message timestamp: "," of the batch for thread: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["No more messages to restore for thread: ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["Ignore duplicate restore request of an existing message"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["Message ID must not be null"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to decode the message"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["No messages to be restored for thread: ",""]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["Not a supported receiver fetch type: ",""]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] timestamp field should not be null as it is required for attachment download retry: ",""]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["timestamp field should not be null as it is required for attachment download retry: ",""]);r=function(){return a};return a}function s(){var a=babelHelpers.taggedTemplateLiteralLoose(["from field is missing from media message: ",""]);s=function(){return a};return a}function t(){var a=babelHelpers.taggedTemplateLiteralLoose(["from field is missing from xma message: ",""]);t=function(){return a};return a}function u(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Media data is null for the message: ",""]);u=function(){return a};return a}function v(){var a=babelHelpers.taggedTemplateLiteralLoose(["Media data is null for the message: ",""]);v=function(){return a};return a}function w(){var a=babelHelpers.taggedTemplateLiteralLoose(["Echo message is missing from the map: ",""]);w=function(){return a};return a}function x(){var a=babelHelpers.taggedTemplateLiteralLoose(["Echo message is missing from the map: ",""]);x=function(){return a};return a}function y(){var a=babelHelpers.taggedTemplateLiteralLoose(["Missed restoring optimistic messages for thread: "," count: "," }"]);y=function(){return a};return a}function z(){var a=babelHelpers.taggedTemplateLiteralLoose(["threadJidPrimaryId "," missing from index db"]);z=function(){return a};return a}function A(){var a=babelHelpers.taggedTemplateLiteralLoose([" Missing thread for thread jid: ",""]);A=function(){return a};return a}function B(){var a=babelHelpers.taggedTemplateLiteralLoose(["Error while restoring media/reaction"]);B=function(){return a};return a}function C(){var a=babelHelpers.taggedTemplateLiteralLoose(["HandleEchoMsgsRestore v2 completed. newlyAdded: "," existing: "," isPointRestore: ",""]);C=function(){return a};return a}function D(){var a=babelHelpers.taggedTemplateLiteralLoose(["Message creation complete. MessagesCreated: "," isPointRestore: "," startSortKey: "," taskSource: ",""]);D=function(){return a};return a}function E(){var a=babelHelpers.taggedTemplateLiteralLoose(["Low level api handleEchoMsgsRestore v2 initiated restore of "," messages. isPointRestore: "," startSortKey: "," taskSource: ",""]);E=function(){return a};return a}var F=d("EBLogger").EBLogger.tags(["restore"]);a=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,f,g,j,k,l,m,n,o,p,q,r,s){var t=l==null?F:F.tags([l]);t.DEBUG(E(),e.length,f,m,p);j=f?d("MAWHandleEchoMsgsRestoreApiUtils").MAWRestoreType.POINT_RESTORE:m!=null?d("MAWHandleEchoMsgsRestoreApiUtils").MAWRestoreType.PAGINATED_RESTORE:d("MAWHandleEchoMsgsRestoreApiUtils").MAWRestoreType.INITIAL_RESTORE;j=j;var u=q!=null?q:d("MAWQplProxy").startQplUserFlow(c("qpl")._(521486220,"827"),{bool:{uploadedFromEBQueue:s},"int":{messages:e.length},string:{message_backup_type:"echo",restore_type:j,trace_id:(q=l)!=null?q:""}},{providedTimeoutInMs:3e5});d("MAWTraceUtils").recordCheckpointForTrace(l,(i||(i=d("LSIntEnum"))).ofNumber(c("LSDataTraceCheckPoint").LABYRINTH_WEB_ECHO_MESSAGE_RESTORE_BEGIN),[],!1);var v=(yield K(a,l)),w={messageIds:[],pendingRestoreSortKeys:[]};if(v){s=G(v,e,f,g,u,k,n,o,l,p,r);var x=a;return s.then(function(g){var j,k=((j=g.restoredMsgsData)==null?void 0:j.newlyAddedMsgs)?(j=g.restoredMsgsData)==null?void 0:j.newlyAddedMsgs.length:0;t.DEBUG(D(),k,f,m,p);N(a,g,n,o);var q=p===c("LSMEBTaskCreationSource").MEDIA_GALLERY_RESTORE&&d("MAWMediaGalleryM2Utils").shouldSkipSyncToLSDB();return(h||(h=b("Promise"))).all([L(g,u,q),M(g,u,l,p),d("MAWHandleEchoReactionsRestore").writeEchoReactionsToReactionsStore(g,d("WAGlobals").getMyUserJid(),u,q),Q(x,g,v==null?void 0:v.jid)]).then(function(j){d("MAWEncryptedBackupCacheManager").setRestoredCacheStatusAsDone(Array.from(g.echoMsgMap.keys()));return(h||(h=b("Promise"))).all([d("MAWRepliesRestoreUtils").updateQuoteDataForReplyMessages(g,u,q),d("MAWHandleEchoXMARestoreV2").writeXMAToXMAStore(g,u,l,q),c("gkx")("2251")?d("MAWHandlePendingStanzasInRestoreV2").applyPendingStanzas(g,f,u):d("MAWDexieTable").dexieResolve(),R(g,u)]).then(function(){c("promiseDone")(d("MAWHandlePointRestoredMsgV2").uploadPointRestoredMessageIfRequired(g));var j=g.restoredMsgsData;j=(j==null?void 0:j.existingMsgs)?j==null?void 0:j.existingMsgs.length:0;var m=e.length;u.endSuccess({"int":{existingMsgs:j,messages_lost:e.length-j-k,newlyAddedMsgs:k,restoredMsgs:j+k,totalMsgsToRestore:m},string:{threadJidPrimaryId:a}});d("MAWTraceUtils").recordCheckpointForTrace(l,(i||(i=d("LSIntEnum"))).ofNumber(c("LSDataTraceCheckPoint").LABYRINTH_RESTORE_MESSAGES_SUCCESS),[],!1);d("MAWTraceUtils").recordCheckpointForTrace(l,i.ofNumber(c("LSDataTraceCheckPoint").FLOW_END_AND_FLUSH),[],!0);g.quotesToBeRestored.forEach(function(a){w.messageIds.push(a.messageId),w.pendingRestoreSortKeys.push(a.sortOrderMs)});t.DEBUG(C(),k,j,f);return(h||(h=b("Promise"))).resolve(d("WAResultOrError").makeResult(w))})})["catch"](function(a){t.catching(a).MUSTFIX(B());u.endFail("error_in_handle_media_or_reaction");return(h||(h=b("Promise"))).resolve(d("WAResultOrError").makeResult(w))})})}else u.endFail("missing_thread_for_thread_jid"),t.MUSTFIX(A(),a),N(a,null,n,o);return(h||(h=b("Promise"))).resolve(d("WAResultOrError").makeResult(w))});return function(b,c,d,e,f,g,h,i,j,k,l,m,n,o){return a.apply(this,arguments)}}();function G(a,b,c,d,e,f,g,h,i,j,k){return H.apply(this,arguments)}function H(){H=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,f,g,i,j,k,l,m,n,o){i==null?void 0:i.addPoint("message_restore_start");var p=new Map(),q=[];e=(yield I(e,f,a,p,g,i,m));var r=e.dbThread,s=e.hasMoreBefore,t=e.messagesToAdd;g=e.quotesToBeRestoredForThread;q.push.apply(q,g);e=t.map(function(b){return{author:b.author,chat:a.jid,externalId:d("WAStanzaUtils").toStanzaId(b.externalId)}});return(h||(h=b("Promise"))).all([d("MAWRestoreMsgsTxns").maybeGetThreadNewestMessage(a),d("MAWRestoreMsgsTxns").maybeGetOldestNonAdminMessage(a),d("MAWRestoreMsgsTxns").getMsgsByProtocolMsgIds(e)]).then(function(a){var b=a[0],e=a[1],g=e.maybeOldestAdminMsg;e=e.maybeOldestMsg;a=a[2];var h=new Set(a.filter(function(a){return a.type!==d("MAWMsgType").MSG_TYPE.CIPHERTEXT}).map(function(a){return a.externalId})),u=t.filter(function(a){return!h.has(a.externalId)});d("MAWCiphertextRecoveryLogging").compareAndLogCiphertextRecoveredByEB(a,t);var v=n===c("LSMEBTaskCreationSource").MEDIA_GALLERY_RESTORE&&d("MAWMediaGalleryM2Utils").shouldSkipSyncToLSDB();b={existingMsgs:a,hasMoreBefore:s,instanceKey:k,isPointRestore:f,maybeNewestMsg:b,maybeOldestAdminMsg:g,maybeOldestMsg:e,minMsgId:j,newMsgs:u,optimisticMsgs:l,shouldSkipSyncToUI:v,taskSource:n,thread:r,traceId:m};var w=[];a.forEach(function(a){return w.push({externalId:a.externalId})});u.forEach(function(a){return w.push({externalId:a.externalId})});return d("MAWRestoreMsgsTxns").restoreMsgsForThread(b).then(function(a){var b=[];(a==null?void 0:a.existingMsgs)!=null&&(b=b.concat(a==null?void 0:a.existingMsgs));(a==null?void 0:a.newlyAddedMsgs)!=null&&(b=b.concat(a==null?void 0:a.newlyAddedMsgs));i==null?void 0:i.addPoint("message_restore_end");o!=null&&!f&&d("MAWRestoreValidationUtils").compareRestoredMsgstoDeanonData({dbMsgArray:b,deanonData:o,echoMsgExternalIds:w,protobufMsgs:void 0,restoreQplFlow:i,traceId:m});return{echoMsgMap:p,quotesToBeRestored:q,restoredMsgsData:a,thread:r}})})});return H.apply(this,arguments)}function I(a,b,c,d,e,f,g){return J.apply(this,arguments)}function J(){J=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c,e,f,g,h){var i=new Set(),p=new Map(),q=h==null?F:F.tags([h]),r=[];if(a==null||a.length===0){q.WARN(o(),c.jid);return{dbThread:c,hasMoreBefore:!1,messagesToAdd:[],quotesToBeRestoredForThread:r}}var s=0,t=[];a.forEach(function(a){a=d("EchoMessage").decodeEchoMessage(a);if(a==null){q.MUSTFIX(n());return}a.contentType===d("EchoMessage").EchoMessageContentType.DECRYPTION_FAILURE&&s++;var b=a.xOfflineThreadingId;if(b==null){q.MUSTFIX(m());return}if(i.has(b)){q.WARN(l());return}i.add(b);t.push(a)});s===a.length&&(g==null?void 0:g.addPoint("decryption_failure_batch",{"int":{decryptionFailuresCount:s}}));t.forEach(function(a){if(a.xOfflineThreadingId==null)return;var b=d("WAStanzaUtils").toStanzaId(a.xOfflineThreadingId),f=d("MAWHandleEchoMsgsRestoreApiUtils").getUnstoredDbMessageFromEchoMessage(a,c.jid,d("WAGlobals").getMyUserJid(),b,h,"echo_content");if(f.success===!0){f=f.value;d("MAWEncryptedBackupCacheManager").addMsgEntryToRestoredCache(b,d("EchoBackupCompareUtils").buildEchoDocCacheValue(a));p.set(b,f);e.set(b,a);a=a==null?void 0:a.quoteData;if(a!=null){var g=d("WAStanzaUtils").toStanzaId(a.quoteMessageId);if(g!=null&&!p.has(g))r.push({messageId:a.quoteMessageId,sortOrderMs:a.quoteSortOrderInMs.toString()});else{a=d("MAWRepliesRestoreUtils").addQuoteDataToReplyMessage(f,p.get(g));p.set(b,a)}}}});a=Array.from(p.values());a.sort(function(a,b){return((a=a.sortOrderMs)!=null?a:0)-((a=b.sortOrderMs)!=null?a:0)});g=b||f!==!1;g||q.DEBUG(k(),c.jid);a.length>0&&q.DEBUG(j(),a[0].sortOrderMs,a[a.length-1].sortOrderMs,c.jid);return{dbThread:c,hasMoreBefore:g,messagesToAdd:a,quotesToBeRestoredForThread:r}});return J.apply(this,arguments)}var K=d("MAWIndexedDb").makeMsgrTransactor({threads:(e=d("MAWTransactionMode")).READONLY},"restoreGetThread",function(a){return function(b,c){var e=c==null?F:F.tags([c]);return d("MAWDbThreadTxns").getThreadPrimaryId(a,b).then(function(a){if(a.success)return a.value;else{e.MUSTFIX(z(),b);return d("MAWDexieTable").dexieResolve()}})}}),L=d("MAWIndexedDb").makeMsgrTransactor({editMsgHistory:e.READWRITE,messages:e.READWRITE},"restoreEditMsgHistory",function(a){return function(b,c,e){c==null?void 0:c.addPoint("msg_history_start");var f=b.restoredMsgsData;if(f!=null){var g=f.newlyAddedMsgs.map(function(c){var e=[],g=c.externalId,h=c.author,i=f.threadJid;c=b.echoMsgMap.get(g);if(c!=null){var j=c.editHistory;return d("MAWDbEditMsgHistoryTxns").getEditHistoryAsEcho(a,g,h,i).then(function(b){if(b.length>=j.length)return d("MAWDexieTable").dexieResolve([]);j.forEach(function(a){return e.push({author:h,editExternalId:a.messageId!=null?d("WAStanzaUtils").toStanzaId(a.messageId):null,editTs:d("WATimeUtils").castToUnixTime(a.timestamp),msgContent:{content:a.text},originalMsgExternalId:g,sendStatus:d("MAWAckLevel").ACK.sent,threadJid:i})});b.length>0&&d("MAWDbEditMsgHistoryTxns").bulkRemoveEditHistory(a,g,h,i);return d("MAWDexieTable").dexieResolve(e)})}else return d("MAWDexieTable").dexieResolve([])});return d("MAWDexieTable").dexieAll(g).then(function(b){return d("MAWDbEditMsgHistoryTxns").bulkAddEditMsgHistory(a,b.flat(),e!=null?!e:!0).then(function(a){return c==null?void 0:c.addPoint("msg_history_end")})})}else{c==null?void 0:c.addPoint("msg_history_end");return d("MAWDexieTable").dexieResolve()}}}),M=function(a,d,e,f){if(c("gkx")("1614"))return(h||(h=b("Promise"))).resolve();else{d==null?void 0:d.addPoint("media_restore_start");return O(a,e,f).then(function(a){d==null?void 0:d.addPoint("media_restore_end",{"int":{media:a}});return(h||(h=b("Promise"))).resolve()})}};function N(a,b,e,f,g){g=g==null?F:F.tags([g]);if(e!=null&&c("gkx")("23961")){var h,i;h=(h=b==null?void 0:(h=b.restoredMsgsData)==null?void 0:h.newlyAddedMsgs.length)!=null?h:0;i=(i=b==null?void 0:(i=b.restoredMsgsData)==null?void 0:i.existingMsgs.length)!=null?i:0;if(f!=null&&f.size>0){var j,k=new Set([].concat((b==null?void 0:(j=b.restoredMsgsData)==null?void 0:(j=j.newlyAddedMsgs)==null?void 0:j.map(function(a){return a.externalId}))||[],(b==null?void 0:(j=b.restoredMsgsData)==null?void 0:(b=j.existingMsgs)==null?void 0:b.map(function(a){return a.externalId}))||[]));j=Array.from(f.keys()).reduce(function(a,b){return a+(k.has(b)?0:1)},0);j>0?(g.WARN(y(),a,j),d("MAWQplProxy").sendQPLFailThroughBridge(c("qpl")._(521482576,"1069"),"optimistic_msgs_missed_restore",{"int":{messages_backend_existing:i,messages_backend_restored:h,missed_message_count:j,optimistic_msgs_count:f.size}},e)):d("MAWQplProxy").sendQPLSuccessThroughBridge(c("qpl")._(521482576,"1069"),{"int":{messages_backend_existing:i,messages_backend_restored:h,optimistic_msgs_count:f.size}},e)}else d("MAWQplProxy").sendQPLSuccessThroughBridge(c("qpl")._(521482576,"1069"),{"int":{messages_backend_existing:i,messages_backend_restored:h,optimistic_msgs_count:0}},e)}}function O(a,e,f){f===void 0&&(f=c("LSMEBTaskCreationSource").UNKNOWN);var g=a.restoredMsgsData,i=0;if(g){var j=g.existingMsgs.filter(function(a){return d("MAWDbMsg").isMediaMsg(a)&&a.mediaId==null}),k=g.newlyAddedMsgs;j=[].concat(j,k);var l=g.threadJid,m=[];j.map(function(b){var c=b.externalId;c=a.echoMsgMap.get(c);var f=(c==null?void 0:c.viewOnce)!=null&&(c==null?void 0:c.viewOnce);if(!f&&(b.type!==d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH&&(c==null?void 0:c.contentType)===d("EchoMessage").EchoMessageContentType.MEDIA||(c==null?void 0:c.contentType)===d("EchoMessage").EchoMessageContentType.XMA)){f=P(l,b,a.echoMsgMap,(c==null?void 0:c.contentType)===d("EchoMessage").EchoMessageContentType.XMA,e);f!=null&&(i+=1,m.push(f))}});return d("MAWHandleEchoMediaMsgsRestoreV2").downloadMediaAndWriteToMediaStore(m,a.thread.jid,f).then(function(a){return i})}return(h||(h=b("Promise"))).resolve(i)}function P(a,b,c,e,f){c=c.get(b.externalId);f=f==null?F:F.tags([f]);if(c==null){e?f.tags(["xma"]).WARN(x(),b.externalId):f.tags(["xma"]).MUSTFIX(w(),b.externalId);return null}var g=c.mediaData;if(g==null){e?f.tags(["media"]).WARN(v(),c.messageId):f.tags(["media"]).MUSTFIX(u(),c.messageId);return null}var h=c.from;if(h==null){e?f.tags(["xma"]).WARN(t(),c.messageId):f.tags(["media"]).MUSTFIX(s(),c.messageId);return null}var i=c.sortOrderMs;if(i==null){e?f.tags(["xma"]).WARN(r(),c.messageId):f.tags(["media"]).MUSTFIX(q(),c.messageId);return null}f=d("MAWJids").toUserJid(h.localKey);h=f===d("WAGlobals").getMyUserJid()?d("WAJids").AUTHOR_ME:f;f=b.externalId;b=b.msgId;h={author:h,echoMsg:c,externalId:f,isXMA:e,messageTimestamp:i,msgId:b,threadJId:a};f=Date.now()-i<1e3*60*60*24*30;return babelHelpers["extends"]({},h,{mediaData:g,previewMediaData:f?c.previewMediaData:null})}function Q(a,b,e){a!=null&&e!=null&&b.quotesToBeRestored.map(function(b){d("MAWBridgeEventTransmitter").issuePointQueryOutsideTxn(b.messageId,a,b.sortOrderMs,c("LSMEBTaskCreationSource").POINT_QUERY_FROM_EB,e)})}function R(a,c,e){var f=e==null?F:F.tags([e]);c==null?void 0:c.addPoint("receiver_fetch_restore_start");e=a.restoredMsgsData;if(e==null){c==null?void 0:c.addPoint("receiver_fetch_restore_end");return(h||(h=b("Promise"))).resolve()}var g=e.newlyAddedMsgs;g=g.concat(e.existingMsgs);var i=g.filter(function(a){return a.type===d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH}).map(function(b){var c=b.externalId;c=a.echoMsgMap.get(c);c=c==null?void 0:c.receiverFetchData;if(c==null||b.receiverFetchId==null)return null;if(c.type!=="sticker"){f.WARN(p(),c.type);return null}c={mimetype:c.mimetype,previewHeight:c.previewHeight,previewWidth:c.previewWidth,receiverFetchId:b.receiverFetchId,type:c.type};return{dbMsg:b,unstoredDbReceiverFetchInfo:c}}).filter(Boolean);if(i.length>0)return S(i).then(function(a){c==null?void 0:c.addPoint("receiver_fetch_restore_end",{"int":{receiver_fetch:i.length}});return(h||(h=b("Promise"))).resolve()});c==null?void 0:c.addPoint("receiver_fetch_restore_end",{"int":{receiver_fetch:0}});return(h||(h=b("Promise"))).resolve()}var S=d("MAWIndexedDb").makeMsgrTransactor({receiverFetchInfo:e.READWRITE},"restoreWriteReceiverFetchInfosToDb",function(a){return function(b){return d("MAWDexieTable").dexieAll(b.map(function(b){var c=b.dbMsg;b=b.unstoredDbReceiverFetchInfo;return d("MAWWriteReceiverFetchTxns").handleUnstoredReceiverFetchInfo(a,c,b)}))}});g.handleEchoMsgsBulkRestore=a;g.getThread=K;g.getMediaMetadataForDownload=P;g.writeReceiverFetchInfosToDb=S}),98);
__d("MAWUnstoredQuotedMsgUtils",["FBLogger","MAWMsgType","WAJids","WAMsgType"],(function(a,b,c,d,e,f,g){"use strict";function h(a){if(a==null)return;var b=a.content;a=a.remoteJid;var e;switch(b.type){case d("MAWMsgType").MSG_TYPE.TEXT:e=j(b);break;case d("MAWMsgType").MSG_TYPE.IMAGE:e=k(b);break;case d("MAWMsgType").MSG_TYPE.VIDEO:e=l(b);break;case d("MAWMsgType").MSG_TYPE.PTT:e=m(b);break;case d("MAWMsgType").MSG_TYPE.GIF:e=n(b);break;case d("MAWMsgType").MSG_TYPE.STICKER:e=o(b);break;case d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:e=q(b);break;case d("MAWMsgType").MSG_TYPE.UNAVAILABLE:e=r(b);break;case d("MAWMsgType").MSG_TYPE.EXPIRED_EPHEMERAL:e=s(b);break;case d("WAMsgType").NOTE_REPLY:e=p(b);break;case d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH:e=t(b);break;default:b.type;throw c("FBLogger")("messenger_web").mustfixThrow("For flow")}return{content:e,remoteJid:a}}function i(a){if(d("WAJids").isAuthorSystem(a.author))throw c("FBLogger")("messenger_web").mustfixThrow("A system message cannot be quoted");return{author:a.author,externalId:a.externalId,ts:a.ts}}function j(a){return babelHelpers["extends"]({},i(a),{msgContent:a.msgContent,type:d("MAWMsgType").MSG_TYPE.TEXT})}function k(a){return babelHelpers["extends"]({},i(a),{type:d("MAWMsgType").MSG_TYPE.IMAGE})}function l(a){return babelHelpers["extends"]({},i(a),{type:d("MAWMsgType").MSG_TYPE.VIDEO})}function m(a){return babelHelpers["extends"]({},i(a),{type:d("MAWMsgType").MSG_TYPE.PTT})}function n(a){return babelHelpers["extends"]({},i(a),{type:d("MAWMsgType").MSG_TYPE.GIF})}function o(a){return babelHelpers["extends"]({},i(a),{type:d("MAWMsgType").MSG_TYPE.STICKER})}function p(a){return babelHelpers["extends"]({},i(a),{expirationTs:a.expirationTs,msgContent:a.msgContent,type:d("WAMsgType").NOTE_REPLY})}function q(a){return babelHelpers["extends"]({},i(a),{type:d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE})}function r(a){return babelHelpers["extends"]({},i(a),{type:d("MAWMsgType").MSG_TYPE.UNAVAILABLE})}function s(a){return babelHelpers["extends"]({},i(a),{type:d("MAWMsgType").MSG_TYPE.EXPIRED_EPHEMERAL})}function t(a){return babelHelpers["extends"]({},i(a),{type:d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH})}function a(a){return{quote:h(a.quote)}}g.getWithQuoteMsg=a}),98);
__d("MAWUnstoredTypedMsgUtils",["MAWAdminMsgType","MAWDbMsg","MAWMsgType","MAWRavenUtils","MAWUnstoredQuotedMsgUtils","WAJids"],(function(a,b,c,d,e,f,g){"use strict";function h(a){return{ack:a.ack,author:a.id.author,ebTimestampMs:a.ebTimestampMs,externalId:a.id.externalId,reportingMeta:a.reportingMeta,serverTs:a.serverTs,ts:a.ts}}function i(a){return{forwardingScore:a.forwardingScore,isForwarded:a.isForwarded}}function j(a){return{ephemeralSetting:k(a.ephemeralSetting),messageDeleteTs:a.deleteTs,messageExpirationTs:a.expirationTs}}function k(a){if(a==null)return;return{ephemeralExpirationInSec:a.expirationTs,ephemeralLastUpdatedOrSetTimestamp:a.updatedTs}}function a(a,b){return babelHelpers["extends"]({},h(a),i(a),d("MAWUnstoredQuotedMsgUtils").getWithQuoteMsg(a),j(a),{altIndex:void 0,collapsibleId:a.collapsibleId,isCollapsed:a.isCollapsed,msgContent:{commands:b.commands,content:(a=b.sentWithMessage)!=null?a:"",mentionedJids:b.mentionedJids},type:d("MAWMsgType").MSG_TYPE.XMA,xmaMessageType:b.targetType})}function b(a){return babelHelpers["extends"]({},h(a),i(a),d("MAWUnstoredQuotedMsgUtils").getWithQuoteMsg(a),j(a),{altIndex:void 0,editCount:0,msgContent:a.msgContent,specialTextSize:a.specialTextSize,type:d("MAWMsgType").MSG_TYPE.TEXT})}function c(a){return babelHelpers["extends"]({},h(a),i(a),d("MAWUnstoredQuotedMsgUtils").getWithQuoteMsg(a),j(a),{altIndex:void 0,plaintextHash:(a=a.mediaId)!=null?a:void 0,type:d("MAWMsgType").MSG_TYPE.IMAGE})}function e(a){return babelHelpers["extends"]({},h(a),d("MAWUnstoredQuotedMsgUtils").getWithQuoteMsg(a),j(a),{altIndex:void 0,ravenEphemeralMediaState:d("MAWRavenUtils").getEphemeralMediaState(a.ravenEphemeralMediaState),ravenEphemeralType:a.ravenEphemeralType,ravenMediaType:a.ravenMediaType,type:d("MAWMsgType").MSG_TYPE.RAVEN})}function f(a){return babelHelpers["extends"]({},h(a),i(a),d("MAWUnstoredQuotedMsgUtils").getWithQuoteMsg(a),j(a),{altIndex:void 0,plaintextHash:(a=a.mediaId)!=null?a:void 0,type:d("MAWMsgType").MSG_TYPE.VIDEO})}function l(a){return babelHelpers["extends"]({},h(a),i(a),d("MAWUnstoredQuotedMsgUtils").getWithQuoteMsg(a),j(a),{altIndex:void 0,type:d("MAWMsgType").MSG_TYPE.PTT})}function m(a){return{adminMsgContent:a.adminMsgContent,adminType:a.adminType}}function n(a){return babelHelpers["extends"]({},h(a),{altIndex:void 0,author:d("WAJids").AUTHOR_SYSTEM,msgContent:m(a.msgContent),type:d("MAWMsgType").MSG_TYPE.ADMIN})}function o(a){return babelHelpers["extends"]({},h(a),i(a),d("MAWUnstoredQuotedMsgUtils").getWithQuoteMsg(a),j(a),{altIndex:void 0,plaintextHash:(a=a.mediaId)!=null?a:void 0,type:d("MAWMsgType").MSG_TYPE.GIF})}function p(a){return babelHelpers["extends"]({},h(a),i(a),d("MAWUnstoredQuotedMsgUtils").getWithQuoteMsg(a),j(a),{altIndex:void 0,plaintextHash:(a=a.mediaId)!=null?a:void 0,type:d("MAWMsgType").MSG_TYPE.STICKER})}function q(a){return babelHelpers["extends"]({},h(a),i(a),d("MAWUnstoredQuotedMsgUtils").getWithQuoteMsg(a),j(a),{altIndex:void 0,type:d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE})}function r(a){return babelHelpers["extends"]({},h(a),{altIndex:d("MAWDbMsg").FUTUREPROOF_ALT_INDEX,msgContent:a.msgContent,type:d("MAWMsgType").MSG_TYPE.FUTUREPROOF})}function s(a){return babelHelpers["extends"]({},h(a),{altIndex:void 0,ebTimestampMs:a.ebTimestampMs,revokedExternalId:a.revokedExternalId,type:d("MAWMsgType").MSG_TYPE.REVOKED})}function t(a){return{adminMsgContent:a.adminMsgContent,adminType:a.adminType}}function u(a){return babelHelpers["extends"]({},h(a),{altIndex:void 0,msgContent:t(a.msgContent),type:d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN})}function v(a){return{adminMsgContent:a.adminMsgContent,adminType:a.adminType,screenshotActionType:a.screenshotActionType,version:a.version}}function w(a){return babelHelpers["extends"]({},h(a),{altIndex:void 0,msgContent:v(a.msgContent),type:d("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION})}function x(a){return{adminType:a.adminType,authorName:a.authorName}}function y(a){return babelHelpers["extends"]({},h(a),{altIndex:void 0,msgContent:x(a.msgContent),type:d("MAWMsgType").MSG_TYPE.ICDC_ALERT})}function z(a){return babelHelpers["extends"]({},h(a),d("MAWUnstoredQuotedMsgUtils").getWithQuoteMsg(a),j(a),{altIndex:void 0,type:d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE})}function A(a,b){b=b.receiverFetchId;return babelHelpers["extends"]({},h(a),i(a),d("MAWUnstoredQuotedMsgUtils").getWithQuoteMsg(a),j(a),{altIndex:void 0,receiverFetchId:b,type:d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH})}function B(a,b){var c=a.id.author===d("WAJids").AUTHOR_ME;b=[b.name];c||b.unshift(a.id.author!==d("WAJids").AUTHOR_ME&&a.id.author!==d("WAJids").AUTHOR_SYSTEM?d("WAJids").userIdFromJid(a.id.author):a.id.author);c=c?d("MAWAdminMsgType").CURRENT_USER_CREATED_POLL:d("MAWAdminMsgType").PARTICIPANT_CREATED_POLL;return babelHelpers["extends"]({},h(a),{altIndex:void 0,msgContent:{adminMsgContent:b,adminType:c,version:1},type:d("MAWMsgType").MSG_TYPE.GROUP_POLL_CREATE})}function C(a){return babelHelpers["extends"]({},h(a),{altIndex:void 0,type:d("MAWMsgType").MSG_TYPE.GROUP_POLL_UPDATE})}g.getXMAMsg=a;g.getTextMsg=b;g.getImageMsg=c;g.getRavenMsg=e;g.getVideoMsg=f;g.getPttMsg=l;g.getAdminMsg=n;g.getGifMsg=o;g.getStickerMsg=p;g.getDocumentFileMsg=q;g.getFutureproofMsg=r;g.getRevokedMsg=s;g.getEphemeralSettingAdminMsg=u;g.getEphemeralScreenshotActionMsg=w;g.getICDCAlertMsg=y;g.getBumpExistingMessageMsg=z;g.getReceiverFetchMsg=A;g.getGroupPollCreateMsg=B;g.getGroupPollUpdateMsg=C}),98);
__d("MAWUnstoredMsgUtils",["FBLogger","MAWMsgType","MAWUnstoredTypedMsgUtils","qex"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b=a.unstoredGroupPollCreateInfo,e=a.unstoredMsg,f=a.unstoredReceiverFetchInfo;a=a.unstoredXMA;if(e==null)return null;switch(e.type){case d("MAWMsgType").MSG_TYPE.TEXT:return d("MAWUnstoredTypedMsgUtils").getTextMsg(e);case d("MAWMsgType").MSG_TYPE.IMAGE:return d("MAWUnstoredTypedMsgUtils").getImageMsg(e);case d("MAWMsgType").MSG_TYPE.VIDEO:return d("MAWUnstoredTypedMsgUtils").getVideoMsg(e);case d("MAWMsgType").MSG_TYPE.PTT:return d("MAWUnstoredTypedMsgUtils").getPttMsg(e);case d("MAWMsgType").MSG_TYPE.ADMIN:return d("MAWUnstoredTypedMsgUtils").getAdminMsg(e);case d("MAWMsgType").MSG_TYPE.FUTUREPROOF:return d("MAWUnstoredTypedMsgUtils").getFutureproofMsg(e);case d("MAWMsgType").MSG_TYPE.REVOKED:return d("MAWUnstoredTypedMsgUtils").getRevokedMsg(e);case d("MAWMsgType").MSG_TYPE.GIF:return d("MAWUnstoredTypedMsgUtils").getGifMsg(e);case d("MAWMsgType").MSG_TYPE.STICKER:return d("MAWUnstoredTypedMsgUtils").getStickerMsg(e);case d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return d("MAWUnstoredTypedMsgUtils").getDocumentFileMsg(e);case d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN:return d("MAWUnstoredTypedMsgUtils").getEphemeralSettingAdminMsg(e);case d("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION:return d("MAWUnstoredTypedMsgUtils").getEphemeralScreenshotActionMsg(e);case d("MAWMsgType").MSG_TYPE.ICDC_ALERT:return d("MAWUnstoredTypedMsgUtils").getICDCAlertMsg(e);case d("MAWMsgType").MSG_TYPE.XMA:if((a==null?void 0:a.xma)==null)throw c("FBLogger")("messenger_web").mustfixThrow("XMA content cannot be parsed without XMA payload");return d("MAWUnstoredTypedMsgUtils").getXMAMsg(e,a==null?void 0:a.xma);case d("MAWMsgType").MSG_TYPE.RAVEN:return d("MAWUnstoredTypedMsgUtils").getRavenMsg(e);case d("MAWMsgType").MSG_TYPE.RAVEN_ACTION:case d("MAWMsgType").MSG_TYPE.REACTION:case d("MAWMsgType").MSG_TYPE.EDIT_ACTION:return null;case d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:return d("MAWUnstoredTypedMsgUtils").getBumpExistingMessageMsg(e);case d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH:if(f==null)throw c("FBLogger")("messenger_web").mustfixThrow("Receiver Fetch Info cannot be null for Receiver Fetch Msg");return d("MAWUnstoredTypedMsgUtils").getReceiverFetchMsg(e,f);case d("MAWMsgType").MSG_TYPE.GROUP_POLL_CREATE:if(!c("qex")._("3169"))throw c("FBLogger")("messenger_web").mustfixThrow("Group polls are not yet supported");if(b==null)throw c("FBLogger")("messenger_web").mustfixThrow("Poll Create Info cannot be null for Poll Create Msg");return d("MAWUnstoredTypedMsgUtils").getGroupPollCreateMsg(e,b);case d("MAWMsgType").MSG_TYPE.GROUP_POLL_UPDATE:if(!c("qex")._("3169"))throw c("FBLogger")("messenger_web").mustfixThrow("Group polls are not yet supported");return d("MAWUnstoredTypedMsgUtils").getGroupPollUpdateMsg(e);default:e.type;return null}}function b(a){if(a==null)return null;switch(a.type){case d("MAWMsgType").MSG_TYPE.TEXT:return d("MAWUnstoredTypedMsgUtils").getTextMsg(a);case d("MAWMsgType").MSG_TYPE.GIF:return d("MAWUnstoredTypedMsgUtils").getGifMsg(a);case d("MAWMsgType").MSG_TYPE.STICKER:return d("MAWUnstoredTypedMsgUtils").getStickerMsg(a);default:return null}}function e(a){a=a.unstoredMsg;if(!a||a.type!==d("MAWMsgType").MSG_TYPE.REACTION)return null;a=a;return{ack:a.ack,author:a.id.author,externalId:a.id.externalId,groupingKey:a.groupingKey,reaction:a.reaction,reactToAuthor:a.reactToAuthor,reactToExternalId:a.reactToExternalId,senderTimestampMs:a.senderTimestampMs,threadJid:a.id.chat,ts:a.ts}}function f(a){a=a.unstoredMsg;if(!a||a.type!==d("MAWMsgType").MSG_TYPE.RAVEN_ACTION)return null;a=a;return{ack:a.ack,actionTimestamp:a.actionTimestamp,actionType:a.actionType,author:a.id.author,externalId:a.id.externalId,ravenActionToMsgExternalId:a.ravenActionToMsgExternalId,ts:a.ts,type:a.type}}function h(a){a=a.unstoredIncomingGroupInvite;return!a?null:babelHelpers["extends"]({},a)}function i(a){return a==null?null:{ack:a.ack,author:a.id.author,editMsgContent:a.editMsgContent,externalId:a.id.externalId,originalMsgExternalId:a.originalMsgExternalId,reportingMeta:a.reportingMeta,serverTs:a.serverTs,specialTextSize:a.specialTextSize,ts:a.ts,type:a.type}}function j(a){a=a.unstoredReceiverFetchInfo;return a==null?null:babelHelpers["extends"]({},a,{type:"sticker"})}function k(a){a=a.unstoredGroupPollCreateInfo;return a==null?null:babelHelpers["extends"]({},a,{latestSenderTimestampsMs:new Map()})}function l(a){a=a.unstoredGroupPollUpdateInfo;return a==null?null:{encryptedMessage:a.pollUpdateMessage}}g.getUnstoredMsg=a;g.getUnstoredAssociatedMsg=b;g.getUnstoredReaction=e;g.getUnstoredRavenActionMsg=f;g.getGroupInvite=h;g.getUnstoredEditActionMsg=i;g.getUnstoredReceiverFetchInfo=j;g.getUnstoredGroupPollCreateInfo=k;g.getUnstoredDbGroupPollUpdateInfo=l}),98);
__d("MAWUnstoredMediaUtils",["MAWUnstoredMsgUtils","WASortedLists"],(function(a,b,c,d,e,f,g){"use strict";function h(a){return a==null?null:{accessibilitySummaryText:a.accessibilitySummaryText,mediaEntry:a.mediaEntry,mediaType:a.mediaType,msgIds:d("WASortedLists").emptySet(),plaintextHash:a.plaintextHash,size:a.size,ts:a.ts,validatedAudioInfo:a.validatedAudioInfo,validatedDocumentFileInfo:a.validatedDocumentFileInfo,validatedImageInfo:a.validatedImageInfo,validatedVideoInfo:a.validatedVideoInfo}}function a(a){a=a.unstoredXMA;if(a==null)return;var b=a.unstoredAssociatedMedia,c=a.unstoredAssociatedMsg,e=a.unstoredFavicon,f=a.unstoredHeaderMedia,g=a.unstoredPreviews;a=a.xma;return{unstoredAssociatedMedia:(b=h(b))!=null?b:void 0,unstoredAssociatedMsg:(b=d("MAWUnstoredMsgUtils").getUnstoredAssociatedMsg(c))!=null?b:void 0,unstoredDbXMA:{author:a.author,contentRef:a.contentRef,ctas:a.ctas,defaultCTA:a.defaultCTA,externalId:a.externalId,headerTitle:a.headerTitle,isTombstoned:a.isTombstoned,maxSubtitleNumOfLines:a.maxSubtitleNumOfLines,maxTitleNumOfLines:a.maxTitleNumOfLines,overlayDescription:a.overlayDescription,overlayIconGlyph:a.overlayIconGlyph,overlayTitle:a.overlayTitle,subtitleText:a.subtitleText,targetExpiringAtSec:a.targetExpiringAtSec,targetId:a.targetId,targetType:a.targetType,targetUsername:a.targetUsername,threadJid:a.threadJid,titleText:a.titleText,xmaDataclass:a.xmaDataclass,xmaLayoutType:a.xmaLayoutType},unstoredFavicon:(c=h(e))!=null?c:void 0,unstoredHeaderMedia:(b=h(f))!=null?b:void 0,unstoredPreviews:g?g.map(function(a){return h(a)}).filter(Boolean):void 0}}g.getUnstoredMedia=h;g.getUnstoredXMA=a}),98);
__d("MAWUnstoredContentToUnstoredDbContentUtils",["MAWUnstoredMediaUtils","MAWUnstoredMsgUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b,c=(b=d("MAWUnstoredMsgUtils")).getUnstoredMsg(a),e=d("MAWUnstoredMediaUtils").getUnstoredMedia(a.unstoredMedia),f=b.getUnstoredReaction(a),g=b.getUnstoredRavenActionMsg(a),h=d("MAWUnstoredMediaUtils").getUnstoredXMA(a),i=b.getGroupInvite(a),j=b.getUnstoredEditActionMsg(a.unstoredEditMsg),k=b.getUnstoredReceiverFetchInfo(a),l=b.getUnstoredGroupPollCreateInfo(a);b=b.getUnstoredDbGroupPollUpdateInfo(a);if(i==null)return{contentTypeForLogging:a.contentTypeForLogging,unstoredDbEditActionMsg:j,unstoredDbGroupPollCreateInfo:l,unstoredDbGroupPollUpdateInfo:b,unstoredDbMedia:e,unstoredDbMsg:c,unstoredDbRavenActionMsg:g,unstoredDbReaction:f,unstoredDbReceiverFetchInfo:k,unstoredXMA:h,xmaTargetTypeForLogging:a.xmaTargetTypeForLogging};else return{contentTypeForLogging:a.contentTypeForLogging,unstoredDbEditActionMsg:j,unstoredDbGroupPollCreateInfo:l,unstoredDbGroupPollUpdateInfo:b,unstoredDbMedia:e,unstoredDbMsg:c,unstoredDbRavenActionMsg:g,unstoredDbReaction:f,unstoredDbReceiverFetchInfo:k,unstoredIncomingDbGroupInvite:i,unstoredXMA:h,xmaTargetTypeForLogging:a.xmaTargetTypeForLogging}}g.unstoredContentToUnstoredDbContent=a}),98);
__d("MAWWriteReactionTxns",["MAWAckLevel","MAWAuthor","MAWDbMsg","MAWDbReaction","MAWDbReactionUtils","MAWDbReactionsTxns","MAWDexieTable","MAWJidUtils","MAWUseProtocolMsgIdForMsgId"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c,e){var f=b.author,g=b.externalId,h=b.groupingKey,i=b.reaction,j=b.reactToAuthor,k=b.reactToExternalId,l=b.senderTimestampMs,m=b.ts;return d("MAWDexieTable").dexieAll([a.messages.where("externalId").equals(k).toArray(),a.reactions.where("reactToExternalId").equals(k).toArray(),d("MAWUseProtocolMsgIdForMsgId").shouldUseProtocolMsgIdForMsgId()?d("MAWDexieTable").dexieResolve(null):d("MAWDbReactionsTxns").getNextReactionIdNumberForThread(a,c)]).then(function(b){var n=b[0],o=b[1];b=b[2];o=d("MAWDbReaction").findMatchingReaction(o,c.jid,f);var p=d("MAWAuthor").getAuthorUserJid(j);n=n.find(function(a){return a.threadJid===c.jid&&p===d("MAWAuthor").getAuthorUserJid(a.author)});var q=o==null?void 0:o.ack;(o==null?void 0:o.ack)===d("MAWAckLevel").ACK.partialOptimistic&&(q=d("MAWAckLevel").ACK.clock);var r=d("MAWDbReaction").formatReactionForDb(c.jid,g,b!=null?d("MAWDbMsg").craftReactionId(c.chatId,b):d("MAWJidUtils").formatProtocolMsgIdFromExternalId(c.jid,g),k,i,h,j,n==null?void 0:n.msgId,m,f,o==null?void 0:o.rowId,q,l);return d("MAWDbReactionsTxns").putReaction(a,r).then(function(a){a=babelHelpers["extends"]({},r,{rowId:a});e!==!0&&d("MAWDbReactionUtils").dispatchReaction(a);return a})})}g.writeReaction=a}),98);
__d("MAWWriteReactionMsgApi",["MAWIndexedDb","MAWTransactionMode","MAWWriteReactionTxns","WAJids"],(function(a,b,c,d,e,f,g){"use strict";var h=function(a,b,c,e,f,g,h){g===void 0&&(g=d("WAJids").AUTHOR_ME);var i=e.groupingKey,j=e.reaction,k=e.reactToAuthor,l=e.reactToExternalId;e=e.senderTimestampMs;var m={author:g,externalId:b,groupingKey:i,reaction:j,reactToAuthor:k,reactToExternalId:l,senderTimestampMs:e,ts:f};return a.threads.get({jid:c}).then(function(b){return b==null?"missing_thread":d("MAWWriteReactionTxns").writeReaction(a,m,b,h)}).then(function(a){return a==="missing_thread"?{type:"missing_thread"}:{msgId:a.reactionId,protocolMsgId:{author:g,chat:c,externalId:a.externalId},type:"not_sent"}})};a=d("MAWIndexedDb").makeMsgrTransactor({messages:d("MAWTransactionMode").READONLY,reactions:d("MAWTransactionMode").READWRITE,threads:d("MAWTransactionMode").READONLY},"writeReactionMsg",function(a){return function(b,c,e,f,g,i){g===void 0&&(g=d("WAJids").AUTHOR_ME);return h(a,b,c,e,f,g,i)}});g.writeReactionMsg=a}),98);
__d("MAWHandleEchoProtobufsRestoreApi",["EBLogger","EchoMessageMediaFieldUtils","EncryptedBackupsDYIMessageProcessingUtils","LSDataTraceCheckPoint","LSIntEnum","LSMEBTaskCreationSource","MAWBridge","MAWBridgeEventTransmitter","MAWBridgeMsg","MAWDbEditMsgHistoryTxns","MAWDbMsg","MAWDbRavenActionTxns","MAWDexieTable","MAWEBRestoreTrackingUtils","MAWHandleEchoMediaMsgsRestoreV2","MAWHandleEchoMsgsRestoreApiUtils","MAWHandleEchoMsgsRestoreApiV2","MAWHandleEchoXMARestoreV2","MAWHandleXmaTransactionUtil","MAWIndexedDb","MAWJids","MAWLoadReplyMediaTxns","MAWMediaGalleryM2Utils","MAWMediaManagementTxns","MAWMsg","MAWMsgType","MAWODSProxy","MAWQplProxy","MAWRestoreMsgsTxns","MAWRestoreValidationUtils","MAWTraceUtils","MAWTransactionMode","MAWUnstoredContentToUnstoredDbContentUtils","MAWUpdateQuotedMsgTxns","MAWWriteReactionMsgApi","MAWWriteReceiverFetchTxns","MessageBackupSupplementalKeyGenerator","Promise","WAAckLevel","WAArmadilloApplication.pb","WAArmadilloBackupMessage.pb","WABase64","WAConsumerApplication.pb","WAGlobals","WAHashUtils","WAJids","WAMediaTransport.pb","WAMediaUtils","WAMsgApplication.pb","WAMsgType","WAOdsEnums","WAParseConsumerMessageProtocol","WAParseMediaTransportProtocol","WAParseMessageApplication","WAStanzaUtils","WATimeUtils","asyncToGeneratorRuntime","decodeProtobuf","emptyFunction","gkx","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(){var a=babelHelpers.taggedTemplateLiteralLoose([" Cannot download media - timestamp cannot be null"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Cannot support message type for protobuf restore - reverting to echo restore"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["Protobuf restore initiated for "," messages. isPointRestore: "," referenceTimestamp: ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["No text content found in edit msg"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["Unknown supplemental identifier. Identifier prefix: ",". Parts: ",""]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["Message contains unparseable message application - unable to restore message"]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["Unable to retrieve decoded protobuf from backup message - unsupported message type"]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["Decoded raven video unstored message is null - unable to restore"]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["No author found for original message that was bumped - unable to restore"]);r=function(){return a};return a}function s(){var a=babelHelpers.taggedTemplateLiteralLoose(["Unable to retrieve revoked message external id"]);s=function(){return a};return a}function t(){var a=babelHelpers.taggedTemplateLiteralLoose(["[MAWHandleEchoProtobufsRestoreApi] consumerMessage has no sticker receiver fetch info"]);t=function(){return a};return a}function u(){var a=babelHelpers.taggedTemplateLiteralLoose(["Cannot generate media entry data, ",""]);u=function(){return a};return a}function v(){var a=babelHelpers.taggedTemplateLiteralLoose(["Invalid attachment type, cannot restore attachment"]);v=function(){return a};return a}function w(){var a=babelHelpers.taggedTemplateLiteralLoose(["Unsupported media type, cannot get mimetype for attachment"]);w=function(){return a};return a}function x(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to create db msg from protobuf"]);x=function(){return a};return a}function y(){var a=babelHelpers.taggedTemplateLiteralLoose(["Missing required fields, unable to create db msg from protobuf for thread jid "," and otid ",""]);y=function(){return a};return a}function z(){var a=babelHelpers.taggedTemplateLiteralLoose(["Missing required author, unable to create db msg from protobuf"]);z=function(){return a};return a}function A(){var a=babelHelpers.taggedTemplateLiteralLoose(["Missing required message id, unable to create db msg from protobuf"]);A=function(){return a};return a}function B(){var a=babelHelpers.taggedTemplateLiteralLoose(["Missing required msg type, unable to create db msg from protobuf"]);B=function(){return a};return a}function C(){var a=babelHelpers.taggedTemplateLiteralLoose(["Missing required metadata, unable to create db msg from protobuf"]);C=function(){return a};return a}function D(){var a=babelHelpers.taggedTemplateLiteralLoose(["No target type found for XMA - unable to extract XMA content for message"]);D=function(){return a};return a}function E(){var a=babelHelpers.taggedTemplateLiteralLoose(["XMA data is null - unable to extract XMA content for message"]);E=function(){return a};return a}function F(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] One of the mandatory fields is missing for the group poll creation msg"]);F=function(){return a};return a}function G(){var a=babelHelpers.taggedTemplateLiteralLoose(["No raven msg media type found for raven msg"]);G=function(){return a};return a}function H(){var a=babelHelpers.taggedTemplateLiteralLoose(["No raven msg ephemeral type found for raven msg"]);H=function(){return a};return a}function I(){var a=babelHelpers.taggedTemplateLiteralLoose(["No revoked msg external id found for revoked msg"]);I=function(){return a};return a}function J(){var a=babelHelpers.taggedTemplateLiteralLoose(["Text content cannot be null for msg type text - unable to restore msg"]);J=function(){return a};return a}function K(){var a=babelHelpers.taggedTemplateLiteralLoose(["isMediaGalleryRestore is deprecated. Consider using taskSource insted"]);K=function(){return a};return a}var L=d("EBLogger").EBLogger.tags(["ProtobufRestore"]);function M(a){var b=a.isMediaGalleryRestore,e=a.taskSource;if(b!=null&&b)d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.EB_RESTORE,key:"is_media_gallery_restore_param"}),L.WARN(K()),b=c("LSMEBTaskCreationSource").MEDIA_GALLERY_RESTORE;else{b=(e=e)!=null?e:c("LSMEBTaskCreationSource").UNKNOWN}return babelHelpers["extends"]({},a,{isMediaGalleryRestore:void 0,taskSource:b})}var N=(e=d("MAWIndexedDb")).makeMsgrTransactor({chunk:(f=d("MAWTransactionMode")).READONLY,media:f.READONLY,messages:f.READWRITE,receiverFetchInfo:f.READONLY,xma:f.READONLY},"associateQuotedMessagesForRestoredDbMsgs",function(a){return function(b,c,e){var f=0;return d("MAWDexieTable").dexieAll(b.map(function(b){return d("MAWUpdateQuotedMsgTxns").associateQuotedMessage(a,c,b,!0).then(function(b){b!=null&&b.length>0&&(f+=b.length,b.forEach(function(b){return d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(a,b).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(b,void 0,a)})})}))})})).then(function(){e==null?void 0:e.addPoint("replies_restore_end",{"int":{replies:f}});return d("MAWDexieTable").dexieResolve()})}});function O(a,b,c){c={author:c,chat:b,externalId:a};return c}function P(a,b,c){var e=new Map(),f=a.metadata;a=a.reactionData;if(f!=null&&a!=null){var g=f.senderId,h=f.messageId;if(g!=null&&h!=null){a.forEach(function(a){var f=a.ts,i=a.senderId,j=a.reactionExternalId,k=d("WAStanzaUtils").toStanzaId(h);if(i==null||j==null)return;j=d("WAStanzaUtils").toStanzaId(j);i=d("MAWJids").toUserJid(i);var l=d("MAWJids").toUserJid(g);i=i===c?d("WAJids").AUTHOR_ME:i;l=l===c?d("WAJids").AUTHOR_ME:l;var m=i===d("WAJids").AUTHOR_ME?d("WAAckLevel").ACK.SENT:d("WAAckLevel").ACK.RECEIVED;m={ack:m,chatJid:b,reaction:a.reaction,reactionAuthor:i,reactionExternalId:j,reactToExternalId:k,reactToMsgAuthor:l,ts:f};e.set(j,m)});return e}}}function Q(a,b,c,e,f,g,h,i,j,k,l,m,n,o,p,q){if(a===d("MAWMsgType").MSG_TYPE.TEXT)if(h==null){L.MUSTFIX(J());return}else{h={ack:c===d("WAJids").AUTHOR_ME?d("WAAckLevel").ACK.SENT:d("WAAckLevel").ACK.RECEIVED,forwardingScore:g,id:e,isForwarded:f,msgContent:{content:h,mentionedJids:i!=null?i.map(d("WAJids").validateUserJid).filter(Boolean):void 0},ts:b,type:d("MAWMsgType").MSG_TYPE.TEXT};return h}else if(a===d("MAWMsgType").MSG_TYPE.VIDEO){i={ack:c===d("WAJids").AUTHOR_ME?d("WAAckLevel").ACK.SENT:d("WAAckLevel").ACK.RECEIVED,forwardingScore:g,id:e,isForwarded:f,mediaId:void 0,ts:b,type:d("MAWMsgType").MSG_TYPE.VIDEO};return i}else if(a===d("MAWMsgType").MSG_TYPE.GIF){h={ack:c===d("WAJids").AUTHOR_ME?d("WAAckLevel").ACK.SENT:d("WAAckLevel").ACK.RECEIVED,forwardingScore:g,id:e,isForwarded:f,mediaId:void 0,ts:b,type:d("MAWMsgType").MSG_TYPE.GIF};return h}else if(a===d("MAWMsgType").MSG_TYPE.IMAGE){i={ack:c===d("WAJids").AUTHOR_ME?d("WAAckLevel").ACK.SENT:d("WAAckLevel").ACK.RECEIVED,forwardingScore:g,id:e,isForwarded:f,mediaId:void 0,ts:b,type:d("MAWMsgType").MSG_TYPE.IMAGE};return i}else if(a===d("MAWMsgType").MSG_TYPE.STICKER){h={ack:c===d("WAJids").AUTHOR_ME?d("WAAckLevel").ACK.SENT:d("WAAckLevel").ACK.RECEIVED,forwardingScore:g,id:e,isForwarded:f,mediaId:void 0,ts:b,type:d("MAWMsgType").MSG_TYPE.STICKER};return h}else if(a===d("MAWMsgType").MSG_TYPE.PTT){i={ack:c===d("WAJids").AUTHOR_ME?d("WAAckLevel").ACK.SENT:d("WAAckLevel").ACK.RECEIVED,forwardingScore:g,id:e,isForwarded:f,mediaId:void 0,ts:b,type:d("MAWMsgType").MSG_TYPE.PTT};return i}else if(a===d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE){h={ack:c===d("WAJids").AUTHOR_ME?d("WAAckLevel").ACK.SENT:d("WAAckLevel").ACK.RECEIVED,forwardingScore:g,id:e,isForwarded:f,mediaId:void 0,ts:b,type:d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE};return h}else if(a===d("MAWMsgType").MSG_TYPE.XMA){i={ack:c===d("WAJids").AUTHOR_ME?d("WAAckLevel").ACK.SENT:d("WAAckLevel").ACK.RECEIVED,forwardingScore:g,id:e,isForwarded:f,ts:b,type:d("MAWMsgType").MSG_TYPE.XMA};return i}else if(a===d("MAWMsgType").MSG_TYPE.REVOKED){if(j==null){L.MUSTFIX(I());return}h={ack:c===d("WAJids").AUTHOR_ME?d("WAAckLevel").ACK.SENT:d("WAAckLevel").ACK.RECEIVED,ebTimestampMs:null,id:e,msgContent:void 0,revokedExternalId:j,ts:b,type:d("MAWMsgType").MSG_TYPE.REVOKED,unsendMsgContentDeleteTs:b};return h}else if(a===d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE){i={ack:d("WAAckLevel").ACK.SENT,id:e,ts:b,type:d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE};return i}else if(a===d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH){j={ack:c===d("WAJids").AUTHOR_ME?d("WAAckLevel").ACK.SENT:d("WAAckLevel").ACK.RECEIVED,forwardingScore:g,id:e,isForwarded:f,ts:b,type:d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH};return j}else if(a===d("MAWMsgType").MSG_TYPE.RAVEN){if(k==null){L.MUSTFIX(H());return}if(l==null){L.MUSTFIX(G());return}h={ack:c===d("WAJids").AUTHOR_ME?d("WAAckLevel").ACK.SENT:d("WAAckLevel").ACK.RECEIVED,id:e,mediaId:m,ravenEphemeralMediaState:d("MAWMsg").MAWRavenMsgEphemeralMediaState.UNSEEN,ravenEphemeralType:k,ravenMediaType:l,ts:b,type:d("MAWMsgType").MSG_TYPE.RAVEN};return h}else if(a===d("MAWMsgType").MSG_TYPE.GROUP_POLL_CREATE){if(n==null||o==null||p==null||q==null){L.MUSTFIX(F());return}i={ack:c===d("WAJids").AUTHOR_ME?d("WAAckLevel").ACK.SENT:d("WAAckLevel").ACK.RECEIVED,id:e,ts:b,type:d("MAWMsgType").MSG_TYPE.GROUP_POLL_CREATE};return i}}function R(a,b,c,e,f){if(f==null){L.MUSTFIX(E());return}var g=f==null?void 0:f.ctas.map(function(a){return{actionUrl:a.actionUrl,buttonType:a.buttonType,ctaType:a.ctaType,nativeUrl:a.nativeUrl,title:a.title}}),h=f.targetType;if(h==null){L.MUSTFIX(D());return}var i;f.targetExpiringAtSec!=null&&typeof f.targetExpiringAtSec==="number"&&(i=d("WATimeUtils").castToUnixTime(f.targetExpiringAtSec));a={author:a,contentRef:f.contentRef,ctas:g,defaultCTA:g.length>0?g[0]:void 0,externalId:b,headerTitle:f.headerTitle,maxSubtitleNumOfLines:f.maxSubtitleNumOfLines,maxTitleNumOfLines:f.maxTitleNumOfLines,msgId:c,overlayDescription:f.overlayDescription,overlayIconGlyph:f.overlayIconGlyph,overlayTitle:f.overlayTitle,subtitleText:f.subtitleText,targetExpiringAtSec:i,targetId:f.targetId,targetType:h,targetUsername:f.targetUsername,threadJid:e,titleText:f.titleText,xmaLayoutType:f.xmaLayoutType};return a}function S(a,b,c,e,f){var g,h,i=a.metadata,j=a.msgType;if(i==null){L.MUSTFIX(C());return}if(j==null){L.MUSTFIX(B());return}var k=i.messageId;i=i.senderId;g=(g=a.decodedPayload)==null?void 0:g.text;h=(h=a.decodedPayload)==null?void 0:h.mentionedJid;if(k==null){L.MUSTFIX(A());return}if(i==null){L.MUSTFIX(z());return}var l=d("WATimeUtils").castMilliSecondsToUnixTime(a.sortOrderMs);i=d("MAWJids").toUserJid(i);var m=d("WAStanzaUtils").toStanzaId(k),n=i===c?d("WAJids").AUTHOR_ME:i,o=O(m,b,i);if(a.editMsgData.length>0){var p=l;a.editMsgData.forEach(function(a){var b;if(a.ts>p&&((b=a.editMsgContent.message)==null?void 0:b.text)!=null){p=a.ts;g=(b=a.editMsgContent.message)==null?void 0:b.text;h=(b=a.editMsgContent.message)==null?void 0:b.mentionedJid}})}o=Q(j,l,n,o,a.isForwarded,a.forwardingScore,g,h,a.revokedMsgExternalId,a.ravenMsgEphemeralType,a.ravenMsgMediaType,(l=a.ravenUnstoredMedia)==null?void 0:l.plaintextHash,(n=a.groupPollInfo)==null?void 0:n.encKey,(o=a.groupPollInfo)==null?void 0:o.name,(l=a.groupPollInfo)==null?void 0:l.options,(n=a.groupPollInfo)==null?void 0:n.selectableOptionsCount);if(o==null){L.MUSTFIX(y(),b,m);return}var q;if(a.xmaData!=null&&((l=a.xmaData)==null?void 0:l.targetType)!=null){l={author:i,externalId:m,targetType:(n=a.xmaData)==null?void 0:n.targetType,threadJid:b};q={unstoredAssociatedMedia:void 0,unstoredAssociatedMsg:void 0,unstoredFavicon:void 0,unstoredHeaderMedia:void 0,unstoredPreviews:void 0,xma:l}}i={unstoredGroupPollCreateInfo:a.groupPollInfo,unstoredMedia:void 0,unstoredMsg:o,unstoredQuotedMedia:void 0,unstoredReceiverFetchInfo:a.receiverFetchInfo,unstoredXMA:q};o.type===d("MAWMsgType").MSG_TYPE.RAVEN&&a.ravenUnstoredMedia!=null&&(i.unstoredMedia=a.ravenUnstoredMedia);n=d("MAWUnstoredContentToUnstoredDbContentUtils").unstoredContentToUnstoredDbContent(i);if(n.unstoredDbMsg!=null){b=n.unstoredDbMsg;b.sortOrderMs=a.sortOrderMs;b.serverTs=d("WATimeUtils").castToUnixTime(a.sortOrderMs/1e3);a.noteReply!=null&&(b.quote={content:a.noteReply,remoteJid:void 0});l=e.get(k);b.author!=null&&c===b.author&&b.author!==d("WAJids").AUTHOR_SYSTEM&&(b.author=d("WAJids").AUTHOR_ME);l!=null&&(b.quoteExternalId=d("WAStanzaUtils").toStanzaId(l));j===d("MAWMsgType").MSG_TYPE.TEXT&&(b.editCount=a.editMsgData.length);o={author:b.author,stanzaId:m,unstoredDbContent:n};n.unstoredDbMedia!=null&&f!=null&&f.set(m,n.unstoredDbMedia);return o}L.MUSTFIX(x())}function T(a){switch(a){case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.IMAGE:return d("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.IMAGE_JPEG;case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.GIF:return d("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.GIF;case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.STICKER:return d("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.STICKER;case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.VIDEO:return d("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.AUDIO_MP4;case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.AUDIO:return d("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.AUDIO_WAV;case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.XMA_IMAGE:return d("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.IMAGE_JPEG;default:return null}}function aa(a){switch(a){case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.IMAGE:return d("EchoMessageMediaFieldUtils").AttachmentType.IMAGE;case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.GIF:return d("EchoMessageMediaFieldUtils").AttachmentType.GIF;case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.STICKER:return d("EchoMessageMediaFieldUtils").AttachmentType.STICKER;case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.VIDEO:return d("EchoMessageMediaFieldUtils").AttachmentType.VIDEO;case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.AUDIO:return d("EchoMessageMediaFieldUtils").AttachmentType.PTT;case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.XMA_IMAGE:return d("EchoMessageMediaFieldUtils").AttachmentType.XMA;case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.DOCUMENT:return d("EchoMessageMediaFieldUtils").AttachmentType.DOCUMENT;default:return null}}function ba(){try{return WorkerGlobalScope!==void 0&&self instanceof WorkerGlobalScope}catch(a){return!1}}function ca(a){var b,e=ba()?d("WAGlobals").getConfig().isOctetStreamAttachmentMimeTypeEnabled():c("gkx")("4644");switch(a){case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.IMAGE:b="image/jpeg";break;case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.AUDIO:b="audio/wav";break;case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.VIDEO:b="video/mp4";break;case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.GIF:b="image/gif";break;case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.STICKER:b="image/webp";break;case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.XMA_IMAGE:b="image/jpeg";break;case d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.DOCUMENT:b=e?"application/octet-stream":"application/pdf";break;default:L.MUSTFIX(w())}return b}function U(a,b,c){var e,f,g,h,i,j;b=b;var k=a.ancillary,l=a.integral;e=l==null?void 0:(e=l.transport)==null?void 0:(e=e.integral)==null?void 0:e.fileSha256;f=l==null?void 0:(f=l.transport)==null?void 0:(f=f.integral)==null?void 0:f.fileEncSha256;g=l==null?void 0:(g=l.transport)==null?void 0:(g=g.integral)==null?void 0:g.mediaKey;h=(l==null?void 0:(h=l.transport)==null?void 0:(h=h.integral)==null?void 0:h.mediaKeyTimestamp)!=null?typeof (l==null?void 0:(h=l.transport)==null?void 0:h.integral.mediaKeyTimestamp)==="number"?l==null?void 0:(h=l.transport)==null?void 0:h.integral.mediaKeyTimestamp:void 0:void 0;var m=k==null?void 0:k.gifPlayback;m!=null&&m&&(b=d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.GIF);m=l==null?void 0:(m=l.transport)==null?void 0:(m=m.ancillary)==null?void 0:(m=m.thumbnail)==null?void 0:m.thumbnailHeight;i=l==null?void 0:(i=l.transport)==null?void 0:(i=i.ancillary)==null?void 0:(i=i.thumbnail)==null?void 0:i.thumbnailWidth;var n=T(b),o=aa(b);if(o===null){L.MUSTFIX(v());return}a=d("EncryptedBackupsDYIMessageProcessingUtils").decodeMediaEntryFromAttachmentPayload(a,o===d("EchoMessageMediaFieldUtils").AttachmentType.XMA,c);a.success||L.WARN(u(),a.error);l={attachmentObjectId:l==null?void 0:(j=l.transport)==null?void 0:(j=j.ancillary)==null?void 0:j.objectId,attachmentType:o,directPath:l==null?void 0:(j=l.transport)==null?void 0:(o=j.integral)==null?void 0:o.directPath,encryptedHash:f!=null?d("WAHashUtils").toPlaintextHash(f):void 0,filename:c,height:k==null?void 0:k.height,mediaEntryData:a.value,mediaKey:g!=null?d("WABase64").encodeB64UrlSafe(g):void 0,mediaKeyTimestamp:h,mediaPlayableDuration:k==null?void 0:k.seconds,plaintextHash:e!=null?d("WAHashUtils").toPlaintextHash(e):void 0,width:k==null?void 0:k.width,xAttachmentType:b,xContentType:"full"};j=ca(b);j!=null&&(l.mediaContentType=j);n!=null&&(l.previewContentType=n,l.previewContentHeight=m,l.previewContentWidth=i);return d("EchoMessageMediaFieldUtils").convertMediaMetadataDetailsToMediaMetadata(l,"protobuf")}function V(a,b,c){b=U(a,b,c);if(b==null)return{mediaMetadata:void 0,previewMetadata:null};c=a.integral;a=null;c=c==null?void 0:(c=c.transport)==null?void 0:(c=c.ancillary)==null?void 0:(c=c.thumbnail)==null?void 0:c.downloadableThumbnail;if(c!=null){var e=c.fileSha256,f=c.fileEncSha256,g=c.mediaKey,h=typeof c.mediaKeyTimestamp==="number"?c.mediaKeyTimestamp:void 0;a={attachmentObjectId:c.objectId,attachmentType:d("EchoMessageMediaFieldUtils").AttachmentType.IMAGE,directPath:c.directPath,encryptedHash:f!=null?d("WAHashUtils").toPlaintextHash(f):void 0,filename:void 0,height:void 0,mediaKey:g!=null?d("WABase64").encodeB64UrlSafe(g):void 0,mediaKeyTimestamp:h,mediaPlayableDuration:void 0,plaintextHash:e!=null?d("WAHashUtils").toPlaintextHash(e):void 0,width:void 0,xAttachmentType:d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.MESSENGER_PREVIEW,xContentType:"preview"};return{mediaMetadata:b,previewMetadata:d("EchoMessageMediaFieldUtils").convertMediaMetadataDetailsToMediaMetadata(a,"protobuf")}}return{mediaMetadata:b,previewMetadata:null}}function W(a,b,c,e,f,g){g===void 0&&(g=null),b!=null&&a!=null&&(c.push({mediaMetadata:b,mediaRestoreType:e,previewMetadata:g}),f.set(d("WAStanzaUtils").toStanzaId(a),c))}function da(a){switch(a){case 0:return d("MAWMsg").MAWRavenMsgEphemeralType.VIEW_ONCE;case 1:return d("MAWMsg").MAWRavenMsgEphemeralType.ALLOW_REPLAY;case 2:return d("MAWMsg").MAWRavenMsgEphemeralType.KEEP_IN_CHAT;default:return void 0}}function ea(a,b,c,e,f,g,h,i,j,k,l){var m,n,o=X(a,g,h,i);m=o==null?void 0:(m=o.obj.payload)==null?void 0:m.content;var u={editMsgData:[],externalId:e,forwardingScore:(n=o==null?void 0:(n=o.metadata)==null?void 0:n.forwardingScore)!=null?n:0,isForwarded:(n=o==null?void 0:(n=o.metadata)==null?void 0:n.isForwarded)!=null?n:!1,metadata:a.metadata,reactionData:[],sortOrderMs:b,unknownFieldCount:a.$$unknownFieldCount},v=[];if(m!=null){if(m.messageText!=null){u.msgType=d("MAWMsgType").MSG_TYPE.TEXT;u.decodedPayload=m.messageText;return u}else if(m.extendedContentMessage!=null){u.msgType=d("MAWMsgType").MSG_TYPE.XMA;u.xmaData=m.extendedContentMessage;if(((n=m.extendedContentMessage)==null?void 0:n.headerImage)!=null){n=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAMediaTransport.pb").ImageTransportSpec,(b=m.extendedContentMessage)==null?void 0:b.headerImage.payload);b=U(n,d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.IMAGE);W(e,b,v,"xma_header",j)}if(((n=m.extendedContentMessage)==null?void 0:n.favicon)!=null){n=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAMediaTransport.pb").ImageTransportSpec,(b=m.extendedContentMessage)==null?void 0:b.favicon.payload);b=U(n,d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.IMAGE);W(e,b,v,"xma_favicon",j)}if(((n=m.extendedContentMessage)==null?void 0:n.previews)!=null){(b=m.extendedContentMessage)==null?void 0:b.previews.forEach(function(a){a=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAMediaTransport.pb").ImageTransportSpec,a.payload);a=U(a,d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.IMAGE);u.mediaMetadata=a;W(e,a,v,"xma_preview",j)})}return u}else if(m.audioMessage!=null){n=d("decodeProtobuf").decodeProtobuf(d("WAMediaTransport.pb").AudioTransportSpec,(n=m.audioMessage)==null?void 0:(b=n.audio)==null?void 0:b.payload);b=U(n,d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.AUDIO);u.msgType=d("MAWMsgType").MSG_TYPE.PTT;u.mediaMetadata=b;W(e,b,v,"attachment",j);return u}else if(m.videoMessage!=null){n=d("decodeProtobuf").decodeProtobuf(d("WAMediaTransport.pb").VideoTransportSpec,(n=m.videoMessage)==null?void 0:(n=n.video)==null?void 0:n.payload);n=V(n,d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.VIDEO);var w=n.mediaMetadata;n=n.previewMetadata;b=w;b!=null&&b.xAttachmentType===d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.GIF?u.msgType=d("MAWMsgType").MSG_TYPE.GIF:u.msgType=d("MAWMsgType").MSG_TYPE.VIDEO;u.mediaMetadata=b;W(e,b,v,"attachment",j,n);return u}else if(m.imageMessage!=null){w=d("decodeProtobuf").decodeProtobuf(d("WAMediaTransport.pb").ImageTransportSpec,(w=m.imageMessage)==null?void 0:(n=w.image)==null?void 0:n.payload);n=V(w,d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.IMAGE);w=n.mediaMetadata;n=n.previewMetadata;b=w;u.msgType=d("MAWMsgType").MSG_TYPE.IMAGE;u.mediaMetadata=b;W(e,b,v,"attachment",j,n);return u}else if(m.stickerMessage!=null){w=d("decodeProtobuf").decodeProtobuf(d("WAMediaTransport.pb").StickerTransportSpec,(w=m.stickerMessage)==null?void 0:(n=w.sticker)==null?void 0:n.payload);if(((n=w.integral)==null?void 0:n.receiverFetchId)!=null){n=d("WAParseMediaTransportProtocol").parseStickerReceiverFetchInfo(w);if(n==null){L.MUSTFIX(t());return u}u.msgType=d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH;u.receiverFetchInfo=n;return u}b=U(w,d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.STICKER);u.msgType=d("MAWMsgType").MSG_TYPE.STICKER;u.mediaMetadata=b;W(e,b,v,"attachment",j);return u}else if(m.documentMessage!=null){n=d("decodeProtobuf").decodeProtobuf(d("WAMediaTransport.pb").DocumentTransportSpec,(n=m.documentMessage)==null?void 0:(w=n.document)==null?void 0:w.payload);b=U(n,d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.DOCUMENT,(w=m.documentMessage)==null?void 0:w.fileName);u.msgType=d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE;u.mediaMetadata=b;W(e,b,v,"attachment",j);return u}}else if((o==null?void 0:(n=o.obj.payload)==null?void 0:(m=n.applicationData)==null?void 0:m.revoke)!=null){n=o==null?void 0:(w=o.obj.payload)==null?void 0:(n=w.applicationData)==null?void 0:(m=n.revoke)==null?void 0:(w=m.key)==null?void 0:w.id;if(n==null)L.MUSTFIX(s());else{u.revokedMsgExternalId=d("WAStanzaUtils").toStanzaId(n);u.msgType=d("MAWMsgType").MSG_TYPE.REVOKED;return u}}if((o==null?void 0:(m=o.obj.payload)==null?void 0:(w=m.content)==null?void 0:w.bumpExistingMessage)!=null){w=o==null?void 0:(n=o.obj.payload)==null?void 0:(m=n.content)==null?void 0:m.bumpExistingMessage;m=(n=w.key)==null?void 0:n.id;m!=null&&(h.has(m)||g.add(m),i.set(e,m));h=(n=w.key)==null?void 0:n.participant;if(h==null){h=(g=w.key)==null?void 0:g.remoteJid}if(h==null)L.MUSTFIX(r());else{i=d("WAJids").unsafeCoerceToUserJid(h);m=i===c?d("WAJids").AUTHOR_ME:i;k.set(d("WAStanzaUtils").toStanzaId(e),m);u.msgType=d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE;return u}}if((o==null?void 0:(n=o.obj)==null?void 0:(w=n.payload)==null?void 0:(g=w.content)==null?void 0:g.noteReplyMessage)!=null){m=o==null?void 0:(h=o.obj)==null?void 0:(i=h.payload)==null?void 0:(k=i.content)==null?void 0:k.noteReplyMessage;n=m.noteTimestampMs;w=m.noteText;h=(g=a.metadata)==null?void 0:g.senderId;if(n!=null&&typeof n==="number"&&h!=null&&f!=null){i=d("MAWJids").toUserJid(h);k=d("MAWJids").toUserJid(f);a=k===i?c:k;g={author:a===c?d("WAJids").AUTHOR_ME:a,externalId:d("WAStanzaUtils").toStanzaId(e),ts:d("WATimeUtils").castMilliSecondsToUnixTime(n),type:d("WAMsgType").NOTE_REPLY};if((w==null?void 0:w.text)!=null){h={content:w==null?void 0:w.text,mentionedJids:w==null?void 0:w.mentionedJid.map(function(a){return d("MAWJids").toUserJid(a)})};g.msgContent=h}u.noteReply=g}if(m.textContent!=null){u.msgType=d("MAWMsgType").MSG_TYPE.TEXT;u.decodedPayload=m.textContent;return u}else if(m.stickerContent!=null){f=d("decodeProtobuf").decodeProtobuf(d("WAMediaTransport.pb").StickerTransportSpec,m.stickerContent.payload);b=U(f,d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.STICKER);u.msgType=d("MAWMsgType").MSG_TYPE.STICKER;u.mediaMetadata=b;W(e,b,v,"attachment",j);return u}else if(m.videoContent!=null){i=d("decodeProtobuf").decodeProtobuf(d("WAMediaTransport.pb").VideoTransportSpec,m.videoContent.payload);b=U(i,d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.VIDEO);b!=null&&b.xAttachmentType===d("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.GIF?u.msgType=d("MAWMsgType").MSG_TYPE.GIF:u.msgType=d("MAWMsgType").MSG_TYPE.VIDEO;u.mediaMetadata=b;W(e,b,v,"attachment",j);return u}}if((o==null?void 0:(k=o.obj)==null?void 0:(c=k.payload)==null?void 0:(a=c.content)==null?void 0:a.ravenMessageMsgr)!=null){u.ravenMsgEphemeralType=da(o==null?void 0:(n=o.obj)==null?void 0:(w=n.payload)==null?void 0:(h=w.content)==null?void 0:(g=h.ravenMessageMsgr)==null?void 0:g.ephemeralType);if((o==null?void 0:(f=o.obj)==null?void 0:(m=f.payload)==null?void 0:(i=m.content)==null?void 0:(b=i.ravenMessageMsgr)==null?void 0:b.imageMessage)!=null){if(l==null||!l){u.ravenUnstoredMedia=d("WAParseMediaTransportProtocol").decodeImageTransport(o==null?void 0:(k=o.obj)==null?void 0:(c=k.payload)==null?void 0:(a=c.content)==null?void 0:(n=a.ravenMessageMsgr)==null?void 0:(w=n.imageMessage)==null?void 0:w.payload,d("WATimeUtils").castMilliSecondsToUnixTime(u.sortOrderMs),"image")}u.ravenMsgMediaType=d("MAWMsg").MAWRavenMsgMediaType.IMAGE}else if((o==null?void 0:(h=o.obj)==null?void 0:(g=h.payload)==null?void 0:(f=g.content)==null?void 0:(m=f.ravenMessageMsgr)==null?void 0:m.videoMessage)!=null){if(l==null||!l){n=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAMediaTransport.pb").VideoTransportSpec,o==null?void 0:(i=o.obj)==null?void 0:(b=i.payload)==null?void 0:(k=b.content)==null?void 0:(c=k.ravenMessageMsgr)==null?void 0:(a=c.videoMessage)==null?void 0:a.payload);w=d("WAParseMediaTransportProtocol").parseVideoMsg(n,d("WATimeUtils").castMilliSecondsToUnixTime(u.sortOrderMs),!1);w!=null?u.ravenUnstoredMedia=w:L.MUSTFIX(q())}u.ravenMsgMediaType=d("MAWMsg").MAWRavenMsgMediaType.VIDEO}u.msgType=d("MAWMsgType").MSG_TYPE.RAVEN;return u}else if((o==null?void 0:(h=o.obj)==null?void 0:(g=h.payload)==null?void 0:(f=g.content)==null?void 0:f.pollCreationMessage)!=null){u.msgType=d("MAWMsgType").MSG_TYPE.GROUP_POLL_CREATE;m=o.obj.payload.content.pollCreationMessage;l=m.encKey;i=m.name;b=m.options;k=m.selectableOptionsCount;l!=null&&i!=null&&b!=null&&(u.groupPollInfo={encKey:l,name:i,options:b.map(function(a){a=a.optionName;return a}).filter(Boolean),selectableOptionsCount:k||0});return u}o!=null&&fa(u,o.obj);L.MUSTFIX(p());return u}function fa(a,b){var c;(b==null?void 0:(c=b.payload)==null?void 0:(c=c.content)==null?void 0:c.locationMessage)!=null&&(a.futureProofMessageType="locationMessage");(b==null?void 0:(c=b.payload)==null?void 0:(c=c.content)==null?void 0:c.liveLocationMessage)!=null&&(a.futureProofMessageType="liveLocationMessage");(b==null?void 0:(c=b.payload)==null?void 0:(c=c.content)==null?void 0:c.pollUpdateMessage)!=null&&(a.futureProofMessageType="pollUpdateMessage");(b==null?void 0:(c=b.payload)==null?void 0:(c=c.content)==null?void 0:c.viewOnceMessage)!=null&&(a.futureProofMessageType="viewOnceMessage");(b==null?void 0:(c=b.payload)==null?void 0:(c=c.content)==null?void 0:c.contactMessage)!=null&&(a.futureProofMessageType="contactMessage");(b==null?void 0:(c=b.payload)==null?void 0:(c=c.content)==null?void 0:c.extendedTextMessage)!=null&&(a.futureProofMessageType="extendedTextMessage");(b==null?void 0:(c=b.payload)==null?void 0:(c=c.content)==null?void 0:c.groupInviteMessage)!=null&&(a.futureProofMessageType="groupInviteMessage");(b==null?void 0:(c=b.payload)==null?void 0:(c=c.content)==null?void 0:c.commonSticker)!=null&&(a.futureProofMessageType="commonSticker");(b==null?void 0:(c=b.payload)==null?void 0:(c=c.content)==null?void 0:c.screenshotAction)!=null&&(a.futureProofMessageType="screenshotAction");(b==null?void 0:(c=b.payload)==null?void 0:(c=c.content)==null?void 0:c.extendedMessageContentWithSear)!=null&&(a.futureProofMessageType="extendedMessageContentWithSear");(b==null?void 0:(c=b.payload)==null?void 0:(c=c.content)==null?void 0:c.imageGalleryMessage)!=null&&(a.futureProofMessageType="imageGalleryMessage");(b==null?void 0:(c=b.payload)==null?void 0:(c=c.content)==null?void 0:c.paymentsTransactionMessage)!=null&&(a.futureProofMessageType="paymentsTransactionMessage");(b==null?void 0:(c=b.payload)==null?void 0:(c=c.applicationData)==null?void 0:c.metadataSync)!=null&&(a.futureProofMessageType="metadataSync");(b==null?void 0:(c=b.payload)==null?void 0:(b=c.applicationData)==null?void 0:b.aiBotResponse)!=null&&(a.futureProofMessageType="aiBotResponse")}function X(a,b,c,e){var f;f=(f=a.metadata)==null?void 0:f.messageId;a=d("decodeProtobuf").decodeProtobuf(d("WAMsgApplication.pb").MessageApplicationSpec,a.encryptedTransportMessage);var g=d("WAParseMessageApplication").parseMessageApplication(a);if(g.type==="error"){L.MUSTFIX(o());return}a=a.metadata;var h=a==null?void 0:a.quotedMessage;h=h==null?void 0:h.stanzaId;f!=null&&h!=null&&(c.has(h)||b.add(h),e.set(f,h));if(g.subprotocolType==="armadillo"){c=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAArmadilloApplication.pb").ArmadilloSpec,g.payload);return{metadata:a,obj:c}}else if(g.subprotocolType==="consumerMessage")return{metadata:a,obj:d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAConsumerApplication.pb").ConsumerApplicationSpec,g.payload)}}function ga(a,b,c,d,e,f,g,h,i){return a.map(function(a){return ha(a,b,c,d,e,f,g,h,i)})}function ha(a,b,c,e,f,g,h,i,j){g===void 0&&(g=new Map());var k=d("decodeProtobuf").decodeProtobuf(d("WAArmadilloBackupMessage.pb").BackupMessageSpec,a.toplevelProtobuf.decryptedProtobuf);k=ea(k,a.toplevelProtobuf.protobufTimestampMS,b,a.otid,c,e,f,g,h,i,j);c=a.supplementalProtobufs;for(h of c){i=h[0];j=h[1];c=d("MessageBackupSupplementalKeyGenerator").parseIdentifierString(i);d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.MAW_EB_DECODE_MESSAGE_PROTOBUF_SUPPLEMENTAL,key:c.type});var l=d("decodeProtobuf").decodeProtobuf(d("WAArmadilloBackupMessage.pb").BackupMessageSpec,j.decryptedProtobuf);if(l.encryptedTransportMessage==null)continue;switch(c.type){case"raven_action_message":var m=X(l,e,f,g),o=c.senderJid;o=o===b?d("WAJids").AUTHOR_ME:o;if(m!=null){var p,q,r;m=m.obj;p=(p=m.payload)==null?void 0:(p=p.content)==null?void 0:(p=p.ravenActionNotifMessage)==null?void 0:p.actionTimestamp;q=(q=m.payload)==null?void 0:(q=q.content)==null?void 0:(q=q.ravenActionNotifMessage)==null?void 0:q.actionType;if(p!=null&&q!=null&&typeof p==="number"&&((r=m.payload)==null?void 0:(r=r.content)==null?void 0:(r=r.ravenActionNotifMessage)==null?void 0:(r=r.key)==null?void 0:r.id)!=null){r=d("WAStanzaUtils").toStanzaId((r=m.payload)==null?void 0:(m=r.content)==null?void 0:(r=m.ravenActionNotifMessage)==null?void 0:(m=r.key)==null?void 0:m.id);if(((m=l.metadata)==null?void 0:m.timestampMs)!=null&&typeof ((m=l.metadata)==null?void 0:m.timestampMs)==="number"&&((m=l.metadata)==null?void 0:m.messageId)!=null){var s;m=(m=l.metadata)==null?void 0:m.messageId;s=d("WATimeUtils").castMilliSecondsToUnixTime((s=l.metadata)==null?void 0:s.timestampMs);m=d("WAStanzaUtils").toStanzaId(m);q=q===0?d("MAWMsg").MAWRavenActionNotifType.PLAYED:q===1?d("MAWMsg").MAWRavenActionNotifType.SCREENSHOTTED:d("MAWMsg").MAWRavenActionNotifType.FORCE_DISABLED;p={ack:d("WAAckLevel").ACK.RECEIVED,actionTimestamp:d("WATimeUtils").castMilliSecondsToUnixTime(p),actionType:q,author:o,externalId:m,ravenActionToMsgExternalId:r,ts:s,type:d("MAWMsgType").MSG_TYPE.RAVEN_ACTION};k.ravenActionUnstoredMsg=p}}}break;case"reaction":o=(q=l.metadata)==null?void 0:q.messageId;p=(m=X(l,e,f,g))==null?void 0:(r=m.obj.payload)==null?void 0:(s=r.content)==null?void 0:s.reactionMessage;q=d("WAJids").extractUserId(c.senderJid);p!=null&&q!=null&&k.reactionData.push({reaction:p,reactionExternalId:o,senderId:q,ts:d("WATimeUtils").castMilliSecondsToUnixTime(j.protobufTimestampMS)});break;case"edit":p=(m=X(l,e,f,g))==null?void 0:(r=m.obj.payload)==null?void 0:(s=r.content)==null?void 0:s.editMessage;q=(o=l.metadata)==null?void 0:o.senderId;if(p!=null){m=(j=p.key)==null?void 0:j.id;r=p.timestampMs;if(m!=null&&r!=null&&q!=null&&typeof r==="number"){s=d("MAWJids").toUserJid(q);o=s===b?d("WAJids").AUTHOR_ME:s;k.editMsgData.push({author:o,editMsgContent:p,externalId:d("WAStanzaUtils").toStanzaId(k.externalId),originalMsgExternalId:d("WAStanzaUtils").toStanzaId(m),ts:d("WATimeUtils").castMilliSecondsToUnixTime(r)})}}break;case"poll_update":j=X(l,e,f,g);if(j==null)continue;o=(q=j.obj.payload)==null?void 0:(s=q.content)==null?void 0:s.pollUpdateMessage;if(o!=null){p={externalId:d("WAStanzaUtils").toStanzaId(c.rawIdentifierString)};o.addOption!=null&&(p.addOption=o.addOption);o.vote!=null&&(p.vote=o.vote);o.pollCreationMessageKey!=null&&(p.pollCreationMessageKey=o.pollCreationMessageKey);k.groupPollUpdateData!=null?k.groupPollUpdateData.push(p):k.groupPollUpdateData=[p]}break;case"unknown":m=i.split(":");r=m[0];L.MUSTFIX(n(),r||"null",m.length);break;default:c.type}}f.add(a.otid);return k}function ia(a,b,e,f,g,h){g==null?void 0:g.addPoint("replies_restore_start");return N(a,f,g).then(function(){b!=null&&(h.forEach(function(a){d("MAWBridgeEventTransmitter").issuePointQueryOutsideTxn(a,b,void 0,c("LSMEBTaskCreationSource").POINT_QUERY_FROM_EB,f)}),h.clear())})}function ja(a,c,e,f){e==null?void 0:e.addPoint("xma_restore_start");var g=[],h=new Map();return(i||(i=b("Promise"))).all(a.map(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){if(d("MAWDbMsg").isXMAMsg(a)){var b=a.externalId,e=c.get(b);if(e!=null&&e.xmaData!=null){e=R(a.author,a.externalId,a.msgId,a.threadJid,e.xmaData);if(e!=null){var i,j,k=[],l=[],m=[],n=new Map();b=f.get(b);b!=null&&b.forEach(function(b){var c=d("WAMediaUtils").stringToDeliveryObjectId(b.mediaMetadata.attachmentObjectId),e=d("WAHashUtils").stringToPlaintextHash(d("MAWHandleEchoMediaMsgsRestoreV2").getBase64WithoutPadding(b.mediaMetadata.plaintextHash)),f=n.get(e);n.set(e,f!=null?[].concat(f,[a.msgId]):[a.msgId]);m.push(c);b.mediaRestoreType==="xma_header"&&(i=c);b.mediaRestoreType==="xma_favicon"&&(j=c);b.mediaRestoreType==="xma_preview"&&k.push(c)});var o=(yield d("MAWHandleEchoXMARestoreV2").getMediaForXMAByObjectIds(n));o.forEach(function(a,b){h.set(a.mediaId,a)});if(i!=null){e.headerMediaId=(b=o.get(i))==null?void 0:b.mediaId}if(j!=null){e.faviconMediaId=(b=o.get(j))==null?void 0:b.mediaId}k.forEach(function(a){a=(a=o.get(a))==null?void 0:a.mediaId;a!=null&&l.push(a)});e.previewMediaIds=l;l.length>0&&(e.defaultPreviewMediaId=l[0]);g.push(e)}}}});return function(b){return a.apply(this,arguments)}}())).then(function(){return d("MAWHandleEchoXMARestoreV2").writeXMAsToDb(g).then(function(a){a.forEach(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b;a.previewMediaIds!=null&&a.previewMediaIds.length>0&&(b=h.get(a.previewMediaIds[0]));a=(yield d("MAWHandleXmaTransactionUtil").checkMediaChunkTransactionAndCreatedBridgeXma(b,a));d("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"NewXMA",value:a}]})});return function(b){return a.apply(this,arguments)}}()),e==null?void 0:e.addPoint("xma_restore_end",{"int":{xma:a.length}})})})}function a(a){return Y.apply(this,arguments)}function Y(){Y=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a=M(a);var e=a.currentUserJid,f=a.deanonApiPayload,g=a.decryptedMessagesProtobufs,m=a.echoMessages,n=a.hasMoreAfter,o=a.hasMoreBefore,p=a.instanceKey,q=a.isPointRestore,r=a.minMsgId,s=a.referenceTimestamp,t=a.requestId,u=a.taskSource,v=a.threadJidPrimaryId;a=a.uploadedFromEbQueue;if(g.length===0)return(i||(i=b("Promise"))).resolve();L.DEBUG(l(),g.length,q,s);var w=new Set(),x=new Set(),y=new Map(),z=new Map(),A=new Map(),B=v,C=(yield d("MAWHandleEchoMsgsRestoreApiV2").getThread(v,t));s=q?d("MAWHandleEchoMsgsRestoreApiUtils").MAWRestoreType.POINT_RESTORE:s!=null?d("MAWHandleEchoMsgsRestoreApiUtils").MAWRestoreType.PAGINATED_RESTORE:d("MAWHandleEchoMsgsRestoreApiUtils").MAWRestoreType.INITIAL_RESTORE;s=s;var D=d("MAWQplProxy").startQplUserFlow(c("qpl")._(521486220,"827"),{bool:{isPointRestore:q,uploadedFromEbQueue:a},"int":{messages:g.length},string:{message_backup_type:"protobuf",restore_type:s}},{providedTimeoutInMs:3e5});d("MAWEBRestoreTrackingUtils").addQPLRestorePointWithAnnotationsWorker({annotations:{bool:{isPointRestore:q,uploadedFromEbQueue:a},"int":{messages:g.length},string:{message_backup_type:"protobuf",restore_type:s}},pointName:"restore_maw_job_start",traceId:t});d("MAWTraceUtils").recordCheckpointForTrace(t,(h||(h=d("LSIntEnum"))).ofNumber(c("LSDataTraceCheckPoint").LABYRINTH_WEB_ECHO_MESSAGE_RESTORE_BEGIN),[],!1);try{if(C){s=ga(g,e,v,w,x,y,A,z);D==null?void 0:D.addPoint("restore_protobuf_decode_done",{"int":{decoded_count:s.length,input_decode_gap:g.length-s.length}});var E=C.jid,F=new Set(),G=new Map(),H=new Map(),I=s.map(function(a){G.set(d("WAStanzaUtils").toStanzaId(a.externalId),a);var b=S(a,E,e,y,H);b==null&&F.add(a.externalId);return b}).filter(Boolean),J=s.filter(function(a){return F.has(a==null?void 0:a.externalId)});m!=null&&m.length>0&&m.length!==g.length&&(D==null?void 0:D.addPoint("mismatch_between_echo_and_protobuf_payload_from_server",{"int":{echoMessagesLength:m.length,protobufMessagesLength:g.length}}));if(J.length>0){var K=new Map();J.forEach(function(a){var b="unknown";a.msgType!=null?b=a.msgType:a.futureProofMessageType!=null&&(b=a.futureProofMessageType);a=K.get(b);a!=null?K.set(b,a+1):K.set(b,1)});var N={};K.forEach(function(a,b){b="protobuf_restore_failure_"+b;N[b]=a});D==null?void 0:D.addPoint("protobuf_restore_failed_count_by_msg_type",{"int":N});if(m!=null&&m.length===g.length){L.DEBUG(k());x.clear();D==null?void 0:D.addPoint("reverting_to_echo_restore");yield d("MAWHandleEchoMsgsRestoreApiV2").handleEchoMsgsBulkRestore(v,m,!1,o,n,r,void 0,void 0,p,void 0,u,D,void 0,a);return}}J=I.map(function(a){return{author:a.author,chat:C.jid,externalId:a.stanzaId}});var O=new Set();m=I.map(function(a){O.add(a.stanzaId);return babelHelpers["extends"]({},babelHelpers["extends"]({},a.unstoredDbContent.unstoredDbMsg,{threadJid:C.jid}))});var P=new Map();f!=null&&f.forEach(function(a){P.set(a.externalId,a.sortOrderMs)});s.forEach(function(a){var b=a.sortOrderMs;a=a.externalId;if(P.size>0&&b!=null){a=P.get(a);a!=null&&(a!==b&&(D==null?void 0:D.addPoint("protobuf_restore_toplevel_ts_mismatch")))}});m.sort(function(a,b){return((a=a.sortOrderMs)!=null?a:0)-((a=b.sortOrderMs)!=null?a:0)});n=(yield (i||(i=b("Promise"))).all([d("MAWRestoreMsgsTxns").maybeGetThreadNewestMessage(C),d("MAWRestoreMsgsTxns").maybeGetOldestNonAdminMessage(C),d("MAWRestoreMsgsTxns").getMsgsByProtocolMsgIds(J)]));a=n[0];I=n[1];s=I.maybeOldestAdminMsg;J=I.maybeOldestMsg;I=n[2];var Q=new Set(I.filter(function(a){return a.type!==d("MAWMsgType").MSG_TYPE.CIPHERTEXT}).map(function(a){return a.externalId}));n=m.filter(function(a){return!Q.has(a.externalId)});m=q||o;var R=u===c("LSMEBTaskCreationSource").MEDIA_GALLERY_RESTORE&&d("MAWMediaGalleryM2Utils").shouldSkipSyncToLSDB();z={bumpMessageAuthorMap:z,existingMsgs:I,hasMoreBefore:(o=m)!=null?o:!0,instanceKey:p,isPointRestore:q,maybeNewestMsg:a,maybeOldestAdminMsg:s,maybeOldestMsg:J,minMsgId:r,newMsgs:n,shouldSkipSyncToUI:R,thread:C};D==null?void 0:D.addPoint("message_restore_start");I=(yield d("MAWRestoreMsgsTxns").restoreMsgsForThread(z));m=0;o=0;D==null?void 0:D.addPoint("message_restore_end");p=[];(I==null?void 0:I.existingMsgs)!=null&&(p=p.concat(I==null?void 0:I.existingMsgs),m=I==null?void 0:I.existingMsgs.length);(I==null?void 0:I.newlyAddedMsgs)!=null&&(p=p.concat(I==null?void 0:I.newlyAddedMsgs),o=I==null?void 0:I.newlyAddedMsgs.length);d("MAWRestoreValidationUtils").compareRestoredMsgstoDeanonData({dbMsgArray:p,deanonData:f,echoMsgExternalIds:void 0,protobufMsgs:g,restoreQplFlow:D,traceId:t});var T=[];yield i.all(p.map(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){if(a!=null)if(A.has(a.externalId)){var b=a.sortOrderMs,c=d("WAParseConsumerMessageProtocol").interpretAsNonSystemAuthor(a.author),e=A.get(a.externalId);b==null?L.MUSTFIX(j()):e!=null&&a.mediaId==null&&e.map(function(e){e={author:c,echoMsg:void 0,externalId:a.externalId,isXMA:d("MAWDbMsg").isXMAMsg(a),mediaData:e.mediaMetadata,messageTimestamp:b,msgId:a.msgId,previewMediaData:e.previewMetadata,threadJId:a.threadJid};T.push(e)})}else if(a.type===d("MAWMsgType").MSG_TYPE.RAVEN){e=H.get(a.externalId);e!=null&&(yield oa(a,e))}});return function(b){return a.apply(this,arguments)}}()));s=d("MAWHandleEchoMediaMsgsRestoreV2").downloadMediaAndWriteToMediaStore(T,E,(a=u)!=null?a:c("LSMEBTaskCreationSource").UNKNOWN);J=i.all(p.map(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a=G.get(a.externalId);a!=null&&(yield ka(a,E,D,e,R),yield ma(a,E,e,D,R),a.ravenActionUnstoredMsg!=null&&(yield pa(a.ravenActionUnstoredMsg,C)))});return function(b){return a.apply(this,arguments)}}()));D==null?void 0:D.addPoint("media_restore_start");yield i.all([s,J]);D==null?void 0:D.addPoint("media_restore_end",{"int":{media:T.length}});yield ja(p,G,D,A);yield qa(p,G,D);yield ia(p,B,q,E,D,w);D.endSuccess({"int":{existingMsgs:m,messages_lost:g.length-m-o,newlyAddedMsgs:o,restoredMsgs:m+o,totalMsgsToRestore:g.length},string:{threadJidPrimaryId:v}});d("MAWTraceUtils").recordCheckpointForTrace(t,(h||(h=d("LSIntEnum"))).ofNumber(c("LSDataTraceCheckPoint").LABYRINTH_RESTORE_MESSAGES_SUCCESS),[],!1);d("MAWTraceUtils").recordCheckpointForTrace(t,h.ofNumber(c("LSDataTraceCheckPoint").FLOW_END_AND_FLUSH),[],!0)}}finally{A.clear(),x.clear()}});return Y.apply(this,arguments)}function ka(a,b,c,d,e){return Z.apply(this,arguments)}function Z(){Z=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c,e,f){c.addPoint("msg_history_start");if(a.editMsgData.length>0){var g,h,i,j=[],k=a.sortOrderMs;g=(g=a.metadata)==null?void 0:g.messageId;h=(h=a.metadata)==null?void 0:h.senderId;i=(i=a.decodedPayload)==null?void 0:i.text;if(g!=null&&h!=null){k=d("WATimeUtils").castMilliSecondsToUnixTime(k);h=d("MAWJids").toUserJid(h);g=d("WAStanzaUtils").toStanzaId(g);e=h===e?d("WAJids").AUTHOR_ME:h;h=la(e,i,g,g,k,b);h!=null&&j.push(h);a.editMsgData.forEach(function(a){var c;c=la(a.author,(c=a.editMsgContent.message)==null?void 0:c.text,a.externalId,a.originalMsgExternalId,a.ts,b);c!=null&&j.push(c)});yield na(j,f);c.addPoint("msg_history_end")}}});return Z.apply(this,arguments)}function la(a,b,c,e,f,g){var h=a===d("WAJids").AUTHOR_ME?d("WAAckLevel").ACK.SENT:d("WAAckLevel").ACK.RECEIVED;if(b!=null)return{author:a,editExternalId:c,editTs:f,msgContent:{content:b},originalMsgExternalId:e,sendStatus:h,threadJid:g};L.MUSTFIX(m());return void 0}function ma(a,b,c,d,e){return $.apply(this,arguments)}function $(){$=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,c,e,f,g){e=P(a,c,e);a=a.metadata;if(e!=null&&a!=null){f.addPoint("reactions_restore_start");var h=a.messageId,j=[];e.forEach(function(a,b){return j.push({stanzaId:b,waReactionMsg:a})});a=(i||(i=b("Promise"))).all(j.map(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.waReactionMsg,e=b.ts;e!=null&&h!=null&&(yield d("MAWWriteReactionMsgApi").writeReactionMsg(a.stanzaId,c,{groupingKey:b.reaction.groupingKey,reaction:b.reaction.text,reactToAuthor:d("WAParseConsumerMessageProtocol").interpretAsNonSystemAuthor(b.reactToMsgAuthor),reactToExternalId:b.reactToExternalId,senderTimestampMs:b.reaction.senderTimestampMs},e,d("WAParseConsumerMessageProtocol").interpretAsNonSystemAuthor(b.reactionAuthor),g))});return function(b){return a.apply(this,arguments)}}()));yield a;f.addPoint("reactions_restore_end")}});return $.apply(this,arguments)}var na=e.makeMsgrTransactor({editMsgHistory:f.READWRITE,messages:f.READWRITE},"bulkAddEditMsgHistory",function(a){return function(b,e){return d("MAWDbEditMsgHistoryTxns").bulkAddEditMsgHistory(a,b,!e).then(c("emptyFunction"))}}),oa=e.makeMsgrTransactor({chunk:f.READWRITE,media:f.READWRITE,mediaBackup:f.READWRITE,messages:f.READWRITE},"handleUnstoredMedia",function(a){return function(b,c){return d("MAWMediaManagementTxns").handleUnstoredDbMedia(a,c,b,"ebrestore",!1,!1,"EncryptedBackups")}}),pa=e.makeMsgrTransactor({messages:f.READWRITE,unrenderedMessages:f.READWRITE},"writeRavenActinomsg",function(a){return function(b,c){return d("MAWDbRavenActionTxns").writeRavenActionMsg(a,b,c)}});function qa(a,b,c){c==null?void 0:c.addPoint("receiver_fetch_restore_start");var e=[];a.forEach(function(a){if(a.type===d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH&&a.receiverFetchId!=null){var c=b.get(a.externalId);if(c!=null&&c.receiverFetchInfo!=null){c=babelHelpers["extends"]({},c.receiverFetchInfo,{type:"sticker"});e.push({dbMsg:a,unstoredDbReceiverFetchInfo:c})}}});return ra(e).then(function(){c==null?void 0:c.addPoint("receiver_fetch_restore_end")})["catch"](function(a){c==null?void 0:c.addPoint("receiver_fetch_restore_failure")})}var ra=e.makeMsgrTransactor({receiverFetchInfo:f.READWRITE},"restoreWriteReceiverFetchInfosToTb",function(a){return function(b){return d("MAWDexieTable").dexieAll(b.map(function(b){var c=b.dbMsg;b=b.unstoredDbReceiverFetchInfo;return d("MAWWriteReceiverFetchTxns").handleUnstoredReceiverFetchInfo(a,c,b)}))}});g.removeDeprecatedProtobufRestoreArgs=M;g.associateQuotedMessagesForRestoredDbMsgsTransactor=N;g.createUnstoredDbContentFromProtobufObject=S;g.decodeProtobufArray=ga;g.decodeDecryptedMessageProtobuf=ha;g.handleProtobufsRestore=a;g.writeReceiverFetchInfosToTb=ra}),98);
__d("MAWEBUnstoredDbMsgUtils",["FBLogger","MAWHandleEBRestoreWithHIM","MAWHandleEchoProtobufsRestoreApi","MAWMessageSortOrderUtils","WAJids","WATagsLogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to convert echo message to unstored db message"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to convert protobuf to unstored db message: type: "," error: ",""]);i=function(){return a};return a}var j=d("WATagsLogger").TAGS(["EB","EBRestore","MAWEBUnstoredDbMsgUtils"]);function a(a,b,e,f){var g=e!=null?e:b!=null?d("WAJids").unsafeCoerceToChatJid(b):void 0;if(g==null){c("FBLogger")("labyrinth_web").mustfix("threadId and chatJid are both null - cannot convert protobuf to unstoredDbMsg");return[]}return d("MAWHandleEchoProtobufsRestoreApi").decodeProtobufArray(a,f,void 0,new Set(),new Set(),new Map(),new Map(),new Map(),!0).map(function(a){var b;if((a==null?void 0:(b=a.metadata)==null?void 0:b.messageId)!=null)try{b=d("MAWHandleEchoProtobufsRestoreApi").createUnstoredDbContentFromProtobufObject(a,g,f,new Map(),void 0);if(b!=null&&b.unstoredDbContent.unstoredDbMsg!=null){b=b.unstoredDbContent.unstoredDbMsg;var c=d("MAWMessageSortOrderUtils").generateAuthoritativeMessageSortOrder(b);b.sortOrderMs=c;return b}}catch(b){j.ERROR(i(),a.msgType,b.message)}return null}).filter(Boolean)}function b(b,c,a){return d("MAWHandleEBRestoreWithHIM").convertEchoMessages(b,c).map(function(b){var c;if(b==null||b.length===0||((c=b[0].decodedMsg)==null?void 0:c.unstoredDbMsg)==null){a!=null&&a.ERROR(h());return null}return(c=b[0].decodedMsg)==null?void 0:c.unstoredDbMsg}).filter(Boolean)}g.getUnstoredDbMsgFromProtobuf=a;g.getUnstoredDbMsgFromEcho=b}),98);
__d("WACryptoAesGcm",["WABinary","WACryptoDependencies","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c,d,e){return h.apply(this,arguments)}function h(){h=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c,e,f){f===void 0&&(f=16);b={name:"AES-GCM",iv:k(b),tagLength:f*8};e!=null&&(b.additionalData=k(e));return d("WACryptoDependencies").getCrypto().subtle.encrypt(b,yield j(a),c)});return h.apply(this,arguments)}function c(a,b,c,d,e){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c,e,f){f===void 0&&(f=16);b={name:"AES-GCM",iv:k(b),tagLength:f*8};e!=null&&(b.additionalData=k(e));return d("WACryptoDependencies").getCrypto().subtle.decrypt(b,yield j(a),c)});return i.apply(this,arguments)}function j(a){return d("WACryptoDependencies").getCrypto().subtle.importKey("raw",a,"AES-GCM",!1,["encrypt","decrypt"])}function k(a){if(a instanceof Uint8Array)return a;if(typeof a==="string"){var b=new(d("WABinary").Binary)();b.writeString(a);return b.readByteArray()}return new Uint8Array(a)}g.gcmEncrypt=a;g.gcmDecrypt=c}),98);
__d("WAUseCaseSecret",["$InternalEnum","WABinary","WACryptoHkdf"],(function(a,b,c,d,e,f,g){"use strict";c=b("$InternalEnum")({POLL_VOTE:"Poll Vote",ENC_REACTION:"Enc Reaction",ENC_COMMENT:"Enc Comment",REPORT_TOKEN:"Report Token",EVENT_RESPONSE:"Event Response",EVENT_EDIT_ENCRYPTED:"Event Edit"});var h=32;function a(a){var b=a.messageSecret,c=a.stanzaId,e=a.parentMsgOriginalSender,f=a.modificationSender;a=a.modificationType;c=d("WABinary").Binary.build(c,e,f,a).readBuffer();return d("WACryptoHkdf").extractAndExpand(b instanceof ArrayBuffer?new Uint8Array(b):b,c,h)}g.UseCaseSecretModificationType=c;g.createUseCaseSecret=a}),98);
__d("MAWGroupPollsDualEncryptionUtils",["MAWDbPoll","WABase64","WAConsumerApplication.pb","WACryptoAesGcm","WACryptoSha256","WAResultOrError","WAUseCaseSecret","asyncToGeneratorRuntime","decodeProtobuf","encodeProtobuf"],(function(a,b,c,d,e,f,g){"use strict";function h(a,b,c){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c){if(a.encIv==null||a.encPayload==null)return d("WAResultOrError").makeError("invalid_poll_enc_value");var e=a.encIv;a=a.encPayload;try{b=(yield d("WACryptoAesGcm").gcmDecrypt(b,e,a,c));return d("WAResultOrError").makeResult(b)}catch(a){return d("WAResultOrError").DEPRECATED_makeError("decryption_error",a)}});return i.apply(this,arguments)}function j(a,b,c){return k.apply(this,arguments)}function k(){k=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c){try{var e=self.crypto.getRandomValues(new Uint8Array(12));b=(yield d("WACryptoAesGcm").gcmEncrypt(b,e,a,c));return d("WAResultOrError").makeResult({encIv:e.buffer,encPayload:b})}catch(a){return d("WAResultOrError").DEPRECATED_makeError("encryption_error",a)}});return k.apply(this,arguments)}function l(a,b){a=a+"\0"+b;return new TextEncoder().encode(a).buffer}function a(a,b){return m.apply(this,arguments)}function m(){m=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){var c=b.pollCreationMessageKey,e=b.pollCreationSenderJid,f=b.pollCreationStanzaId,g=b.pollUpdateSenderJid;b=b.pollUpdateStanzaId;c=(yield d("WAUseCaseSecret").createUseCaseSecret({messageSecret:c,modificationSender:g,modificationType:d("WAUseCaseSecret").UseCaseSecretModificationType.POLL_VOTE,parentMsgOriginalSender:e,stanzaId:f}));e=l(b,g);f=d("encodeProtobuf").encodeProtobuf(d("WAConsumerApplication.pb").ConsumerApplication$PollVoteMessageSpec,a).readBuffer();return j(f,c,e)});return m.apply(this,arguments)}function c(a,b){return n.apply(this,arguments)}function n(){n=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){var c=b.pollCreationMessageKey,e=b.pollCreationSenderJid,f=b.pollCreationStanzaId,g=b.pollUpdateSenderJid;b=b.pollUpdateStanzaId;c=(yield d("WAUseCaseSecret").createUseCaseSecret({messageSecret:c,modificationSender:g,modificationType:d("WAUseCaseSecret").UseCaseSecretModificationType.POLL_VOTE,parentMsgOriginalSender:e,stanzaId:f}));e=l(b,g);f=(yield h(a,c,e));if(!f.success)return f;try{return d("WAResultOrError").makeResult(d("decodeProtobuf").decodeProtobuf(d("WAConsumerApplication.pb").ConsumerApplication$PollVoteMessageSpec,f.value))}catch(a){return d("WAResultOrError").DEPRECATED_makeError("protobuf_decode_error",a)}});return n.apply(this,arguments)}function e(a,b){return o.apply(this,arguments)}function o(){o=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){var c=b.pollCreationMessageKey,e=b.pollCreationSenderJid,f=b.pollCreationStanzaId,g=b.pollUpdateSenderJid;b=b.pollUpdateStanzaId;c=(yield d("WAUseCaseSecret").createUseCaseSecret({messageSecret:c,modificationSender:g,modificationType:d("WAUseCaseSecret").UseCaseSecretModificationType.POLL_VOTE,parentMsgOriginalSender:e,stanzaId:f}));e=l(b,g);f=d("encodeProtobuf").encodeProtobuf(d("WAConsumerApplication.pb").ConsumerApplication$PollAddOptionMessageSpec,a).readBuffer();return j(f,c,e)});return o.apply(this,arguments)}function f(a,b){return p.apply(this,arguments)}function p(){p=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){var c=b.pollCreationMessageKey,e=b.pollCreationSenderJid,f=b.pollCreationStanzaId,g=b.pollUpdateSenderJid;b=b.pollUpdateStanzaId;c=(yield d("WAUseCaseSecret").createUseCaseSecret({messageSecret:c,modificationSender:g,modificationType:d("WAUseCaseSecret").UseCaseSecretModificationType.POLL_VOTE,parentMsgOriginalSender:e,stanzaId:f}));e=l(b,g);f=(yield h(a,c,e));if(!f.success)return f;try{return d("WAResultOrError").makeResult(d("decodeProtobuf").decodeProtobuf(d("WAConsumerApplication.pb").ConsumerApplication$PollAddOptionMessageSpec,f.value))}catch(a){return d("WAResultOrError").DEPRECATED_makeError("protobuf_decode_error",a)}});return p.apply(this,arguments)}function q(a){return r.apply(this,arguments)}function r(){r=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a=(yield d("WACryptoSha256").sha256(new TextEncoder("utf8").encode(a)));return s(a)});return r.apply(this,arguments)}function s(a){return d("MAWDbPoll").convertStringToOptionHash(d("WABase64").encodeB64(a))}g.encryptGroupPollVote=a;g.decryptGroupPollVote=c;g.encryptGroupPollAddOption=e;g.decryptGroupPollAddOption=f;g.getHashForOptionName=q;g.getBase64EncodedHash=s}),98);
__d("WACreateWasmFunction",["WAErrorMessage","WAResultOrError","WASI","asyncToGeneratorRuntime","decodeProtobuf","encodeProtobuf"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Unexpected runtime error: ",", for cli: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["invalid result type"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["non-zero-exit-code: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["",""]);l=function(){return a};return a}var m="input",n="output",o="/"+m,p="/"+n;function q(a){var b=a.command,c=a.input,d=a.stderr,e=a.stdout;a=a.cli;var f=new Date();return{args:[a,b,"-i="+m,"-o="+n],fs:(a={},a[o]={content:new Uint8Array(c),mode:"binary",path:o,timestamps:{access:f,change:f,modification:f}},a),stderr:d,stdout:e}}function a(a){var c=a.InputSpec,e=a.ResultSpec,f=a.command,g=a.getWasmModule,m=a.logger,n=a.validateResult,o=a.cli,r=m.TAGS(["WasmFunc"]),s=function(a){r.ERROR(l(),a)},t=function(a){r.LOG(k(),a)};return function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){try{a=d("encodeProtobuf").encodeProtobuf(c,a).readBuffer();a=d("WASI").createWasi(q({cli:o,command:f,input:a,stderr:s,stdout:t}));var b=a.getImportObject;a=a.start;var k=(yield g());k=(yield WebAssembly.instantiate(k,b()));b=a(k);a=b.exitCode;k=b.fs;k=(b=k[p])==null?void 0:b.content;if(a!==0){r.ERROR(j(),a);return d("WAResultOrError").makeError("wasm-internal-non-zero-exit-code")}if(!(k instanceof Uint8Array)){r.ERROR(i());return d("WAResultOrError").makeError("wasm-internal-invalid-result-type")}b=d("decodeProtobuf").decodeProtobuf(e,k);return n(b)}catch(a){r.ERROR(h(),d("WAErrorMessage").maybeGetMessageFromError(a),o);return a instanceof Error?d("WAResultOrError").DEPRECATED_makeError("wasm-internal-runtime-error",a):d("WAResultOrError").makeError("wasm-internal-runtime-error")}});function k(b){return a.apply(this,arguments)}return k}()}g.createWasmFunction=a}),98);
__d("WACryptoCurve25519Dependencies",["Promise","WACryptoPrimitives","WASignalKeys","WASignalOther"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(){return(h||(h=b("Promise"))).resolve().then(function(){return d("WASignalKeys").makeKeyPair()})}function c(a,c){return(h||(h=b("Promise"))).resolve().then(function(){return d("WACryptoPrimitives").scalarMult(d("WASignalOther").ensureSize(c,32),d("WASignalOther").ensureSize(a,32)).buffer})}e={generateIdentityKeyPair:a,calculateAgreement:c};g.calculateAgreement=c;g.CURVE25519_SIGNAL_DEPENDENCIES=e}),98);
__d("createMainThreadQuery",["FBLogger","IGDWebUtils","MAWRotateDTSG","WARetryableError","asyncToGeneratorRuntime","executeGraphQLQuery","relay-runtime"],(function(a,b,c,d,e,f,g){"use strict";function a(a){a=a.getNetwork();a={execute:a.execute};return a}function e(a,b,c){return h.apply(this,arguments)}function h(){h=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e){var f=d("relay-runtime").getRequest(a);if(f.params.operationKind!=="query")throw c("FBLogger")("messenger_web").mustfixThrow("createWorkerQuery: Expected query operation");var g=d("IGDWebUtils").isOnInstagramWeb();f=(yield d("executeGraphQLQuery").executeGraphQLQuery(e,a,b).then(function(a){return a.toPromise()}).then(function(a){return Array.isArray(a)?a[0].data:(a=a.data)!=null?a:null})["catch"](function(a){if(("code"in a&&a.code===1357004||"message"in a&&a.message.indexOf("1357004")!==-1||typeof a==="string"&&a.indexOf("1357004")!==-1)&&!g){c("FBLogger")("messenger_web").info("Failed with expired DTSG, attempting to rotate.");return d("MAWRotateDTSG").tryRotateDTSG().then(function(b){if(b)throw new(c("WARetryableError"))(a);throw a})}throw a}));return f});return h.apply(this,arguments)}g.getWorkerLikeRelayEnvironment=a;g.createMainThreadQuery=e}),98);